From 7f2f4bb36593c0d2ed3284b3b8be2951fa6d5008 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sat, 4 Feb 2012 22:10:40 -0800
Subject: [PATCH 001/119] diff: -N, --unidirectional-new-file now compare to
 "-" too

* NEWS: Document this.
* doc/diffutils.texi (Comparing Directories): Likewise.
Also, document that these options work at the top level.
* src/diff.c (compare_files): Treat EBADF like ENOENT, to handle
the case where "-" is closed.  Allow the other file to be
STDIN_FILENO, in case it's "-".
* tests/Makefile.am (TESTS): Add new-file.
* tests/new-file: New file.
---
 NEWS               |  5 +++++
 doc/diffutils.texi | 33 +++++++++++++++++----------------
 src/diff.c         | 16 +++++++---------
 tests/Makefile.am  |  1 +
 tests/new-file     | 38 ++++++++++++++++++++++++++++++++++++++
 5 files changed, 68 insertions(+), 25 deletions(-)
 create mode 100755 tests/new-file

diff --git a/NEWS b/NEWS
index 808c603..5a69cd7 100644
--- a/NEWS
+++ b/NEWS
@@ -2,6 +2,11 @@ GNU diffutils NEWS                                    -*- outline -*-
 
 * Noteworthy changes in release ?.? (????-??-??) [?]
 
+** New features
+
+  --new-file (-N) and --unidirectional-new-file now allow comparisons to "-".
+  A standard input that's closed acts like a nonexistent file.
+
 
 * Noteworthy changes in release 3.2 (2011-09-02) [stable]
 
diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 00403df..d4a68f8 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -1784,20 +1784,23 @@ subdirectories' files, but if you use the @option{-r} or
 @option{--recursive} option, it compares every corresponding pair of files
 in the directory trees, as many levels deep as they go.
 
-For file names that are in only one of the directories, @command{diff}
-normally does not show the contents of the file that exists; it reports
-only that the file exists in that directory and not in the other.  You
-can make @command{diff} act as though the file existed but was empty in the
-other directory, so that it outputs the entire contents of the file that
+If only one file exists, @command{diff} normally does not show its
+contents; it merely reports that one file exists but the other does
+not.  You can make @command{diff} act as though the missing file is
+empty, so that it outputs the entire contents of the file that
 actually exists.  (It is output as either an insertion or a
-deletion, depending on whether it is in the first or the second
-directory given.)  To do this, use the @option{--new-file} (@option{-N})
-option.
-
-If the older directory contains one or more large files that are not in
+deletion, depending on whether the missing file is in the first or the
+second position.)  To do this, use the @option{--new-file}
+(@option{-N}) option.  This option affects command-line arguments as
+well as files found via directory traversal; for example, @samp{diff
+-N a b} treats @file{a} as empty if @file{a} does not exist but
+@file{b} does, and similarly @samp{diff -N - b} treats standard input
+as empty if it is closed but @file{b} exists.
+
+If the older directory contains large files that are not in
 the newer directory, you can make the patch smaller by using the
 @option{--unidirectional-new-file} option instead of @option{-N}.
-This option is like @option{-N} except that it only inserts the contents
+This option is like @option{-N} except that it inserts the contents only
 of files that appear in the second directory but not the first (that is,
 files that were added).  At the top of the patch, write instructions for
 the user applying the patch to remove the files that were deleted before
@@ -3843,9 +3846,8 @@ specifies the number of lines affected.  @xref{RCS}.
 
 @item -N
 @itemx --new-file
-In directory comparison, if a file is found in only one directory,
-treat it as present but empty in the other directory.  @xref{Comparing
-Directories}.
+If one file is missing, treat it as present but empty.
+@xref{Comparing Directories}.
 
 @item --new-group-format=@var{format}
 Use @var{format} to output a group of lines taken from just the second
@@ -3937,8 +3939,7 @@ Use @var{format} to output a line common to both files in if-then-else
 format.  @xref{Line Formats}.
 
 @item --unidirectional-new-file
-When comparing directories, if a file appears only in the second
-directory of the two, treat it as present but empty in the other.
+If a first file is missing, treat it as present but empty.
 @xref{Comparing Directories}.
 
 @item -U @var{lines}
diff --git a/src/diff.c b/src/diff.c
index 972d84d..200112b 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -92,15 +92,11 @@ static bool binary;
 enum { binary = true };
 #endif
 
-/* When comparing directories, if a file appears only in one
-   directory, treat it as present but empty in the other (-N).
-   Then 'patch' would create the file with appropriate contents.  */
+/* If one file is missing, treat it as present but empty (-N).  */
 static bool new_file;
 
-/* When comparing directories, if a file appears only in the second
-   directory of the two, treat it as present but empty in the other
-   (--unidirectional-new-file).
-   Then 'patch' would create the file with appropriate contents.  */
+/* If the first file is missing, treat it as present but empty
+   (--unidirectional-new-file).  */
 static bool unidirectional_new_file;
 
 /* Report files compared that are the same (-s).
@@ -1155,9 +1151,11 @@ compare_files (struct comparison const *parent,
 	    ? (S_ISREG (cmp.file[f].stat.st_mode)
 	       && ! (cmp.file[f].stat.st_mode & (S_IRWXU | S_IRWXG | S_IRWXO))
 	       && cmp.file[f].stat.st_size == 0)
-	    : (cmp.file[f].desc == ERRNO_ENCODE (ENOENT)
+	    : ((cmp.file[f].desc == ERRNO_ENCODE (ENOENT)
+		|| cmp.file[f].desc == ERRNO_ENCODE (EBADF))
 	       && ! parent
-	       && cmp.file[1 - f].desc == UNOPENED)))
+	       && (cmp.file[1 - f].desc == UNOPENED
+		   || cmp.file[1 - f].desc == STDIN_FILENO))))
       cmp.file[f].desc = NONEXISTENT;
 
   for (f = 0; f < 2; f++)
diff --git a/tests/Makefile.am b/tests/Makefile.am
index 2f6ad53..afc9aad 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -8,6 +8,7 @@ TESTS = \
   help-version	\
   function-line-vs-leading-space \
   label-vs-func	\
+  new-file \
   no-dereference \
   no-newline-at-eof \
   stdin
diff --git a/tests/new-file b/tests/new-file
new file mode 100755
index 0000000..af7cc4c
--- /dev/null
+++ b/tests/new-file
@@ -0,0 +1,38 @@
+#!/bin/sh
+# Test --new-file (-N) and --unidirectional-new-file.
+
+. "${srcdir=.}/init.sh"; path_prepend_ ../src
+
+fail=0
+
+echo a > a || fail=1
+
+echo '0a1
+> a' > exp || fail=1
+
+diff -N - a <&- > out; test $? = 1 || fail=1
+compare exp out || fail=1
+
+diff --unidirectional-new-file - a <&- > out; test $? = 1 || fail=1
+compare exp out || fail=1
+
+diff -N b - < a > out; test $? = 1 || fail=1
+compare exp out || fail=1
+
+diff --unidirectional-new-file b - < a > out; test $? = 1 || fail=1
+compare exp out || fail=1
+
+echo '1d0
+< a' > exp || fail=1
+
+diff -N a - <&- > out; test $? = 1 || fail=1
+compare exp out || fail=1
+
+diff --unidirectional-new-file a - <&- > out; test $? = 2 || fail=1
+
+diff -N - b < a > out; test $? = 1 || fail=1
+compare exp out || fail=1
+
+diff --unidirectional-new-file - b < a > out; test $? = 2 || fail=1
+
+Exit $fail
-- 
2.10.1 (Apple Git-78)


From b2892140d83cbc05881440a2fdbc13bb24b6cd76 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 12 Feb 2012 13:08:26 -0800
Subject: [PATCH 002/119] sdiff: remove dependency on sigprocmask

* bootstrap.conf (gnulib_modules): Remove sigprocmask.
* src/sdiff.c (temporary_file): No need to invoke sigprocmask
here, since the signal handler merely sets a flag.
---
 bootstrap.conf | 1 -
 src/sdiff.c    | 9 ---------
 2 files changed, 10 deletions(-)

diff --git a/bootstrap.conf b/bootstrap.conf
index 9b67b74..55f0837 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -60,7 +60,6 @@ readme-release
 regex
 sh-quote
 signal
-sigprocmask
 stat
 stat-macros
 stat-time
diff --git a/src/sdiff.c b/src/sdiff.c
index e1bb117..ceda3db 100644
--- a/src/sdiff.c
+++ b/src/sdiff.c
@@ -1178,18 +1178,9 @@ temporary_file (void)
   char const *dir = tmpdir ? tmpdir : P_tmpdir;
   char *buf = xmalloc (strlen (dir) + 1 + 5 + 6 + 1);
   int fd;
-  int e;
-  sigset_t procmask;
-  sigset_t blocked;
   sprintf (buf, "%s/sdiffXXXXXX", dir);
-  sigemptyset (&blocked);
-  sigaddset (&blocked, SIGINT);
-  sigprocmask (SIG_BLOCK, &blocked, &procmask);
   fd = mkstemp (buf);
-  e = errno;
   if (0 <= fd)
     tmpname = buf;
-  sigprocmask (SIG_SETMASK, &procmask, 0);
-  errno = e;
   return fd;
 }
-- 
2.10.1 (Apple Git-78)


From c7560370da8ff0d7b48b75989b8f46cb619fbfd8 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 4 Mar 2012 13:19:55 -0800
Subject: [PATCH 003/119] doc: explain -I RE better in --help output

* src/diff.c, src/sdiff.c (option_help_msgid): For -I RE,
change "whose lines all match" to "all whose lines match" to avoid
unintended interpretation.  Reported by Danijel Tasov in
<http://bugs.debian.org/648411>.
---
 src/diff.c  | 2 +-
 src/sdiff.c | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/diff.c b/src/diff.c
index 200112b..85950fa 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -894,7 +894,7 @@ static char const * const option_help_msgid[] = {
   N_("-b, --ignore-space-change       ignore changes in the amount of white space"),
   N_("-w, --ignore-all-space          ignore all white space"),
   N_("-B, --ignore-blank-lines        ignore changes whose lines are all blank"),
-  N_("-I, --ignore-matching-lines=RE  ignore changes whose lines all match RE"),
+  N_("-I, --ignore-matching-lines=RE  ignore changes all whose lines match RE"),
   "",
   N_("-a, --text                      treat all files as text"),
   N_("    --strip-trailing-cr         strip trailing carriage return on input"),
diff --git a/src/sdiff.c b/src/sdiff.c
index ceda3db..63b2861 100644
--- a/src/sdiff.c
+++ b/src/sdiff.c
@@ -175,7 +175,7 @@ static char const * const option_help_msgid[] = {
   N_("-b, --ignore-space-change    ignore changes in the amount of white space"),
   N_("-W, --ignore-all-space       ignore all white space"),
   N_("-B, --ignore-blank-lines     ignore changes whose lines are all blank"),
-  N_("-I, --ignore-matching-lines=RE  ignore changes whose lines all match RE"),
+  N_("-I, --ignore-matching-lines=RE  ignore changes all whose lines match RE"),
   N_("    --strip-trailing-cr      strip trailing carriage return on input"),
   N_("-a, --text                   treat all files as text"),
   "",
-- 
2.10.1 (Apple Git-78)


From 2f108d7405ab121ebbec88ee9865bac8657f7218 Mon Sep 17 00:00:00 2001
From: Eric Blake <eblake@redhat.com>
Date: Wed, 7 Mar 2012 09:13:10 -0700
Subject: [PATCH 004/119] usage: improve wording of --ignore-matching-lines

* src/diff.c (option_help_msgid): Tweak wording.
---
 src/diff.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/diff.c b/src/diff.c
index 85950fa..b316afe 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -893,8 +893,8 @@ static char const * const option_help_msgid[] = {
   N_("-Z, --ignore-trailing-space     ignore white space at line end"),
   N_("-b, --ignore-space-change       ignore changes in the amount of white space"),
   N_("-w, --ignore-all-space          ignore all white space"),
-  N_("-B, --ignore-blank-lines        ignore changes whose lines are all blank"),
-  N_("-I, --ignore-matching-lines=RE  ignore changes all whose lines match RE"),
+  N_("-B, --ignore-blank-lines        ignore changes where lines are all blank"),
+  N_("-I, --ignore-matching-lines=RE  ignore changes where all lines match RE"),
   "",
   N_("-a, --text                      treat all files as text"),
   N_("    --strip-trailing-cr         strip trailing carriage return on input"),
-- 
2.10.1 (Apple Git-78)


From 6cb7786fd85a503bfcbe8f28dd34a92902736825 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@redhat.com>
Date: Thu, 26 Jan 2012 12:25:27 +0100
Subject: [PATCH 005/119] maint: update bootstrap from gnulib

* bootstrap: Update from gnulib.
---
 bootstrap | 26 +++++++++++++++++++-------
 1 file changed, 19 insertions(+), 7 deletions(-)

diff --git a/bootstrap b/bootstrap
index 66da981..c8ee3cc 100755
--- a/bootstrap
+++ b/bootstrap
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Print a version string.
-scriptversion=2012-01-06.07; # UTC
+scriptversion=2012-02-11.09; # UTC
 
 # Bootstrap this package from checked-out sources.
 
@@ -87,9 +87,9 @@ gnulib_files=
 : ${AUTOPOINT=autopoint}
 : ${AUTORECONF=autoreconf}
 
-# A function to be called to edit gnulib.mk right after it's created.
+# A function to be called right after gnulib-tool is run.
 # Override it via your own definition in bootstrap.conf.
-gnulib_mk_hook() { :; }
+bootstrap_post_import_hook() { :; }
 
 # A function to be called after everything else in this script.
 # Override it via your own definition in bootstrap.conf.
@@ -604,7 +604,7 @@ if $bootstrap_sync; then
 fi
 
 gnulib_tool=$GNULIB_SRCDIR/gnulib-tool
-<$gnulib_tool || exit
+<$gnulib_tool || exit $?
 
 # Get translations.
 
@@ -758,7 +758,7 @@ fi
 # Autoreconf runs aclocal before libtoolize, which causes spurious
 # warnings if the initial aclocal is confused by the libtoolized
 # (or worse out-of-date) macro directory.
-if grep '^[    ]*LT_INIT' configure.ac >/dev/null; then
+if test $use_libtool = 1; then
   echo "running: $LIBTOOLIZE --copy --install"
   $LIBTOOLIZE --copy --install
 fi
@@ -807,6 +807,9 @@ for file in $gnulib_files; do
   symlink_to_dir "$GNULIB_SRCDIR" $file || exit
 done
 
+bootstrap_post_import_hook \
+  || { echo >&2 "$me: bootstrap_post_import_hook failed"; exit 1; }
+
 # Remove any dangling symlink matching "*.m4" or "*.[ch]" in some
 # gnulib-populated directories.  Such .m4 files would cause aclocal to fail.
 # The following requires GNU find 4.2.3 or newer.  Considering the usual
@@ -819,11 +822,20 @@ find "$m4_base" "$source_base" \
   -depth \( -name '*.m4' -o -name '*.[ch]' \) \
   -type l -xtype l -delete > /dev/null 2>&1
 
+# Some systems (RHEL 5) are using ancient autotools, for which the
+# --no-recursive option had not been invented.  Detect that lack and
+# omit the option when it's not supported.  FIXME in 2017: remove this
+# hack when RHEL 5 autotools are updated, or when they become irrelevant.
+no_recursive=
+case $($AUTORECONF --help) in
+  *--no-recursive*) no_recursive=--no-recursive;;
+esac
+
 # Tell autoreconf not to invoke autopoint or libtoolize; they were run above.
 echo "running: AUTOPOINT=true LIBTOOLIZE=true " \
-    "$AUTORECONF --verbose --install --no-recursive -I $m4_base $ACLOCAL_FLAGS"
+    "$AUTORECONF --verbose --install $no_recursive -I $m4_base $ACLOCAL_FLAGS"
 AUTOPOINT=true LIBTOOLIZE=true \
-    $AUTORECONF --verbose --install --no-recursive -I $m4_base $ACLOCAL_FLAGS \
+    $AUTORECONF --verbose --install $no_recursive -I $m4_base $ACLOCAL_FLAGS \
   || exit 1
 
 # Get some extra files from gnulib, overriding existing files.
-- 
2.10.1 (Apple Git-78)


From 3c19ca08b1cf7aaaae72393073affaa082928ae4 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@redhat.com>
Date: Sat, 5 May 2012 15:51:25 +0200
Subject: [PATCH 006/119] diff: fix a typo that was always disabling the
 same_special_file macro

* src/system.h (same_special_file): Correct cpp guard expression:
s/HAVE_ST_RDEV/HAVE_STRUCT_STAT_ST_RDEV/.  Reported by Eli Zaretskii.
---
 src/system.h | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/system.h b/src/system.h
index 2767b57..eb9ed53 100644
--- a/src/system.h
+++ b/src/system.h
@@ -151,7 +151,7 @@ verify (sizeof (lin) <= sizeof (long int));
 
 /* Do struct stat *S, *T describe the same special file?  */
 #ifndef same_special_file
-# if HAVE_ST_RDEV && defined S_ISBLK && defined S_ISCHR
+# if HAVE_STRUCT_STAT_ST_RDEV && defined S_ISBLK && defined S_ISCHR
 #  define same_special_file(s, t) \
      (((S_ISBLK ((s)->st_mode) && S_ISBLK ((t)->st_mode)) \
        || (S_ISCHR ((s)->st_mode) && S_ISCHR ((t)->st_mode))) \
-- 
2.10.1 (Apple Git-78)


From 5f295d6115179216d13b78a768c97e873f493da9 Mon Sep 17 00:00:00 2001
From: Stefano Lattarini <stefano.lattarini@gmail.com>
Date: Sun, 13 May 2012 19:46:30 -0700
Subject: [PATCH 007/119] build: omit obsolete AM_PROG_CC_STDC macro

The Automake-provided macro 'AM_PROG_CC_STDC' has been superseded by
the Autoconf-provided one 'AC_PROG_CC' since October 2002, and will
be removed in the next major automake version.
* configure.ac (AM_PROG_CC_STDC): Drop it.
---
 configure.ac | 1 -
 1 file changed, 1 deletion(-)

diff --git a/configure.ac b/configure.ac
index 199af3e..cf71ade 100644
--- a/configure.ac
+++ b/configure.ac
@@ -33,7 +33,6 @@ AC_CONFIG_HEADER([lib/config.h:lib/config.hin])
 
 AC_PROG_AWK
 AC_PROG_CC
-AM_PROG_CC_STDC
 AM_MISSING_PROG([HELP2MAN], [help2man])
 AC_PROG_RANLIB
 gl_EARLY
-- 
2.10.1 (Apple Git-78)


From aa7a1de25ab798fc7c45a68df41556b1f9f17fb2 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Mon, 14 May 2012 10:10:21 -0700
Subject: [PATCH 008/119] build: update gnulib submodule to latest

---
 .gitignore            |  1 +
 bootstrap             | 78 ++++++++++++++++++++++++++++++++++++---------------
 gl/lib/regcomp.c.diff | 28 +++++++++---------
 gnulib                |  2 +-
 4 files changed, 73 insertions(+), 36 deletions(-)

diff --git a/.gitignore b/.gitignore
index e1210ea..2252cc2 100644
--- a/.gitignore
+++ b/.gitignore
@@ -10,6 +10,7 @@
 /INSTALL
 /README-release
 /aclocal.m4
+/build-aux
 /config.cache
 /config.log
 /config.status
diff --git a/bootstrap b/bootstrap
index c8ee3cc..1f2f4f4 100755
--- a/bootstrap
+++ b/bootstrap
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Print a version string.
-scriptversion=2012-02-11.09; # UTC
+scriptversion=2012-05-13.09; # UTC
 
 # Bootstrap this package from checked-out sources.
 
@@ -36,6 +36,10 @@ nl='
 LC_ALL=C
 export LC_ALL
 
+# Ensure that CDPATH is not set.  Otherwise, the output from cd
+# would cause trouble in at least one use below.
+(unset CDPATH) >/dev/null 2>&1 && unset CDPATH
+
 local_gl_dir=gl
 
 me=$0
@@ -126,7 +130,7 @@ extract_package_name='
      p
   }
 '
-package=`sed -n "$extract_package_name" configure.ac` || exit
+package=$(sed -n "$extract_package_name" configure.ac) || exit
 gnulib_name=lib$package
 
 build_aux=build-aux
@@ -252,7 +256,7 @@ do
     usage
     exit;;
   --gnulib-srcdir=*)
-    GNULIB_SRCDIR=`expr "X$option" : 'X--gnulib-srcdir=\(.*\)'`;;
+    GNULIB_SRCDIR=${option#--gnulib-srcdir=};;
   --skip-po)
     SKIP_PO=t;;
   --force)
@@ -319,7 +323,7 @@ insert_vc_ignore() {
     # A .gitignore entry that does not start with '/' applies
     # recursively to subdirectories, so prepend '/' to every
     # .gitignore entry.
-    pattern=`echo "$pattern" | sed s,^,/,`;;
+    pattern=$(echo "$pattern" | sed s,^,/,);;
   esac
   insert_sorted_if_absent "$vc_ignore_file" "$pattern"
 }
@@ -423,12 +427,28 @@ check_versions() {
       $use_git || continue
     fi
     # Honor $APP variables ($TAR, $AUTOCONF, etc.)
-    appvar=`echo $app | tr '[a-z]-' '[A-Z]_'`
+    appvar=$(echo $app | LC_ALL=C tr '[a-z]-' '[A-Z]_')
     test "$appvar" = TAR && appvar=AMTAR
     case $appvar in
         GZIP) ;; # Do not use $GZIP:  it contains gzip options.
         *) eval "app=\${$appvar-$app}" ;;
     esac
+
+    # Handle the still-experimental Automake-NG programs specially.
+    # They remain named as the mainstream Automake programs ("automake",
+    # and "aclocal") to avoid gratuitous incompatibilities with
+    # pre-existing usages (by, say, autoreconf, or custom autogen.sh
+    # scripts), but correctly identify themselves (as being part of
+    # "GNU automake-ng") when asked their version.
+    case $app in
+      automake-ng|aclocal-ng)
+        app=${app%-ng}
+        ($app --version | grep '(GNU automake-ng)') >/dev/null 2>&1 || {
+          echo "$me: Error: '$app' not found or not from Automake-NG" >&2
+          ret=1
+          continue
+        } ;;
+    esac
     if [ "$req_ver" = "-" ]; then
       # Merely require app to exist; not all prereq apps are well-behaved
       # so we have to rely on $? rather than get_version.
@@ -492,10 +512,8 @@ esac
 
 # When we can deduce that gnulib-tool will require patch,
 # and when patch is not already listed as a prerequisite, add it, too.
-if test ! -d "$local_gl_dir" \
-    || find "$local_gl_dir" -name '*.diff' -exec false {} +; then
-  :
-else
+if test -d "$local_gl_dir" \
+    && ! find "$local_gl_dir" -name '*.diff' -exec false {} +; then
   case $buildreq in
     *patch*) ;;
     *) buildreq="patch -
@@ -539,7 +557,7 @@ git_modules_config () {
   test -f .gitmodules && git config --file .gitmodules "$@"
 }
 
-gnulib_path=`git_modules_config submodule.gnulib.path`
+gnulib_path=$(git_modules_config submodule.gnulib.path)
 test -z "$gnulib_path" && gnulib_path=gnulib
 
 # Get gnulib files.
@@ -612,10 +630,10 @@ download_po_files() {
   subdir=$1
   domain=$2
   echo "$me: getting translations into $subdir for $domain..."
-  cmd=`printf "$po_download_command_format" "$domain" "$subdir"`
+  cmd=$(printf "$po_download_command_format" "$domain" "$subdir")
   eval "$cmd" && return
   # Fallback to HTTP.
-  cmd=`printf "$po_download_command_format2" "$subdir" "$domain"`
+  cmd=$(printf "$po_download_command_format2" "$subdir" "$domain")
   eval "$cmd"
 }
 
@@ -638,7 +656,7 @@ update_po_files() {
     && ls "$ref_po_dir"/*.po 2>/dev/null |
       sed 's|.*/||; s|\.po$||' > "$po_dir/LINGUAS" || return
 
-  langs=`cd $ref_po_dir && echo *.po|sed 's/\.po//g'`
+  langs=$(cd $ref_po_dir && echo *.po | sed 's/\.po//g')
   test "$langs" = '*' && langs=x
   for po in $langs; do
     case $po in x) continue;; esac
@@ -675,18 +693,18 @@ symlink_to_dir()
 
     # If the destination directory doesn't exist, create it.
     # This is required at least for "lib/uniwidth/cjk.h".
-    dst_dir=`dirname "$dst"`
+    dst_dir=$(dirname "$dst")
     if ! test -d "$dst_dir"; then
       mkdir -p "$dst_dir"
 
       # If we've just created a directory like lib/uniwidth,
       # tell version control system(s) it's ignorable.
       # FIXME: for now, this does only one level
-      parent=`dirname "$dst_dir"`
+      parent=$(dirname "$dst_dir")
       for dot_ig in x $vc_ignore; do
         test $dot_ig = x && continue
         ig=$parent/$dot_ig
-        insert_vc_ignore $ig `echo "$dst_dir"|sed 's,.*/,,'`
+        insert_vc_ignore $ig "${dst_dir##*/}"
       done
     fi
 
@@ -710,10 +728,10 @@ symlink_to_dir()
       # so that broken tools aren't confused into skipping needed builds.  See
       # <http://lists.gnu.org/archive/html/bug-gnulib/2011-05/msg00326.html>.
       test -h "$dst" &&
-      src_ls=`ls -diL "$src" 2>/dev/null` && set $src_ls && src_i=$1 &&
-      dst_ls=`ls -diL "$dst" 2>/dev/null` && set $dst_ls && dst_i=$1 &&
+      src_ls=$(ls -diL "$src" 2>/dev/null) && set $src_ls && src_i=$1 &&
+      dst_ls=$(ls -diL "$dst" 2>/dev/null) && set $dst_ls && dst_i=$1 &&
       test "$src_i" = "$dst_i" &&
-      both_ls=`ls -dt "$src" "$dst"` &&
+      both_ls=$(ls -dt "$src" "$dst") &&
       test "X$both_ls" = "X$dst$nl$src" || {
         dot_dots=
         case $src in
@@ -758,9 +776,15 @@ fi
 # Autoreconf runs aclocal before libtoolize, which causes spurious
 # warnings if the initial aclocal is confused by the libtoolized
 # (or worse out-of-date) macro directory.
+# libtoolize 1.9b added the --install option; but we support back
+# to libtoolize 1.5.22, where the install action was default.
 if test $use_libtool = 1; then
-  echo "running: $LIBTOOLIZE --copy --install"
-  $LIBTOOLIZE --copy --install
+  install=
+  case $($LIBTOOLIZE --help) in
+    *--install*) install=--install ;;
+  esac
+  echo "running: $LIBTOOLIZE $install --copy"
+  $LIBTOOLIZE $install --copy
 fi
 
 version_controlled_file() {
@@ -842,7 +866,7 @@ AUTOPOINT=true LIBTOOLIZE=true \
 for file in $gnulib_extra_files; do
   case $file in
   */INSTALL) dst=INSTALL;;
-  build-aux/*) dst=$build_aux/`expr "$file" : 'build-aux/\(.*\)'`;;
+  build-aux/*) dst=$build_aux/${file#build-aux/};;
   *) dst=$file;;
   esac
   symlink_to_dir "$GNULIB_SRCDIR" $file $dst || exit
@@ -863,6 +887,16 @@ if test $with_gettext = yes; then
     }
   ' po/Makevars.template >po/Makevars || exit 1
 
+  # If the 'gettext' module is in use, grab the latest Makefile.in.in.
+  # If only the 'gettext-h' module is in use, assume autopoint already
+  # put the correct version of this file into place.
+  case $gnulib_modules in
+  *gettext-h*) ;;
+  *gettext*)
+    cp $GNULIB_SRCDIR/build-aux/po/Makefile.in.in po/Makefile.in.in || exit 1
+    ;;
+  esac
+
   if test -d runtime-po; then
     # Similarly for runtime-po/Makevars, but not quite the same.
     rm -f runtime-po/Makevars
diff --git a/gl/lib/regcomp.c.diff b/gl/lib/regcomp.c.diff
index 63fc187..30a6a02 100644
--- a/gl/lib/regcomp.c.diff
+++ b/gl/lib/regcomp.c.diff
@@ -1,8 +1,7 @@
-diff --git a/lib/regcomp.c b/lib/regcomp.c
-index d5968bd..4926676 100644
+diff -pu a/lib/regcomp.c b/lib/regcomp.c
 --- a/lib/regcomp.c
 +++ b/lib/regcomp.c
-@@ -541,7 +541,7 @@ regerror (errcode, preg, errbuf, errbuf_size)
+@@ -539,7 +539,7 @@ regerror (errcode, preg, errbuf, errbuf_
      size_t errbuf_size;
  #else /* size_t might promote */
  size_t
@@ -11,7 +10,7 @@ index d5968bd..4926676 100644
  	  char *_Restrict_ errbuf, size_t errbuf_size)
  #endif
  {
-@@ -1383,7 +1383,7 @@ calc_first (void *extra, bin_tree_t *node)
+@@ -1415,7 +1415,7 @@ calc_first (void *extra, bin_tree_t *nod
 
  /* Pass 2: compute NEXT on the tree.  Preorder visit.  */
  static reg_errcode_t
@@ -20,17 +19,20 @@ index d5968bd..4926676 100644
  {
    switch (node->token.type)
      {
-@@ -2744,7 +2744,8 @@ static reg_errcode_t
+@@ -2798,8 +2798,10 @@ build_range_exp (const reg_syntax_t synt
+ static reg_errcode_t
  internal_function
- build_collating_symbol (bitset_t sbcset,
  # ifdef RE_ENABLE_I18N
--			re_charset_t *mbcset, Idx *coll_sym_alloc,
+-build_collating_symbol (bitset_t sbcset, re_charset_t *mbcset,
+-			Idx *coll_sym_alloc, const unsigned char *name)
++build_collating_symbol (bitset_t sbcset,
 +			re_charset_t *mbcset _UNUSED_PARAMETER_,
 +			Idx *coll_sym_alloc _UNUSED_PARAMETER_,
- # endif
- 			const unsigned char *name)
- {
-@@ -3323,7 +3324,8 @@ parse_bracket_exp (re_string_t *regexp, re_dfa_t *dfa, re_token_t *token,
++			const unsigned char *name)
+ # else /* not RE_ENABLE_I18N */
+ build_collating_symbol (bitset_t sbcset, const unsigned char *name)
+ # endif /* not RE_ENABLE_I18N */
+@@ -3383,7 +3385,8 @@ parse_bracket_exp (re_string_t *regexp,
 
  static reg_errcode_t
  parse_bracket_element (bracket_elem_t *elem, re_string_t *regexp,
@@ -40,7 +42,7 @@ index d5968bd..4926676 100644
  		       reg_syntax_t syntax, bool accept_hyphen)
  {
  #ifdef RE_ENABLE_I18N
-@@ -3410,8 +3412,9 @@ parse_bracket_symbol (bracket_elem_t *elem, re_string_t *regexp,
+@@ -3470,8 +3473,9 @@ parse_bracket_symbol (bracket_elem_t *el
 
  static reg_errcode_t
  #ifdef RE_ENABLE_I18N
@@ -52,7 +54,7 @@ index d5968bd..4926676 100644
  #else /* not RE_ENABLE_I18N */
  build_equiv_class (bitset_t sbcset, const unsigned char *name)
  #endif /* not RE_ENABLE_I18N */
-@@ -3816,7 +3819,7 @@ free_token (re_token_t *node)
+@@ -3877,7 +3881,7 @@ free_token (re_token_t *node)
     and its children. */
 
  static reg_errcode_t
diff --git a/gnulib b/gnulib
index 55b0a0b..258577f 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 55b0a0b1dd267ef48971e4bb84768244ff58b340
+Subproject commit 258577fccc77760d91f8c28286aaa4838ca9cd90
-- 
2.10.1 (Apple Git-78)


From e537e2c86632dca0ba3abe2b6e2d7d7cac189b2c Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 13 May 2012 19:30:56 -0700
Subject: [PATCH 009/119] Use binary mode when testing for binary files.

This reverts the 2006-01-05 change and modernizes to the current API.
Idea suggested by Eli Zaretskii in:
http://lists.gnu.org/archive/html/bug-gnu-utils/2012-05/msg00066.html
* src/cmp.c (main):
* src/diff.c (main, compare_files):
Use set_binary_mode rather than SET_BINARY.
* src/diff.c (compare_files): Omit unnecessary use of O_BINARY.
* src/io.c (sip): Sample unknown files in binary mode, to see
whether they are binary.
(read_files): Read binary files in binary mode.
---
 src/cmp.c  |  2 +-
 src/diff.c |  6 +++---
 src/io.c   | 25 ++++++++++++++++++++-----
 3 files changed, 24 insertions(+), 9 deletions(-)

diff --git a/src/cmp.c b/src/cmp.c
index 1387ec1..32b25e6 100644
--- a/src/cmp.c
+++ b/src/cmp.c
@@ -293,7 +293,7 @@ main (int argc, char **argv)
 	{
 	  file_desc[f1] = STDIN_FILENO;
 	  if (O_BINARY && ! isatty (STDIN_FILENO))
-	    SET_BINARY (STDIN_FILENO);
+	    set_binary_mode (STDIN_FILENO, O_BINARY);
 	}
       else
 	file_desc[f1] = open (file[f1], O_RDONLY | O_BINARY, 0);
diff --git a/src/diff.c b/src/diff.c
index b316afe..79a4726 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -524,7 +524,7 @@ main (int argc, char **argv)
 #if O_BINARY
 	  binary = true;
 	  if (! isatty (STDOUT_FILENO))
-	    SET_BINARY (STDOUT_FILENO);
+	    set_binary_mode (STDOUT_FILENO, O_BINARY);
 #endif
 	  break;
 
@@ -1111,8 +1111,8 @@ compare_files (struct comparison const *parent,
 	  else if (STREQ (cmp.file[f].name, "-"))
 	    {
 	      cmp.file[f].desc = STDIN_FILENO;
-	      if (O_BINARY && binary && ! isatty (STDIN_FILENO))
-		SET_BINARY (STDIN_FILENO);
+	      if (binary && ! isatty (STDIN_FILENO))
+		set_binary_mode (STDIN_FILENO, O_BINARY);
 	      if (fstat (STDIN_FILENO, &cmp.file[f].stat) != 0)
 		cmp.file[f].desc = ERRNO_ENCODE (errno);
 	      else
diff --git a/src/io.c b/src/io.c
index 5a631a5..3abffb5 100644
--- a/src/io.c
+++ b/src/io.c
@@ -19,6 +19,7 @@
    along with this program.  If not, see <http://www.gnu.org/licenses/>.  */
 
 #include "diff.h"
+#include <binary-io.h>
 #include <cmpbuf.h>
 #include <file-type.h>
 #include <xalloc.h>
@@ -111,11 +112,24 @@ sip (struct file_data *current, bool skip_test)
 	{
 	  /* Check first part of file to see if it's a binary file.  */
 
-	  /* FIXME: if O_BINARY, this should revert to text mode
-	     if the file is not binary.  */
-
+	  int prev_mode = set_binary_mode (current->desc, O_BINARY);
+	  off_t buffered;
 	  file_block_read (current, current->bufsize);
-	  return binary_file_p (current->buffer, current->buffered);
+	  buffered = current->buffered;
+
+	  if (prev_mode != O_BINARY)
+	    {
+	      /* Revert to text mode and seek back to the start to reread
+		 the file.  Use relative seek, since file descriptors
+		 like stdin might not start at offset zero.  */
+	      if (lseek (current->desc, - buffered, SEEK_CUR) < 0)
+		pfatal_with_name (current->name);
+	      set_binary_mode (current->desc, prev_mode);
+	      current->buffered = 0;
+	      current->eof = false;
+	    }
+
+	  return binary_file_p (current->buffer, buffered);
 	}
     }
 
@@ -761,7 +775,8 @@ read_files (struct file_data filevec[], bool pretend_binary)
     }
   if (appears_binary)
     {
-      /* FIXME: If O_BINARY, this should set both files to binary mode.  */
+      set_binary_mode (filevec[0].desc, O_BINARY);
+      set_binary_mode (filevec[1].desc, O_BINARY);
       return true;
     }
 
-- 
2.10.1 (Apple Git-78)


From 98985d32063135ab0e584fafb6e9edcf45869ec9 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Mon, 14 May 2012 22:12:21 -0700
Subject: [PATCH 010/119] maint: m4/gnulib-cache.m4 is not under version
 control

This is like what coreutils does, and suppresses 'git status' chatter.
* .gitignore: Add /m4/gnulib-cache.m4.
---
 .gitignore | 1 +
 1 file changed, 1 insertion(+)

diff --git a/.gitignore b/.gitignore
index 2252cc2..7236c0b 100644
--- a/.gitignore
+++ b/.gitignore
@@ -37,6 +37,7 @@
 /lib/unused-parameter.h
 /lib/warn-on-use.h
 /m4/.gitignore
+/m4/gnulib-cache.m4
 /maint.mk
 /po/*.pot
 /po/*.sed
-- 
2.10.1 (Apple Git-78)


From de512b8345de9d501b21a5c1bc446e28d50ebf8c Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Mon, 14 May 2012 22:13:21 -0700
Subject: [PATCH 011/119] maint: update bootstrap from gnulib

* bootstrap: Update from gnulib.
---
 bootstrap | 99 +++++++++++++++++++++++++++++++++++++++++----------------------
 1 file changed, 64 insertions(+), 35 deletions(-)

diff --git a/bootstrap b/bootstrap
index 1f2f4f4..78f335e 100755
--- a/bootstrap
+++ b/bootstrap
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Print a version string.
-scriptversion=2012-05-13.09; # UTC
+scriptversion=2012-05-14.21; # UTC
 
 # Bootstrap this package from checked-out sources.
 
@@ -754,6 +754,22 @@ symlink_to_dir()
   }
 }
 
+version_controlled_file() {
+  parent=$1
+  file=$2
+  if test -d .git; then
+    git rm -n "$file" > /dev/null 2>&1
+  elif test -d .svn; then
+    svn log -r HEAD "$file" > /dev/null 2>&1
+  elif test -d CVS; then
+    grep -F "/${file##*/}/" "$parent/CVS/Entries" 2>/dev/null |
+             grep '^/[^/]*/[0-9]' > /dev/null
+  else
+    echo "$me: no version control for $file?" >&2
+    false
+  fi
+}
+
 # NOTE: we have to be careful to run both autopoint and libtoolize
 # before gnulib-tool, since gnulib-tool is likely to provide newer
 # versions of files "installed" by these two programs.
@@ -766,43 +782,56 @@ with_gettext=yes
 grep '^[	 ]*AM_GNU_GETTEXT_VERSION(' configure.ac >/dev/null || \
     with_gettext=no
 
-if test $with_gettext = yes; then
-  # Released autopoint has the tendency to install macros that have been
-  # obsoleted in current gnulib, so run this before gnulib-tool.
-  echo "$0: $AUTOPOINT --force"
-  $AUTOPOINT --force || exit
-fi
+if test $with_gettext = yes || test $use_libtool = 1; then
 
-# Autoreconf runs aclocal before libtoolize, which causes spurious
-# warnings if the initial aclocal is confused by the libtoolized
-# (or worse out-of-date) macro directory.
-# libtoolize 1.9b added the --install option; but we support back
-# to libtoolize 1.5.22, where the install action was default.
-if test $use_libtool = 1; then
-  install=
-  case $($LIBTOOLIZE --help) in
-    *--install*) install=--install ;;
-  esac
-  echo "running: $LIBTOOLIZE $install --copy"
-  $LIBTOOLIZE $install --copy
-fi
+  tempbase=.bootstrap$$
+  trap "rm -f $tempbase.0 $tempbase.1" 1 2 13 15
 
-version_controlled_file() {
-  dir=$1
-  file=$2
-  found=no
-  if test -d CVS; then
-    grep -F "/$file/" $dir/CVS/Entries 2>/dev/null |
-             grep '^/[^/]*/[0-9]' > /dev/null && found=yes
-  elif test -d .git; then
-    git rm -n "$dir/$file" > /dev/null 2>&1 && found=yes
-  elif test -d .svn; then
-    svn log -r HEAD "$dir/$file" > /dev/null 2>&1 && found=yes
-  else
-    echo "$me: no version control for $dir/$file?" >&2
+  > $tempbase.0 > $tempbase.1 &&
+  find . ! -type d -print | sort > $tempbase.0 || exit
+
+  if test $with_gettext = yes; then
+    # Released autopoint has the tendency to install macros that have been
+    # obsoleted in current gnulib, so run this before gnulib-tool.
+    echo "$0: $AUTOPOINT --force"
+    $AUTOPOINT --force || exit
   fi
-  test $found = yes
-}
+
+  # Autoreconf runs aclocal before libtoolize, which causes spurious
+  # warnings if the initial aclocal is confused by the libtoolized
+  # (or worse out-of-date) macro directory.
+  # libtoolize 1.9b added the --install option; but we support back
+  # to libtoolize 1.5.22, where the install action was default.
+  if test $use_libtool = 1; then
+    install=
+    case $($LIBTOOLIZE --help) in
+      *--install*) install=--install ;;
+    esac
+    echo "running: $LIBTOOLIZE $install --copy"
+    $LIBTOOLIZE $install --copy
+  fi
+
+  set -x
+  find . ! -type d -print | sort >$tempbase.1
+  old_IFS=$IFS
+  IFS=$nl
+  for file in $(comm -13 $tempbase.0 $tempbase.1); do
+    IFS=$old_IFS
+    parent=${file%/*}
+    version_controlled_file "$parent" "$file" || {
+      for dot_ig in x $vc_ignore; do
+        test $dot_ig = x && continue
+        ig=$parent/$dot_ig
+        insert_vc_ignore "$ig" "${file##*/}"
+      done
+    }
+  done
+  IFS=$old_IFS
+  set +x
+
+  rm -f $tempbase.0 $tempbase.1
+  trap - 1 2 13 15
+fi
 
 # Import from gnulib.
 
-- 
2.10.1 (Apple Git-78)


From 3549f733b9cd2c7fd5dd1e4a273151e2da01a00b Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Mon, 14 May 2012 23:07:13 -0700
Subject: [PATCH 012/119] main: port subcommands to mingw

Problem reported by Eli Zaretskii in
<http://lists.gnu.org/archive/html/bug-gnu-utils/2012-05/msg00013.html>.
Approach suggested by Bruno Haible as option (4) in
<http://lists.gnu.org/archive/html/bug-gnu-utils/2012-05/msg00036.html>.
* bootstrap.conf (gnulib_modules): Add system-quote.
* src/diff3.c, src/sdiff.c, src/util.c:
Include <system-quote.h>, not <sh-quote.h>.
* src/diff3.c (read_diff):
* src/sdiff.c (main, edit):
* src/util.c (begin_output):
Use system_quote_argv, for portability to Mingw.
* src/sdiff.c (NUM_SIGS, handler_index_of_SIGINT): Now enum
values, not macros; this is cleaner and avoids a GCC warning if
!HAVE_WORKING_VFORK.
* src/util.c (begin_output) [! HAVE_WORKING_FORK]: Do not use -f,
for consistency with the HAVE_WORKING_FORK code.
---
 bootstrap.conf |  1 +
 src/diff3.c    | 39 +++++++++------------------------------
 src/sdiff.c    | 41 +++++++++++++----------------------------
 src/util.c     | 19 ++++++++++---------
 4 files changed, 33 insertions(+), 67 deletions(-)

diff --git a/bootstrap.conf b/bootstrap.conf
index 55f0837..3954c4d 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -69,6 +69,7 @@ strftime
 strptime
 strtoumax
 sys_wait
+system-quote
 unistd
 unlocked-io
 update-copyright
diff --git a/src/diff3.c b/src/diff3.c
index 3b01071..e234401 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -29,7 +29,7 @@
 #include <file-type.h>
 #include <getopt.h>
 #include <progname.h>
-#include <sh-quote.h>
+#include <system-quote.h>
 #include <version-etc.h>
 #include <xalloc.h>
 #include <xfreopen.h>
@@ -1161,13 +1161,15 @@ read_diff (char const *filea,
   int fd, wstatus, status;
   int werrno = 0;
   struct stat pipestat;
-
-#if HAVE_WORKING_FORK
-
   char const *argv[9];
   char const **ap;
+#if HAVE_WORKING_FORK
   int fds[2];
   pid_t pid;
+#else
+  FILE *fpipe;
+  char *command;
+#endif
 
   ap = argv;
   *ap++ = diff_program;
@@ -1181,6 +1183,8 @@ read_diff (char const *filea,
   *ap++ = fileb;
   *ap = 0;
 
+#if HAVE_WORKING_FORK
+
   if (pipe (fds) != 0)
     perror_with_exit ("pipe");
 
@@ -1210,32 +1214,7 @@ read_diff (char const *filea,
 
 #else
 
-  FILE *fpipe;
-  char const args[] = " --horizon-lines=100 -- ";
-  char *command = xmalloc (shell_quote_length (diff_program)
-			   + sizeof "-a"
-			   + sizeof "--strip-trailing-cr"
-			   + sizeof args - 1
-			   + shell_quote_length (filea) + 1
-			   + shell_quote_length (fileb) + 1);
-  char *p = command;
-  p = shell_quote_copy (p, diff_program);
-  if (text)
-    {
-      strcpy (p, " -a");
-      p += 3;
-    }
-  if (strip_trailing_cr)
-    {
-      strcpy (p, " --strip-trailing-cr");
-      p += 20;
-    }
-  strcpy (p, args);
-  p += sizeof args - 1;
-  p = shell_quote_copy (p, filea);
-  *p++ = ' ';
-  p = shell_quote_copy (p, fileb);
-  *p = 0;
+  command = system_quote_argv (SCI_SYSTEM, (char **) argv);
   errno = 0;
   fpipe = popen (command, "r");
   if (!fpipe)
diff --git a/src/sdiff.c b/src/sdiff.c
index 63b2861..e82ec84 100644
--- a/src/sdiff.c
+++ b/src/sdiff.c
@@ -31,7 +31,7 @@
 #include <file-type.h>
 #include <getopt.h>
 #include <progname.h>
-#include <sh-quote.h>
+#include <system-quote.h>
 #include <version-etc.h>
 #include <xalloc.h>
 
@@ -66,7 +66,6 @@ static void perror_fatal (char const *) __attribute__((noreturn));
 static void trapsigs (void);
 static void untrapsig (int);
 
-#define NUM_SIGS (sizeof sigs / sizeof *sigs)
 static int const sigs[] = {
 #ifdef SIGHUP
        SIGHUP,
@@ -87,8 +86,12 @@ static int const sigs[] = {
        SIGPIPE,
 #endif
        SIGINT
-#define handler_index_of_SIGINT (NUM_SIGS - 1)
 };
+enum
+  {
+    NUM_SIGS = sizeof sigs / sizeof *sigs,
+    handler_index_of_SIGINT = NUM_SIGS - 1
+  };
 
 #if HAVE_SIGACTION
   /* Prefer 'sigaction' if available, since 'signal' can lose signals.  */
@@ -607,19 +610,7 @@ main (int argc, char *argv[])
 
 #if ! HAVE_WORKING_FORK
       {
-	size_t cmdsize = 1;
-	char *p, *command;
-	int i;
-
-	for (i = 0;  diffargv[i];  i++)
-	  cmdsize += shell_quote_length (diffargv[i]) + 1;
-	command = p = xmalloc (cmdsize);
-	for (i = 0;  diffargv[i];  i++)
-	  {
-	    p = shell_quote_copy (p, diffargv[i]);
-	    *p++ = ' ';
-	  }
-	p[-1] = 0;
+	char *command = system_quote_argv (SCI_SYSTEM, (char **) diffargv);
 	errno = 0;
 	diffout = popen (command, "r");
 	if (! diffout)
@@ -1020,16 +1011,17 @@ edit (struct line_filter *left, char const *lname, lin lline, lin llen,
 	    {
 	      int wstatus;
 	      int werrno = 0;
+	      char const *argv[3];
+
 	      ignore_SIGINT = true;
 	      checksigs ();
+	      argv[0] = editor_program;
+	      argv[1] = tmpname;
+	      argv[2] = 0;
 
 	      {
 #if ! HAVE_WORKING_FORK
-		char *command =
-		  xmalloc (shell_quote_length (editor_program)
-			   + 1 + strlen (tmpname) + 1);
-		sprintf (shell_quote_copy (command, editor_program),
-			 " %s", tmpname);
+		char *command = system_quote_argv (SCI_SYSTEM, (char **) argv);
 		wstatus = system (command);
 		if (wstatus == -1)
 		  werrno = errno;
@@ -1040,13 +1032,6 @@ edit (struct line_filter *left, char const *lname, lin lline, lin llen,
 		pid = fork ();
 		if (pid == 0)
 		  {
-		    char const *argv[3];
-		    int i = 0;
-
-		    argv[i++] = editor_program;
-		    argv[i++] = tmpname;
-		    argv[i] = 0;
-
 		    execvp (editor_program, (char **) argv);
 		    _exit (errno == ENOENT ? 127 : 126);
 		  }
diff --git a/src/util.c b/src/util.c
index 2b0bbbf..38b33ef 100644
--- a/src/util.c
+++ b/src/util.c
@@ -21,7 +21,7 @@
 #include "diff.h"
 #include <dirname.h>
 #include <error.h>
-#include <sh-quote.h>
+#include <system-quote.h>
 #include <xalloc.h>
 
 char const pr_program[] = PR_PROGRAM;
@@ -187,9 +187,16 @@ begin_output (void)
 
   if (paginate)
     {
+      char const *argv[4];
+
       if (fflush (stdout) != 0)
 	pfatal_with_name (_("write failed"));
 
+      argv[0] = pr_program;
+      argv[1] = "-h";
+      argv[2] = name;
+      argv[3] = 0;
+
       /* Make OUTFILE a pipe to a subsidiary 'pr'.  */
       {
 #if HAVE_WORKING_FORK
@@ -212,7 +219,7 @@ begin_output (void)
 		close (pipes[0]);
 	      }
 
-	    execl (pr_program, pr_program, "-h", name, (char *) 0);
+	    execv (pr_program, (char **) argv);
 	    _exit (errno == ENOENT ? 127 : 126);
 	  }
 	else
@@ -223,13 +230,7 @@ begin_output (void)
 	      pfatal_with_name ("fdopen");
 	  }
 #else
-	char *command = xmalloc (sizeof pr_program - 1 + 7
-				 + shell_quote_length (name) + 1);
-	char *p;
-	sprintf (command, "%s -f -h ", pr_program);
-	p = command + sizeof pr_program - 1 + 7;
-	p = shell_quote_copy (p, name);
-	*p = 0;
+	char *command = system_quote_argv (SCI_SYSTEM, (char **) argv);
 	errno = 0;
 	outfile = popen (command, "w");
 	if (!outfile)
-- 
2.10.1 (Apple Git-78)


From bca6d67e3f92b9c358e96098d7cd9b841dc16604 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Mon, 14 May 2012 23:24:49 -0700
Subject: [PATCH 013/119] maint: update bootstrap from gnulib

* bootstrap: Update from gnulib.
---
 bootstrap | 6 ++----
 1 file changed, 2 insertions(+), 4 deletions(-)

diff --git a/bootstrap b/bootstrap
index 78f335e..ce37a2c 100755
--- a/bootstrap
+++ b/bootstrap
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Print a version string.
-scriptversion=2012-05-14.21; # UTC
+scriptversion=2012-05-15.06; # UTC
 
 # Bootstrap this package from checked-out sources.
 
@@ -307,7 +307,7 @@ insert_sorted_if_absent() {
   file=$1
   str=$2
   test -f $file || touch $file
-  echo "$str" | sort_patterns - $file | cmp - $file > /dev/null \
+  echo "$str" | sort_patterns - $file | cmp -s - $file > /dev/null \
     || { echo "$str" | sort_patterns - $file > $file.bak \
       && mv $file.bak $file; } \
     || exit 1
@@ -811,7 +811,6 @@ if test $with_gettext = yes || test $use_libtool = 1; then
     $LIBTOOLIZE $install --copy
   fi
 
-  set -x
   find . ! -type d -print | sort >$tempbase.1
   old_IFS=$IFS
   IFS=$nl
@@ -827,7 +826,6 @@ if test $with_gettext = yes || test $use_libtool = 1; then
     }
   done
   IFS=$old_IFS
-  set +x
 
   rm -f $tempbase.0 $tempbase.1
   trap - 1 2 13 15
-- 
2.10.1 (Apple Git-78)


From 1f281b36801627601f8a92f26e8ac6a0a7e36526 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Tue, 15 May 2012 14:01:53 -0700
Subject: [PATCH 014/119] maint: remove ms subdirectory

diffutils is now designed to build with Cygwin or MinGW.
The old DJGPP stuff probably doesn't work anyway.
* Makefile.am (SUBDIRS): Remove ms.
* NEWS: Document this.
* configure.ac (AC_CONFIG_FILES): Remove ms/Makefile.
* ms/Makefile.am, ms/README, ms/config.bat, ms/config.sed:
* ms/config.site: Remove.
---
 Makefile.am    |   2 +-
 NEWS           |   5 ++
 configure.ac   |   1 -
 ms/Makefile.am |  18 ----
 ms/README      |  64 --------------
 ms/config.bat  | 259 ---------------------------------------------------------
 ms/config.sed  |  85 -------------------
 ms/config.site |  78 -----------------
 8 files changed, 6 insertions(+), 506 deletions(-)
 delete mode 100644 ms/Makefile.am
 delete mode 100644 ms/README
 delete mode 100644 ms/config.bat
 delete mode 100644 ms/config.sed
 delete mode 100644 ms/config.site

diff --git a/Makefile.am b/Makefile.am
index 73cac49..dcd4b74 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -18,7 +18,7 @@
 ALL_RECURSIVE_TARGETS =
 
 EXTRA_DIST = bootstrap exgettext ChangeLog-2008 cfg.mk dist-check.mk
-SUBDIRS = lib src tests doc man po ms gnulib-tests
+SUBDIRS = lib src tests doc man po gnulib-tests
 
 ACLOCAL_AMFLAGS = -I m4
 AM_CFLAGS = $(WARN_CFLAGS) $(WERROR_CFLAGS)
diff --git a/NEWS b/NEWS
index 5a69cd7..567fa3d 100644
--- a/NEWS
+++ b/NEWS
@@ -7,6 +7,11 @@ GNU diffutils NEWS                                    -*- outline -*-
   --new-file (-N) and --unidirectional-new-file now allow comparisons to "-".
   A standard input that's closed acts like a nonexistent file.
 
+** Packaging
+
+  diffutils is now designed to build with Cygwin or MinGW rather than DJGPP.
+  The ms subdirectory has been removed.
+
 
 * Noteworthy changes in release 3.2 (2011-09-02) [stable]
 
diff --git a/configure.ac b/configure.ac
index cf71ade..d6e52c4 100644
--- a/configure.ac
+++ b/configure.ac
@@ -168,6 +168,5 @@ AC_CONFIG_FILES([
   gnulib-tests/Makefile
   man/Makefile
   po/Makefile.in
-  ms/Makefile
 ])
 AC_OUTPUT
diff --git a/ms/Makefile.am b/ms/Makefile.am
deleted file mode 100644
index 2296d6a..0000000
--- a/ms/Makefile.am
+++ /dev/null
@@ -1,18 +0,0 @@
-# Makefile for GNU diffutils sources used on Microsoft operating systems.
-
-# Copyright (C) 2001-2002, 2009-2012 Free Software Foundation, Inc.
-
-# This program is free software: you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or
-# (at your option) any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-
-EXTRA_DIST = config.bat config.sed config.site
diff --git a/ms/README b/ms/README
deleted file mode 100644
index 93a9074..0000000
--- a/ms/README
+++ /dev/null
@@ -1,64 +0,0 @@
-This directory contains files required to build GNU Diffutils on
-MS_DOS and MS-Windows using the DJGPP tools.
-
-To build Diffutils, you will need the following packages:
-
-    . the basic DJGPP development kit: GCC, Binutils, and djdevNNN.zip
-    . a DJGPP port of Bash (bsh204b.zip)
-    . GNU Fileutils (fil40b.zip)
-    . GNU Textutils (txt20b.zip)
-    . GNU Sh-utils (shl112b.zip)
-    . GNU Grep (grep24b.zip)
-    . GNU Awk (gwk306b.zip)
-    . GNU Sed (sed302b.zip)
-    . GNU Make (mak3791b.zip)
-
-The package names in parentheses indicate the oldest version which
-should work; newer versions are okay.  All those packages can be found
-on the usual DJGPP sites, in the v2gnu directory.  Please see
-<http://www.delorie.com/djgpp/getting.html> for a list of DJGPP sites.
-
-The source distribution of Diffutils you find on DJGPP sites comes
-preconfigured for the latest officially released version of the DJGPP
-library, and without NLS support.  If that is what you have installed,
-and if you don't need NLS support in Diffutils, you don't need to run
-the configure script; proceed directly to the "make" step below.
-
-If you are building the official GNU distribution, or your library is
-not the latest official release, or if you modified your headers or
-installed optional libraries, or if you want to have NLS support in
-Diffutils, you will have to reconfigure the package.  To this end,
-after unpacking the sources, chdir to the top-level directory created
-by unpacking, and type this command:
-
-   ms\config [nls]
-
-The "nls" option, if given, will configure the package for NLS
-support.
-
-This will run for a while and create the Makefile's and the config.h
-header file.
-
-Next type "make"; this will build the programs.
-
-To install the package, type "make install".
-
-That's it!
-
------
-Copyright (C) 2001, 2009-2012 Free Software Foundation, Inc.
-
-This file is part of GNU DIFF.
-
-This program is free software: you can redistribute it and/or modify
-it under the terms of the GNU General Public License as published by
-the Free Software Foundation, either version 3 of the License, or
-(at your option) any later version.
-
-This program is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
-
-You should have received a copy of the GNU General Public License
-along with this program.  If not, see <http://www.gnu.org/licenses/>.
diff --git a/ms/config.bat b/ms/config.bat
deleted file mode 100644
index 57d5f3f..0000000
--- a/ms/config.bat
+++ /dev/null
@@ -1,259 +0,0 @@
-@echo off
-
-echo Configuring GNU Diffutils for DJGPP v2.x...
-
-Rem Copyright (C) 2001, 2009-2012 Free Software Foundation, Inc.
-
-Rem This program is free software: you can redistribute it and/or modify
-Rem it under the terms of the GNU General Public License as published by
-Rem the Free Software Foundation, either version 3 of the License, or
-Rem (at your option) any later version.
-
-Rem This program is distributed in the hope that it will be useful,
-Rem but WITHOUT ANY WARRANTY; without even the implied warranty of
-Rem MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-Rem GNU General Public License for more details.
-
-Rem You should have received a copy of the GNU General Public License
-Rem along with this program.  If not, see <http://www.gnu.org/licenses/>.
-
-Rem Written by Eli Zaretskii.
-
-
-Rem The small_env tests protect against fixed and too small size
-Rem of the environment in stock DOS shell.
-
-Rem Find out if NLS is wanted or not,
-Rem if dependency-tracking is wanted or not,
-Rem if cache is wanted or not
-Rem and where the sources are.
-set ARGS=
-set NLS=disabled
-if not "%NLS%" == "disabled" goto small_env
-set CACHE=enabled
-if not "%CACHE%" == "enabled" goto small_env
-set DEPENDENCY_TRACKING=disabled
-if not "%DEPENDENCY_TRACKING%" == "disabled" goto small_env
-set XSRC=.
-if not "%XSRC%" == "." goto small_env
-
-Rem Loop over all arguments.
-Rem Special arguments are: NLS, XSRC CACHE and DEPS.
-Rem All other arguments are stored into ARGS.
-:arg_loop
-set SPECIAL_ARG_SEEN=0
-if not "%SPECIAL_ARG_SEEN%" == "0" goto small_env
-if "%1" == "NLS" goto nls_on
-if not "%1" == "nls" goto CacheOpt
-:nls_on
-if "%1" == "nls" set NLS=enabled
-if "%1" == "NLS" set NLS=enabled
-if not "%NLS%" == "enabled" goto small_env
-set SPECIAL_ARG_SEEN=1
-if not "%SPECIAL_ARG_SEEN%" == "1" goto small_env
-shift
-:CacheOpt
-set SPECIAL_ARG_SEEN=0
-if not "%SPECIAL_ARG_SEEN%" == "0" goto small_env
-if "%1" == "no-cache" goto cache_off
-if "%1" == "no-CACHE" goto cache_off
-if not "%1" == "NO-CACHE" goto dependency_opt
-:cache_off
-if "%1" == "no-cache" set CACHE=disabled
-if "%1" == "no-CACHE" set CACHE=disabled
-if "%1" == "NO-CACHE" set CACHE=disabled
-if not "%CACHE%" == "disabled" goto small_env
-set SPECIAL_ARG_SEEN=1
-if not "%SPECIAL_ARG_SEEN%" == "1" goto small_env
-shift
-:dependency_opt
-set SPECIAL_ARG_SEEN=0
-if not "%SPECIAL_ARG_SEEN%" == "0" goto small_env
-if "%1" == "dep" goto dep_off
-if not "%1" == "DEP" goto src_dir_opt
-:dep_off
-if "%1" == "dep" set DEPENDENCY_TRACKING=enabled
-if "%1" == "DEP" set DEPENDENCY_TRACKING=enabled
-if not "%DEPENDENCY_TRACKING%" == "enabled" goto small_env
-set SPECIAL_ARG_SEEN=1
-if not "%SPECIAL_ARG_SEEN%" == "1" goto small_env
-shift
-:src_dir_opt
-set SPECIAL_ARG_SEEN=0
-if not "%SPECIAL_ARG_SEEN%" == "0" goto small_env
-echo %1 | grep -q "/"
-if errorlevel 1 goto collect_arg
-set XSRC=%1
-if not "%XSRC%" == "%1" goto small_env
-set SPECIAL_ARG_SEEN=1
-if not "%SPECIAL_ARG_SEEN%" == "1" goto small_env
-:collect_arg
-if "%SPECIAL_ARG_SEEN%" == "0" set _ARGS=%ARGS% %1
-if "%SPECIAL_ARG_SEEN%" == "0" if not "%_ARGS%" == "%ARGS% %1" goto small_env
-echo %_ARGS% | grep -q "[^ ]"
-if not errorlevel 0 set ARGS=%_ARGS%
-set _ARGS=
-shift
-if not "%1" == "" goto arg_loop
-set SPECIAL_ARG_SEEN=
-
-Rem Create a response file for the configure script.
-echo --srcdir=%XSRC% > arguments
-if "%CACHE%" == "enabled"                echo --config-cache >> arguments
-if "%DEPENDENCY_TRACKING%" == "enabled"  echo --enable-dependency-tracking >> arguments
-if "%DEPENDENCY_TRACKING%" == "disabled" echo --disable-dependency-tracking >> arguments
-if not "%ARGS%" == ""                    echo %ARGS% >> arguments
-set ARGS=
-set CACHE=
-set DEPENDENCY_TRACKING=
-
-if "%XSRC%" == "." goto in_place
-
-:not_in_place
-redir -e /dev/null update %XSRC%/configure.orig ./configure
-test -f ./configure
-if errorlevel 1 update %XSRC%/configure ./configure
-
-:in_place
-Rem Update configuration files
-echo Updating configuration scripts...
-test -f ./configure.orig
-if errorlevel 1 update configure configure.orig
-sed -f %XSRC%/ms/config.sed configure.orig > configure
-if errorlevel 1 goto sed_error
-
-Rem Make sure they have a config.site file
-set CONFIG_SITE=%XSRC%/ms/config.site
-if not "%CONFIG_SITE%" == "%XSRC%/ms/config.site" goto small_env
-
-Rem Make sure crucial file names are not munged by unpacking
-test -f %XSRC%/po/Makefile.in.in
-if not errorlevel 1 mv -f %XSRC%/po/Makefile.in.in %XSRC%/po/Makefile.in-in
-test -f %XSRC%/m4/Makefile.am.in
-if not errorlevel 1 mv -f %XSRC%/m4/Makefile.am.in %XSRC%/m4/Makefile.am-in
-
-Rem This is required because DOS/Windows are case-insensitive
-Rem to file names, and "make install" will do nothing if Make
-Rem finds a file called 'install'.
-if exist INSTALL ren INSTALL INSTALL.txt
-
-Rem Set HOME to a sane default so configure stops complaining.
-if not "%HOME%" == "" goto HostName
-set HOME=%XSRC%/ms
-if not "%HOME%" == "%XSRC%/ms" goto small_env
-echo No HOME found in the environment, using default value
-
-:HostName
-Rem Set HOSTNAME so it shows in config.status
-if not "%HOSTNAME%" == "" goto hostdone
-if "%windir%" == "" goto msdos
-set OS=MS-Windows
-if not "%OS%" == "MS-Windows" goto small_env
-goto haveos
-:msdos
-set OS=MS-DOS
-if not "%OS%" == "MS-DOS" goto small_env
-:haveos
-if not "%USERNAME%" == "" goto haveuname
-if not "%USER%" == "" goto haveuser
-echo No USERNAME and no USER found in the environment, using default values
-set HOSTNAME=Unknown PC
-if not "%HOSTNAME%" == "Unknown PC" goto small_env
-goto userdone
-:haveuser
-set HOSTNAME=%USER%'s PC
-if not "%HOSTNAME%" == "%USER%'s PC" goto small_env
-goto userdone
-:haveuname
-set HOSTNAME=%USERNAME%'s PC
-if not "%HOSTNAME%" == "%USERNAME%'s PC" goto small_env
-:userdone
-set _HOSTNAME=%HOSTNAME%, %OS%
-if not "%_HOSTNAME%" == "%HOSTNAME%, %OS%" goto small_env
-set HOSTNAME=%_HOSTNAME%
-:hostdone
-set _HOSTNAME=
-set OS=
-
-Rem install-sh is required by the configure script but clashes with the
-Rem various Makefile install-foo targets, so we MUST have it before the
-Rem script runs and rename it afterwards
-test -f %XSRC%/install-sh
-if not errorlevel 1 goto no_ren0
-test -f %XSRC%/install-sh.sh
-if not errorlevel 1 mv -f %XSRC%/install-sh.sh %XSRC%/install-sh
-:no_ren0
-
-if "%NLS%" == "disabled" goto without_NLS
-
-:with_NLS
-Rem Check for the needed libraries and binaries.
-test -x /dev/env/DJDIR/bin/msgfmt.exe
-if not errorlevel 0 goto missing_NLS_tools
-test -x /dev/env/DJDIR/bin/xgettext.exe
-if not errorlevel 0 goto missing_NLS_tools
-test -f /dev/env/DJDIR/include/libcharset.h
-if not errorlevel 0 goto missing_NLS_tools
-test -f /dev/env/DJDIR/lib/libcharset.a
-if not errorlevel 0 goto missing_NLS_tools
-test -f /dev/env/DJDIR/include/iconv.h
-if not errorlevel 0 goto missing_NLS_tools
-test -f /dev/env/DJDIR/lib/libiconv.a
-if not errorlevel 0 goto missing_NLS_tools
-test -f /dev/env/DJDIR/include/libintl.h
-if not errorlevel 0 goto missing_NLS_tools
-test -f /dev/env/DJDIR/lib/libintl.a
-if not errorlevel 0 goto missing_NLS_tools
-
-Rem Recreate the files in the %XSRC%/po subdir with our ported tools.
-redir -e /dev/null rm %XSRC%/po/*.gmo
-redir -e /dev/null rm %XSRC%/po/diffutil*.pot
-redir -e /dev/null rm %XSRC%/po/cat-id-tbl.c
-redir -e /dev/null rm %XSRC%/po/stamp-cat-id
-
-Rem Update the arguments file for the configure script.
-Rem We prefer without-included-gettext because libintl.a from gettext package
-Rem is the only one that is guaranteed to have been ported to DJGPP.
-echo --enable-nls --without-included-gettext >> arguments
-goto configure_package
-
-:missing_NLS_tools
-echo Needed libs/tools for NLS not found. Configuring without NLS.
-:without_NLS
-Rem Update the arguments file for the configure script.
-echo --disable-nls >> arguments
-
-:configure_package
-echo Running the ./configure script...
-sh ./configure @arguments
-if errorlevel 1 goto cfg_error
-rm arguments
-echo Done.
-goto End
-
-:sed_error
-echo ./configure script editing failed!
-goto End
-
-:cfg_error
-echo ./configure script exited abnormally!
-goto End
-
-:small_env
-echo Your environment size is too small.  Enlarge it and run me again.
-echo Configuration NOT done!
-
-:End
-test -f %XSRC%/install-sh.sh
-if not errorlevel 1 goto no_ren1
-test -f %XSRC%/install-sh
-if not errorlevel 1 mv -f %XSRC%/install-sh %XSRC%/install-sh.sh
-:no_ren1
-if "%HOME%" == "%XSRC%/ms" set HOME=
-set ARGS=
-set CONFIG_SITE=
-set HOSTNAME=
-set NLS=
-set CACHE=
-set DEPENDENCY_TRACKING=
-set XSRC=
diff --git a/ms/config.sed b/ms/config.sed
deleted file mode 100644
index 0d40421..0000000
--- a/ms/config.sed
+++ /dev/null
@@ -1,85 +0,0 @@
-# Additional editing of Makefiles and of config.status
-
-# Copyright (C) 2001-2002, 2009-2012 Free Software Foundation, Inc.
-
-# This program is free software: you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or
-# (at your option) any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-
-# Written by Eli Zaretskii.
-
-
-/(echo[	 ]*':t/ a\
-# DJGPP specific Makefile changes.\
-  /^aliaspath *	*=/s,:,";",g;t t\
-  /TEXINPUTS=/s,:,";",g;t t\
-  /PATH=/s,:,";",g;t t\
-  s,\\.deps,_deps,g;t t\
-  s,\\.new\\.,_new.,g;t t\
-  s,\\.old\\.,_old.,g;t t\
-  s,\\.tab\\.,_tab.,g;t t\
-  s,Makefile\\.in\\.in,Makefile.in-in,g;t t\
-  s,Makefile\\.am\\.in,Makefile.am-in,g;t t\
-  /^install-info-am:/,/^$/ {\
-    /@list=.\\\$(INFO_DEPS)\[^ \]/s,DEPS),& diff.i,\
-    s,\\(\\\$\\\$d/\\\$\\\$file-\\[0-9\\]\\[0-9\\]\\)\\(\[^ \]\\),\\1 \\$\\$d/\\$\\$file[0-9] \\$\\$d/\\$\\$file[0-9][0-9]\\2,\
-    s,\\( \\\$\\\$file-\\[0-9\\]\\[0-9\\]\\)\\(\[^ \]\\),\\1 \\$\\$file[0-9] \\$\\$file[0-9][0-9]\\2,\
-  }\
-  /^uninstall-info-am:/,/^$/ {\
-    /@list=.\\\$(INFO_DEPS)\[^ \]/s,DEPS),& diff.i,\
-    s,\\(file-\\[0-9\\]\\[0-9\\]\\)\\(\[^ \]\\),\\1 \\$\\$file[0-9] \\$\\$file[0-9][0-9]\\2,\
-  }
-
-# Makefile.in.in is renamed to Makefile.in-in.
-/^ac_config_files=/,/_ACEOF/ {
-  s|po/Makefile\.in|&:po/Makefile.in-in|
-}
-/CONFIG_FILES=/ s|po/Makefile\.in|&:po/Makefile.in-in|2
-
-# We always use _deps instead of .deps, because the latter is an
-# invalid name on 8+3 MS-DOS file system.  This makes the generated
-# Makefiles good for every DJGPP installation, not only the one
-# where the package was configured (which could happen to be a
-# Windows box, where leading dots in file names are allowed).
-s,\.deps,_deps,g
-
-# The following two items are changes needed for configuring
-# and compiling across partitions.
-# The given srcdir value is always translated from the
-# "x:" syntax into "/dev/x" syntax while we run configure.
-/^[	 ]*-srcdir=\*.*$/ a\
-    ac_optarg=`echo "$ac_optarg" | sed "s,^\\([A-Za-z]\\):,/dev/\\1,"`
-/set X `ls -Lt \$srcdir/ i\
-   if `echo $srcdir | grep "^/dev/" - > /dev/null`; then\
-     srcdir=`echo "$srcdir" | sed -e "s%^/dev/%%" -e "s%/%:/%"`\
-   fi
-
-# Autoconf 2.52e generated configure scripts write absolute paths into
-# Makefiles, making them useless for DJGPP installations other than the
-# one for which the package has been configured.
-/MISSING=/,/^$/ {
-  /^fi$/ a\
-am_missing_run=`echo "$am_missing_run" | sed 's%/dev.*/diffutil.*[-.]2.*[7-9].*[0-9]%${top_srcdir}%'`
-}
-/^install_sh=/a\
-install_sh=`echo "$install_sh" | sed 's%/dev.*/diffutil.*[-.]2.*[7-9].*[0-9]%${top_srcdir}%'`
-
-
-# The following makes sure we are not going to remove a directory
-# which is the cwd on its drive (DOS doesn't allow to remove such
-# a directory).  The trick is to chdir to the root directory on
-# temp directory's drive.
-/^ *trap 'exit_status=\$\?; rm -rf/s%rm -rf%cd $tmp; cd /; &%
-
-# AC_CONFIG_LINKS fails if the source and destination are on
-# different file systems and symlinks don't work.
-/^    ln \$srcdir/s%||%|| cp -pf $srcdir/$ac_source $ac_dest ||%
diff --git a/ms/config.site b/ms/config.site
deleted file mode 100644
index c863616..0000000
--- a/ms/config.site
+++ /dev/null
@@ -1,78 +0,0 @@
-#! /bin/sh
-# Site defaults for the DJGPP configuration
-
-# Copyright (C) 2001, 2009-2012 Free Software Foundation, Inc.
-
-# This program is free software: you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or
-# (at your option) any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-
-# Written by Eli Zaretskii.
-
-
-# These two variables are required, otherwise looking for
-# programs along the PATH will not work.
-PATH_SEPARATOR=:
-PATH_EXPAND=y
-
-# This is required in for "test -f foo" to find foo.exe.
-export TEST_FINDS_EXE=y
-
-# The root of the DJGPP tree serves as the default prefix
-# for all paths that are hardcoded in the binaries.
-# When installing the installation prefix must be supplied.
-test "x$prefix" = xNONE && prefix='/dev/env/DJDIR'
-
-# This is required for config.status script to be run, since
-# ./configure runs it by invoking ${CONFIG_SHELL-/bin/sh}
-# CONFIG_SHELL=${CONFIG_SHELL='sh'}
-
-# These are set here so the generated Makefile's will be good
-# for every DJGPP installation, not only the one where the
-# package was configured.
-# $INSTALL must be an absolute path name, otherwise config.status
-# will try to prepend ./ and ../ to it when it goes into subdirs.
-INSTALL=${INSTALL='/dev/env/DJDIR/bin/ginstall -c'}
-RANLIB=${RANLIB='ranlib'}
-GMSGFMT=${GMSGFMT='/dev/env/DJDIR/bin/msgfmt'}
-MSGFMT=${MSGFMT='/dev/env/DJDIR/bin/msgfmt'}
-XGETTEXT=${XGETTEXT='/dev/env/DJDIR/bin/xgettext'}
-
-# Sane defaults for standard programs compiled into the package that
-# we are about to build.  Use .exe extension so that library functions
-# invoking these programs will provide a better diagnostics when a
-# program is not found: the library won't need to call the stock DOS
-# shell, which always returns a zero status, even if it doesn't find
-# the program.
-ac_cv_path_PR_PROGRAM=${PR_PROGRAM='/dev/env/DJDIR/bin/pr.exe'}
-
-# Sane defaults for standard programs used by the build process.
-# We force the values of these variables so that the resultant
-# Makefile's will work on any DJGPP platform, not only on the
-# machine where the package was configured.
-ac_cv_prog_AWK=${AWK='gawk'}
-ac_cv_prog_INTLBISON=${INTLBISON='bison'}
-ac_cv_prog_CC=${CC='gcc'}
-
-# These are set here so the generated libtool/Makefile's will
-# be good for every DJGPP installation, not only the one where
-# the package was configured.
-NM=${NM='nm'}
-LD=${LD='ld'}
-MAKEINFO=${MAKEINFO='makeinfo'}
-
-# Force the test for 'ln -s' to report 'cp -pf'.
-ac_cv_prog_LN_S='cp -pf'
-
-# We have 'fork', but it always fails.  Don't trust Autoconf to be
-# smart enough to detect that...
-ac_cv_func_fork=no
-- 
2.10.1 (Apple Git-78)


From 5cb0eea638e5db4de66bcf99d9ce4f6fd974e04e Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@redhat.com>
Date: Tue, 28 Aug 2012 10:58:48 +0200
Subject: [PATCH 015/119] maint: avoid new syntax-check failure due to @xref
 use

* doc/diffutils.texi: Change several "; @xref{..." to ".  @xref{...",
since @xref should start a sentence.
---
 doc/diffutils.texi | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index d4a68f8..2908120 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -821,7 +821,7 @@ The fractional seconds are omitted on hosts that do not support
 fractional time stamps.
 
 You can change the header's content with the
-@option{--label=@var{label}} option; see @xref{Alternate Names}.
+@option{--label=@var{label}} option. @xref{Alternate Names}.
 
 Next come one or more hunks of differences; each hunk shows one area
 where the files differ.  Unified format hunks look like this:
@@ -993,7 +993,7 @@ The corresponding lines differ, and only the second line is incomplete.
 @end table
 
 Normally, an output line is incomplete if and only if the lines that it
-contains are incomplete; @xref{Incomplete Lines}.  However, when an
+contains are incomplete.  @xref{Incomplete Lines}.  However, when an
 output line represents two differing lines, one might be incomplete
 while the other is not.  In this case, the output line is complete,
 but its the gutter is marked @samp{\} if the first line is incomplete,
@@ -1708,7 +1708,7 @@ might contain duplicate or otherwise incorrect code.
 
 The @command{patch} @option{-D @var{name}} option behaves like
 the @command{diff} @option{-D @var{name}} option, except it operates on
-a file and a diff to produce a merged file; @xref{patch Options}.
+a file and a diff to produce a merged file.  @xref{patch Options}.
 
 @node Incomplete Lines
 @chapter Incomplete Lines
@@ -1727,10 +1727,10 @@ line by a following line that starts with @samp{\}.  However, the
 @acronym{RCS} format (@pxref{RCS}) outputs the incomplete line as-is,
 without any trailing newline or following line.  The side by side
 format normally represents incomplete lines as-is, but in some cases
-uses a @samp{\} or @samp{/} gutter marker; @xref{Side by Side}.  The
+uses a @samp{\} or @samp{/} gutter marker.  @xref{Side by Side}.  The
 if-then-else line format preserves a line's incompleteness with
-@samp{%L}, and discards the newline with @samp{%l}; @xref{Line
-Formats}.  Finally, with the @command{ed} and forward @command{ed}
+@samp{%L}, and discards the newline with @samp{%l}.  @xref{Line Formats}.
+Finally, with the @command{ed} and forward @command{ed}
 output formats (@pxref{Output Formats}) @command{diff} cannot
 represent an incomplete line, so it pretends there was a newline and
 reports an error.
-- 
2.10.1 (Apple Git-78)


From 6c273a4db62c4f7b0667545c31a5ad24b913598a Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@redhat.com>
Date: Tue, 28 Aug 2012 08:47:27 +0200
Subject: [PATCH 016/119] build: update gnulib, bootstrap and init.sh to latest

---
 bootstrap     | 118 ++++++++++++++++++++++++++++++++++------------------------
 gnulib        |   2 +-
 tests/init.sh |  18 +++++++--
 3 files changed, 84 insertions(+), 54 deletions(-)

diff --git a/bootstrap b/bootstrap
index ce37a2c..e3e270b 100755
--- a/bootstrap
+++ b/bootstrap
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Print a version string.
-scriptversion=2012-05-15.06; # UTC
+scriptversion=2012-07-19.14; # UTC
 
 # Bootstrap this package from checked-out sources.
 
@@ -77,6 +77,33 @@ Running without arguments will suffice in most cases.
 EOF
 }
 
+# warnf_ FORMAT-STRING ARG1...
+warnf_ ()
+{
+  warnf_format_=$1
+  shift
+  nl='
+'
+  case $* in
+    *$nl*) me_=$(printf "$me"|tr "$nl|" '??')
+       printf "$warnf_format_" "$@" | sed "s|^|$me_: |" ;;
+    *) printf "$me: $warnf_format_" "$@" ;;
+  esac >&2
+}
+
+# warn_ WORD1...
+warn_ ()
+{
+  # If IFS does not start with ' ', set it and emit the warning in a subshell.
+  case $IFS in
+    ' '*) warnf_ '%s\n' "$*";;
+    *)    (IFS=' '; warn_ "$@");;
+  esac
+}
+
+# die WORD1...
+die() { warn_ "$@"; exit 1; }
+
 # Configuration.
 
 # Name of the Makefile.am
@@ -130,7 +157,8 @@ extract_package_name='
      p
   }
 '
-package=$(sed -n "$extract_package_name" configure.ac) || exit
+package=$(sed -n "$extract_package_name" configure.ac) \
+  || die 'cannot find package name in configure.ac'
 gnulib_name=lib$package
 
 build_aux=build-aux
@@ -186,6 +214,8 @@ use_git=true
 # otherwise find the first of the NAMES that can be run (i.e.,
 # supports --version).  If found, set ENVVAR to the program name,
 # die otherwise.
+#
+# FIXME: code duplication, see also gnu-web-doc-update.
 find_tool ()
 {
   find_tool_envvar=$1
@@ -203,19 +233,15 @@ find_tool ()
   else
     find_tool_error_prefix="\$$find_tool_envvar: "
   fi
-  if test x"$find_tool_res" = x; then
-    echo >&2 "$me: one of these is required: $find_tool_names"
-    exit 1
-  fi
-  ($find_tool_res --version </dev/null) >/dev/null 2>&1 || {
-    echo >&2 "$me: ${find_tool_error_prefix}cannot run $find_tool_res --version"
-    exit 1
-  }
+  test x"$find_tool_res" != x \
+    || die "one of these is required: $find_tool_names"
+  ($find_tool_res --version </dev/null) >/dev/null 2>&1 \
+    || die "${find_tool_error_prefix}cannot run $find_tool_res --version"
   eval "$find_tool_envvar=\$find_tool_res"
   eval "export $find_tool_envvar"
 }
 
-# Find sha1sum, named gsha1sum on MacPorts, and shasum on MacOS 10.6.
+# Find sha1sum, named gsha1sum on MacPorts, and shasum on Mac OS X 10.6.
 find_tool SHA1SUM sha1sum gsha1sum shasum
 
 # Override the default configuration, if necessary.
@@ -230,7 +256,6 @@ esac
 test -z "${gnulib_extra_files}" && \
   gnulib_extra_files="
         $build_aux/install-sh
-        $build_aux/missing
         $build_aux/mdate-sh
         $build_aux/texinfo.tex
         $build_aux/depcomp
@@ -270,21 +295,15 @@ do
   --no-git)
     use_git=false;;
   *)
-    echo >&2 "$0: $option: unknown option"
-    exit 1;;
+    die "$option: unknown option";;
   esac
 done
 
-if $use_git || test -d "$GNULIB_SRCDIR"; then
-  :
-else
-  echo "$0: Error: --no-git requires --gnulib-srcdir" >&2
-  exit 1
-fi
+$use_git || test -d "$GNULIB_SRCDIR" \
+  || die "Error: --no-git requires --gnulib-srcdir"
 
 if test -n "$checkout_only_file" && test ! -r "$checkout_only_file"; then
-  echo "$0: Bootstrapping from a non-checked-out distribution is risky." >&2
-  exit 1
+  die "Bootstrapping from a non-checked-out distribution is risky."
 fi
 
 # Ensure that lines starting with ! sort last, per gitignore conventions
@@ -310,7 +329,7 @@ insert_sorted_if_absent() {
   echo "$str" | sort_patterns - $file | cmp -s - $file > /dev/null \
     || { echo "$str" | sort_patterns - $file > $file.bak \
       && mv $file.bak $file; } \
-    || exit 1
+    || die "insert_sorted_if_absent $file $str: failed"
 }
 
 # Adjust $PATTERN for $VC_IGNORE_FILE and insert it with
@@ -334,11 +353,8 @@ grep '^[	 ]*AC_CONFIG_AUX_DIR(\['"$build_aux"'\])' configure.ac \
     >/dev/null && found_aux_dir=yes
 grep '^[	 ]*AC_CONFIG_AUX_DIR('"$build_aux"')' configure.ac \
     >/dev/null && found_aux_dir=yes
-if test $found_aux_dir = no; then
-  echo "$0: expected line not found in configure.ac. Add the following:" >&2
-  echo "  AC_CONFIG_AUX_DIR([$build_aux])" >&2
-  exit 1
-fi
+test $found_aux_dir = yes \
+  || die "configure.ac lacks 'AC_CONFIG_AUX_DIR([$build_aux])'; add it"
 
 # If $build_aux doesn't exist, create it now, otherwise some bits
 # below will malfunction.  If creating it, also mark it as ignored.
@@ -444,7 +460,7 @@ check_versions() {
       automake-ng|aclocal-ng)
         app=${app%-ng}
         ($app --version | grep '(GNU automake-ng)') >/dev/null 2>&1 || {
-          echo "$me: Error: '$app' not found or not from Automake-NG" >&2
+          warn_ "Error: '$app' not found or not from Automake-NG"
           ret=1
           continue
         } ;;
@@ -454,20 +470,21 @@ check_versions() {
       # so we have to rely on $? rather than get_version.
       $app --version >/dev/null 2>&1
       if [ 126 -le $? ]; then
-        echo "$me: Error: '$app' not found" >&2
+        warn_ "Error: '$app' not found"
         ret=1
       fi
     else
       # Require app to produce a new enough version string.
       inst_ver=$(get_version $app)
       if [ ! "$inst_ver" ]; then
-        echo "$me: Error: '$app' not found" >&2
+        warn_ "Error: '$app' not found"
         ret=1
       else
         latest_ver=$(sort_ver $req_ver $inst_ver | cut -d' ' -f2)
         if [ ! "$latest_ver" = "$inst_ver" ]; then
-          echo "$me: Error: '$app' version == $inst_ver is too old" >&2
-          echo "       '$app' version >= $req_ver is required" >&2
+          warnf_ '%s\n'                                        \
+              "Error: '$app' version == $inst_ver is too old"  \
+              "       '$app' version >= $req_ver is required"
           ret=1
         fi
       fi
@@ -524,11 +541,10 @@ fi
 if ! printf "$buildreq" | check_versions; then
   echo >&2
   if test -f README-prereq; then
-    echo "$0: See README-prereq for how to get the prerequisite programs" >&2
+    die "See README-prereq for how to get the prerequisite programs"
   else
-    echo "$0: Please install the prerequisite programs" >&2
+    die "Please install the prerequisite programs"
   fi
-  exit 1
 fi
 
 echo "$0: Bootstrapping from checked-out $package sources..."
@@ -739,11 +755,10 @@ symlink_to_dir()
         *)
           case /$dst/ in
           *//* | */../* | */./* | /*/*/*/*/*/)
-             echo >&2 "$me: invalid symlink calculation: $src -> $dst"
-             exit 1;;
-          /*/*/*/*/)	dot_dots=../../../;;
-          /*/*/*/)	dot_dots=../../;;
-          /*/*/)	dot_dots=../;;
+             die "invalid symlink calculation: $src -> $dst";;
+          /*/*/*/*/)    dot_dots=../../../;;
+          /*/*/*/)      dot_dots=../../;;
+          /*/*/)        dot_dots=../;;
           esac;;
         esac
 
@@ -765,7 +780,7 @@ version_controlled_file() {
     grep -F "/${file##*/}/" "$parent/CVS/Entries" 2>/dev/null |
              grep '^/[^/]*/[0-9]' > /dev/null
   else
-    echo "$me: no version control for $file?" >&2
+    warn_ "no version control for $file?"
     false
   fi
 }
@@ -855,11 +870,12 @@ echo "$0: $gnulib_tool $gnulib_tool_options --import ..."
 $gnulib_tool $gnulib_tool_options --import $gnulib_modules &&
 
 for file in $gnulib_files; do
-  symlink_to_dir "$GNULIB_SRCDIR" $file || exit
+  symlink_to_dir "$GNULIB_SRCDIR" $file \
+    || die "failed to symlink $file"
 done
 
 bootstrap_post_import_hook \
-  || { echo >&2 "$me: bootstrap_post_import_hook failed"; exit 1; }
+  || die "bootstrap_post_import_hook failed"
 
 # Remove any dangling symlink matching "*.m4" or "*.[ch]" in some
 # gnulib-populated directories.  Such .m4 files would cause aclocal to fail.
@@ -887,7 +903,7 @@ echo "running: AUTOPOINT=true LIBTOOLIZE=true " \
     "$AUTORECONF --verbose --install $no_recursive -I $m4_base $ACLOCAL_FLAGS"
 AUTOPOINT=true LIBTOOLIZE=true \
     $AUTORECONF --verbose --install $no_recursive -I $m4_base $ACLOCAL_FLAGS \
-  || exit 1
+  || die "autoreconf failed"
 
 # Get some extra files from gnulib, overriding existing files.
 for file in $gnulib_extra_files; do
@@ -896,7 +912,8 @@ for file in $gnulib_extra_files; do
   build-aux/*) dst=$build_aux/${file#build-aux/};;
   *) dst=$file;;
   esac
-  symlink_to_dir "$GNULIB_SRCDIR" $file $dst || exit
+  symlink_to_dir "$GNULIB_SRCDIR" $file $dst \
+    || die "failed to symlink $file"
 done
 
 if test $with_gettext = yes; then
@@ -912,7 +929,8 @@ if test $with_gettext = yes; then
       a\
           '"$XGETTEXT_OPTIONS"' $${end_of_xgettext_options+}
     }
-  ' po/Makevars.template >po/Makevars || exit 1
+  ' po/Makevars.template >po/Makevars \
+    || die 'cannot generate po/Makevars'
 
   # If the 'gettext' module is in use, grab the latest Makefile.in.in.
   # If only the 'gettext-h' module is in use, assume autopoint already
@@ -920,7 +938,8 @@ if test $with_gettext = yes; then
   case $gnulib_modules in
   *gettext-h*) ;;
   *gettext*)
-    cp $GNULIB_SRCDIR/build-aux/po/Makefile.in.in po/Makefile.in.in || exit 1
+    cp $GNULIB_SRCDIR/build-aux/po/Makefile.in.in po/Makefile.in.in \
+      || die "cannot create po/Makefile.in.in"
     ;;
   esac
 
@@ -936,7 +955,8 @@ if test $with_gettext = yes; then
         a\
             '"$XGETTEXT_OPTIONS_RUNTIME"' $${end_of_xgettext_options+}
       }
-    ' po/Makevars.template >runtime-po/Makevars || exit 1
+    ' po/Makevars.template >runtime-po/Makevars \
+    || die 'cannot generate runtime-po/Makevars'
 
     # Copy identical files from po to runtime-po.
     (cd po && cp -p Makefile.in.in *-quot *.header *.sed *.sin ../runtime-po)
diff --git a/gnulib b/gnulib
index 258577f..68f693f 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 258577fccc77760d91f8c28286aaa4838ca9cd90
+Subproject commit 68f693ff1db33bf24695f0f42c62e7801966fd06
diff --git a/tests/init.sh b/tests/init.sh
index 5985552..5f6e638 100644
--- a/tests/init.sh
+++ b/tests/init.sh
@@ -207,6 +207,14 @@ else
   fi
 fi
 
+# If this is bash, turn off all aliases.
+test -n "$BASH_VERSION" && unalias -a
+
+# Note that when supporting $EXEEXT (transparently mapping from PROG_NAME to
+# PROG_NAME.exe), we want to support hyphen-containing names like test-acos.
+# That is part of the shell-selection test above.  Why use aliases rather
+# than functions?  Because support for hyphen-containing aliases is more
+# widespread than that for hyphen-containing function names.
 test -n "$EXEEXT" && shopt -s expand_aliases
 
 # Enable glibc's malloc-perturbing option.
@@ -255,7 +263,10 @@ compare_dev_null_ ()
   return 2
 }
 
-if diff_out_=`exec 2>/dev/null; diff -u "$0" "$0" < /dev/null`; then
+if diff_out_=`exec 2>/dev/null; diff -u "$0" "$0" < /dev/null` \
+   && diff -u Makefile "$0" 2>/dev/null | grep '^[+]#!' >/dev/null; then
+  # diff accepts the -u option and does not (like AIX 7 'diff') produce an
+  # extra space on column 1 of every content line.
   if test -z "$diff_out_"; then
     compare_ () { diff -u "$@"; }
   else
@@ -400,8 +411,7 @@ path_prepend_ ()
     case $path_dir_ in
       '') fail_ "invalid path dir: '$1'";;
       /*) abs_path_dir_=$path_dir_;;
-      *) abs_path_dir_=`cd "$initial_cwd_/$path_dir_" && echo "$PWD"` \
-           || fail_ "invalid path dir: $path_dir_";;
+      *) abs_path_dir_=$initial_cwd_/$path_dir_;;
     esac
     case $abs_path_dir_ in
       *:*) fail_ "invalid path dir: '$abs_path_dir_'";;
@@ -437,7 +447,7 @@ setup_ ()
   pfx_=`testdir_prefix_`
   test_dir_=`mktempd_ "$initial_cwd_" "$pfx_-$ME_.XXXX"` \
     || fail_ "failed to create temporary directory in $initial_cwd_"
-  cd "$test_dir_"
+  cd "$test_dir_" || fail_ "failed to cd to temporary directory"
 
   # As autoconf-generated configure scripts do, ensure that IFS
   # is defined initially, so that saving and restoring $IFS works.
-- 
2.10.1 (Apple Git-78)


From f6ac439e484731a8a910bcd91e45039a3fa39c59 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@redhat.com>
Date: Tue, 28 Aug 2012 09:39:53 +0200
Subject: [PATCH 017/119] diff: avoid possible longjmp-triggered misbehavior

* src/dir.c (find_dir_file_pathname): gcc 4.8.0 20120825 reported
that a local variable's value might be clobbered.  Declare "match"
to be volatile.
---
 src/dir.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/dir.c b/src/dir.c
index 57134c7..a2f6bba 100644
--- a/src/dir.c
+++ b/src/dir.c
@@ -324,7 +324,7 @@ char *
 find_dir_file_pathname (char const *dir, char const *file)
 {
   char *val;
-  char const *match = file;
+  char const *volatile match = file;
   struct dirdata dirdata;
   dirdata.names = NULL;
   dirdata.data = NULL;
-- 
2.10.1 (Apple Git-78)


From baeaa83e31da3a1a36d2a1f76140b67ff76859fe Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Thu, 30 Aug 2012 07:52:22 -0700
Subject: [PATCH 018/119] diff: silence GCC warning instead of slowing down

* src/dir.c (find_dir_file_pathname): Use 'IF_LINT (volatile)' to
silence the gcc warning, rather than using 'volatile', as the
warning appears to be bogus.
---
 src/dir.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/dir.c b/src/dir.c
index a2f6bba..530807e 100644
--- a/src/dir.c
+++ b/src/dir.c
@@ -323,8 +323,13 @@ dir_loop (struct comparison const *cmp, int i)
 char *
 find_dir_file_pathname (char const *dir, char const *file)
 {
+  /* The 'IF_LINT (volatile)' works around what appears to be a bug in
+     gcc 4.8.0 20120825; see
+     <http://lists.gnu.org/archive/html/bug-diffutils/2012-08/msg00007.html>.
+     */
+  char const * IF_LINT (volatile) match = file;
+
   char *val;
-  char const *volatile match = file;
   struct dirdata dirdata;
   dirdata.names = NULL;
   dirdata.data = NULL;
-- 
2.10.1 (Apple Git-78)


From e17295dc5529b252c269f12e081184bbde42d575 Mon Sep 17 00:00:00 2001
From: Andreas Gruenbacher <agruen@gnu.org>
Date: Tue, 14 Aug 2012 00:30:46 +0200
Subject: [PATCH 019/119] diff: encode file names with special characters

* src/util.c (c_escape_char): New function.
(c_escape): New function.
(begin_output): Escape file names when needed.
* src/context.c (print_context_header): New names parameter.
(print_context_label): New name parameter.
* src/diff.h (print_context_header): Change prototype.
* tests/filename-quoting: New file.
* NEWS: Document this change.
---
 NEWS                   |   5 +++
 src/context.c          |  13 ++++---
 src/diff.h             |   2 +-
 src/util.c             | 101 ++++++++++++++++++++++++++++++++++++++++++++++---
 tests/Makefile.am      |   3 +-
 tests/filename-quoting |  61 +++++++++++++++++++++++++++++
 6 files changed, 172 insertions(+), 13 deletions(-)
 create mode 100755 tests/filename-quoting

diff --git a/NEWS b/NEWS
index 567fa3d..ce0d8c2 100644
--- a/NEWS
+++ b/NEWS
@@ -7,6 +7,11 @@ GNU diffutils NEWS                                    -*- outline -*-
   --new-file (-N) and --unidirectional-new-file now allow comparisons to "-".
   A standard input that's closed acts like a nonexistent file.
 
+  A file name containing spaces, double quotes, backslashes or control
+  characters is now encoded in a diff header as a double-quoted C string
+  literal.  The escape sequences \\, \", \a, \b, \f, \n, \r, \t, \v and
+  \ooo (a three-digit octal number between 0 and 255) are used.
+
 ** Packaging
 
   diffutils is now designed to build with Cygwin or MinGW rather than DJGPP.
diff --git a/src/context.c b/src/context.c
index b73d5c3..53aa203 100644
--- a/src/context.c
+++ b/src/context.c
@@ -40,6 +40,7 @@ static lin find_function_last_match;
 static void
 print_context_label (char const *mark,
 		     struct file_data *inf,
+		     char const *name,
 		     char const *label)
 {
   if (label)
@@ -70,24 +71,24 @@ print_context_label (char const *mark,
 	      sprintf (buf, "%"PRIuMAX".%.9d", sec, nsec);
 	    }
 	}
-      fprintf (outfile, "%s %s\t%s\n", mark, inf->name, buf);
+      fprintf (outfile, "%s %s\t%s\n", mark, name, buf);
     }
 }
 
 /* Print a header for a context diff, with the file names and dates.  */
 
 void
-print_context_header (struct file_data inf[], bool unidiff)
+print_context_header (struct file_data inf[], char const *const *names, bool unidiff)
 {
   if (unidiff)
     {
-      print_context_label ("---", &inf[0], file_label[0]);
-      print_context_label ("+++", &inf[1], file_label[1]);
+      print_context_label ("---", &inf[0], names[0], file_label[0]);
+      print_context_label ("+++", &inf[1], names[1], file_label[1]);
     }
   else
     {
-      print_context_label ("***", &inf[0], file_label[0]);
-      print_context_label ("---", &inf[1], file_label[1]);
+      print_context_label ("***", &inf[0], names[0], file_label[0]);
+      print_context_label ("---", &inf[1], names[1], file_label[1]);
     }
 }
 
diff --git a/src/diff.h b/src/diff.h
index 4b6595c..212a8d0 100644
--- a/src/diff.h
+++ b/src/diff.h
@@ -332,7 +332,7 @@ XTERN FILE *outfile;
 extern int diff_2_files (struct comparison *);
 
 /* context.c */
-extern void print_context_header (struct file_data[], bool);
+extern void print_context_header (struct file_data[], char const * const *, bool);
 extern void print_context_script (struct change *, bool);
 
 /* dir.c */
diff --git a/src/util.c b/src/util.c
index 38b33ef..868b7e8 100644
--- a/src/util.c
+++ b/src/util.c
@@ -166,24 +166,110 @@ setup_output (char const *name0, char const *name1, bool recursive)
 static pid_t pr_pid;
 #endif
 
+static char c_escape_char (char c)
+{
+  switch (c) {
+    case '\a': return 'a';
+    case '\b': return 'b';
+    case '\t': return 't';
+    case '\n': return 'n';
+    case '\v': return 'v';
+    case '\f': return 'f';
+    case '\r': return 'r';
+    case '"': return '"';
+    case '\\': return '\\';
+    default:
+      return c < 32;
+  }
+}
+
+static char *
+c_escape (char const *str)
+{
+  char const *s;
+  size_t plus = 0;
+  bool must_quote = false;
+
+  for (s = str; *s; s++)
+    {
+      char c = *s;
+
+      if (c == ' ')
+	{
+	  must_quote = true;
+	  continue;
+	}
+      switch (c_escape_char (*s))
+	{
+	  case 1:
+	    plus += 3;
+	    /* fall through */
+	  case 0:
+	    break;
+	  default:
+	    plus++;
+	    break;
+	}
+    }
+
+  if (must_quote || plus)
+    {
+      size_t s_len = s - str;
+      char *buffer = xmalloc (s_len + plus + 3);
+      char *b = buffer;
+
+      *b++ = '"';
+      for (s = str; *s; s++)
+	{
+	  char c = *s;
+	  char escape = c_escape_char (c);
+
+	  switch (escape)
+	    {
+	      case 0:
+		*b++ = c;
+		break;
+	      case 1:
+		*b++ = '\\';
+		*b++ = ((c >> 6) & 03) + '0';
+		*b++ = ((c >> 3) & 07) + '0';
+		*b++ = ((c >> 0) & 07) + '0';
+		break;
+	      default:
+		*b++ = '\\';
+		*b++ = escape;
+		break;
+	    }
+	}
+      *b++ = '"';
+      *b = 0;
+      return buffer;
+    }
+
+  return (char *) str;
+}
+
 void
 begin_output (void)
 {
+  char *names[2];
   char *name;
 
   if (outfile != 0)
     return;
 
+  names[0] = c_escape (current_name0);
+  names[1] = c_escape (current_name1);
+
   /* Construct the header of this piece of diff.  */
-  name = xmalloc (strlen (current_name0) + strlen (current_name1)
-		  + strlen (switch_string) + 7);
+  name = xmalloc (strlen (names[0]) + strlen (names[1]) + strlen (switch_string) + 7);
 
   /* POSIX 1003.1-2001 specifies this format.  But there are some bugs in
      the standard: it says that we must print only the last component
      of the pathnames, and it requires two spaces after "diff" if
      there are no options.  These requirements are silly and do not
      match historical practice.  */
-  sprintf (name, "diff%s %s %s", switch_string, current_name0, current_name1);
+  sprintf (name, "diff%s %s %s", switch_string, names[0], names[1]);
 
   if (paginate)
     {
@@ -258,16 +344,21 @@ begin_output (void)
   switch (output_style)
     {
     case OUTPUT_CONTEXT:
-      print_context_header (files, false);
+      print_context_header (files, (char const *const *)names, false);
       break;
 
     case OUTPUT_UNIFIED:
-      print_context_header (files, true);
+      print_context_header (files, (char const *const *)names, true);
       break;
 
     default:
       break;
     }
+
+  if (names[0] != current_name0)
+    free (names[0]);
+  if (names[1] != current_name1)
+    free (names[1]);
 }
 
 /* Call after the end of output of diffs for one file.
diff --git a/tests/Makefile.am b/tests/Makefile.am
index afc9aad..c9b59e5 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -11,7 +11,8 @@ TESTS = \
   new-file \
   no-dereference \
   no-newline-at-eof \
-  stdin
+  stdin \
+  filename-quoting
 
 EXTRA_DIST = \
   $(TESTS) init.sh t-local.sh
diff --git a/tests/filename-quoting b/tests/filename-quoting
new file mode 100755
index 0000000..e3e9193
--- /dev/null
+++ b/tests/filename-quoting
@@ -0,0 +1,61 @@
+#!/bin/sh
+# filename quoting
+
+. "${srcdir=.}/init.sh"; path_prepend_ ../src
+
+fail=0
+
+cat <<EOF > exp- || fail=1
+diff -N -r "a/ " "b/ "
+0a1
+> space
+EOF
+
+cat <<EOF > exp--u || fail=1
+diff -N -r -u "a/ " "b/ "
+--- "a/ "
++++ "b/ "
+@@ -0,0 +1 @@
++space
+EOF
+
+cat <<EOF > exp--c || fail=1
+diff -N -r -c "a/ " "b/ "
+*** "a/ "
+--- "b/ "
+***************
+*** 0 ****
+--- 1 ----
++ space
+EOF
+
+mkdir a b
+echo space > "b/ " || fail=1
+for opt in '' -u -c; do
+  diff -N -r $opt a b > out 2> err; test $? = 1 || fail=1
+  # Remove date and time.
+  sed -e 's/^\([-+*][-+*][-+*] [^	]*\)	.*/\1/' out > k; mv k out
+  compare exp-$(echo $opt|tr ' ' _) out || fail=1
+done
+
+rm -f "b/ "
+
+cat <<EOF > exp || fail=1
+--- "a/\t"
++++ "b/\001"
+@@ -1 +1 @@
+-tab
++one
+EOF
+
+tab=$(printf '\t')
+x01=$(printf '\001')
+
+echo tab > "a/$tab"   || fail=1
+echo one > "b/$x01" || fail=1
+diff -u "a/$tab" "b/$x01" > out 2> err; test $? = 1 || fail=1
+# Remove date and time.
+sed -e 's/^\([-+*][-+*][-+*] [^	]*\)	.*/\1/' out > k; mv k out
+compare exp out || fail=1
+
+Exit $fail
-- 
2.10.1 (Apple Git-78)


From 221383bcb1f9de839727b6ffd1b5a2b725314779 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@redhat.com>
Date: Mon, 10 Sep 2012 12:18:59 +0200
Subject: [PATCH 020/119] maint: use xasprintf in place of xmalloc+sprintf

* bootstrap.conf (gnulib_modules): Add gnulib's xvasprintf module.
* src/util.c: Include "xvasprintf.h".
(begin_output): Use xasprintf in place of xmalloc+sprintf.
---
 bootstrap.conf | 1 +
 src/util.c     | 5 ++---
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/bootstrap.conf b/bootstrap.conf
index 3954c4d..81b318e 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -81,6 +81,7 @@ xalloc
 xfreopen
 xreadlink
 xstrtoumax
+xvasprintf
 '
 
 # Additional xgettext options to use.  Use "\\\newline" to break lines.
diff --git a/src/util.c b/src/util.c
index 868b7e8..c02d156 100644
--- a/src/util.c
+++ b/src/util.c
@@ -23,6 +23,7 @@
 #include <error.h>
 #include <system-quote.h>
 #include <xalloc.h>
+#include "xvasprintf.h"
 
 char const pr_program[] = PR_PROGRAM;
 
@@ -262,14 +263,12 @@ begin_output (void)
   names[1] = c_escape (current_name1);
 
   /* Construct the header of this piece of diff.  */
-  name = xmalloc (strlen (names[0]) + strlen (names[1]) + strlen (switch_string) + 7);
-
   /* POSIX 1003.1-2001 specifies this format.  But there are some bugs in
      the standard: it says that we must print only the last component
      of the pathnames, and it requires two spaces after "diff" if
      there are no options.  These requirements are silly and do not
      match historical practice.  */
-  sprintf (name, "diff%s %s %s", switch_string, names[0], names[1]);
+  name = xasprintf ("diff%s %s %s", switch_string, names[0], names[1]);
 
   if (paginate)
     {
-- 
2.10.1 (Apple Git-78)


From 42f6244ee028dfbc535934e21028e6aa582256e7 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Wed, 3 Oct 2012 21:57:21 -0700
Subject: [PATCH 021/119] * doc/diffutils.texi (cmp Options): Document -l
 format better.

---
 doc/diffutils.texi | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 2908120..8509cf2 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -3563,6 +3563,9 @@ second.
 @itemx --verbose
 Output the (decimal) byte numbers and (octal) values of all differing bytes,
 instead of the default standard output.
+Each output line contains a differing byte's number relative to the
+start of the input, followed by the differing byte values.
+Byte numbers start at 1.
 Also, output the @acronym{EOF} message if one file is shorter than the other.
 
 @item -n @var{count}
-- 
2.10.1 (Apple Git-78)


From 01d92dba155d9ad87eaf0378876e0c67285c2075 Mon Sep 17 00:00:00 2001
From: Eric Blake <eblake@redhat.com>
Date: Tue, 23 Oct 2012 11:06:48 +0200
Subject: [PATCH 022/119] build: default to --enable-gcc-warnings in a git tree

Anyone building from cloned sources can be assumed to have a new
enough environment, such that enabling gcc warnings by default will
be useful.  Tarballs still default to no warnings, and the default
can still be overridden with --disable-gcc-warnings.
* configure.ac (gl_gcc_warnings): Set default based on environment.
---
 configure.ac | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/configure.ac b/configure.ac
index d6e52c4..18ff554 100644
--- a/configure.ac
+++ b/configure.ac
@@ -47,7 +47,11 @@ AC_ARG_ENABLE([gcc-warnings],
      *)      AC_MSG_ERROR([bad value $enableval for gcc-warnings option]) ;;
    esac
    gl_gcc_warnings=$enableval],
-  [gl_gcc_warnings=no]
+  [if test -d "$srcdir"/.git; then
+     gl_gcc_warnings=yes
+   else
+     gl_gcc_warnings=no
+   fi]
 )
 
 if test "$gl_gcc_warnings" = yes; then
-- 
2.10.1 (Apple Git-78)


From a0483cb2fc67ce559033a28e98b310e8ceaa9fd0 Mon Sep 17 00:00:00 2001
From: Jim Meyering <jim@meyering.net>
Date: Fri, 4 Jan 2013 11:13:02 +0100
Subject: [PATCH 023/119] maint: update all copyright year number ranges

Run "make update-copyright".
---
 AUTHORS            | 2 +-
 ChangeLog-2008     | 2 +-
 HACKING            | 2 +-
 Makefile.am        | 2 +-
 NEWS               | 2 +-
 README             | 2 +-
 README-hacking     | 2 +-
 bootstrap          | 2 +-
 bootstrap.conf     | 2 +-
 cfg.mk             | 2 +-
 configure.ac       | 2 +-
 doc/Makefile.am    | 2 +-
 doc/diffutils.texi | 2 +-
 exgettext          | 2 +-
 gnulib             | 2 +-
 lib/Makefile.am    | 2 +-
 lib/cmpbuf.c       | 2 +-
 lib/cmpbuf.h       | 2 +-
 lib/prepargs.c     | 2 +-
 m4/vararrays.m4    | 2 +-
 man/Makefile.am    | 2 +-
 man/help2man       | 3 +--
 po/POTFILES.in     | 2 +-
 po/en.po           | 2 +-
 src/Makefile.am    | 2 +-
 src/analyze.c      | 2 +-
 src/cmp.c          | 2 +-
 src/context.c      | 2 +-
 src/diff.c         | 2 +-
 src/diff.h         | 2 +-
 src/diff3.c        | 2 +-
 src/dir.c          | 2 +-
 src/ed.c           | 2 +-
 src/ifdef.c        | 2 +-
 src/io.c           | 2 +-
 src/normal.c       | 2 +-
 src/sdiff.c        | 2 +-
 src/side.c         | 2 +-
 src/system.h       | 2 +-
 src/util.c         | 2 +-
 tests/help-version | 2 +-
 tests/init.sh      | 2 +-
 42 files changed, 42 insertions(+), 43 deletions(-)

diff --git a/AUTHORS b/AUTHORS
index cc41f1d..d091302 100644
--- a/AUTHORS
+++ b/AUTHORS
@@ -33,7 +33,7 @@ Patrick D'Cruze
 Eli Zaretskii
 
 
-Copyright (C) 2001, 2006, 2009-2012 Free Software Foundation, Inc.
+Copyright (C) 2001, 2006, 2009-2013 Free Software Foundation, Inc.
 
 This file is part of GNU diffutils.
 
diff --git a/ChangeLog-2008 b/ChangeLog-2008
index cc9d0f7..5238b63 100644
--- a/ChangeLog-2008
+++ b/ChangeLog-2008
@@ -4265,7 +4265,7 @@ Thu Nov  3 16:30:24 1988  Randall Smith  (randy at gluteus.ai.mit.edu)
 
 	-----
 
-	Copyright (C) 1988-1994, 1997-2002, 2004, 2006, 2009-2012 Free Software
+	Copyright (C) 1988-1994, 1997-2002, 2004, 2006, 2009-2013 Free Software
 	Foundation, Inc.
 
 	Copying and distribution of this file, with or without
diff --git a/HACKING b/HACKING
index 522e0b5..13122ef 100644
--- a/HACKING
+++ b/HACKING
@@ -581,7 +581,7 @@ Then just open the index.html file (in the generated lcov-html directory)
 in your favorite web browser.
 
 ========================================================================
-Copyright (C) 2009-2012 Free Software Foundation, Inc.
+Copyright (C) 2009-2013 Free Software Foundation, Inc.
 
 Permission is granted to copy, distribute and/or modify this document
 under the terms of the GNU Free Documentation License, Version 1.3 or
diff --git a/Makefile.am b/Makefile.am
index dcd4b74..cf0ce1d 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -1,6 +1,6 @@
 # Main Automakefile for GNU diffutils.
 
-# Copyright (C) 2001-2002, 2004, 2006, 2009-2012 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2004, 2006, 2009-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/NEWS b/NEWS
index ce0d8c2..eddda02 100644
--- a/NEWS
+++ b/NEWS
@@ -324,7 +324,7 @@ User-visible changes in version 2.0:
 
 
 
-Copyright (C) 1993-1994, 1998, 2001-2002, 2004, 2006, 2009-2012 Free Software
+Copyright (C) 1993-1994, 1998, 2001-2002, 2004, 2006, 2009-2013 Free Software
 Foundation, Inc.
 
 This file is part of GNU Diffutils.
diff --git a/README b/README
index ddab36e..753e66e 100644
--- a/README
+++ b/README
@@ -51,7 +51,7 @@ Please report bugs to <bug-gnu-utils@gnu.org>.
 
 -----
 
-Copyright (C) 1992, 1998, 2001-2002, 2004, 2009-2012 Free Software Foundation,
+Copyright (C) 1992, 1998, 2001-2002, 2004, 2009-2013 Free Software Foundation,
 Inc.
 
 This file is part of GNU Diffutils.
diff --git a/README-hacking b/README-hacking
index e276592..530ef09 100644
--- a/README-hacking
+++ b/README-hacking
@@ -94,7 +94,7 @@ each program.  One way to do this is to use vc-dwim
 
 -----
 
-Copyright (C) 2002-2007, 2009-2012 Free Software Foundation, Inc.
+Copyright (C) 2002-2007, 2009-2013 Free Software Foundation, Inc.
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
diff --git a/bootstrap b/bootstrap
index e3e270b..48181c9 100755
--- a/bootstrap
+++ b/bootstrap
@@ -4,7 +4,7 @@ scriptversion=2012-07-19.14; # UTC
 
 # Bootstrap this package from checked-out sources.
 
-# Copyright (C) 2003-2012 Free Software Foundation, Inc.
+# Copyright (C) 2003-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/bootstrap.conf b/bootstrap.conf
index 81b318e..00e75e3 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -1,6 +1,6 @@
 # Bootstrap configuration.
 
-# Copyright (C) 2006-2012 Free Software Foundation, Inc.
+# Copyright (C) 2006-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/cfg.mk b/cfg.mk
index 72fddc0..9e31187 100644
--- a/cfg.mk
+++ b/cfg.mk
@@ -1,5 +1,5 @@
 # Customize maint.mk                           -*- makefile -*-
-# Copyright (C) 2003-2012 Free Software Foundation, Inc.
+# Copyright (C) 2003-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/configure.ac b/configure.ac
index 18ff554..7d29646 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1,6 +1,6 @@
 # Configure template for GNU Diffutils.
 
-# Copyright (C) 1994-1995, 1998, 2001-2002, 2004, 2006, 2009-2012 Free Software
+# Copyright (C) 1994-1995, 1998, 2001-2002, 2004, 2006, 2009-2013 Free Software
 # Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
diff --git a/doc/Makefile.am b/doc/Makefile.am
index 5672057..286f7a4 100644
--- a/doc/Makefile.am
+++ b/doc/Makefile.am
@@ -1,6 +1,6 @@
 # Makefile for GNU diffutils documentation.
 
-# Copyright (C) 2001-2002, 2009-2012 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2009-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 8509cf2..800d8c5 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -14,7 +14,7 @@ and documents the @acronym{GNU} @command{diff}, @command{diff3},
 differences between files and the @acronym{GNU} @command{patch} command for
 using their output to update files.
 
-Copyright @copyright{} 1992-1994, 1998, 2001-2002, 2004, 2006, 2009-2012 Free
+Copyright @copyright{} 1992-1994, 1998, 2001-2002, 2004, 2006, 2009-2013 Free
 Software Foundation, Inc.
 
 @quotation
diff --git a/exgettext b/exgettext
index 44652c3..c81941a 100755
--- a/exgettext
+++ b/exgettext
@@ -1,7 +1,7 @@
 #! /bin/sh
 # Wrapper around gettext for programs using the msgid convention.
 
-# Copyright (C) 1998, 2001, 2004, 2009-2012 Free Software Foundation, Inc.
+# Copyright (C) 1998, 2001, 2004, 2009-2013 Free Software Foundation, Inc.
 
 # Written by Paul Eggert <eggert@twinsun.com>.
 
diff --git a/gnulib b/gnulib
index 68f693f..0899891 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 68f693ff1db33bf24695f0f42c62e7801966fd06
+Subproject commit 08998910dd73aad59b78886ab01ab96f7d1e9c38
diff --git a/lib/Makefile.am b/lib/Makefile.am
index c120366..2e98878 100644
--- a/lib/Makefile.am
+++ b/lib/Makefile.am
@@ -1,6 +1,6 @@
 # Automakefile for GNU Diffutils library.
 
-# Copyright (C) 2001-2002, 2004, 2006, 2009-2012 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2004, 2006, 2009-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/lib/cmpbuf.c b/lib/cmpbuf.c
index cb6a339..a47cb70 100644
--- a/lib/cmpbuf.c
+++ b/lib/cmpbuf.c
@@ -1,6 +1,6 @@
 /* Buffer primitives for comparison operations.
 
-   Copyright (C) 1993, 1995, 1998, 2001-2002, 2006, 2009-2012 Free Software
+   Copyright (C) 1993, 1995, 1998, 2001-2002, 2006, 2009-2013 Free Software
    Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
diff --git a/lib/cmpbuf.h b/lib/cmpbuf.h
index 196edb6..732d7ab 100644
--- a/lib/cmpbuf.h
+++ b/lib/cmpbuf.h
@@ -1,6 +1,6 @@
 /* Buffer primitives for comparison operations.
 
-   Copyright (C) 2002, 2009-2012 Free Software Foundation, Inc.
+   Copyright (C) 2002, 2009-2013 Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/lib/prepargs.c b/lib/prepargs.c
index f4cf0c5..ec19a08 100644
--- a/lib/prepargs.c
+++ b/lib/prepargs.c
@@ -1,6 +1,6 @@
 /* Parse arguments from a string and prepend them to an argv.
 
-   Copyright (C) 1999-2002, 2006, 2009-2012 Free Software Foundation, Inc.
+   Copyright (C) 1999-2002, 2006, 2009-2013 Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/m4/vararrays.m4 b/m4/vararrays.m4
index c387d39..bf957ef 100644
--- a/m4/vararrays.m4
+++ b/m4/vararrays.m4
@@ -4,7 +4,7 @@
 
 # From Paul Eggert
 
-# Copyright (C) 2001, 2009-2012 Free Software Foundation, Inc.
+# Copyright (C) 2001, 2009-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/man/Makefile.am b/man/Makefile.am
index ae5886e..02cd761 100644
--- a/man/Makefile.am
+++ b/man/Makefile.am
@@ -1,6 +1,6 @@
 # Automakefile for GNU diffutils man pages
 
-# Copyright (C) 2002, 2009-2012 Free Software Foundation, Inc.
+# Copyright (C) 2002, 2009-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/man/help2man b/man/help2man
index 8bc961c..834b5ee 100755
--- a/man/help2man
+++ b/man/help2man
@@ -1,8 +1,7 @@
 #!/usr/bin/perl -w
 
 # Generate a short man page from --help and --version output.
-# Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2009, 2010,
-# 2011 Free Software Foundation, Inc.
+# Copyright (C) 1997-2005, 2009-2011, 2013 Free Software Foundation, Inc.
 
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/po/POTFILES.in b/po/POTFILES.in
index 866fa44..b6764e6 100644
--- a/po/POTFILES.in
+++ b/po/POTFILES.in
@@ -1,6 +1,6 @@
 # List of files that contain translatable strings.
 
-# Copyright (C) 2001-2002, 2009-2012 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2009-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/po/en.po b/po/en.po
index ad59232..6ebf25b 100644
--- a/po/en.po
+++ b/po/en.po
@@ -1,5 +1,5 @@
 # English messages for GNU diffutils
-# Copyright 1998, 2001-2003, 2009-2012 Free Software Foundation, Inc.
+# Copyright 1998, 2001-2003, 2009-2013 Free Software Foundation, Inc.
 # Paul Eggert <eggert@twinsun.com>, 1998
 #
 msgid ""
diff --git a/src/Makefile.am b/src/Makefile.am
index 14e2029..99fbfcc 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -1,6 +1,6 @@
 # Automakefile for GNU diffutils programs.
 
-# Copyright (C) 2001-2002, 2006, 2009-2012 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2006, 2009-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/src/analyze.c b/src/analyze.c
index 0e61a82..9dc9347 100644
--- a/src/analyze.c
+++ b/src/analyze.c
@@ -1,7 +1,7 @@
 /* Analyze file differences for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2012 Free Software Foundation, Inc.
+   2009-2013 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/cmp.c b/src/cmp.c
index 32b25e6..97473c9 100644
--- a/src/cmp.c
+++ b/src/cmp.c
@@ -1,6 +1,6 @@
 /* cmp - compare two files byte by byte
 
-   Copyright (C) 1990-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2012 Free
+   Copyright (C) 1990-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013 Free
    Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
diff --git a/src/context.c b/src/context.c
index 53aa203..dd79f89 100644
--- a/src/context.c
+++ b/src/context.c
@@ -1,6 +1,6 @@
 /* Context-format output routines for GNU DIFF.
 
-   Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2006, 2009-2012
+   Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2006, 2009-2013
    Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/diff.c b/src/diff.c
index 79a4726..50d0365 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -1,7 +1,7 @@
 /* diff - compare files line by line
 
    Copyright (C) 1988-1989, 1992-1994, 1996, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2012 Free Software Foundation, Inc.
+   2009-2013 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/diff.h b/src/diff.h
index 212a8d0..e9f0471 100644
--- a/src/diff.h
+++ b/src/diff.h
@@ -1,6 +1,6 @@
 /* Shared definitions for GNU DIFF
 
-   Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2009-2012 Free
+   Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2009-2013 Free
    Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/diff3.c b/src/diff3.c
index e234401..e25ef5d 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -1,6 +1,6 @@
 /* diff3 - compare three files line by line
 
-   Copyright (C) 1988-1989, 1992-1996, 1998, 2001-2002, 2004, 2006, 2009-2012
+   Copyright (C) 1988-1989, 1992-1996, 1998, 2001-2002, 2004, 2006, 2009-2013
    Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
diff --git a/src/dir.c b/src/dir.c
index 530807e..7f647b0 100644
--- a/src/dir.c
+++ b/src/dir.c
@@ -1,7 +1,7 @@
 /* Read, sort and compare two directories.  Used for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2012 Free Software Foundation, Inc.
+   2009-2013 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/ed.c b/src/ed.c
index 66a0400..6a884df 100644
--- a/src/ed.c
+++ b/src/ed.c
@@ -1,6 +1,6 @@
 /* Output routines for ed-script format.
 
-   Copyright (C) 1988-1989, 1991-1993, 1995, 1998, 2001, 2004, 2006, 2009-2012
+   Copyright (C) 1988-1989, 1991-1993, 1995, 1998, 2001, 2004, 2006, 2009-2013
    Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/ifdef.c b/src/ifdef.c
index 94f170b..34a5175 100644
--- a/src/ifdef.c
+++ b/src/ifdef.c
@@ -1,6 +1,6 @@
 /* #ifdef-format output routines for GNU DIFF.
 
-   Copyright (C) 1989, 1991-1994, 2001-2002, 2004, 2006, 2009-2012 Free
+   Copyright (C) 1989, 1991-1994, 2001-2002, 2004, 2006, 2009-2013 Free
    Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/io.c b/src/io.c
index 3abffb5..463ee35 100644
--- a/src/io.c
+++ b/src/io.c
@@ -1,6 +1,6 @@
 /* File I/O for GNU DIFF.
 
-   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2012
+   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013
    Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/normal.c b/src/normal.c
index 85b6c71..ea9de57 100644
--- a/src/normal.c
+++ b/src/normal.c
@@ -1,6 +1,6 @@
 /* Normal-format output routines for GNU DIFF.
 
-   Copyright (C) 1988-1989, 1993, 1995, 1998, 2001, 2006, 2009-2012 Free
+   Copyright (C) 1988-1989, 1993, 1995, 1998, 2001, 2006, 2009-2013 Free
    Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/sdiff.c b/src/sdiff.c
index e82ec84..b7f9f6a 100644
--- a/src/sdiff.c
+++ b/src/sdiff.c
@@ -1,6 +1,6 @@
 /* sdiff - side-by-side merge of file differences
 
-   Copyright (C) 1992-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2012 Free
+   Copyright (C) 1992-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013 Free
    Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/side.c b/src/side.c
index 076b898..284d960 100644
--- a/src/side.c
+++ b/src/side.c
@@ -1,6 +1,6 @@
 /* sdiff-format output routines for GNU DIFF.
 
-   Copyright (C) 1991-1993, 1998, 2001-2002, 2004, 2009-2012 Free Software
+   Copyright (C) 1991-1993, 1998, 2001-2002, 2004, 2009-2013 Free Software
    Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/system.h b/src/system.h
index eb9ed53..827df96 100644
--- a/src/system.h
+++ b/src/system.h
@@ -1,6 +1,6 @@
 /* System dependent declarations.
 
-   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2012
+   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013
    Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/util.c b/src/util.c
index c02d156..016057d 100644
--- a/src/util.c
+++ b/src/util.c
@@ -1,6 +1,6 @@
 /* Support routines for GNU DIFF.
 
-   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2012
+   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013
    Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/tests/help-version b/tests/help-version
index bc9edce..36ea213 100755
--- a/tests/help-version
+++ b/tests/help-version
@@ -2,7 +2,7 @@
 # Make sure all these programs work properly
 # when invoked with --help or --version.
 
-# Copyright (C) 2000-2012 Free Software Foundation, Inc.
+# Copyright (C) 2000-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/tests/init.sh b/tests/init.sh
index 5f6e638..bd2048e 100644
--- a/tests/init.sh
+++ b/tests/init.sh
@@ -1,6 +1,6 @@
 # source this file; set up for tests
 
-# Copyright (C) 2009-2012 Free Software Foundation, Inc.
+# Copyright (C) 2009-2013 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
-- 
2.10.1 (Apple Git-78)


From 45716f1cabffe46278c22b91a6399d7970639fef Mon Sep 17 00:00:00 2001
From: Jim Meyering <jim@meyering.net>
Date: Fri, 4 Jan 2013 11:19:17 +0100
Subject: [PATCH 024/119] build: update gnulib submodule to latest

---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index 0899891..f782c0f 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 08998910dd73aad59b78886ab01ab96f7d1e9c38
+Subproject commit f782c0f66728e636e98214c33e55de063f00f113
-- 
2.10.1 (Apple Git-78)


From 118d732ab2f414f9964377b4663598fa4a3ac3a6 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 6 Jan 2013 08:25:05 -0800
Subject: [PATCH 025/119] maint: update .gitignore for recent gnulib

* .gitignore: Add tests/*.trs and several *.h and *.sed files in lib,
---
 .gitignore | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

diff --git a/.gitignore b/.gitignore
index 7236c0b..bf11312 100644
--- a/.gitignore
+++ b/.gitignore
@@ -26,16 +26,37 @@
 /gnulib-tests/locale/
 /gnulib-tests/uniwidth/
 /lib/.gitignore
+/lib/alloca.h
 /lib/c++defs.h
 /lib/charset.alias
 /lib/config.h
 /lib/config.hin
 /lib/configmake.h
+/lib/fcntl.h
+/lib/iconv*.h
+/lib/inttypes.h
+/lib/langinfo.h
+/lib/locale.h
+/lib/ref-add.sed
+/lib/ref-del.sed
+/lib/signal.h
 /lib/stamp-h1
+/lib/stdio.h
+/lib/stdlib.h
+/lib/string.h
+/lib/strings.h
+/lib/sys/
+/lib/time.h
+/lib/unistd.h
 /lib/unistr
+/lib/unistr.h
+/lib/unitypes.h
 /lib/uniwidth
+/lib/uniwidth.h
 /lib/unused-parameter.h
 /lib/warn-on-use.h
+/lib/wchar.h
+/lib/wctype.h
 /m4/.gitignore
 /m4/gnulib-cache.m4
 /maint.mk
@@ -71,3 +92,4 @@ src/paths.h
 src/sdiff
 src/version.[ch]
 tests/*.log
+tests/*.trs
-- 
2.10.1 (Apple Git-78)


From b2f1e4bc555073d43b664c4389569a195ff040e3 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 6 Jan 2013 08:30:39 -0800
Subject: [PATCH 026/119] tests: port to hosts lacking fmt, make -C

* tests/Makefile.am (built_programs): Don't assume fmt works.
Don't rely on 'make -C', either.
---
 tests/Makefile.am | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/tests/Makefile.am b/tests/Makefile.am
index c9b59e5..f9beeeb 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -48,7 +48,7 @@ LOG_COMPILER= $(SHELL)
 
 built_programs =							\
   echo 'spy:;@echo $$(PROGRAMS)'					\
-    | MAKEFLAGS= $(MAKE) -s -C $(builddir)/../src -f Makefile -f - spy	\
-    | fmt -1 | sed 's,$(EXEEXT)$$,,' | sort -u
+    | (cd ../src && MAKEFLAGS= $(MAKE) -s -f Makefile -f - spy)		\
+    | tr ' ' '\n' | sed '/^$$/d; s,$(EXEEXT)$$,,' | sort -u
 
 VERBOSE = yes
-- 
2.10.1 (Apple Git-78)


From 90fd310a7865bf4ae695aaab0f21a9ab71f849f8 Mon Sep 17 00:00:00 2001
From: Jim Meyering <jim@meyering.net>
Date: Fri, 22 Mar 2013 04:39:25 +0100
Subject: [PATCH 027/119] build: update gnulib to latest and adapt; update
 bootstrap, too

Blindly updating to the latest from gnulib, bootstrap would
fail due to failure of our local patches to apply.  Hence,
these first two updates.
* gl/lib/regex_internal.c.diff: Update offsets, so this patch
applies to the latest from gnulib.
* gl/lib/regex_internal.h.diff: Remove file.  No longer needed.
* bootstrap: Update from gnulib.
---
 bootstrap                    | 57 ++++++++++++++++++++++----------------------
 gl/lib/regex_internal.c.diff |  4 ++--
 gl/lib/regex_internal.h.diff | 14 -----------
 gnulib                       |  2 +-
 4 files changed, 32 insertions(+), 45 deletions(-)
 delete mode 100644 gl/lib/regex_internal.h.diff

diff --git a/bootstrap b/bootstrap
index 48181c9..bee7765 100755
--- a/bootstrap
+++ b/bootstrap
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Print a version string.
-scriptversion=2012-07-19.14; # UTC
+scriptversion=2013-01-20.16; # UTC
 
 # Bootstrap this package from checked-out sources.
 
@@ -306,34 +306,34 @@ if test -n "$checkout_only_file" && test ! -r "$checkout_only_file"; then
   die "Bootstrapping from a non-checked-out distribution is risky."
 fi
 
-# Ensure that lines starting with ! sort last, per gitignore conventions
-# for whitelisting exceptions after a more generic blacklist pattern.
-sort_patterns() {
-  sort -u "$@" | sed '/^!/ {
-    H
-    d
-  }
-  $ {
-    P
-    x
-    s/^\n//
-  }' | sed '/^$/d'
+# Strip blank and comment lines to leave significant entries.
+gitignore_entries() {
+  sed '/^#/d; /^$/d' "$@"
 }
 
-# If $STR is not already on a line by itself in $FILE, insert it,
-# sorting the new contents of the file and replacing $FILE with the result.
-insert_sorted_if_absent() {
+# If $STR is not already on a line by itself in $FILE, insert it at the start.
+# Entries are inserted at the start of the ignore list to ensure existing
+# entries starting with ! are not overridden.  Such entries support
+# whitelisting exceptions after a more generic blacklist pattern.
+insert_if_absent() {
   file=$1
   str=$2
   test -f $file || touch $file
-  echo "$str" | sort_patterns - $file | cmp -s - $file > /dev/null \
-    || { echo "$str" | sort_patterns - $file > $file.bak \
-      && mv $file.bak $file; } \
-    || die "insert_sorted_if_absent $file $str: failed"
+  test -r $file || die "Error: failed to read ignore file: $file"
+  duplicate_entries=$(gitignore_entries $file | sort | uniq -d)
+  if [ "$duplicate_entries" ] ; then
+    die "Error: Duplicate entries in $file: " $duplicate_entries
+  fi
+  linesold=$(gitignore_entries $file | wc -l)
+  linesnew=$(echo "$str" | gitignore_entries - $file | sort -u | wc -l)
+  if [ $linesold != $linesnew ] ; then
+    { echo "$str" | cat - $file > $file.bak && mv $file.bak $file; } \
+      || die "insert_if_absent $file $str: failed"
+  fi
 }
 
 # Adjust $PATTERN for $VC_IGNORE_FILE and insert it with
-# insert_sorted_if_absent.
+# insert_if_absent.
 insert_vc_ignore() {
   vc_ignore_file="$1"
   pattern="$2"
@@ -344,7 +344,7 @@ insert_vc_ignore() {
     # .gitignore entry.
     pattern=$(echo "$pattern" | sed s,^,/,);;
   esac
-  insert_sorted_if_absent "$vc_ignore_file" "$pattern"
+  insert_if_absent "$vc_ignore_file" "$pattern"
 }
 
 # Die if there is no AC_CONFIG_AUX_DIR($build_aux) line in configure.ac.
@@ -889,20 +889,21 @@ find "$m4_base" "$source_base" \
   -depth \( -name '*.m4' -o -name '*.[ch]' \) \
   -type l -xtype l -delete > /dev/null 2>&1
 
+# Invoke autoreconf with --force --install to ensure upgrades of tools
+# such as ylwrap.
+AUTORECONFFLAGS="--verbose --install --force -I $m4_base $ACLOCAL_FLAGS"
+
 # Some systems (RHEL 5) are using ancient autotools, for which the
 # --no-recursive option had not been invented.  Detect that lack and
 # omit the option when it's not supported.  FIXME in 2017: remove this
 # hack when RHEL 5 autotools are updated, or when they become irrelevant.
-no_recursive=
 case $($AUTORECONF --help) in
-  *--no-recursive*) no_recursive=--no-recursive;;
+  *--no-recursive*) AUTORECONFFLAGS="$AUTORECONFFLAGS --no-recursive";;
 esac
 
 # Tell autoreconf not to invoke autopoint or libtoolize; they were run above.
-echo "running: AUTOPOINT=true LIBTOOLIZE=true " \
-    "$AUTORECONF --verbose --install $no_recursive -I $m4_base $ACLOCAL_FLAGS"
-AUTOPOINT=true LIBTOOLIZE=true \
-    $AUTORECONF --verbose --install $no_recursive -I $m4_base $ACLOCAL_FLAGS \
+echo "running: AUTOPOINT=true LIBTOOLIZE=true $AUTORECONF $AUTORECONFFLAGS"
+AUTOPOINT=true LIBTOOLIZE=true $AUTORECONF $AUTORECONFFLAGS \
   || die "autoreconf failed"
 
 # Get some extra files from gnulib, overriding existing files.
diff --git a/gl/lib/regex_internal.c.diff b/gl/lib/regex_internal.c.diff
index 2cede3c..40b0f55 100644
--- a/gl/lib/regex_internal.c.diff
+++ b/gl/lib/regex_internal.c.diff
@@ -2,7 +2,7 @@ diff --git a/lib/regex_internal.c b/lib/regex_internal.c
 index 904b88e..61c8d9d 100644
 --- a/lib/regex_internal.c
 +++ b/lib/regex_internal.c
-@@ -18,6 +18,8 @@
+@@ -17,6 +17,8 @@
     with this program; if not, write to the Free Software Foundation,
     Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA. */
 
@@ -11,7 +11,7 @@ index 904b88e..61c8d9d 100644
  static void re_string_construct_common (const char *str, Idx len,
  					re_string_t *pstr,
  					RE_TRANSLATE_TYPE trans, bool icase,
-@@ -1390,7 +1392,10 @@ static void
+@@ -1394,7 +1396,10 @@ static void
  internal_function
  re_node_set_remove_at (re_node_set *set, Idx idx)
  {
diff --git a/gl/lib/regex_internal.h.diff b/gl/lib/regex_internal.h.diff
deleted file mode 100644
index d1506a6..0000000
--- a/gl/lib/regex_internal.h.diff
+++ /dev/null
@@ -1,14 +0,0 @@
-diff --git i/lib/regex_internal.h w/lib/regex_internal.h
-index 859832f..3c7fe06 100644
---- i/lib/regex_internal.h
-+++ w/lib/regex_internal.h
-@@ -826,7 +826,8 @@ re_string_wchar_at (const re_string_t *pstr, Idx idx)
-
- static int
- internal_function __attribute ((pure))
--re_string_elem_size_at (const re_string_t *pstr, Idx idx)
-+re_string_elem_size_at (const re_string_t *pstr _UNUSED_PARAMETER_,
-+			Idx idx _UNUSED_PARAMETER_)
- {
- # ifdef _LIBC
-   const unsigned char *p, *extra;
diff --git a/gnulib b/gnulib
index f782c0f..db9cad7 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit f782c0f66728e636e98214c33e55de063f00f113
+Subproject commit db9cad7b8b59a010ff9158513a29cb002a2b8ae1
-- 
2.10.1 (Apple Git-78)


From 0c22f56ed7990cf02cbd2ade738944dd5ea8afd5 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sat, 23 Mar 2013 00:21:45 -0700
Subject: [PATCH 028/119] maint: update build procedure to recent gettext etc.

* bootstrap.conf (gnulib_modules): Add vararrays.
(needed_gnulib_files, unnecessary_gettext_files): New vars.
(bootstrap_post_import_hook): New function, to implement these vars.
(excluded_files): Remove; 'bootstrap' no longer supports this.
Its function is now performed by unnecessary_gettext_files.
(buildreq): Update automake to 1.12.2, to avoid CVE-2012-3386.
* configure.ac (AM_GNU_GETTEXT_VERSION): Bump from 0.17 to 0.18.2,
to lessen the probability that we'll have outlandishly old files
during a build.
* m4/vararrays.m4: Remove from repository, as we now use the
gnulib version.
---
 bootstrap.conf  | 48 ++++++++++++++++++++++++++++++++++++++----------
 configure.ac    |  2 +-
 m4/vararrays.m4 | 35 -----------------------------------
 3 files changed, 39 insertions(+), 46 deletions(-)
 delete mode 100644 m4/vararrays.m4

diff --git a/bootstrap.conf b/bootstrap.conf
index 00e75e3..240754b 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -73,6 +73,7 @@ system-quote
 unistd
 unlocked-io
 update-copyright
+vararrays
 verify
 version-etc
 version-etc-fsf
@@ -106,18 +107,36 @@ grep '^[	 ]*AM_GNU_GETTEXT(external\>' configure.ac > /dev/null &&
 grep '^[	 ]*AM_GNU_GETTEXT(\[external\]' configure.ac > /dev/null &&
   gettext_external=1
 
+needed_gnulib_files=
+unnecessary_gettext_files=
+
 if test $gettext_external = 1; then
   # Gettext supplies these files, but we don't need them since
   # we don't have an intl subdirectory.
-  excluded_files='
-      m4/glibc2.m4
-      m4/intdiv0.m4
-      m4/lcmessage.m4
-      m4/printf-posix.m4
-      m4/uintmax_t.m4
-      m4/ulonglong.m4
-      m4/visibility.m4
-'
+  unnecessary_gettext_files='
+    m4/glibc2.m4
+    m4/intdiv0.m4
+    m4/intl.m4
+    m4/intldir.m4
+    m4/intmax.m4
+    m4/lcmessage.m4
+    m4/lock.m4
+    m4/printf-posix.m4
+    m4/threadlib.m4
+    m4/uintmax_t.m4
+    m4/visibility.m4
+  '
+
+  # Gettext supplies these files, but the gnulib version of these files
+  # typically is more up-to-date.  We don't use gnulib's gettext module,
+  # as it's too heavyweight, so grab the files one at a time instead.
+  needed_gnulib_files='
+    m4/gettext.m4
+    m4/intlmacosx.m4
+    m4/nls.m4
+    m4/po.m4
+    m4/progtest.m4
+  '
 fi
 
 gnulib_tool_option_extras="--tests-base=gnulib-tests --with-tests
@@ -130,7 +149,7 @@ gnulib_tool_option_extras="--tests-base=gnulib-tests --with-tests
 # Build prerequisites
 buildreq="\
 autoconf   2.61
-automake   1.11
+automake   1.12.2
 autopoint  -
 gettext    -
 git        1.4.4
@@ -145,6 +164,15 @@ tar        -
 # Automake requires that ChangeLog exist.
 touch ChangeLog || exit 1
 
+bootstrap_post_import_hook()
+{
+  for file in $needed_gnulib_files; do
+    echo "$0: $gnulib_tool --copy-file $file $file ..."
+    $gnulib_tool --copy-file $file $file || exit
+  done
+  rm -f $unnecessary_gettext_files || exit
+}
+
 bootstrap_epilogue()
 {
   perl -pi -e "s/\@PACKAGE\@/$package/g" README-release
diff --git a/configure.ac b/configure.ac
index 7d29646..aea40fc 100644
--- a/configure.ac
+++ b/configure.ac
@@ -161,7 +161,7 @@ test -f $srcdir/.tarball-version \
   || SRC_VERSION_C=../src/version.c
 
 AM_GNU_GETTEXT([external], [need-ngettext])
-AM_GNU_GETTEXT_VERSION([0.17])
+AM_GNU_GETTEXT_VERSION([0.18.2])
 XGETTEXT="AWK='$AWK' \$(SHELL) \$(top_srcdir)/exgettext $XGETTEXT"
 
 AC_CONFIG_FILES([
diff --git a/m4/vararrays.m4 b/m4/vararrays.m4
deleted file mode 100644
index bf957ef..0000000
--- a/m4/vararrays.m4
+++ /dev/null
@@ -1,35 +0,0 @@
-# Check for variable-length arrays.
-
-#serial 2
-
-# From Paul Eggert
-
-# Copyright (C) 2001, 2009-2013 Free Software Foundation, Inc.
-
-# This program is free software: you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or
-# (at your option) any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-
-AC_DEFUN([AC_C_VARARRAYS],
-[
-  AC_CACHE_CHECK([for variable-length arrays],
-    ac_cv_c_vararrays,
-    [AC_TRY_COMPILE(
-       [],
-       [static int x; char a[++x]; a[sizeof a - 1] = 0; return a[0];],
-       ac_cv_c_vararrays=yes,
-       ac_cv_c_vararrays=no)])
-  if test $ac_cv_c_vararrays = yes; then
-    AC_DEFINE([HAVE_C_VARARRAYS], [1],
-      [Define to 1 if C supports variable-length arrays.])
-  fi
-])
-- 
2.10.1 (Apple Git-78)


From 6e68271b694fd8fd75459f613861f66ae7b9573b Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sat, 23 Mar 2013 00:26:09 -0700
Subject: [PATCH 029/119] doc: fix menu typo

* doc/diffutils.texi (Comparing Three Files): Fix out-of-order menu.
Bug caught by Texinfo 5.0.
---
 doc/diffutils.texi | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 800d8c5..2d238dc 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -2014,8 +2014,8 @@ their location in the input files.
 @menu
 * Sample diff3 Input::    Sample @command{diff3} input for examples.
 * Example diff3 Normal::  Sample output in the normal format.
-* diff3 Hunks::           The format of normal output format.
 * Detailed diff3 Normal:: A detailed description of normal output format.
+* diff3 Hunks::           The format of normal output format.
 @end menu
 
 @node Sample diff3 Input
-- 
2.10.1 (Apple Git-78)


From 4544aa68fda5404835d1e0bfbfda8467d7e0d4a5 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 24 Mar 2013 11:00:34 -0700
Subject: [PATCH 030/119] version 3.3

* NEWS: Record release date.
---
 NEWS | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/NEWS b/NEWS
index eddda02..12ad4f7 100644
--- a/NEWS
+++ b/NEWS
@@ -1,6 +1,6 @@
 GNU diffutils NEWS                                    -*- outline -*-
 
-* Noteworthy changes in release ?.? (????-??-??) [?]
+* Noteworthy changes in release 3.3 (2013-03-24) [stable]
 
 ** New features
 
-- 
2.10.1 (Apple Git-78)


From 36671926115bb6cd29876470afbd85cdda33b443 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 24 Mar 2013 11:09:13 -0700
Subject: [PATCH 031/119] maint: post-release administrivia

* NEWS: Add header line for next release.
* .prev-version: Record previous version.
* cfg.mk (old_NEWS_hash): Auto-update.
---
 .prev-version | 2 +-
 NEWS          | 3 +++
 cfg.mk        | 2 +-
 3 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/.prev-version b/.prev-version
index a3ec5a4..eb39e53 100644
--- a/.prev-version
+++ b/.prev-version
@@ -1 +1 @@
-3.2
+3.3
diff --git a/NEWS b/NEWS
index 12ad4f7..ef73e2f 100644
--- a/NEWS
+++ b/NEWS
@@ -1,5 +1,8 @@
 GNU diffutils NEWS                                    -*- outline -*-
 
+* Noteworthy changes in release ?.? (????-??-??) [?]
+
+
 * Noteworthy changes in release 3.3 (2013-03-24) [stable]
 
 ** New features
diff --git a/cfg.mk b/cfg.mk
index 9e31187..1db88cf 100644
--- a/cfg.mk
+++ b/cfg.mk
@@ -29,7 +29,7 @@ bootstrap-tools = autoconf,automake,gnulib
 # Now that we have better tests, make this the default.
 export VERBOSE = yes
 
-old_NEWS_hash = 7d70c18e90495732e671b3c94da01651
+old_NEWS_hash = 1d1b7468264850b366b1138bd78e5520
 
 # Tell maint.mk's syntax-check rules that diff gets config.h directly or
 # via diff.h or system.h.
-- 
2.10.1 (Apple Git-78)


From 283d1b9528e193ac25018b542665ac5c0e53811f Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Tue, 26 Mar 2013 11:39:06 -0700
Subject: [PATCH 032/119] tests: port to Solaris 10 /bin/sh

* tests/Makefile.am (TESTS_ENVIRONMENT):
Use "FOO=val; export FOO" rather than "export FOO=val",
as the latter form doesn't work with Solaris /bin/sh.
Problem found when trying to run "make check" on Solaris 10.
---
 tests/Makefile.am | 42 +++++++++++++++++++++---------------------
 1 file changed, 21 insertions(+), 21 deletions(-)

diff --git a/tests/Makefile.am b/tests/Makefile.am
index f9beeeb..5cbcfb4 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -21,27 +21,27 @@ EXTRA_DIST = \
 # variables that can perturb tests are unset or set to expected values.
 # The rest are envvar settings that propagate build-related Makefile
 # variables to test scripts.
-TESTS_ENVIRONMENT =				\
-  tmp__=$$TMPDIR; test -d "$$tmp__" || tmp__=.;	\
-  TMPDIR=$$tmp__; export TMPDIR;		\
-  export					\
-  VERSION='$(VERSION)'				\
-  abs_top_builddir='$(abs_top_builddir)'	\
-  abs_top_srcdir='$(abs_top_srcdir)'		\
-  abs_srcdir='$(abs_srcdir)'			\
-  built_programs="`$(built_programs)`"		\
-  srcdir='$(srcdir)'				\
-  top_srcdir='$(top_srcdir)'			\
-  CC='$(CC)'					\
-  MAKE=$(MAKE)					\
-  PACKAGE_BUGREPORT='$(PACKAGE_BUGREPORT)'	\
-  PACKAGE_VERSION=$(PACKAGE_VERSION)		\
-  CONFIG_HEADER='$(abs_top_builddir)/lib/config.h' \
-  ENABLE_DEVICE_MAPPER=$(ENABLE_DEVICE_MAPPER)	\
-  PERL='$(PERL)'				\
-  PREFERABLY_POSIX_SHELL='$(PREFERABLY_POSIX_SHELL)' \
-  REPLACE_GETCWD=$(REPLACE_GETCWD)		\
-  PATH='$(abs_top_builddir)/src$(PATH_SEPARATOR)'"$$PATH" \
+TESTS_ENVIRONMENT =							\
+  tmp__=$$TMPDIR; test -d "$$tmp__" || tmp__=.;				\
+  TMPDIR=$$tmp__; export TMPDIR;					\
+  VERSION='$(VERSION)'; export VERSION;					\
+  abs_top_builddir='$(abs_top_builddir)'; export abs_top_builddir;	\
+  abs_top_srcdir='$(abs_top_srcdir)'; export abs_top_srcdir;		\
+  abs_srcdir='$(abs_srcdir)'; export abs_srcdir;			\
+  built_programs="`$(built_programs)`"					\
+  srcdir='$(srcdir)'; export built_programs;				\
+  top_srcdir='$(top_srcdir)'; export top_srcdir;			\
+  CC='$(CC)'; export CC;						\
+  MAKE=$(MAKE); export MAKE;						\
+  PACKAGE_BUGREPORT='$(PACKAGE_BUGREPORT)'; export PACKAGE_BUGREPORT;	\
+  PACKAGE_VERSION=$(PACKAGE_VERSION); export PACKAGE_VERSION;		\
+  CONFIG_HEADER='$(abs_top_builddir)/lib/config.h'; export CONFIG_HEADER; \
+  ENABLE_DEVICE_MAPPER=$(ENABLE_DEVICE_MAPPER); export ENABLE_DEVICE_MAPPER; \
+  PERL='$(PERL)'; export PERL;						\
+  PREFERABLY_POSIX_SHELL='$(PREFERABLY_POSIX_SHELL)';			\
+    export PREFERABLY_POSIX_SHELL;					\
+  REPLACE_GETCWD=$(REPLACE_GETCWD); export REPLACE_GETCWD;		\
+  PATH='$(abs_top_builddir)/src$(PATH_SEPARATOR)'"$$PATH"; export PATH	\
   ; 9>&2
 
 LOG_COMPILER= $(SHELL)
-- 
2.10.1 (Apple Git-78)


From 417363e4ce3e0195b539a4170ff0cda91400dbc8 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 30 Mar 2013 12:50:27 -0700
Subject: [PATCH 033/119] doc: mention new option, --no-dereference in 3.3's
 NEWS

* NEWS (New feeatures): Update 3.3's news to mention --no-dereference.
Reported by Denis Excoffier.
* Makefile.am (old_NEWS_hash): Update, since this modifies old, and
normally-immutable NEWS.
---
 NEWS   | 6 ++++++
 cfg.mk | 2 +-
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/NEWS b/NEWS
index ef73e2f..ac7a75e 100644
--- a/NEWS
+++ b/NEWS
@@ -7,6 +7,12 @@ GNU diffutils NEWS                                    -*- outline -*-
 
 ** New features
 
+  diff accepts a new option, --no-dereference.  With this option, symbolic
+  links are treated specially: as a separate type of file that can compare
+  equal only to another symbolic link with the same value.  For example,
+  with --no-dereference, two symbolic links compare equal when they have
+  the same value, even when that value does not reference a readable file.
+
   --new-file (-N) and --unidirectional-new-file now allow comparisons to "-".
   A standard input that's closed acts like a nonexistent file.
 
diff --git a/cfg.mk b/cfg.mk
index 1db88cf..d37bea9 100644
--- a/cfg.mk
+++ b/cfg.mk
@@ -29,7 +29,7 @@ bootstrap-tools = autoconf,automake,gnulib
 # Now that we have better tests, make this the default.
 export VERBOSE = yes
 
-old_NEWS_hash = 1d1b7468264850b366b1138bd78e5520
+old_NEWS_hash = 8632093db0c946f65f639f06ac7de39a
 
 # Tell maint.mk's syntax-check rules that diff gets config.h directly or
 # via diff.h or system.h.
-- 
2.10.1 (Apple Git-78)


From 085417c79b05afc72ef9d0333a5846da53826a8c Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Wed, 3 Apr 2013 07:48:22 -0700
Subject: [PATCH 034/119] diff: tune compare_names_for_qsort

* src/dir.c (compare_collated): New function.
(compare_names): Use it.
(compare_names_for_qsort): Use it.  This is a bit more efficient
as it can avoid a double invocation of file_name_cmp when
file_name_cmp returns zero.
---
 src/dir.c | 49 +++++++++++++++++++++++++++++++------------------
 1 file changed, 31 insertions(+), 18 deletions(-)

diff --git a/src/dir.c b/src/dir.c
index 7f647b0..fc42f62 100644
--- a/src/dir.c
+++ b/src/dir.c
@@ -140,28 +140,34 @@ dir_read (struct file_data const *dir, struct dirdata *dirdata)
   return true;
 }
 
-/* Compare file names, returning a value compatible with strcmp.  */
+/* Compare strings in a locale-specific way, returning a value
+   compatible with strcmp.  */
 
 static int
-compare_names (char const *name1, char const *name2)
+compare_collated (char const *name1, char const *name2)
 {
-  if (locale_specific_sorting)
+  int r;
+  errno = 0;
+  if (ignore_file_name_case)
+    r = strcasecoll (name1, name2);
+  else
+    r = strcoll (name1, name2);
+  if (errno)
     {
-      int r;
-      errno = 0;
-      if (ignore_file_name_case)
-	r = strcasecoll (name1, name2);
-      else
-	r = strcoll (name1, name2);
-      if (errno)
-	{
-	  error (0, errno, _("cannot compare file names '%s' and '%s'"),
-		 name1, name2);
-	  longjmp (failed_locale_specific_sorting, 1);
-	}
-      return r;
+      error (0, errno, _("cannot compare file names '%s' and '%s'"),
+	     name1, name2);
+      longjmp (failed_locale_specific_sorting, 1);
     }
+  return r;
+}
+
+/* Compare file names, returning a value compatible with strcmp.  */
 
+static int
+compare_names (char const *name1, char const *name2)
+{
+  if (locale_specific_sorting)
+    return compare_collated (name1, name2);
   return file_name_cmp (name1, name2);
 }
 
@@ -173,8 +179,15 @@ compare_names_for_qsort (void const *file1, void const *file2)
 {
   char const *const *f1 = file1;
   char const *const *f2 = file2;
-  int diff = compare_names (*f1, *f2);
-  return diff ? diff : file_name_cmp (*f1, *f2);
+  char const *name1 = *f1;
+  char const *name2 = *f2;
+  if (locale_specific_sorting)
+    {
+      int diff = compare_collated (name1, name2);
+      if (diff)
+	return diff;
+    }
+  return file_name_cmp (name1, name2);
 }
 
 /* Compare the contents of two directories named in CMP.
-- 
2.10.1 (Apple Git-78)


From 885dfcec001ba7712257e371c4af61914c64133b Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Wed, 3 Apr 2013 07:51:33 -0700
Subject: [PATCH 035/119] diff: remove unnecessary decl

* src/dir.c (compare_names_for_qsort): Remove declaration.
Not needed now that we assume C89.
---
 src/dir.c | 1 -
 1 file changed, 1 deletion(-)

diff --git a/src/dir.c b/src/dir.c
index fc42f62..21b1935 100644
--- a/src/dir.c
+++ b/src/dir.c
@@ -45,7 +45,6 @@ static bool locale_specific_sorting;
 static jmp_buf failed_locale_specific_sorting;
 
 static bool dir_loop (struct comparison const *, int);
-static int compare_names_for_qsort (void const *, void const *);
 
 
 /* Read a directory and get its vector of names.  */
-- 
2.10.1 (Apple Git-78)


From 4825b8d70cff23f6ebe0dfa0ab181bc8401007a5 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Wed, 3 Apr 2013 08:20:31 -0700
Subject: [PATCH 036/119] diff: fix bug with Asian file names

Problem reported by Errembault Philippe in:
http://lists.gnu.org/archive/html/bug-diffutils/2013-03/msg00012.html
* NEWS: Document this.
* src/dir.c (compare_names): Fall back on file_name_cmp if
compare_collated returns 0, unless ignoring file name case.
(diff_dirs): Don't bother with the O(N**2) stuff unless ignoring
file name case.
* tests/Makefile.am (TESTS): Add strcoll-0-names.
* tests/strcoll-0-names: New file.
---
 NEWS                  |  7 +++++++
 src/dir.c             |  8 ++++++--
 tests/Makefile.am     |  1 +
 tests/strcoll-0-names | 25 +++++++++++++++++++++++++
 4 files changed, 39 insertions(+), 2 deletions(-)
 create mode 100755 tests/strcoll-0-names

diff --git a/NEWS b/NEWS
index ac7a75e..79517f2 100644
--- a/NEWS
+++ b/NEWS
@@ -2,6 +2,13 @@ GNU diffutils NEWS                                    -*- outline -*-
 
 * Noteworthy changes in release ?.? (????-??-??) [?]
 
+** Bug fixes
+
+  Unless the --ignore-file-name-case option is used, diff now
+  considers file names to be equal only if they are byte-for-byte
+  equivalent.  This fixes a bug where diff in an English locale might
+  consider two Asian file names to be the same merely because they
+  contain no English characters.
 
 * Noteworthy changes in release 3.3 (2013-03-24) [stable]
 
diff --git a/src/dir.c b/src/dir.c
index 21b1935..d3b0a2d 100644
--- a/src/dir.c
+++ b/src/dir.c
@@ -166,7 +166,11 @@ static int
 compare_names (char const *name1, char const *name2)
 {
   if (locale_specific_sorting)
-    return compare_collated (name1, name2);
+    {
+      int diff = compare_collated (name1, name2);
+      if (diff || ignore_file_name_case)
+	return diff;
+    }
   return file_name_cmp (name1, name2);
 }
 
@@ -271,7 +275,7 @@ diff_dirs (struct comparison const *cmp,
 	     O(N**2), where N is the number of names in a directory
 	     that compare_names says are all equal, but in practice N
 	     is so small it's not worth tuning.  */
-	  if (nameorder == 0)
+	  if (nameorder == 0 && ignore_file_name_case)
 	    {
 	      int raw_order = file_name_cmp (*names[0], *names[1]);
 	      if (raw_order != 0)
diff --git a/tests/Makefile.am b/tests/Makefile.am
index 5cbcfb4..dd2d514 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -12,6 +12,7 @@ TESTS = \
   no-dereference \
   no-newline-at-eof \
   stdin \
+  strcoll-0-names \
   filename-quoting
 
 EXTRA_DIST = \
diff --git a/tests/strcoll-0-names b/tests/strcoll-0-names
new file mode 100755
index 0000000..33c4a3c
--- /dev/null
+++ b/tests/strcoll-0-names
@@ -0,0 +1,25 @@
+#!/bin/sh
+# Check that diff responds well with two different file names
+# that compare equal with strcoll.  See:
+# http://lists.gnu.org/archive/html/bug-diffutils/2013-03/msg00012.html
+
+. "${srcdir=.}/init.sh"; path_prepend_ ../src
+
+# These two names compare equal in the en_US.UTF-8 locale
+# in current (2013) versions of glibc.
+# On systems where the names do not compare equal,
+# this diff test should still do the right thing.
+LC_ALL=en_US.UTF-8
+export LC_ALL
+name1='1'
+name2='1'
+
+mkdir d1 d2 || fail=1
+echo x >d1/"$name1" || fail=1
+echo x >d2/"$name2" || fail=1
+
+# This should report a difference, but on the affected systems
+# diffutils 3.3 does not.
+diff d1 d2 && fail=1
+
+Exit $fail
-- 
2.10.1 (Apple Git-78)


From 1280234016e4eece403b72fc69f53e13044df5ef Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 28 Apr 2013 20:48:44 -0700
Subject: [PATCH 037/119] build: update gnulib submodule to latest

---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index db9cad7..72c63c0 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit db9cad7b8b59a010ff9158513a29cb002a2b8ae1
+Subproject commit 72c63c089365640c7f1acd97fb72ee26932ac2b3
-- 
2.10.1 (Apple Git-78)


From d1d1df8e369b0f31e5e6f2784dbfa35d7ddc3647 Mon Sep 17 00:00:00 2001
From: Stefano Lattarini <stefano.lattarini@gmail.com>
Date: Fri, 3 May 2013 12:10:32 +0200
Subject: [PATCH 038/119] build: enable 'subdir-objects' automake option

The future major Automake version (2.0, ETA at least one year from now)
might enable that option unconditionally, so better get prepared in due
time.

* configure.ac (AM_INIT_AUTOMAKE): Adjust.
(AM_PROG_CC_C_O): New, required by Automake up to 1.13.x when the
'subdir-objects' is in use.
---
 configure.ac | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/configure.ac b/configure.ac
index aea40fc..90bebc9 100644
--- a/configure.ac
+++ b/configure.ac
@@ -26,13 +26,15 @@ AC_CONFIG_SRCDIR([src/diff.c])
 AC_CONFIG_AUX_DIR([build-aux])
 AC_CONFIG_MACRO_DIR([m4])
 
-AM_INIT_AUTOMAKE([1.11 dist-xz no-dist-gzip color-tests parallel-tests])
+AM_INIT_AUTOMAKE([1.11 dist-xz no-dist-gzip subdir-objects
+                       color-tests parallel-tests])
 AM_SILENT_RULES([yes]) # make --enable-silent-rules the default.
 
 AC_CONFIG_HEADER([lib/config.h:lib/config.hin])
 
 AC_PROG_AWK
 AC_PROG_CC
+AM_PROG_CC_C_O
 AM_MISSING_PROG([HELP2MAN], [help2man])
 AC_PROG_RANLIB
 gl_EARLY
-- 
2.10.1 (Apple Git-78)


From 8f248489ebcc39c9e553f749c90b4bbdf19eb5bd Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sat, 6 Jul 2013 17:41:19 -0700
Subject: [PATCH 039/119] build: update gnulib submodule to latest

---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index 72c63c0..c96bab3 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 72c63c089365640c7f1acd97fb72ee26932ac2b3
+Subproject commit c96bab3fee48a9df55e7366344f838e1fc785c28
-- 
2.10.1 (Apple Git-78)


From 9350980d5dd0d922845bcbb225207a775cf40697 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Mon, 12 Aug 2013 16:24:01 -0700
Subject: [PATCH 040/119] cmp: tune 'cmp a b' for GCC x86
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Performance problem reported by David Balaic in:
http://lists.gnu.org/archive/html/bug-diffutils/2013-08/msg00013.html
* src/system.h (word): Make it size_t, not uintmax_t.
This sped up plain cmp 90% on my tests (GCC 4.8.1, x86).
---
 src/system.h | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/system.h b/src/system.h
index 827df96..f39fff0 100644
--- a/src/system.h
+++ b/src/system.h
@@ -119,10 +119,12 @@ int strcasecmp (char const *, char const *);
 #include "propername.h"
 #include "version.h"
 
-/* Type used for fast comparison of several bytes at a time.  */
+/* Type used for fast comparison of several bytes at a time.
+   This used to be uintmax_t, but changing it to size_t
+   made plain 'cmp' 90% faster (GCC 4.8.1, x86).  */
 
 #ifndef word
-# define word uintmax_t
+# define word size_t
 #endif
 
 /* The integer type of a line number.  Since files are read into main
-- 
2.10.1 (Apple Git-78)


From 59f4ef95f8a9c0583d1560ef447eab9d44e32cd1 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Thu, 22 Aug 2013 15:45:56 -0700
Subject: [PATCH 041/119] cmp, diff, sdiff: tune by using rawmemchr

On my platform (AMD Phenom II X4 910e, Fedora 17 x86-64), this sped up
'cmp -n 8GiB /dev/full /dev/zero' by a factor of 3.8, and
'cmp -sn 8GiB /dev/full /dev/zero' by a factor of 1.8.
* bootstrap.conf (gnulib_modules): Add rawmemchr.
* src/cmp.c (cmp): Optimize the common case where buffers are the same,
by using count_newlines rather than block_compare_and_count.
(block_compare_and_count): Remove.
(count_newlines): New function.
* src/cmp.c (count_newlines):
* src/io.c (prepare_text):
* src/sdiff.c (lf_copy, lf_skip, lf_snarf):
Use rawmemchr instead of memchr, for speed.
---
 bootstrap.conf |  1 +
 src/cmp.c      | 88 +++++++++++++++++++---------------------------------------
 src/io.c       | 24 ++++++++++------
 src/sdiff.c    | 10 +++----
 4 files changed, 51 insertions(+), 72 deletions(-)

diff --git a/bootstrap.conf b/bootstrap.conf
index 240754b..ac85adf 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -56,6 +56,7 @@ mkstemp
 mktime
 progname
 propername
+rawmemchr
 readme-release
 regex
 sh-quote
diff --git a/src/cmp.c b/src/cmp.c
index 97473c9..9e35b07 100644
--- a/src/cmp.c
+++ b/src/cmp.c
@@ -52,7 +52,7 @@
 static int cmp (void);
 static off_t file_position (int);
 static size_t block_compare (word const *, word const *) _GL_ATTRIBUTE_PURE;
-static size_t block_compare_and_count (word const *, word const *, off_t *);
+static size_t count_newlines (char *, size_t);
 static void sprintc (char *, unsigned char);
 
 /* Filenames of the compared files.  */
@@ -448,20 +448,23 @@ cmp (void)
       if (read1 == SIZE_MAX)
 	error (EXIT_TROUBLE, errno, "%s", file[1]);
 
-      /* Insert sentinels for the block compare.  */
+      smaller = MIN (read0, read1);
 
-      buf0[read0] = ~buf1[read0];
-      buf1[read1] = ~buf0[read1];
+      /* Optimize the common case where the buffers are the same.  */
+      if (memcmp (buf0, buf1, smaller) == 0)
+	first_diff = smaller;
+      else
+	{
+	  /* Insert sentinels for the block compare.  */
+	  buf0[read0] = ~buf1[read0];
+	  buf1[read1] = ~buf0[read1];
 
-      /* If the line number should be written for differing files,
-	 compare the blocks and count the number of newlines
-	 simultaneously.  */
-      first_diff = (comparison_type == type_first_diff
-		    ? block_compare_and_count (buffer0, buffer1, &line_number)
-		    : block_compare (buffer0, buffer1));
+	  first_diff = block_compare (buffer0, buffer1);
+	}
 
       byte_number += first_diff;
-      smaller = MIN (read0, read1);
+      if (comparison_type == type_first_diff)
+	line_number += count_newlines (buf0, first_diff);
 
       if (first_diff < smaller)
 	{
@@ -567,54 +570,6 @@ cmp (void)
   return differing == 0 ? EXIT_SUCCESS : EXIT_FAILURE;
 }
 
-/* Compare two blocks of memory P0 and P1 until they differ,
-   and count the number of '\n' occurrences in the common
-   part of P0 and P1.
-   If the blocks are not guaranteed to be different, put sentinels at the ends
-   of the blocks before calling this function.
-
-   Return the offset of the first byte that differs.
-   Increment *COUNT by the count of '\n' occurrences.  */
-
-static size_t
-block_compare_and_count (word const *p0, word const *p1, off_t *count)
-{
-  word l;		/* One word from first buffer. */
-  word const *l0, *l1;	/* Pointers into each buffer. */
-  char const *c0, *c1;	/* Pointers for finding exact address. */
-  size_t cnt = 0;	/* Number of '\n' occurrences. */
-  word nnnn;		/* Newline, sizeof (word) times.  */
-  int i;
-
-  nnnn = 0;
-  for (i = 0; i < sizeof nnnn; i++)
-    nnnn = (nnnn << CHAR_BIT) | '\n';
-
-  /* Find the rough position of the first difference by reading words,
-     not bytes.  */
-
-  for (l0 = p0, l1 = p1;  (l = *l0) == *l1;  l0++, l1++)
-    {
-      l ^= nnnn;
-      for (i = 0; i < sizeof l; i++)
-	{
-	  unsigned char uc = l;
-	  cnt += ! uc;
-	  l >>= CHAR_BIT;
-	}
-    }
-
-  /* Find the exact differing position (endianness independent).  */
-
-  for (c0 = (char const *) l0, c1 = (char const *) l1;
-       *c0 == *c1;
-       c0++, c1++)
-    cnt += *c0 == '\n';
-
-  *count += cnt;
-  return c0 - (char const *) p0;
-}
-
 /* Compare two blocks of memory P0 and P1 until they differ.
    If the blocks are not guaranteed to be different, put sentinels at the ends
    of the blocks before calling this function.
@@ -643,6 +598,21 @@ block_compare (word const *p0, word const *p1)
   return c0 - (char const *) p0;
 }
 
+/* Return the number of newlines in BUF, of size BUFSIZE,
+   where BUF[NBYTES] is available for use as a sentinel.  */
+
+static size_t
+count_newlines (char *buf, size_t bufsize)
+{
+  size_t count = 0;
+  char *p;
+  char *lim = buf + bufsize;
+  *lim = '\n';
+  for (p = buf; (p = rawmemchr (p, '\n')) != lim; p++)
+    count++;
+  return count;
+}
+
 /* Put into BUF the unsigned char C, making unprintable bytes
    visible by quoting like cat -t does.  */
 
diff --git a/src/io.c b/src/io.c
index 463ee35..05a898c 100644
--- a/src/io.c
+++ b/src/io.c
@@ -474,7 +474,6 @@ prepare_text (struct file_data *current)
 {
   size_t buffered = current->buffered;
   char *p = FILE_BUFFER (current);
-  char *dst;
 
   if (buffered == 0 || p[buffered - 1] == '\n')
     current->missing_newline = false;
@@ -490,16 +489,25 @@ prepare_text (struct file_data *current)
   /* Don't use uninitialized storage when planting or using sentinels.  */
   memset (p + buffered, 0, sizeof (word));
 
-  if (strip_trailing_cr && (dst = memchr (p, '\r', buffered)))
+  if (strip_trailing_cr)
     {
-      char const *src = dst;
-      char const *srclim = p + buffered;
+      char *dst;
+      char *srclim = p + buffered;
+      *srclim = '\r';
+      dst = rawmemchr (p, '\r');
 
-      do
-	dst += ! ((*dst = *src++) == '\r' && *src == '\n');
-      while (src < srclim);
+      if (dst != srclim)
+	{
+	  char const *src = dst;
+	  do
+	    {
+	      *dst = *src++;
+	      dst += ! (*dst == '\r' && *src == '\n');
+	    }
+	  while (src < srclim);
 
-      buffered -= src - dst;
+	  buffered -= src - dst;
+	}
     }
 
   current->buffered = buffered;
diff --git a/src/sdiff.c b/src/sdiff.c
index b7f9f6a..e7bc657 100644
--- a/src/sdiff.c
+++ b/src/sdiff.c
@@ -379,8 +379,8 @@ lf_copy (struct line_filter *lf, lin lines, FILE *outfile)
 
   while (lines)
     {
-      lf->bufpos = (char *) memchr (lf->bufpos, '\n', lf->buflim - lf->bufpos);
-      if (! lf->bufpos)
+      lf->bufpos = rawmemchr (lf->bufpos, '\n');
+      if (lf->bufpos == lf->buflim)
 	{
 	  ck_fwrite (start, lf->buflim - start, outfile);
 	  if (! lf_refill (lf))
@@ -403,8 +403,8 @@ lf_skip (struct line_filter *lf, lin lines)
 {
   while (lines)
     {
-      lf->bufpos = (char *) memchr (lf->bufpos, '\n', lf->buflim - lf->bufpos);
-      if (! lf->bufpos)
+      lf->bufpos = rawmemchr (lf->bufpos, '\n');
+      if (lf->bufpos == lf->buflim)
 	{
 	  if (! lf_refill (lf))
 	    break;
@@ -424,7 +424,7 @@ lf_snarf (struct line_filter *lf, char *buffer, size_t bufsize)
   for (;;)
     {
       char *start = lf->bufpos;
-      char *next = (char *) memchr (start, '\n', lf->buflim + 1 - start);
+      char *next = rawmemchr (start, '\n');
       size_t s = next - start;
       if (bufsize <= s)
 	return 0;
-- 
2.10.1 (Apple Git-78)


From 1875453ee6e1021d67c6856c46e7024bcecdbea8 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Thu, 26 Sep 2013 12:20:00 -0700
Subject: [PATCH 042/119] build: omit -Wsuggest-attribute=pure for lib

* configure.ac (WARN_CFLAGS): Omit -Wsuggest-attribute=pure
when compiling the lib subdirectory.  Reported for Fedora 19
by Eric Blake in <http://bugs.gnu.org/15463>.
---
 configure.ac | 1 +
 1 file changed, 1 insertion(+)

diff --git a/configure.ac b/configure.ac
index 90bebc9..f7efcb1 100644
--- a/configure.ac
+++ b/configure.ac
@@ -123,6 +123,7 @@ if test "$gl_gcc_warnings" = yes; then
   nw="$nw -Wunused-macros"
   nw="$nw -Wmissing-prototypes"
   nw="$nw -Wold-style-definition"
+  nw="$nw -Wsuggest-attribute=pure"
   gl_MANYWARN_COMPLEMENT([GNULIB_WARN_CFLAGS], [$WARN_CFLAGS], [$nw])
   AC_SUBST([GNULIB_WARN_CFLAGS])
 fi
-- 
2.10.1 (Apple Git-78)


From bc4b4b2bbf699267bab167af0484336780791953 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Fri, 31 Jan 2014 17:15:26 -0800
Subject: [PATCH 043/119] diff: exit with status 1, not 2, when binary files
 differ

Problem reported by Vincent Lefevre in <http://bugs.gnu.org/16608>.
* NEWS:
* doc/diffutils.texi (Binary, Invoking diff): Document this.
* src/analyze.c (briefly_report): Return void, not int.
All uses changed.  Do not futz with exit status.  Simplify.
* tests/binary: Adjust to match new behavior.
---
 NEWS               |  3 +++
 doc/diffutils.texi | 15 +++------------
 src/analyze.c      | 28 +++++++++-------------------
 tests/binary       |  4 ++--
 4 files changed, 17 insertions(+), 33 deletions(-)

diff --git a/NEWS b/NEWS
index 79517f2..aff7a9d 100644
--- a/NEWS
+++ b/NEWS
@@ -4,6 +4,9 @@ GNU diffutils NEWS                                    -*- outline -*-
 
 ** Bug fixes
 
+  When binary files differ, diff now exits with status 1 as POSIX requires.
+  Formerly it exited with status 2.
+
   Unless the --ignore-file-name-case option is used, diff now
   considers file names to be equal only if they are byte-for-byte
   equivalent.  This fixes a bug where diff in an English locale might
diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 2d238dc..1d48f54 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -426,6 +426,8 @@ binary (a non-text file), it normally treats that pair of files much as
 if the summary output format had been selected (@pxref{Brief}), and
 reports only that the binary files are different.  This is because line
 by line comparisons are usually not meaningful for binary files.
+This does not count as trouble, even though the resulting output does
+not capture all the differences.
 
 @command{diff} determines whether a file is text or binary by checking the
 first few bytes in the file; the exact number of bytes is system
@@ -450,14 +452,6 @@ You can also force @command{diff} to report only whether files differ
 (but not how).  Use the @option{--brief} (@option{-q}) option for
 this.
 
-Normally, differing binary files count as trouble because the
-resulting @command{diff} output does not capture all the differences.
-This trouble causes @command{diff} to exit with status 2.  However,
-this trouble cannot occur with the @option{--text} (@option{-a})
-option, or with the @option{--brief} (@option{-q}) option, as these
-options both cause @command{diff} to generate a form of output that
-represents differences as requested.
-
 In operating systems that distinguish between text and binary files,
 @command{diff} normally reads and writes all data as text.  Use the
 @option{--binary} option to force @command{diff} to read and write binary
@@ -3705,10 +3699,7 @@ argument by itself treats the remaining arguments as file names even if
 they begin with @samp{-}.
 
 An exit status of 0 means no differences were found, 1 means some
-differences were found, and 2 means trouble.  Normally, differing
-binary files count as trouble, but this can be altered by using the
-@option{--text} (@option{-a}) option, or the @option{-q} or
-@option{--brief} option.
+differences were found, and 2 means trouble.
 
 @menu
 * diff Options:: Summary of options to @command{diff}.
diff --git a/src/analyze.c b/src/analyze.c
index 9dc9347..1886e7e 100644
--- a/src/analyze.c
+++ b/src/analyze.c
@@ -445,26 +445,16 @@ build_script (struct file_data const filevec[])
   return script;
 }
 
-/* If CHANGES, briefly report that two files differed.
-   Return 2 if trouble, CHANGES otherwise.  */
-static int
+/* If CHANGES, briefly report that two files differed.  */
+static void
 briefly_report (int changes, struct file_data const filevec[])
 {
   if (changes)
-    {
-      char const *label0 = file_label[0] ? file_label[0] : filevec[0].name;
-      char const *label1 = file_label[1] ? file_label[1] : filevec[1].name;
-
-      if (brief)
-	message ("Files %s and %s differ\n", label0, label1);
-      else
-	{
-	  message ("Binary files %s and %s differ\n", label0, label1);
-	  changes = 2;
-	}
-    }
-
-  return changes;
+    message ((brief
+	      ? _("Files %s and %s differ\n")
+	      : _("Binary files %s and %s differ\n")),
+	     file_label[0] ? file_label[0] : filevec[0].name,
+	     file_label[1] ? file_label[1] : filevec[1].name);
 }
 
 /* Report the differences of two files.  */
@@ -536,7 +526,7 @@ diff_2_files (struct comparison *cmp)
 	    }
 	}
 
-      changes = briefly_report (changes, cmp->file);
+      briefly_report (changes, cmp->file);
     }
   else
     {
@@ -635,7 +625,7 @@ diff_2_files (struct comparison *cmp)
 	changes = (script != 0);
 
       if (brief)
-	changes = briefly_report (changes, cmp->file);
+	briefly_report (changes, cmp->file);
       else
 	{
 	  if (changes || !no_diff_means_no_output)
diff --git a/tests/binary b/tests/binary
index d7b3943..0110f6e 100755
--- a/tests/binary
+++ b/tests/binary
@@ -9,8 +9,8 @@ fail=0
 
 printf '\0'|diff - /dev/null > out 2> err
 
-# diff must exit with status 2, stdout as above, and no stderr.
-test $? = 2 || fail=1
+# diff must exit with status 1, stdout as above, and no stderr.
+test $? = 1 || fail=1
 compare out-exp out || fail=1
 compare /dev/null err || fail=1
 
-- 
2.10.1 (Apple Git-78)


From bc51e4bcb4a843998c3cd89f8c2ba00e73bb5381 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 23 Feb 2014 16:23:17 -0800
Subject: [PATCH 044/119] build: update gnulib submodule to latest

---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index c96bab3..1aed559 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit c96bab3fee48a9df55e7366344f838e1fc785c28
+Subproject commit 1aed559952395ff1eff24263701b349eb77a4e06
-- 
2.10.1 (Apple Git-78)


From 9b48bf3d3ed002e32fad5de5f539745bc861a104 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 23 Feb 2014 22:49:27 -0800
Subject: [PATCH 045/119] diff: remove TOO_EXPENSIVE heuristic

Problem reported by Vincent Lefevre in <http://bugs.gnu.org/16848>.
The simplest solution is to remove the TOO_EXPENSIVE heuristic
that I added to GNU diff in 1993.  Although appropriate for
circa-1993 hardware, these days the heuristic seems to be more
trouble than it's worth.
* NEWS: Document this.
* doc/diffutils.texi (Overview): Modernize citations.
Remove mention of TOO_EXPENSIVE heuristic.
* src/analyze.c (diff_2_files): Adjust to TOO_EXPENSIVE-related
API changes in gnulib's diffseq module.
---
 NEWS               |  7 +++++++
 doc/diffutils.texi | 18 +++++++++---------
 src/analyze.c      | 10 +---------
 3 files changed, 17 insertions(+), 18 deletions(-)

diff --git a/NEWS b/NEWS
index aff7a9d..58a7cbb 100644
--- a/NEWS
+++ b/NEWS
@@ -13,6 +13,13 @@ GNU diffutils NEWS                                    -*- outline -*-
   consider two Asian file names to be the same merely because they
   contain no English characters.
 
+** Performance changes
+
+  diff's default algorithm has been adjusted to output higher-quality
+  results at somewhat greater computational cost, as CPUs have gotten
+  faster since the algorithm was last tweaked in diffutils-2.6 (1993).
+
+
 * Noteworthy changes in release 3.3 (2013-03-24) [stable]
 
 ** New features
diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 1d48f54..7b08cd4 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -142,26 +142,26 @@ use diffs to update files.
 David Hayes, Richard Stallman, and Len Tower.  Wayne Davison designed and
 implemented the unified output format.  The basic algorithm is described
 by Eugene W. Myers in ``An O(ND) Difference Algorithm and its Variations'',
-@cite{Algorithmica} Vol.@: 1 No.@: 2, 1986, pp.@: 251--266; and in ``A File
+@cite{Algorithmica} Vol.@: 1, 1986, pp.@: 251--266,
+@url{http://dx.doi.org/10.1007/BF01840446}; and in ``A File
 Comparison Program'', Webb Miller and Eugene W. Myers,
-@cite{Software---Practice and Experience} Vol.@: 15 No.@: 11, 1985,
-pp.@: 1025--1040.
+@cite{Software---Practice and Experience} Vol.@: 15, 1985,
+pp.@: 1025--1040,
+@url{http://dx.doi.org/10.1002/spe.4380151102}.
 @c From: "Gene Myers" <gene@cs.arizona.edu>
 @c They are about the same basic algorithm; the Algorithmica
 @c paper gives a rigorous treatment and the sub-algorithm for
 @c delivering scripts and should be the primary reference, but
 @c both should be mentioned.
-The algorithm was independently discovered as described by E. Ukkonen in
+The algorithm was independently discovered as described by Esko Ukkonen in
 ``Algorithms for Approximate String Matching'',
-@cite{Information and Control} Vol.@: 64, 1985, pp.@: 100--118.
+@cite{Information and Control} Vol.@: 64, 1985, pp.@: 100--118,
+@url{http://dx.doi.org/10.1016/S0019-9958(85)80046-2}.
 @c From: "Gene Myers" <gene@cs.arizona.edu>
 @c Date: Wed, 29 Sep 1993 08:27:55 MST
 @c Ukkonen should be given credit for also discovering the algorithm used
 @c in GNU diff.
-Unless the @option{--minimal} option is used, @command{diff} uses a
-heuristic by Paul Eggert that limits the cost to @math{O(N^1.5 log N)}
-at the price of producing suboptimal output for large inputs with many
-differences.  Related algorithms are surveyed by Alfred V. Aho in
+Related algorithms are surveyed by Alfred V. Aho in
 section 6.3 of ``Algorithms for Finding Patterns in Strings'',
 @cite{Handbook of Theoretical Computer Science} (Jan Van Leeuwen,
 ed.), Vol.@: A, @cite{Algorithms and Complexity}, Elsevier/MIT Press,
diff --git a/src/analyze.c b/src/analyze.c
index 1886e7e..f062fd3 100644
--- a/src/analyze.c
+++ b/src/analyze.c
@@ -532,7 +532,6 @@ diff_2_files (struct comparison *cmp)
     {
       struct context ctxt;
       lin diags;
-      lin too_expensive;
 
       /* Allocate vectors for the results of comparison:
 	 a flag for each line of each file, saying whether that line
@@ -564,18 +563,11 @@ diff_2_files (struct comparison *cmp)
 
       ctxt.heuristic = speed_large_files;
 
-      /* Set TOO_EXPENSIVE to be approximate square root of input size,
-	 bounded below by 256.  */
-      too_expensive = 1;
-      for (;  diags != 0;  diags >>= 2)
-	too_expensive <<= 1;
-      ctxt.too_expensive = MAX (256, too_expensive);
-
       files[0] = cmp->file[0];
       files[1] = cmp->file[1];
 
       compareseq (0, cmp->file[0].nondiscarded_lines,
-		  0, cmp->file[1].nondiscarded_lines, minimal, &ctxt);
+		  0, cmp->file[1].nondiscarded_lines, &ctxt);
 
       free (ctxt.fdiag - (cmp->file[1].nondiscarded_lines + 1));
 
-- 
2.10.1 (Apple Git-78)


From c26334b7df5a10a70447d762711380c693fdc2a7 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Mon, 24 Feb 2014 21:38:02 -0800
Subject: [PATCH 046/119] diff: fix bug with -I and overlapping hunks

Problem reported by Vincent Lefevre in <http://bugs.gnu.org/16864>.
* src/context.c (find_hunk): Threshold is CONTEXT only if
the second change is ignorable.
* tests/ignore-matching-lines: New test.
* tests/Makefile.am (TESTS): Add it.
---
 src/context.c               |  7 +++----
 tests/Makefile.am           |  1 +
 tests/ignore-matching-lines | 47 +++++++++++++++++++++++++++++++++++++++++++++
 3 files changed, 51 insertions(+), 4 deletions(-)
 create mode 100755 tests/ignore-matching-lines

diff --git a/src/context.c b/src/context.c
index dd79f89..42f1eed 100644
--- a/src/context.c
+++ b/src/context.c
@@ -402,9 +402,8 @@ find_hunk (struct change *start)
   lin top0, top1;
   lin thresh;
 
-  /* Threshold distance is 2 * CONTEXT + 1 between two non-ignorable
-     changes, but only CONTEXT if one is ignorable.  Watch out for
-     integer overflow, though.  */
+  /* Threshold distance is CONTEXT if the second change is ignorable,
+     2 * CONTEXT + 1 otherwise.  Watch out for integer overflow.  */
   lin non_ignorable_threshold =
     (LIN_MAX - 1) / 2 < context ? LIN_MAX : 2 * context + 1;
   lin ignorable_threshold = context;
@@ -416,7 +415,7 @@ find_hunk (struct change *start)
       top1 = start->line1 + start->inserted;
       prev = start;
       start = start->link;
-      thresh = (prev->ignore || (start && start->ignore)
+      thresh = (start && start->ignore
 		? ignorable_threshold
 		: non_ignorable_threshold);
       /* It is not supposed to matter which file we check in the end-test.
diff --git a/tests/Makefile.am b/tests/Makefile.am
index dd2d514..005d9f0 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -7,6 +7,7 @@ TESTS = \
   excess-slash \
   help-version	\
   function-line-vs-leading-space \
+  ignore-matching-lines \
   label-vs-func	\
   new-file \
   no-dereference \
diff --git a/tests/ignore-matching-lines b/tests/ignore-matching-lines
new file mode 100755
index 0000000..5db9ba3
--- /dev/null
+++ b/tests/ignore-matching-lines
@@ -0,0 +1,47 @@
+#!/bin/sh
+# --ignore-matching-lines
+
+# Bug reported by Vincent Lefevre in <http://bugs.gnu.org/16864>.
+
+. "${srcdir=.}/init.sh"; path_prepend_ ../src
+
+fail=0
+
+cat <<'EOF' >a
+1a
+2
+3a
+4
+5
+6
+EOF
+
+cat <<'EOF' >b
+1b
+2
+3b
+4
+5
+6
+7
+EOF
+
+cat <<'EOF' >exp
+@@ -1,6 +1,7 @@
+-1a
++1b
+ 2
+-3a
++3b
+ 4
+ 5
+ 6
++7
+EOF
+
+diff -u --ignore-matching-lines 3 a b >out 2>err
+test $? = 1 || fail=1
+sed 1,2d out >outtail || framework_failure+
+compare exp outtail || fail=1
+
+Exit $fail
-- 
2.10.1 (Apple Git-78)


From ed8975e7de513e0edaf77ea3f15dcce3f39b8d97 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Mon, 24 Feb 2014 21:56:21 -0800
Subject: [PATCH 047/119] diff, sdiff: minor integer overflow fixes

* src/context.c (find_hunk):
Simplify, now that 2 * context + 1 cannot overflow.
* src/diff.c (main):
* src/sdiff.c (interact):
Don't rely on undefined behavior on signed integer overflow.
* src/diff.c (main): Don't let contexts exceed CONTEXT_MAX.
* src/system.h (CONTEXT_MAX): New macro.
---
 src/context.c |  6 +++---
 src/diff.c    | 15 ++++++++-------
 src/sdiff.c   | 10 ++++++----
 src/system.h  |  5 +++++
 4 files changed, 22 insertions(+), 14 deletions(-)

diff --git a/src/context.c b/src/context.c
index 42f1eed..32053d1 100644
--- a/src/context.c
+++ b/src/context.c
@@ -403,10 +403,10 @@ find_hunk (struct change *start)
   lin thresh;
 
   /* Threshold distance is CONTEXT if the second change is ignorable,
-     2 * CONTEXT + 1 otherwise.  Watch out for integer overflow.  */
-  lin non_ignorable_threshold =
-    (LIN_MAX - 1) / 2 < context ? LIN_MAX : 2 * context + 1;
+     2 * CONTEXT + 1 otherwise.  Integer overflow can't happen, due
+     to CONTEXT_LIM.  */
   lin ignorable_threshold = context;
+  lin non_ignorable_threshold = 2 * context + 1;
 
   do
     {
diff --git a/src/diff.c b/src/diff.c
index 50d0365..c6ba5f6 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -304,11 +304,12 @@ main (int argc, char **argv)
 	case '7':
 	case '8':
 	case '9':
-	  if (! ISDIGIT (prev))
-	    ocontext = c - '0';
-	  else if (LIN_MAX / 10 < ocontext
-		   || ((ocontext = 10 * ocontext + c - '0') < 0))
-	    ocontext = LIN_MAX;
+	  ocontext = (! ISDIGIT (prev)
+		      ? c - '0'
+		      : (ocontext - (c - '0' <= CONTEXT_MAX % 10)
+			 < CONTEXT_MAX / 10)
+		      ? 10 * ocontext + (c - '0')
+		      : CONTEXT_MAX);
 	  break;
 
 	case 'a':
@@ -337,8 +338,8 @@ main (int argc, char **argv)
 		numval = strtoumax (optarg, &numend, 10);
 		if (*numend)
 		  try_help ("invalid context length '%s'", optarg);
-		if (LIN_MAX < numval)
-		  numval = LIN_MAX;
+		if (CONTEXT_MAX < numval)
+		  numval = CONTEXT_MAX;
 	      }
 	    else
 	      numval = 3;
diff --git a/src/sdiff.c b/src/sdiff.c
index e7bc657..329fa52 100644
--- a/src/sdiff.c
+++ b/src/sdiff.c
@@ -1099,12 +1099,14 @@ interact (struct line_filter *diff,
 	  uintmax_t val;
 	  lin llen, rlen, lenmax;
 	  errno = 0;
-	  llen = val = strtoumax (diff_help + 1, &numend, 10);
-	  if (llen < 0 || llen != val || errno || *numend != ',')
+	  val = strtoumax (diff_help + 1, &numend, 10);
+	  if (LIN_MAX < val || errno || *numend != ',')
 	    fatal (diff_help);
-	  rlen = val = strtoumax (numend + 1, &numend, 10);
-	  if (rlen < 0 || rlen != val || errno || *numend)
+	  llen = val;
+	  val = strtoumax (numend + 1, &numend, 10);
+	  if (LIN_MAX < val || errno || *numend)
 	    fatal (diff_help);
+	  rlen = val;
 
 	  lenmax = MAX (llen, rlen);
 
diff --git a/src/system.h b/src/system.h
index f39fff0..1f81a72 100644
--- a/src/system.h
+++ b/src/system.h
@@ -135,6 +135,11 @@ typedef ptrdiff_t lin;
 verify (TYPE_SIGNED (lin));
 verify (sizeof (ptrdiff_t) <= sizeof (lin));
 verify (sizeof (lin) <= sizeof (long int));
+
+/* Limit so that 2 * CONTEXT + 1 does not overflow.  */
+
+#define CONTEXT_MAX ((LIN_MAX - 1) / 2)
+
 
 /* This section contains POSIX-compliant defaults for macros
    that are meant to be overridden by hand in config.h as needed.  */
-- 
2.10.1 (Apple Git-78)


From fee3cad6b7e039e7bba524c3264f368af69396cd Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Tue, 25 Mar 2014 17:55:26 -0700
Subject: [PATCH 048/119] doc: improve documentation about reading and stdin

See Bug#17075.
* doc/diffutils.texi (Comparison): Say that files need not be read.
(Invoking diff): Remove confusing remark about 'diff - -'.
It's not that useful, and it's not portable anyway.
---
 doc/diffutils.texi | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 7b08cd4..022fb8d 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -219,6 +219,11 @@ groups of lines that differ, and reports each group of differing lines.
 Its output is designed to make it easy to inspect two different sets of
 changes to the same file.
 
+These commands compare input files without necessarily reading them.
+For example, if @command{diff} is asked simply to report whether two
+files differ, and it discovers that the files have different sizes, it
+need not read them to do its job.
+
 @menu
 * Hunks::             Groups of differing lines.
 * White Space::       Suppressing differences in white space.
@@ -3672,8 +3677,7 @@ diff @var{options}@dots{} @var{files}@dots{}
 In the simplest case, two file names @var{from-file} and
 @var{to-file} are given, and @command{diff} compares the contents of
 @var{from-file} and @var{to-file}.  A file name of @file{-} stands for
-text read from the standard input.  As a special case, @samp{diff - -}
-compares a copy of standard input to itself.
+the standard input.
 
 If one file is a directory and the other is not, @command{diff} compares
 the file in the directory whose name is that of the non-directory.
-- 
2.10.1 (Apple Git-78)


From f6f1b1b49c5dc1c8265f457012cdd78fe71ad4f5 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@penguin.cs.ucla.edu>
Date: Wed, 26 Mar 2014 11:12:12 -0700
Subject: [PATCH 049/119] diff: fix two "..." typos in --help output

* src/diff.c (option_help_msgid): Remove two "..." typos (Bug#17102).
---
 src/diff.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/diff.c b/src/diff.c
index c6ba5f6..397815e 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -939,7 +939,7 @@ static char const * const option_help_msgid[] = {
   N_("    --help               display this help and exit"),
   N_("-v, --version            output version information and exit"),
   "",
-  N_("FILES are 'FILE1 FILE2' or 'DIR1 DIR2' or 'DIR FILE...' or 'FILE... DIR'."),
+  N_("FILES are 'FILE1 FILE2' or 'DIR1 DIR2' or 'DIR FILE' or 'FILE DIR'."),
   N_("If --from-file or --to-file is given, there are no restrictions on FILE(s)."),
   N_("If a FILE is '-', read standard input."),
   N_("Exit status is 0 if inputs are the same, 1 if different, 2 if trouble."),
-- 
2.10.1 (Apple Git-78)


From 667864f2844c417090149b7948052fbd757d3b48 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Mon, 23 Dec 2013 07:06:41 -0800
Subject: [PATCH 050/119] maint: update bug-reporting address

* README: Change bug-gnu-utils@... to bug-diffutils@gnu.org.
* doc/diffutils.texi: Likewise.
Reported by Jamie Landeg Jones.
---
 README             | 2 +-
 doc/diffutils.texi | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/README b/README
index 753e66e..f6c2641 100644
--- a/README
+++ b/README
@@ -47,7 +47,7 @@ this distribution:
 For any copyright year range specified as YYYY-ZZZZ in this package
 note that the range specifies every single year in that closed interval.
 
-Please report bugs to <bug-gnu-utils@gnu.org>.
+Please report bugs to <bug-diffutils@gnu.org>.
 
 -----
 
diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 022fb8d..14bfec8 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -4675,8 +4675,8 @@ time stamps have the same content.  @xref{diff Performance}.
 If you think you have found a bug in @acronym{GNU} @command{cmp},
 @command{diff}, @command{diff3}, or @command{sdiff}, please report it
 by electronic mail to the
-@uref{http://mail.gnu.org/mailman/listinfo/bug-gnu-utils,GNU utilities
-bug report mailing list} @email{bug-gnu-utils@@gnu.org}.  Please send
+@uref{http://mail.gnu.org/mailman/listinfo/bug-diffutils,GNU utilities
+bug report mailing list} @email{bug-diffutils@@gnu.org}.  Please send
 bug reports for @acronym{GNU} @command{patch} to
 @email{bug-patch@@gnu.org}.  Send as precise a description of the
 problem as you can, including the output of the @option{--version}
-- 
2.10.1 (Apple Git-78)


From cfcba8735034e5aa4dae7fa4b3290ef25b0c3c52 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 8 Jun 2014 19:10:24 -0700
Subject: [PATCH 051/119] maint: update copyright year range in texinfo
 documentation

* doc/diffutils.texi: Update copyright.
---
 doc/diffutils.texi | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 14bfec8..5e84ff7 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -14,7 +14,7 @@ and documents the @acronym{GNU} @command{diff}, @command{diff3},
 differences between files and the @acronym{GNU} @command{patch} command for
 using their output to update files.
 
-Copyright @copyright{} 1992-1994, 1998, 2001-2002, 2004, 2006, 2009-2013 Free
+Copyright @copyright{} 1992-1994, 1998, 2001-2002, 2004, 2006, 2009-2014 Free
 Software Foundation, Inc.
 
 @quotation
-- 
2.10.1 (Apple Git-78)


From b6e691277288c4e8d53b1d2577137d265008d13e Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 23 Aug 2014 14:10:20 -0700
Subject: [PATCH 052/119] gnulib: update to latest, as well as bootstrap

---
 bootstrap | 116 +++++++++++++++++++++++++++++++++++++-------------------------
 gnulib    |   2 +-
 2 files changed, 70 insertions(+), 48 deletions(-)

diff --git a/bootstrap b/bootstrap
index bee7765..ce90bc4 100755
--- a/bootstrap
+++ b/bootstrap
@@ -1,10 +1,10 @@
 #! /bin/sh
 # Print a version string.
-scriptversion=2013-01-20.16; # UTC
+scriptversion=2013-12-05.23; # UTC
 
 # Bootstrap this package from checked-out sources.
 
-# Copyright (C) 2003-2013 Free Software Foundation, Inc.
+# Copyright (C) 2003-2014 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -140,20 +140,21 @@ po_download_command_format2=\
 "wget --mirror -nd -q -np -A.po -P '%s' \
  http://translationproject.org/latest/%s/"
 
+# Prefer a non-empty tarname (4th argument of AC_INIT if given), else
+# fall back to the package name (1st argument with munging)
 extract_package_name='
-  /^AC_INIT(/{
-     /.*,.*,.*, */{
-       s///
-       s/[][]//g
-       s/)$//
+  /^AC_INIT(\[*/{
+     s///
+     /^[^,]*,[^,]*,[^,]*,[ []*\([^][ ,)]\)/{
+       s//\1/
+       s/[],)].*//
        p
        q
      }
-     s/AC_INIT(\[*//
-     s/]*,.*//
+     s/[],)].*//
      s/^GNU //
      y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/
-     s/[^A-Za-z0-9_]/-/g
+     s/[^abcdefghijklmnopqrstuvwxyz0123456789_]/-/g
      p
   }
 '
@@ -208,12 +209,16 @@ bootstrap_sync=false
 # Use git to update gnulib sources
 use_git=true
 
+check_exists() {
+  ($1 --version </dev/null) >/dev/null 2>&1
+  test $? -lt 126
+}
+
 # find_tool ENVVAR NAMES...
 # -------------------------
 # Search for a required program.  Use the value of ENVVAR, if set,
-# otherwise find the first of the NAMES that can be run (i.e.,
-# supports --version).  If found, set ENVVAR to the program name,
-# die otherwise.
+# otherwise find the first of the NAMES that can be run.
+# If found, set ENVVAR to the program name, die otherwise.
 #
 # FIXME: code duplication, see also gnu-web-doc-update.
 find_tool ()
@@ -223,27 +228,21 @@ find_tool ()
   find_tool_names=$@
   eval "find_tool_res=\$$find_tool_envvar"
   if test x"$find_tool_res" = x; then
-    for i
-    do
-      if ($i --version </dev/null) >/dev/null 2>&1; then
-       find_tool_res=$i
-       break
+    for i; do
+      if check_exists $i; then
+        find_tool_res=$i
+        break
       fi
     done
-  else
-    find_tool_error_prefix="\$$find_tool_envvar: "
   fi
-  test x"$find_tool_res" != x \
-    || die "one of these is required: $find_tool_names"
-  ($find_tool_res --version </dev/null) >/dev/null 2>&1 \
-    || die "${find_tool_error_prefix}cannot run $find_tool_res --version"
+  if test x"$find_tool_res" = x; then
+    warn_ "one of these is required: $find_tool_names;"
+    die   "alternatively set $find_tool_envvar to a compatible tool"
+  fi
   eval "$find_tool_envvar=\$find_tool_res"
   eval "export $find_tool_envvar"
 }
 
-# Find sha1sum, named gsha1sum on MacPorts, and shasum on Mac OS X 10.6.
-find_tool SHA1SUM sha1sum gsha1sum shasum
-
 # Override the default configuration, if necessary.
 # Make sure that bootstrap.conf is sourced from the current directory
 # if we were invoked as "sh bootstrap".
@@ -255,12 +254,12 @@ esac
 # Extra files from gnulib, which override files from other sources.
 test -z "${gnulib_extra_files}" && \
   gnulib_extra_files="
-        $build_aux/install-sh
-        $build_aux/mdate-sh
-        $build_aux/texinfo.tex
-        $build_aux/depcomp
-        $build_aux/config.guess
-        $build_aux/config.sub
+        build-aux/install-sh
+        build-aux/mdate-sh
+        build-aux/texinfo.tex
+        build-aux/depcomp
+        build-aux/config.guess
+        build-aux/config.sub
         doc/INSTALL
 "
 
@@ -325,7 +324,7 @@ insert_if_absent() {
     die "Error: Duplicate entries in $file: " $duplicate_entries
   fi
   linesold=$(gitignore_entries $file | wc -l)
-  linesnew=$(echo "$str" | gitignore_entries - $file | sort -u | wc -l)
+  linesnew=$( { echo "$str"; cat $file; } | gitignore_entries | sort -u | wc -l)
   if [ $linesold != $linesnew ] ; then
     { echo "$str" | cat - $file > $file.bak && mv $file.bak $file; } \
       || die "insert_if_absent $file $str: failed"
@@ -468,8 +467,7 @@ check_versions() {
     if [ "$req_ver" = "-" ]; then
       # Merely require app to exist; not all prereq apps are well-behaved
       # so we have to rely on $? rather than get_version.
-      $app --version >/dev/null 2>&1
-      if [ 126 -le $? ]; then
+      if ! check_exists $app; then
         warn_ "Error: '$app' not found"
         ret=1
       fi
@@ -502,6 +500,12 @@ print_versions() {
   # can't depend on column -t
 }
 
+# Find sha1sum, named gsha1sum on MacPorts, shasum on Mac OS X 10.6.
+# Also find the compatible sha1 utility on the BSDs
+if test x"$SKIP_PO" = x; then
+  find_tool SHA1SUM sha1sum gsha1sum shasum sha1
+fi
+
 use_libtool=0
 # We'd like to use grep -E, to see if any of LT_INIT,
 # AC_PROG_LIBTOOL, AM_PROG_LIBTOOL is used in configure.ac,
@@ -547,13 +551,21 @@ if ! printf "$buildreq" | check_versions; then
   fi
 fi
 
+# Warn the user if autom4te appears to be broken; this causes known
+# issues with at least gettext 0.18.3.
+probe=$(echo 'm4_quote([hi])' | autom4te -l M4sugar -t 'm4_quote:$%' -)
+if test "x$probe" != xhi; then
+  warn_ "WARNING: your autom4te wrapper eats stdin;"
+  warn_ "if bootstrap fails, consider upgrading your autotools"
+fi
+
 echo "$0: Bootstrapping from checked-out $package sources..."
 
 # See if we can use gnulib's git-merge-changelog merge driver.
-if test -d .git && (git --version) >/dev/null 2>/dev/null ; then
+if $use_git && test -d .git && check_exists git; then
   if git config merge.merge-changelog.driver >/dev/null ; then
     :
-  elif (git-merge-changelog --version) >/dev/null 2>/dev/null ; then
+  elif check_exists git-merge-changelog; then
     echo "$0: initializing git-merge-changelog driver"
     git config merge.merge-changelog.name 'GNU-style ChangeLog merge driver'
     git config merge.merge-changelog.driver 'git-merge-changelog %O %A %B'
@@ -573,13 +585,17 @@ git_modules_config () {
   test -f .gitmodules && git config --file .gitmodules "$@"
 }
 
-gnulib_path=$(git_modules_config submodule.gnulib.path)
-test -z "$gnulib_path" && gnulib_path=gnulib
+if $use_git; then
+  gnulib_path=$(git_modules_config submodule.gnulib.path)
+  test -z "$gnulib_path" && gnulib_path=gnulib
+fi
 
-# Get gnulib files.
+# Get gnulib files.  Populate $GNULIB_SRCDIR, possibly updating a
+# submodule, for use in the rest of the script.
 
 case ${GNULIB_SRCDIR--} in
 -)
+  # Note that $use_git is necessarily true in this case.
   if git_modules_config submodule.gnulib.url >/dev/null; then
     echo "$0: getting gnulib files..."
     git submodule init || exit $?
@@ -600,8 +616,8 @@ case ${GNULIB_SRCDIR--} in
   GNULIB_SRCDIR=$gnulib_path
   ;;
 *)
-  # Use GNULIB_SRCDIR as a reference.
-  if test -d "$GNULIB_SRCDIR"/.git && \
+  # Use GNULIB_SRCDIR directly or as a reference.
+  if $use_git && test -d "$GNULIB_SRCDIR"/.git && \
         git_modules_config submodule.gnulib.url >/dev/null; then
     echo "$0: getting gnulib files..."
     if git submodule -h|grep -- --reference > /dev/null; then
@@ -627,12 +643,19 @@ case ${GNULIB_SRCDIR--} in
   ;;
 esac
 
+# $GNULIB_SRCDIR now points to the version of gnulib to use, and
+# we no longer need to use git or $gnulib_path below here.
+
 if $bootstrap_sync; then
   cmp -s "$0" "$GNULIB_SRCDIR/build-aux/bootstrap" || {
     echo "$0: updating bootstrap and restarting..."
+    case $(sh -c 'echo "$1"' -- a) in
+      a) ignored=--;;
+      *) ignored=ignored;;
+    esac
     exec sh -c \
       'cp "$1" "$2" && shift && exec "${CONFIG_SHELL-/bin/sh}" "$@"' \
-      -- "$GNULIB_SRCDIR/build-aux/bootstrap" \
+      $ignored "$GNULIB_SRCDIR/build-aux/bootstrap" \
       "$0" "$@" --no-bootstrap-sync
   }
 fi
@@ -680,11 +703,10 @@ update_po_files() {
     cksum_file="$ref_po_dir/$po.s1"
     if ! test -f "$cksum_file" ||
         ! test -f "$po_dir/$po.po" ||
-        ! $SHA1SUM -c --status "$cksum_file" \
-            < "$new_po" > /dev/null; then
+        ! $SHA1SUM -c "$cksum_file" < "$new_po" > /dev/null 2>&1; then
       echo "$me: updated $po_dir/$po.po..."
       cp "$new_po" "$po_dir/$po.po" \
-          && $SHA1SUM < "$new_po" > "$cksum_file"
+          && $SHA1SUM < "$new_po" > "$cksum_file" || return
     fi
   done
 }
diff --git a/gnulib b/gnulib
index 1aed559..a6c54be 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 1aed559952395ff1eff24263701b349eb77a4e06
+Subproject commit a6c54be167bd5be41013a254b4e6ba840420a1d0
-- 
2.10.1 (Apple Git-78)


From 7bdd6479ce43d6b45803fd0bc4b363370975ceab Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Wed, 3 Sep 2014 15:25:21 -0700
Subject: [PATCH 053/119] diff: fix performance bug with prefix computation

* src/io.c (find_identical_ends): Fix performance bug:
the test for when the prefix was needed messed up by
the 2002-02-28 integer-overflow fixes, causing performance to be
worse than it needed to be.
---
 src/io.c | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/src/io.c b/src/io.c
index 05a898c..1a8b936 100644
--- a/src/io.c
+++ b/src/io.c
@@ -538,6 +538,7 @@ find_identical_ends (struct file_data filevec[])
   lin i, lines;
   size_t n0, n1;
   lin alloc_lines0, alloc_lines1;
+  bool prefix_needed;
   lin buffered_prefix, prefix_count, prefix_mask;
   lin middle_guess, suffix_guess;
 
@@ -687,12 +688,13 @@ find_identical_ends (struct file_data filevec[])
   prefix_mask = prefix_count - 1;
   lines = 0;
   linbuf0 = xmalloc (alloc_lines0 * sizeof *linbuf0);
+  prefix_needed = ! (no_diff_means_no_output
+		     && filevec[0].prefix_end == p0
+		     && filevec[1].prefix_end == p1);
   p0 = buffer0;
 
   /* If the prefix is needed, find the prefix lines.  */
-  if (! (no_diff_means_no_output
-	 && filevec[0].prefix_end == p0
-	 && filevec[1].prefix_end == p1))
+  if (prefix_needed)
     {
       end0 = filevec[0].prefix_end;
       while (p0 != end0)
-- 
2.10.1 (Apple Git-78)


From d2fd9d4683ef60c259a3b426f71cef1b89ff383d Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Wed, 3 Sep 2014 15:58:03 -0700
Subject: [PATCH 054/119] diff: fix bug with diff -B and incomplete lines

Reported by Navin Kabra via Eric Blake in:
http://bugs.gnu.org/18402
* src/util.c (analyze_hunk): Don't mishandle incomplete
lines at end of file.
* tests/no-newline-at-eof: Test for the bug.
---
 src/util.c              | 6 ++++--
 tests/no-newline-at-eof | 6 ++++++
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/src/util.c b/src/util.c
index 016057d..44ce61f 100644
--- a/src/util.c
+++ b/src/util.c
@@ -817,7 +817,8 @@ analyze_hunk (struct change *hunk,
       for (i = next->line0; i <= l0 && trivial; i++)
 	{
 	  char const *line = linbuf0[i];
-	  char const *newline = linbuf0[i + 1] - 1;
+	  char const *lastbyte = linbuf0[i + 1] - 1;
+	  char const *newline = lastbyte + (*lastbyte != '\n');
 	  size_t len = newline - line;
 	  char const *p = line;
 	  if (skip_white_space)
@@ -837,7 +838,8 @@ analyze_hunk (struct change *hunk,
       for (i = next->line1; i <= l1 && trivial; i++)
 	{
 	  char const *line = linbuf1[i];
-	  char const *newline = linbuf1[i + 1] - 1;
+	  char const *lastbyte = linbuf1[i + 1] - 1;
+	  char const *newline = lastbyte + (*lastbyte != '\n');
 	  size_t len = newline - line;
 	  char const *p = line;
 	  if (skip_white_space)
diff --git a/tests/no-newline-at-eof b/tests/no-newline-at-eof
index 14d5f49..f503718 100755
--- a/tests/no-newline-at-eof
+++ b/tests/no-newline-at-eof
@@ -50,4 +50,10 @@ compare exp2 out || fail=1
 # expect empty stderr
 compare /dev/null err || fail=1
 
+# Test for Bug#18402.
+printf a > a
+printf b > b
+diff -B a b > out 2>err
+test $? = 1 || fail=1
+
 Exit $fail
-- 
2.10.1 (Apple Git-78)


From df3af29627a92495a740da13cb8bb0d4fcc1bf84 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Wed, 3 Sep 2014 16:02:35 -0700
Subject: [PATCH 055/119] doc: mention diff -B fix in NEWS

---
 NEWS | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/NEWS b/NEWS
index 58a7cbb..9f388dd 100644
--- a/NEWS
+++ b/NEWS
@@ -13,6 +13,9 @@ GNU diffutils NEWS                                    -*- outline -*-
   consider two Asian file names to be the same merely because they
   contain no English characters.
 
+  diff -B no longer generates incorrect output if the two inputs
+  each end with a one-byte incomplete line.
+
 ** Performance changes
 
   diff's default algorithm has been adjusted to output higher-quality
-- 
2.10.1 (Apple Git-78)


From 1fa6140faacb29e44f2d666c74529ed27b0abb5a Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Mon, 27 Oct 2014 19:53:08 -0700
Subject: [PATCH 056/119] diff: fix integer overflow problem with --tabsize

Reported by Tobias Stoeckmann in: http://bugs.gnu.org/18857
* src/diff.c (main): Don't overflow if INTMAX_MAX / 2 < tabsize.
* tests/bignum: New file, to test for this bug.
* tests/Makefile.am (TESTS): Add it.
---
 src/diff.c        | 15 ++++++++++-----
 tests/Makefile.am |  1 +
 tests/bignum      | 14 ++++++++++++++
 3 files changed, 25 insertions(+), 5 deletions(-)
 create mode 100755 tests/bignum

diff --git a/src/diff.c b/src/diff.c
index 397815e..03f8e4f 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -595,7 +595,8 @@ main (int argc, char **argv)
 
 	case TABSIZE_OPTION:
 	  numval = strtoumax (optarg, &numend, 10);
-	  if (! (0 < numval && numval <= SIZE_MAX) || *numend)
+	  if (! (0 < numval && numval <= SIZE_MAX - GUTTER_WIDTH_MINIMUM)
+	      || *numend)
 	    try_help ("invalid tabsize '%s'", optarg);
 	  if (tabsize != numval)
 	    {
@@ -682,10 +683,14 @@ main (int argc, char **argv)
 		a half line plus a gutter is an integral number of tabs,
 		so that tabs in the right column line up.  */
 
-    intmax_t t = expand_tabs ? 1 : tabsize;
-    intmax_t w = width;
-    intmax_t off = (w + t + GUTTER_WIDTH_MINIMUM) / (2 * t)  *  t;
-    sdiff_half_width = MAX (0, MIN (off - GUTTER_WIDTH_MINIMUM, w - off)),
+    size_t t = expand_tabs ? 1 : tabsize;
+    size_t w = width;
+    size_t t_plus_g = t + GUTTER_WIDTH_MINIMUM;
+    size_t unaligned_off = (w >> 1) + (t_plus_g >> 1) + (w & t_plus_g & 1);
+    size_t off = unaligned_off - unaligned_off % t;
+    sdiff_half_width = (off <= GUTTER_WIDTH_MINIMUM || w <= off
+			? 0
+			: MIN (off - GUTTER_WIDTH_MINIMUM, w - off));
     sdiff_column2_offset = sdiff_half_width ? off : w;
   }
 
diff --git a/tests/Makefile.am b/tests/Makefile.am
index 005d9f0..438fbdf 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -2,6 +2,7 @@
 
 TESTS = \
   basic \
+  bignum \
   binary \
   colliding-file-names \
   excess-slash \
diff --git a/tests/bignum b/tests/bignum
new file mode 100755
index 0000000..a0c95f6
--- /dev/null
+++ b/tests/bignum
@@ -0,0 +1,14 @@
+#!/bin/sh
+# big numbers
+
+. "${srcdir=.}/init.sh"; path_prepend_ ../src
+
+fail=0
+
+for tabsize in 2147483648 9223372036854775808; do
+  diff --tabsize=$tabsize /dev/null /dev/null
+  status=$?
+  test $status -eq 0 || test $status -eq 2 || fail=1
+done
+
+Exit $fail
-- 
2.10.1 (Apple Git-78)


From 3ef90a7e7cc5f318ff7b4e674d717e1cb6dc2d1d Mon Sep 17 00:00:00 2001
From: KO Myung-Hun <komh78@gmail.com>
Date: Tue, 9 Dec 2014 06:49:25 -0800
Subject: [PATCH 057/119] build: double-quote use of $PATH

* man/Makefile.am (dist_man1_MANS): On OS/2, PATH_SEPARATOR is ';',
but unquoted, that is interpreted as the shell's statement
terminator.  Quote it.
---
 man/Makefile.am | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/man/Makefile.am b/man/Makefile.am
index 02cd761..36eb35f 100644
--- a/man/Makefile.am
+++ b/man/Makefile.am
@@ -29,6 +29,6 @@ sdiff.1: $S/sdiff.c sdiff.x
 $(dist_man1_MANS): $(SRC_VERSION_C) help2man
 	$(AM_V_GEN)base=`expr $@ : '\(.*\).1'`				\
 	  && (echo '[NAME]' && sed 's@/\* *@@; s/-/\\-/; q' $S/$$base.c) \
-	     | PATH=..$(PATH_SEPARATOR)$$PATH				\
+	     | PATH="..$(PATH_SEPARATOR)$$PATH"				\
 	       $(srcdir)/help2man -i - -i $(srcdir)/$$base.x		\
 		 -S '$(PACKAGE) $(VERSION)' $$base > $@-t && mv $@-t $@
-- 
2.10.1 (Apple Git-78)


From ecf6a420586272e618652a33074bc38de75052dc Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Tue, 9 Dec 2014 06:51:03 -0800
Subject: [PATCH 058/119] gnulib: update to latest

---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index a6c54be..cc00098 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit a6c54be167bd5be41013a254b4e6ba840420a1d0
+Subproject commit cc0009850129a39e514e00df66a7b5cc3609fb87
-- 
2.10.1 (Apple Git-78)


From ec60c3b6d1754ad88ffd7fc2f00b72ae835f9ca8 Mon Sep 17 00:00:00 2001
From: KO Myung-Hun <komh@chollian.net>
Date: Tue, 15 Jul 2014 11:50:53 +0900
Subject: [PATCH 059/119] diff: skip test if seek is not possible on OS/2 kLIBC

This fixes the problem that 'diff - file' and 'cat file | diff - file'
fail due to a seek failure with a message 'diff.exe: -: Invalid seek',
because seek does not work on stdin and a pipe on OS/2 kLIBC.

* src/io.c (sip): Set skip_test to true if seek is not possible on
OS/2 kLIBC.
---
 src/io.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/io.c b/src/io.c
index 1a8b936..e564f40 100644
--- a/src/io.c
+++ b/src/io.c
@@ -108,6 +108,13 @@ sip (struct file_data *current, bool skip_test)
 				     PTRDIFF_MAX - 2 * sizeof (word));
       current->buffer = xmalloc (current->bufsize);
 
+#ifdef __KLIBC__
+      /* Skip test if seek is not possible */
+      skip_test = skip_test
+		  || (lseek (current->desc, 0, SEEK_CUR) < 0
+		      && errno == ESPIPE);
+#endif
+
       if (! skip_test)
 	{
 	  /* Check first part of file to see if it's a binary file.  */
-- 
2.10.1 (Apple Git-78)


From 29e8de4885e0d9f2b4fd2ed9acc09d4a41267329 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Thu, 1 Jan 2015 22:17:39 -0800
Subject: [PATCH 060/119] maint: update copyright year ranges to include 2015;
 update gnulib

---
 AUTHORS            | 2 +-
 ChangeLog-2008     | 4 ++--
 HACKING            | 2 +-
 Makefile.am        | 3 ++-
 NEWS               | 4 ++--
 README             | 4 ++--
 README-hacking     | 2 +-
 bootstrap          | 2 +-
 bootstrap.conf     | 2 +-
 cfg.mk             | 2 +-
 configure.ac       | 4 ++--
 doc/Makefile.am    | 2 +-
 doc/diffutils.texi | 2 +-
 exgettext          | 3 ++-
 gnulib             | 2 +-
 lib/Makefile.am    | 3 ++-
 lib/cmpbuf.c       | 4 ++--
 lib/cmpbuf.h       | 2 +-
 lib/prepargs.c     | 3 ++-
 man/Makefile.am    | 2 +-
 man/help2man       | 2 +-
 po/POTFILES.in     | 2 +-
 po/en.po           | 2 +-
 src/Makefile.am    | 2 +-
 src/analyze.c      | 2 +-
 src/cmp.c          | 4 ++--
 src/context.c      | 4 ++--
 src/diff.c         | 2 +-
 src/diff.h         | 4 ++--
 src/diff3.c        | 4 ++--
 src/dir.c          | 2 +-
 src/ed.c           | 4 ++--
 src/ifdef.c        | 2 +-
 src/io.c           | 4 ++--
 src/normal.c       | 2 +-
 src/sdiff.c        | 4 ++--
 src/side.c         | 4 ++--
 src/system.h       | 4 ++--
 src/util.c         | 4 ++--
 tests/help-version | 2 +-
 tests/init.sh      | 2 +-
 41 files changed, 60 insertions(+), 56 deletions(-)

diff --git a/AUTHORS b/AUTHORS
index d091302..0c6b0f4 100644
--- a/AUTHORS
+++ b/AUTHORS
@@ -33,7 +33,7 @@ Patrick D'Cruze
 Eli Zaretskii
 
 
-Copyright (C) 2001, 2006, 2009-2013 Free Software Foundation, Inc.
+Copyright (C) 2001, 2006, 2009-2013, 2015 Free Software Foundation, Inc.
 
 This file is part of GNU diffutils.
 
diff --git a/ChangeLog-2008 b/ChangeLog-2008
index 5238b63..9945407 100644
--- a/ChangeLog-2008
+++ b/ChangeLog-2008
@@ -4265,8 +4265,8 @@ Thu Nov  3 16:30:24 1988  Randall Smith  (randy at gluteus.ai.mit.edu)
 
 	-----
 
-	Copyright (C) 1988-1994, 1997-2002, 2004, 2006, 2009-2013 Free Software
-	Foundation, Inc.
+	Copyright (C) 1988-1994, 1997-2002, 2004, 2006, 2009-2013, 2015 Free
+	Software Foundation, Inc.
 
 	Copying and distribution of this file, with or without
 	modification, are permitted provided the copyright notice and this
diff --git a/HACKING b/HACKING
index 13122ef..80633a5 100644
--- a/HACKING
+++ b/HACKING
@@ -581,7 +581,7 @@ Then just open the index.html file (in the generated lcov-html directory)
 in your favorite web browser.
 
 ========================================================================
-Copyright (C) 2009-2013 Free Software Foundation, Inc.
+Copyright (C) 2009-2013, 2015 Free Software Foundation, Inc.
 
 Permission is granted to copy, distribute and/or modify this document
 under the terms of the GNU Free Documentation License, Version 1.3 or
diff --git a/Makefile.am b/Makefile.am
index cf0ce1d..7a1f431 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -1,6 +1,7 @@
 # Main Automakefile for GNU diffutils.
 
-# Copyright (C) 2001-2002, 2004, 2006, 2009-2013 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2004, 2006, 2009-2013, 2015 Free Software
+# Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/NEWS b/NEWS
index 9f388dd..7cdfedd 100644
--- a/NEWS
+++ b/NEWS
@@ -353,8 +353,8 @@ User-visible changes in version 2.0:
 
 
 
-Copyright (C) 1993-1994, 1998, 2001-2002, 2004, 2006, 2009-2013 Free Software
-Foundation, Inc.
+Copyright (C) 1993-1994, 1998, 2001-2002, 2004, 2006, 2009-2013, 2015 Free
+Software Foundation, Inc.
 
 This file is part of GNU Diffutils.
 
diff --git a/README b/README
index f6c2641..1317dfa 100644
--- a/README
+++ b/README
@@ -51,8 +51,8 @@ Please report bugs to <bug-diffutils@gnu.org>.
 
 -----
 
-Copyright (C) 1992, 1998, 2001-2002, 2004, 2009-2013 Free Software Foundation,
-Inc.
+Copyright (C) 1992, 1998, 2001-2002, 2004, 2009-2013, 2015 Free Software
+Foundation, Inc.
 
 This file is part of GNU Diffutils.
 
diff --git a/README-hacking b/README-hacking
index 530ef09..24f2a3f 100644
--- a/README-hacking
+++ b/README-hacking
@@ -94,7 +94,7 @@ each program.  One way to do this is to use vc-dwim
 
 -----
 
-Copyright (C) 2002-2007, 2009-2013 Free Software Foundation, Inc.
+Copyright (C) 2002-2007, 2009-2013, 2015 Free Software Foundation, Inc.
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
diff --git a/bootstrap b/bootstrap
index ce90bc4..7d3aa5b 100755
--- a/bootstrap
+++ b/bootstrap
@@ -4,7 +4,7 @@ scriptversion=2013-12-05.23; # UTC
 
 # Bootstrap this package from checked-out sources.
 
-# Copyright (C) 2003-2014 Free Software Foundation, Inc.
+# Copyright (C) 2003-2015 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/bootstrap.conf b/bootstrap.conf
index ac85adf..9b2de22 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -1,6 +1,6 @@
 # Bootstrap configuration.
 
-# Copyright (C) 2006-2013 Free Software Foundation, Inc.
+# Copyright (C) 2006-2013, 2015 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/cfg.mk b/cfg.mk
index d37bea9..510bf8a 100644
--- a/cfg.mk
+++ b/cfg.mk
@@ -1,5 +1,5 @@
 # Customize maint.mk                           -*- makefile -*-
-# Copyright (C) 2003-2013 Free Software Foundation, Inc.
+# Copyright (C) 2003-2013, 2015 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/configure.ac b/configure.ac
index f7efcb1..667ad61 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1,7 +1,7 @@
 # Configure template for GNU Diffutils.
 
-# Copyright (C) 1994-1995, 1998, 2001-2002, 2004, 2006, 2009-2013 Free Software
-# Foundation, Inc.
+# Copyright (C) 1994-1995, 1998, 2001-2002, 2004, 2006, 2009-2013, 2015 Free
+# Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/doc/Makefile.am b/doc/Makefile.am
index 286f7a4..641fc96 100644
--- a/doc/Makefile.am
+++ b/doc/Makefile.am
@@ -1,6 +1,6 @@
 # Makefile for GNU diffutils documentation.
 
-# Copyright (C) 2001-2002, 2009-2013 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2009-2013, 2015 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 5e84ff7..3e25807 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -14,7 +14,7 @@ and documents the @acronym{GNU} @command{diff}, @command{diff3},
 differences between files and the @acronym{GNU} @command{patch} command for
 using their output to update files.
 
-Copyright @copyright{} 1992-1994, 1998, 2001-2002, 2004, 2006, 2009-2014 Free
+Copyright @copyright{} 1992-1994, 1998, 2001-2002, 2004, 2006, 2009-2015 Free
 Software Foundation, Inc.
 
 @quotation
diff --git a/exgettext b/exgettext
index c81941a..19fbdb8 100755
--- a/exgettext
+++ b/exgettext
@@ -1,7 +1,8 @@
 #! /bin/sh
 # Wrapper around gettext for programs using the msgid convention.
 
-# Copyright (C) 1998, 2001, 2004, 2009-2013 Free Software Foundation, Inc.
+# Copyright (C) 1998, 2001, 2004, 2009-2013, 2015 Free Software Foundation,
+# Inc.
 
 # Written by Paul Eggert <eggert@twinsun.com>.
 
diff --git a/gnulib b/gnulib
index cc00098..aecd387 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit cc0009850129a39e514e00df66a7b5cc3609fb87
+Subproject commit aecd38787af5ca0000e184912194e8c83123eb7f
diff --git a/lib/Makefile.am b/lib/Makefile.am
index 2e98878..b8c6eb6 100644
--- a/lib/Makefile.am
+++ b/lib/Makefile.am
@@ -1,6 +1,7 @@
 # Automakefile for GNU Diffutils library.
 
-# Copyright (C) 2001-2002, 2004, 2006, 2009-2013 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2004, 2006, 2009-2013, 2015 Free Software
+# Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/lib/cmpbuf.c b/lib/cmpbuf.c
index a47cb70..498b43a 100644
--- a/lib/cmpbuf.c
+++ b/lib/cmpbuf.c
@@ -1,7 +1,7 @@
 /* Buffer primitives for comparison operations.
 
-   Copyright (C) 1993, 1995, 1998, 2001-2002, 2006, 2009-2013 Free Software
-   Foundation, Inc.
+   Copyright (C) 1993, 1995, 1998, 2001-2002, 2006, 2009-2013, 2015 Free
+   Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/lib/cmpbuf.h b/lib/cmpbuf.h
index 732d7ab..ecd2e21 100644
--- a/lib/cmpbuf.h
+++ b/lib/cmpbuf.h
@@ -1,6 +1,6 @@
 /* Buffer primitives for comparison operations.
 
-   Copyright (C) 2002, 2009-2013 Free Software Foundation, Inc.
+   Copyright (C) 2002, 2009-2013, 2015 Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/lib/prepargs.c b/lib/prepargs.c
index ec19a08..285ad2b 100644
--- a/lib/prepargs.c
+++ b/lib/prepargs.c
@@ -1,6 +1,7 @@
 /* Parse arguments from a string and prepend them to an argv.
 
-   Copyright (C) 1999-2002, 2006, 2009-2013 Free Software Foundation, Inc.
+   Copyright (C) 1999-2002, 2006, 2009-2013, 2015 Free Software Foundation,
+   Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/man/Makefile.am b/man/Makefile.am
index 36eb35f..fd136d2 100644
--- a/man/Makefile.am
+++ b/man/Makefile.am
@@ -1,6 +1,6 @@
 # Automakefile for GNU diffutils man pages
 
-# Copyright (C) 2002, 2009-2013 Free Software Foundation, Inc.
+# Copyright (C) 2002, 2009-2013, 2015 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/man/help2man b/man/help2man
index 834b5ee..7c92fb5 100755
--- a/man/help2man
+++ b/man/help2man
@@ -1,7 +1,7 @@
 #!/usr/bin/perl -w
 
 # Generate a short man page from --help and --version output.
-# Copyright (C) 1997-2005, 2009-2011, 2013 Free Software Foundation, Inc.
+# Copyright (C) 1997-2005, 2009-2011, 2013, 2015 Free Software Foundation, Inc.
 
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/po/POTFILES.in b/po/POTFILES.in
index b6764e6..74fb756 100644
--- a/po/POTFILES.in
+++ b/po/POTFILES.in
@@ -1,6 +1,6 @@
 # List of files that contain translatable strings.
 
-# Copyright (C) 2001-2002, 2009-2013 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2009-2013, 2015 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/po/en.po b/po/en.po
index 6ebf25b..2f44c2f 100644
--- a/po/en.po
+++ b/po/en.po
@@ -1,5 +1,5 @@
 # English messages for GNU diffutils
-# Copyright 1998, 2001-2003, 2009-2013 Free Software Foundation, Inc.
+# Copyright 1998, 2001-2003, 2009-2013, 2015 Free Software Foundation, Inc.
 # Paul Eggert <eggert@twinsun.com>, 1998
 #
 msgid ""
diff --git a/src/Makefile.am b/src/Makefile.am
index 99fbfcc..ca2d25c 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -1,6 +1,6 @@
 # Automakefile for GNU diffutils programs.
 
-# Copyright (C) 2001-2002, 2006, 2009-2013 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2006, 2009-2013, 2015 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/src/analyze.c b/src/analyze.c
index f062fd3..893d07c 100644
--- a/src/analyze.c
+++ b/src/analyze.c
@@ -1,7 +1,7 @@
 /* Analyze file differences for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2013 Free Software Foundation, Inc.
+   2009-2013, 2015 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/cmp.c b/src/cmp.c
index 9e35b07..87ee7be 100644
--- a/src/cmp.c
+++ b/src/cmp.c
@@ -1,7 +1,7 @@
 /* cmp - compare two files byte by byte
 
-   Copyright (C) 1990-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013 Free
-   Software Foundation, Inc.
+   Copyright (C) 1990-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013, 2015
+   Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/src/context.c b/src/context.c
index 32053d1..e0f21c4 100644
--- a/src/context.c
+++ b/src/context.c
@@ -1,7 +1,7 @@
 /* Context-format output routines for GNU DIFF.
 
-   Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2006, 2009-2013
-   Free Software Foundation, Inc.
+   Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
+   2015 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/diff.c b/src/diff.c
index 03f8e4f..ff28377 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -1,7 +1,7 @@
 /* diff - compare files line by line
 
    Copyright (C) 1988-1989, 1992-1994, 1996, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2013 Free Software Foundation, Inc.
+   2009-2013, 2015 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/diff.h b/src/diff.h
index e9f0471..465e4bc 100644
--- a/src/diff.h
+++ b/src/diff.h
@@ -1,7 +1,7 @@
 /* Shared definitions for GNU DIFF
 
-   Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2009-2013 Free
-   Software Foundation, Inc.
+   Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2009-2013, 2015
+   Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/diff3.c b/src/diff3.c
index e25ef5d..26a95ea 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -1,7 +1,7 @@
 /* diff3 - compare three files line by line
 
-   Copyright (C) 1988-1989, 1992-1996, 1998, 2001-2002, 2004, 2006, 2009-2013
-   Free Software Foundation, Inc.
+   Copyright (C) 1988-1989, 1992-1996, 1998, 2001-2002, 2004, 2006, 2009-2013,
+   2015 Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/src/dir.c b/src/dir.c
index d3b0a2d..f34e83d 100644
--- a/src/dir.c
+++ b/src/dir.c
@@ -1,7 +1,7 @@
 /* Read, sort and compare two directories.  Used for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2013 Free Software Foundation, Inc.
+   2009-2013, 2015 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/ed.c b/src/ed.c
index 6a884df..cb74f24 100644
--- a/src/ed.c
+++ b/src/ed.c
@@ -1,7 +1,7 @@
 /* Output routines for ed-script format.
 
-   Copyright (C) 1988-1989, 1991-1993, 1995, 1998, 2001, 2004, 2006, 2009-2013
-   Free Software Foundation, Inc.
+   Copyright (C) 1988-1989, 1991-1993, 1995, 1998, 2001, 2004, 2006, 2009-2013,
+   2015 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/ifdef.c b/src/ifdef.c
index 34a5175..c41f0aa 100644
--- a/src/ifdef.c
+++ b/src/ifdef.c
@@ -1,6 +1,6 @@
 /* #ifdef-format output routines for GNU DIFF.
 
-   Copyright (C) 1989, 1991-1994, 2001-2002, 2004, 2006, 2009-2013 Free
+   Copyright (C) 1989, 1991-1994, 2001-2002, 2004, 2006, 2009-2013, 2015 Free
    Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/io.c b/src/io.c
index e564f40..1aab782 100644
--- a/src/io.c
+++ b/src/io.c
@@ -1,7 +1,7 @@
 /* File I/O for GNU DIFF.
 
-   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013
-   Free Software Foundation, Inc.
+   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
+   2015 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/normal.c b/src/normal.c
index ea9de57..721fd1a 100644
--- a/src/normal.c
+++ b/src/normal.c
@@ -1,6 +1,6 @@
 /* Normal-format output routines for GNU DIFF.
 
-   Copyright (C) 1988-1989, 1993, 1995, 1998, 2001, 2006, 2009-2013 Free
+   Copyright (C) 1988-1989, 1993, 1995, 1998, 2001, 2006, 2009-2013, 2015 Free
    Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/sdiff.c b/src/sdiff.c
index 329fa52..1c66beb 100644
--- a/src/sdiff.c
+++ b/src/sdiff.c
@@ -1,7 +1,7 @@
 /* sdiff - side-by-side merge of file differences
 
-   Copyright (C) 1992-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013 Free
-   Software Foundation, Inc.
+   Copyright (C) 1992-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013, 2015
+   Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/side.c b/src/side.c
index 284d960..155512c 100644
--- a/src/side.c
+++ b/src/side.c
@@ -1,7 +1,7 @@
 /* sdiff-format output routines for GNU DIFF.
 
-   Copyright (C) 1991-1993, 1998, 2001-2002, 2004, 2009-2013 Free Software
-   Foundation, Inc.
+   Copyright (C) 1991-1993, 1998, 2001-2002, 2004, 2009-2013, 2015 Free
+   Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/system.h b/src/system.h
index 1f81a72..19a1f3a 100644
--- a/src/system.h
+++ b/src/system.h
@@ -1,7 +1,7 @@
 /* System dependent declarations.
 
-   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013
-   Free Software Foundation, Inc.
+   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
+   2015 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/util.c b/src/util.c
index 44ce61f..2d6d3fc 100644
--- a/src/util.c
+++ b/src/util.c
@@ -1,7 +1,7 @@
 /* Support routines for GNU DIFF.
 
-   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013
-   Free Software Foundation, Inc.
+   Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
+   2015 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/tests/help-version b/tests/help-version
index 36ea213..5f01f76 100755
--- a/tests/help-version
+++ b/tests/help-version
@@ -2,7 +2,7 @@
 # Make sure all these programs work properly
 # when invoked with --help or --version.
 
-# Copyright (C) 2000-2013 Free Software Foundation, Inc.
+# Copyright (C) 2000-2013, 2015 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/tests/init.sh b/tests/init.sh
index bd2048e..671f802 100644
--- a/tests/init.sh
+++ b/tests/init.sh
@@ -1,6 +1,6 @@
 # source this file; set up for tests
 
-# Copyright (C) 2009-2013 Free Software Foundation, Inc.
+# Copyright (C) 2009-2013, 2015 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
-- 
2.10.1 (Apple Git-78)


From 5801f8add854c842e8065225d261f459089d7ac8 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Fri, 10 Jul 2015 09:55:43 -0700
Subject: [PATCH 061/119] doc: --no-dereference: improve wording/description

* doc/diffutils.texi (Comparing Directories): Correct grammar.
(diff Options) [--no-dereference]: Say a little more.
---
 doc/diffutils.texi | 9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 3e25807..091257f 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -1848,12 +1848,9 @@ is specified while the @option{--ignore-file-name-case} option is in
 effect, case is ignored when excluding file names matching the
 specified patterns.
 
-To avoid that @command{diff} follows symbolic links, use the
+To tell @command{diff} not to follow a symbolic link, use the
 @c later: @option{--no-dereference} (@option{-P}).
-@option{--no-dereference}.
-When this option is in use,
-symbolic links will be treated like a special kind of files, rather than
-comparing the target of each symbolic link.
+@option{--no-dereference} option.
 
 @node Adjusting Output
 @chapter Making @command{diff} Output Prettier
@@ -3857,6 +3854,8 @@ if-then-else format.  @xref{Line Formats}.
 
 @item --no-dereference
 Act on symbolic links themselves instead of what they point to.
+Two symbolic links are deemed equal only when each points to
+precisely the same name.
 
 @item --old-group-format=@var{format}
 Use @var{format} to output a group of lines taken from just the first
-- 
2.10.1 (Apple Git-78)


From 2cd4ff3a5ff52d89b6b992d158f389b757f4faf4 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Mon, 31 Aug 2015 23:12:43 -0700
Subject: [PATCH 062/119] build: correct man-page generation rule
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The PATH was set incorrectly, so that the diff used by
help2man was the one from $PATH, rather than the just-built
one.
* man/Makefile.am (bin_dir): New variable, to...
(dist_man1_MANS): ...prepend ../src to PATH, not just "..".
Also, add a test to ensure that each $(bin_dir)/$$base is
executable, so this doesn't happen again.
In http://debbugs.gnu.org/21023, Rodrigo Valia
Gutirrez reported that diff.1 from the diffutils-3.3 tarball
contained no description of the then-new --no-dereference option.
---
 man/Makefile.am | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/man/Makefile.am b/man/Makefile.am
index fd136d2..de55e00 100644
--- a/man/Makefile.am
+++ b/man/Makefile.am
@@ -25,10 +25,15 @@ diff.1: $S/diff.c diff.x
 diff3.1: $S/diff3.c diff3.x
 sdiff.1: $S/sdiff.c sdiff.x
 
+# Directory in which just-built programs reside.  It is used
+# to ensure help2man invokes them via the use of PATH below.
+bin_dir = ../src
+
 # Depend on the former to get version number changes.
 $(dist_man1_MANS): $(SRC_VERSION_C) help2man
 	$(AM_V_GEN)base=`expr $@ : '\(.*\).1'`				\
+	  && test -x $(bin_dir)/$$base					\
 	  && (echo '[NAME]' && sed 's@/\* *@@; s/-/\\-/; q' $S/$$base.c) \
-	     | PATH="..$(PATH_SEPARATOR)$$PATH"				\
+	     | PATH="$(bin_dir)$(PATH_SEPARATOR)$$PATH"			\
 	       $(srcdir)/help2man -i - -i $(srcdir)/$$base.x		\
 		 -S '$(PACKAGE) $(VERSION)' $$base > $@-t && mv $@-t $@
-- 
2.10.1 (Apple Git-78)


From b4efca9de418c0166f0b106fef068a594b4ab483 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andreas=20Gr=C3=BCnbacher?= <agruen@gnu.org>
Date: Thu, 24 Sep 2015 07:36:31 -0700
Subject: [PATCH 063/119] diff: Improve help text of option --label

* src/diff.c (option_help_msgid): Improve help text of option --label.
---
 src/diff.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/diff.c b/src/diff.c
index ff28377..efd7e47 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -871,7 +871,7 @@ static char const * const option_help_msgid[] = {
   "",
   N_("-p, --show-c-function         show which C function each change is in"),
   N_("-F, --show-function-line=RE   show the most recent line matching RE"),
-  N_("    --label LABEL             use LABEL instead of file name\n"
+  N_("    --label LABEL             use LABEL instead of file name and timestamp\n"
      "                                (can be repeated)"),
   "",
   N_("-t, --expand-tabs             expand tabs to spaces in output"),
-- 
2.10.1 (Apple Git-78)


From c0fa19fe92da71404f809aafb5f51cfd99b1bee2 Mon Sep 17 00:00:00 2001
From: Giuseppe Scrivano <gscrivano@gnu.org>
Date: Sun, 8 Mar 2015 22:45:11 +0100
Subject: [PATCH 064/119] diff: add support for --color

* doc/diffutils.texi (diff Options): Add documentation for --color.
Copied from coreutils ls --color.
* src/context.c (pr_unidiff_hunk): Set the color context.
(print_context_header): Likewise.
(pr_context_hunk): Likewise.
* src/diff.h (enum colors_style): New enum to record when to use colors.
(colors_style): New variable to memorize the argument value.
(set_color_context): Add function definition.
* src/diff.c: : Define COLOR_OPTION.
(specify_colors_style): New function.
(longopts): Add --color.
(main): Handle --color argument.
(option_help_msgid): Add usage string for --color.
* src/normal.c (print_normal_hunk): Set the color context.
* src/side.c (print_1sdiff_line): Likewise.
* src/util.c (print_1_line_nl): New function.
(print_1_line): Make it a wrapper of 'print_1_line_nl'.
(colors_enabled): New boolean variable.
(begin_output): Call check_color_output once the output file is
configured.
(output_1_line): Periodically call `process_signals'.
(caught_signals): New sigset_t.
(colors_enabled): New boolean variable.
(interrupt_signal): New sig_atomic_t.
(stop_signal_count): New sig_atomic_t.
(check_color_output): New function.
(install_signal_handlers): Likewise. Copied from coreutils ls.
(process_signals): Likewise.  Copied from coreutils ls.
(set_color_context): New function.
(sighandler): Likewise.  Copied from coreutils ls.
(stophandler): Likewise.  Copied from coreutils ls.
---
 doc/diffutils.texi |  21 ++++
 src/context.c      |  81 ++++++++++---
 src/diff.c         |  27 ++++-
 src/diff.h         |  28 +++++
 src/normal.c       |  30 ++++-
 src/side.c         |  15 +++
 src/util.c         | 327 +++++++++++++++++++++++++++++++++++++++++++++++------
 7 files changed, 471 insertions(+), 58 deletions(-)

diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 091257f..b2c39da 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -3742,6 +3742,27 @@ Read and write data in binary mode.  @xref{Binary}.
 Use the context output format, showing three lines of context.
 @xref{Context Format}.
 
+@item --color [=@var{when}]
+@cindex color, distinguishing different context
+Specify whether to use color for distinguishing different contexts,
+like header, added or removed lines.  @var{when} may be omitted, or
+one of:
+@itemize @bullet
+@item none
+@vindex none @r{color option}
+Do not use color at all.  This is the default when no --color option
+is specified.
+@item auto
+@vindex auto @r{color option}
+@cindex terminal, using color iff
+Use color only if standard output is a terminal.
+@item always
+@vindex always @r{color option}
+Always use color.
+@end itemize
+Specifying @option{--color} and no @var{when} is equivalent to
+@option{--color=auto}.
+
 @item -C @var{lines}
 @itemx --context@r{[}=@var{lines}@r{]}
 Use the context output format, showing @var{lines} (an integer) lines of
diff --git a/src/context.c b/src/context.c
index e0f21c4..46b5b1f 100644
--- a/src/context.c
+++ b/src/context.c
@@ -80,6 +80,7 @@ print_context_label (char const *mark,
 void
 print_context_header (struct file_data inf[], char const *const *names, bool unidiff)
 {
+  set_color_context (HEADER_CONTEXT);
   if (unidiff)
     {
       print_context_label ("---", &inf[0], names[0], file_label[0]);
@@ -90,6 +91,7 @@ print_context_header (struct file_data inf[], char const *const *names, bool uni
       print_context_label ("***", &inf[0], names[0], file_label[0]);
       print_context_label ("---", &inf[1], names[1], file_label[1]);
     }
+  set_color_context (RESET_CONTEXT);
 }
 
 /* Print an edit script in context format.  */
@@ -205,14 +207,21 @@ pr_context_hunk (struct change *hunk)
   if (function)
     print_context_function (out, function);
 
-  fputs ("\n*** ", out);
+  putc ('\n', out);
+  set_color_context (LINE_NUMBER_CONTEXT);
+  fputs ("*** ", out);
   print_context_number_range (&files[0], first0, last0);
-  fputs (" ****\n", out);
+  fputs (" ****", out);
+  set_color_context (RESET_CONTEXT);
+  putc ('\n', out);
 
   if (changes & OLD)
     {
       struct change *next = hunk;
 
+      if (first0 <= last0)
+        set_color_context (DELETE_CONTEXT);
+
       for (i = first0; i <= last0; i++)
 	{
 	  /* Skip past changes that apply (in file 0)
@@ -225,23 +234,34 @@ pr_context_hunk (struct change *hunk)
 
 	  prefix = " ";
 	  if (next && next->line0 <= i)
-	    /* The change NEXT covers this line.
-	       If lines were inserted here in file 1, this is "changed".
-	       Otherwise it is "deleted".  */
-	    prefix = (next->inserted > 0 ? "!" : "-");
-
-	  print_1_line (prefix, &files[0].linbuf[i]);
+            {
+              /* The change NEXT covers this line.
+                 If lines were inserted here in file 1, this is "changed".
+                 Otherwise it is "deleted".  */
+              prefix = (next->inserted > 0 ? "!" : "-");
+            }
+	  print_1_line_nl (prefix, &files[0].linbuf[i], true);
+          if (i == last0)
+            set_color_context (RESET_CONTEXT);
+          if (files[0].linbuf[i + 1][-1] == '\n')
+            putc ('\n', out);
 	}
     }
 
+  set_color_context (LINE_NUMBER_CONTEXT);
   fputs ("--- ", out);
   print_context_number_range (&files[1], first1, last1);
-  fputs (" ----\n", out);
+  fputs (" ----", out);
+  set_color_context (RESET_CONTEXT);
+  putc ('\n', out);
 
   if (changes & NEW)
     {
       struct change *next = hunk;
 
+      if (first1 <= last1)
+        set_color_context (ADD_CONTEXT);
+
       for (i = first1; i <= last1; i++)
 	{
 	  /* Skip past changes that apply (in file 1)
@@ -254,12 +274,17 @@ pr_context_hunk (struct change *hunk)
 
 	  prefix = " ";
 	  if (next && next->line1 <= i)
-	    /* The change NEXT covers this line.
-	       If lines were deleted here in file 0, this is "changed".
-	       Otherwise it is "inserted".  */
-	    prefix = (next->deleted > 0 ? "!" : "+");
-
-	  print_1_line (prefix, &files[1].linbuf[i]);
+            {
+              /* The change NEXT covers this line.
+                 If lines were deleted here in file 0, this is "changed".
+                 Otherwise it is "inserted".  */
+              prefix = (next->deleted > 0 ? "!" : "+");
+            }
+	  print_1_line_nl (prefix, &files[1].linbuf[i], true);
+          if (i == last1)
+            set_color_context (RESET_CONTEXT);
+          if (files[1].linbuf[i + 1][-1] == '\n')
+            putc ('\n', out);
 	}
     }
 }
@@ -330,11 +355,13 @@ pr_unidiff_hunk (struct change *hunk)
   begin_output ();
   out = outfile;
 
+  set_color_context (LINE_NUMBER_CONTEXT);
   fputs ("@@ -", out);
   print_unidiff_number_range (&files[0], first0, last0);
   fputs (" +", out);
   print_unidiff_number_range (&files[1], first1, last1);
   fputs (" @@", out);
+  set_color_context (RESET_CONTEXT);
 
   if (function)
     print_context_function (out, function);
@@ -363,25 +390,43 @@ pr_unidiff_hunk (struct change *hunk)
 	  /* For each difference, first output the deleted part. */
 
 	  k = next->deleted;
+          if (k)
+            set_color_context (DELETE_CONTEXT);
+
 	  while (k--)
 	    {
 	      char const * const *line = &files[0].linbuf[i++];
 	      putc ('-', out);
 	      if (initial_tab && ! (suppress_blank_empty && **line == '\n'))
 		putc ('\t', out);
-	      print_1_line (NULL, line);
+	      print_1_line_nl (NULL, line, true);
+
+              if (!k)
+                set_color_context (RESET_CONTEXT);
+
+              if (line[1][-1] == '\n')
+                putc ('\n', out);
 	    }
 
 	  /* Then output the inserted part. */
 
 	  k = next->inserted;
-	  while (k--)
+          if (k)
+            set_color_context (ADD_CONTEXT);
+
+          while (k--)
 	    {
 	      char const * const *line = &files[1].linbuf[j++];
 	      putc ('+', out);
 	      if (initial_tab && ! (suppress_blank_empty && **line == '\n'))
 		putc ('\t', out);
-	      print_1_line (NULL, line);
+	      print_1_line_nl (NULL, line, true);
+
+              if (!k)
+                set_color_context (RESET_CONTEXT);
+
+              if (line[1][-1] == '\n')
+                putc ('\n', out);
 	    }
 
 	  /* We're done with this hunk, so on to the next! */
diff --git a/src/diff.c b/src/diff.c
index efd7e47..536f545 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -70,6 +70,7 @@ static void add_regexp (struct regexp_list *, char const *);
 static void summarize_regexp_list (struct regexp_list *);
 static void specify_style (enum output_style);
 static void specify_value (char const **, char const *, char const *);
+static void specify_colors_style (char const *);
 static void try_help (char const *, char const *) __attribute__((noreturn));
 static void check_stdout (void);
 static void usage (void);
@@ -136,7 +137,9 @@ enum
   UNCHANGED_GROUP_FORMAT_OPTION,
   OLD_GROUP_FORMAT_OPTION,
   NEW_GROUP_FORMAT_OPTION,
-  CHANGED_GROUP_FORMAT_OPTION
+  CHANGED_GROUP_FORMAT_OPTION,
+
+  COLOR_OPTION,
 };
 
 static char const group_format_option[][sizeof "--unchanged-group-format"] =
@@ -159,6 +162,7 @@ static struct option const longopts[] =
   {"binary", 0, 0, BINARY_OPTION},
   {"brief", 0, 0, 'q'},
   {"changed-group-format", 1, 0, CHANGED_GROUP_FORMAT_OPTION},
+  {"color", 2, 0, COLOR_OPTION},
   {"context", 2, 0, 'C'},
   {"ed", 0, 0, 'e'},
   {"exclude", 1, 0, 'x'},
@@ -627,6 +631,10 @@ main (int argc, char **argv)
 	  specify_value (&group_format[c], optarg, group_format_option[c]);
 	  break;
 
+	case COLOR_OPTION:
+	  specify_colors_style (optarg);
+	  break;
+
 	default:
 	  try_help (NULL, NULL);
 	}
@@ -940,6 +948,8 @@ static char const * const option_help_msgid[] = {
   N_("-d, --minimal            try hard to find a smaller set of changes"),
   N_("    --horizon-lines=NUM  keep NUM lines of the common prefix and suffix"),
   N_("    --speed-large-files  assume large files and many scattered small changes"),
+  N_("    --color[=WHEN]       colorize the output; WHEN can be 'never', 'always',"),
+  N_("                           or 'auto' (the default)"),
   "",
   N_("    --help               display this help and exit"),
   N_("-v, --version            output version information and exit"),
@@ -1008,6 +1018,21 @@ specify_style (enum output_style style)
       output_style = style;
     }
 }
+
+/* Set the color mode.  */
+static void
+specify_colors_style (char const *value)
+{
+  if (value == NULL || STREQ (value, "auto"))
+    colors_style = AUTO;
+  else if (STREQ (value, "always"))
+    colors_style = ALWAYS;
+  else if (STREQ (value, "never"))
+    colors_style = NEVER;
+  else
+    try_help ("invalid color '%s'", value);
+}
+
 
 /* Set the last-modified time of *ST to be the current time.  */
 
diff --git a/src/diff.h b/src/diff.h
index 465e4bc..7bf7344 100644
--- a/src/diff.h
+++ b/src/diff.h
@@ -38,6 +38,19 @@ enum changes
   /* Both deletes and inserts: a hunk containing both old and new lines.  */
   CHANGED
 };
+
+/* When colors should be used in the output.  */
+enum colors_style
+{
+  /* Never output colors.  */
+  NEVER,
+
+  /* Output colors if the output is a terminal.  */
+  AUTO,
+
+  /* Always output colors.  */
+  ALWAYS,
+};
 
 /* Variables for command line options */
 
@@ -83,6 +96,9 @@ enum output_style
 
 XTERN enum output_style output_style;
 
+/* Define the current color context used to print a line.  */
+XTERN enum colors_style colors_style;
+
 /* Nonzero if output cannot be generated for identical files.  */
 XTERN bool no_diff_means_no_output;
 
@@ -383,6 +399,7 @@ extern void output_1_line (char const *, char const *, char const *,
 extern void perror_with_name (char const *);
 extern void pfatal_with_name (char const *) __attribute__((noreturn));
 extern void print_1_line (char const *, char const * const *);
+extern void print_1_line_nl (char const *, char const * const *, bool);
 extern void print_message_queue (void);
 extern void print_number_range (char, struct file_data *, lin, lin);
 extern void print_script (struct change *, struct change * (*) (struct change *),
@@ -390,3 +407,14 @@ extern void print_script (struct change *, struct change * (*) (struct change *)
 extern void setup_output (char const *, char const *, bool);
 extern void translate_range (struct file_data const *, lin, lin,
                              long int *, long int *);
+
+enum color_context
+{
+  HEADER_CONTEXT,
+  ADD_CONTEXT,
+  DELETE_CONTEXT,
+  RESET_CONTEXT,
+  LINE_NUMBER_CONTEXT,
+};
+
+extern void set_color_context (enum color_context color_context);
diff --git a/src/normal.c b/src/normal.c
index 721fd1a..e78e8ba 100644
--- a/src/normal.c
+++ b/src/normal.c
@@ -49,21 +49,43 @@ print_normal_hunk (struct change *hunk)
   begin_output ();
 
   /* Print out the line number header for this hunk */
+  set_color_context (LINE_NUMBER_CONTEXT);
   print_number_range (',', &files[0], first0, last0);
   fputc (change_letter[changes], outfile);
   print_number_range (',', &files[1], first1, last1);
+  set_color_context (RESET_CONTEXT);
   fputc ('\n', outfile);
 
   /* Print the lines that the first file has.  */
   if (changes & OLD)
-    for (i = first0; i <= last0; i++)
-      print_1_line ("<", &files[0].linbuf[i]);
+    {
+      if (first0 <= last0)
+        set_color_context (DELETE_CONTEXT);
+      for (i = first0; i <= last0; i++)
+        {
+          print_1_line_nl ("<", &files[0].linbuf[i], true);
+          if (i == last0)
+            set_color_context (RESET_CONTEXT);
+          if (files[0].linbuf[i + 1][-1] == '\n')
+            putc ('\n', outfile);
+        }
+    }
 
   if (changes == CHANGED)
     fputs ("---\n", outfile);
 
   /* Print the lines that the second file has.  */
   if (changes & NEW)
-    for (i = first1; i <= last1; i++)
-      print_1_line (">", &files[1].linbuf[i]);
+    {
+      if (first1 <= last1)
+        set_color_context (ADD_CONTEXT);
+      for (i = first1; i <= last1; i++)
+        {
+          print_1_line_nl (">", &files[1].linbuf[i], true);
+          if (i == last1)
+            set_color_context (RESET_CONTEXT);
+          if (files[1].linbuf[i + 1][-1] == '\n')
+            putc ('\n', outfile);
+        }
+    }
 }
diff --git a/src/side.c b/src/side.c
index 155512c..a0213c4 100644
--- a/src/side.c
+++ b/src/side.c
@@ -206,6 +206,18 @@ print_1sdiff_line (char const *const *left, char sep,
   size_t c2o = sdiff_column2_offset;
   size_t col = 0;
   bool put_newline = false;
+  bool color_to_reset = false;
+
+  if (sep == '<')
+    {
+      set_color_context (DELETE_CONTEXT);
+      color_to_reset = true;
+    }
+  else if (sep == '>')
+    {
+      set_color_context (ADD_CONTEXT);
+      color_to_reset = true;
+    }
 
   if (left)
     {
@@ -233,6 +245,9 @@ print_1sdiff_line (char const *const *left, char sep,
 
   if (put_newline)
     putc ('\n', out);
+
+  if (color_to_reset)
+    set_color_context (RESET_CONTEXT);
 }
 
 /* Print lines common to both files in side-by-side format.  */
diff --git a/src/util.c b/src/util.c
index 2d6d3fc..78b1a2d 100644
--- a/src/util.c
+++ b/src/util.c
@@ -24,6 +24,22 @@
 #include <system-quote.h>
 #include <xalloc.h>
 #include "xvasprintf.h"
+#include <signal.h>
+
+/* Use SA_NOCLDSTOP as a proxy for whether the sigaction machinery is
+   present.  */
+#ifndef SA_NOCLDSTOP
+# define SA_NOCLDSTOP 0
+# define sigprocmask(How, Set, Oset) /* empty */
+# define sigset_t int
+# if ! HAVE_SIGINTERRUPT
+#  define siginterrupt(sig, flag) /* empty */
+# endif
+#endif
+
+#ifndef SA_RESTART
+# define SA_RESTART 0
+#endif
 
 char const pr_program[] = PR_PROGRAM;
 
@@ -143,6 +159,174 @@ print_message_queue (void)
     }
 }
 
+/* The set of signals that are caught.  */
+
+static sigset_t caught_signals;
+
+/* If nonzero, the value of the pending fatal signal.  */
+
+static sig_atomic_t volatile interrupt_signal;
+
+/* A count of the number of pending stop signals that have been received.  */
+
+static sig_atomic_t volatile stop_signal_count;
+
+/* An ordinary signal was received; arrange for the program to exit.  */
+
+static void
+sighandler (int sig)
+{
+  if (! SA_NOCLDSTOP)
+    signal (sig, SIG_IGN);
+  if (! interrupt_signal)
+    interrupt_signal = sig;
+}
+
+/* A SIGTSTP was received; arrange for the program to suspend itself.  */
+
+static void
+stophandler (int sig)
+{
+  if (! SA_NOCLDSTOP)
+    signal (sig, stophandler);
+  if (! interrupt_signal)
+    stop_signal_count++;
+}
+/* Process any pending signals.  If signals are caught, this function
+   should be called periodically.  Ideally there should never be an
+   unbounded amount of time when signals are not being processed.
+   Signal handling can restore the default colors, so callers must
+   immediately change colors after invoking this function.  */
+
+static void
+process_signals (void)
+{
+  while (interrupt_signal || stop_signal_count)
+    {
+      int sig;
+      int stops;
+      sigset_t oldset;
+
+      set_color_context (RESET_CONTEXT);
+      fflush (stdout);
+
+      sigprocmask (SIG_BLOCK, &caught_signals, &oldset);
+
+      /* Reload interrupt_signal and stop_signal_count, in case a new
+         signal was handled before sigprocmask took effect.  */
+      sig = interrupt_signal;
+      stops = stop_signal_count;
+
+      /* SIGTSTP is special, since the application can receive that signal
+         more than once.  In this case, don't set the signal handler to the
+         default.  Instead, just raise the uncatchable SIGSTOP.  */
+      if (stops)
+        {
+          stop_signal_count = stops - 1;
+          sig = SIGSTOP;
+        }
+      else
+        signal (sig, SIG_DFL);
+
+      /* Exit or suspend the program.  */
+      raise (sig);
+      sigprocmask (SIG_SETMASK, &oldset, NULL);
+
+      /* If execution reaches here, then the program has been
+         continued (after being suspended).  */
+    }
+}
+
+static void
+install_signal_handlers (void)
+{
+  /* The signals that are trapped, and the number of such signals.  */
+  static int const sig[] =
+    {
+      /* This one is handled specially.  */
+      SIGTSTP,
+
+      /* The usual suspects.  */
+      SIGALRM, SIGHUP, SIGINT, SIGPIPE, SIGQUIT, SIGTERM,
+#ifdef SIGPOLL
+      SIGPOLL,
+#endif
+#ifdef SIGPROF
+      SIGPROF,
+#endif
+#ifdef SIGVTALRM
+      SIGVTALRM,
+#endif
+#ifdef SIGXCPU
+      SIGXCPU,
+#endif
+#ifdef SIGXFSZ
+      SIGXFSZ,
+#endif
+    };
+  enum { nsigs = sizeof (sig) / sizeof *(sig) };
+
+#if ! SA_NOCLDSTOP
+  bool caught_sig[nsigs];
+#endif
+  {
+    int j;
+#if SA_NOCLDSTOP
+    struct sigaction act;
+
+    sigemptyset (&caught_signals);
+    for (j = 0; j < nsigs; j++)
+      {
+        sigaction (sig[j], NULL, &act);
+        if (act.sa_handler != SIG_IGN)
+          sigaddset (&caught_signals, sig[j]);
+      }
+
+    act.sa_mask = caught_signals;
+    act.sa_flags = SA_RESTART;
+
+    for (j = 0; j < nsigs; j++)
+      if (sigismember (&caught_signals, sig[j]))
+        {
+          act.sa_handler = sig[j] == SIGTSTP ? stophandler : sighandler;
+          sigaction (sig[j], &act, NULL);
+        }
+#else
+    for (j = 0; j < nsigs; j++)
+      {
+        caught_sig[j] = (signal (sig[j], SIG_IGN) != SIG_IGN);
+        if (caught_sig[j])
+          {
+            signal (sig[j], sig[j] == SIGTSTP ? stophandler : sighandler);
+            siginterrupt (sig[j], 0);
+          }
+      }
+#endif
+    }
+}
+
+static char const *current_name0;
+static char const *current_name1;
+static bool currently_recursive;
+static bool colors_enabled;
+
+static void
+check_color_output (bool is_pipe)
+{
+  bool output_is_tty;
+
+  if (! outfile || colors_style == NEVER)
+    return;
+
+  output_is_tty = !is_pipe && isatty (fileno (outfile));
+
+  colors_enabled = (colors_style == ALWAYS
+                    || (colors_style == AUTO && output_is_tty));
+
+  if (output_is_tty)
+    install_signal_handlers ();
+}
+
 /* Call before outputting the results of comparing files NAME0 and NAME1
    to set up OUTFILE, the stdio stream for the output to go to.
 
@@ -150,10 +334,6 @@ print_message_queue (void)
    we fork off a 'pr' and make OUTFILE a pipe to it.
    'pr' then outputs to our stdout.  */
 
-static char const *current_name0;
-static char const *current_name1;
-static bool currently_recursive;
-
 void
 setup_output (char const *name0, char const *name1, bool recursive)
 {
@@ -313,6 +493,7 @@ begin_output (void)
 	    outfile = fdopen (pipes[1], "w");
 	    if (!outfile)
 	      pfatal_with_name ("fdopen");
+	    check_color_output (true);
 	  }
 #else
 	char *command = system_quote_argv (SCI_SYSTEM, (char **) argv);
@@ -320,6 +501,7 @@ begin_output (void)
 	outfile = popen (command, "w");
 	if (!outfile)
 	  pfatal_with_name (command);
+	check_color_output (true);
 	free (command);
 #endif
       }
@@ -330,6 +512,7 @@ begin_output (void)
       /* If -l was not specified, output the diff straight to 'stdout'.  */
 
       outfile = stdout;
+      check_color_output (false);
 
       /* If handling multiple files (because scanning a directory),
 	 print which files the following output is about.  */
@@ -630,6 +813,18 @@ print_script (struct change *script,
 void
 print_1_line (char const *line_flag, char const *const *line)
 {
+  print_1_line_nl (line_flag, line, false);
+}
+
+/* Print the text of a single line LINE,
+   flagging it with the characters in LINE_FLAG (which say whether
+   the line is inserted, deleted, changed, etc.).  LINE_FLAG must not
+   end in a blank, unless it is a single blank.  If SKIP_NL is set, then
+   the final '\n' is not printed.  */
+
+void
+print_1_line_nl (char const *line_flag, char const *const *line, bool skip_nl)
+{
   char const *base = line[0], *limit = line[1]; /* Help the compiler.  */
   FILE *out = outfile; /* Help the compiler some more.  */
   char const *flag_format = 0;
@@ -657,10 +852,13 @@ print_1_line (char const *line_flag, char const *const *line)
       fprintf (out, flag_format_1, line_flag_1);
     }
 
-  output_1_line (base, limit, flag_format, line_flag);
+  output_1_line (base, limit - (skip_nl && limit[-1] == '\n'), flag_format, line_flag);
 
   if ((!line_flag || line_flag[0]) && limit[-1] != '\n')
-    fprintf (out, "\n\\ %s\n", _("No newline at end of file"));
+    {
+      set_color_context (RESET_CONTEXT);
+      fprintf (out, "\n\\ %s\n", _("No newline at end of file"));
+    }
 }
 
 /* Output a line from BASE up to LIMIT.
@@ -672,8 +870,21 @@ void
 output_1_line (char const *base, char const *limit, char const *flag_format,
 	       char const *line_flag)
 {
+  const size_t MAX_CHUNK = 1024;
   if (!expand_tabs)
-    fwrite (base, sizeof (char), limit - base, outfile);
+    {
+      size_t left = limit - base;
+      while (left)
+        {
+          size_t to_write = MIN (left, MAX_CHUNK);
+          size_t written = fwrite (base, sizeof (char), to_write, outfile);
+          if (written < to_write)
+            return;
+          base += written;
+          left -= written;
+          process_signals ();
+        }
+    }
   else
     {
       register FILE *out = outfile;
@@ -681,39 +892,85 @@ output_1_line (char const *base, char const *limit, char const *flag_format,
       register char const *t = base;
       register size_t column = 0;
       size_t tab_size = tabsize;
+      size_t counter_proc_signals = 0;
 
       while (t < limit)
-	switch ((c = *t++))
-	  {
-	  case '\t':
-	    {
-	      size_t spaces = tab_size - column % tab_size;
-	      column += spaces;
-	      do
-		putc (' ', out);
-	      while (--spaces);
-	    }
-	    break;
+        {
+          counter_proc_signals++;
+          if (counter_proc_signals == MAX_CHUNK)
+            {
+              process_signals ();
+              counter_proc_signals = 0;
+            }
+
+          switch ((c = *t++))
+            {
+            case '\t':
+              {
+                size_t spaces = tab_size - column % tab_size;
+                column += spaces;
+                do
+                  putc (' ', out);
+                while (--spaces);
+              }
+              break;
+
+            case '\r':
+              putc (c, out);
+              if (flag_format && t < limit && *t != '\n')
+                fprintf (out, flag_format, line_flag);
+              column = 0;
+              break;
+
+            case '\b':
+              if (column == 0)
+                continue;
+              column--;
+              putc (c, out);
+              break;
+
+            default:
+              column += isprint (c) != 0;
+              putc (c, out);
+              break;
+            }
+        }
+    }
+}
 
-	  case '\r':
-	    putc (c, out);
-	    if (flag_format && t < limit && *t != '\n')
-	      fprintf (out, flag_format, line_flag);
-	    column = 0;
-	    break;
 
-	  case '\b':
-	    if (column == 0)
-	      continue;
-	    column--;
-	    putc (c, out);
-	    break;
+void
+set_color_context (enum color_context color_context)
+{
+  process_signals ();
+  if (colors_enabled)
+    {
+      switch (color_context)
+        {
+        case HEADER_CONTEXT:
+          fputs ("\x1B[1m", outfile);
+          break;
 
-	  default:
-	    column += isprint (c) != 0;
-	    putc (c, out);
-	    break;
-	  }
+        case LINE_NUMBER_CONTEXT:
+          fputs ("\x1B[36m", outfile);
+
+          break;
+
+        case ADD_CONTEXT:
+          fputs ("\x1B[32m", outfile);
+          break;
+
+        case DELETE_CONTEXT:
+          fputs ("\x1B[31m", outfile);
+          break;
+
+        case RESET_CONTEXT:
+          fputs ("\x1b[0m", outfile);
+          break;
+
+        default:
+          abort ();
+        }
     }
 }
 
-- 
2.10.1 (Apple Git-78)


From 04f6d57177fb6c9e7bbcf716c521bc323936a9a5 Mon Sep 17 00:00:00 2001
From: Giuseppe Scrivano <gscrivano@gnu.org>
Date: Mon, 19 Oct 2015 10:29:41 +0200
Subject: [PATCH 065/119] diff: add --palette

* bootstrap (gnulib_modules): Add 'argmatch'.
* doc/diffutils.texi: Add documentation for --palette
* src/diff.h (set_color_palette): New prototype.
* src/diff.c (set_color_palette): New function.
(color_palette): New variable.
* src/utils.c: Include "argmatch.h".
(struct bin_str): New struct.
(struct color_ext_type): New struct.
(color_indicator): New array.
(indicator_name): New array.
(indicator_no): New enum.
(parse_state): New enum.
(put_indicator): New function.
(get_funky_string): New function. Copied from coreutils ls.
(parse_diff_color):  New function. Copied from coreutils ls
"parse_ls_color" function.
(set_color_context): Use put_indicator instead of directly
outputting the sequence.
* po/POTFILES.in: Add 'lib/argmatch.c'
---
 bootstrap.conf     |   1 +
 doc/diffutils.texi |  34 +++++
 po/POTFILES.in     |   1 +
 src/diff.c         |   8 +
 src/diff.h         |   1 +
 src/util.c         | 424 ++++++++++++++++++++++++++++++++++++++++++++++++++++-
 6 files changed, 462 insertions(+), 7 deletions(-)

diff --git a/bootstrap.conf b/bootstrap.conf
index 9b2de22..3ab2c8b 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -19,6 +19,7 @@
 # gnulib modules used by this package.
 gnulib_modules='
 announce-gen
+argmatch
 binary-io
 c-stack
 config-h
diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index b2c39da..4ec9a0b 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -3890,6 +3890,40 @@ if-then-else format.  @xref{Line Formats}.
 @itemx --show-c-function
 Show which C function each change is in.  @xref{C Function Headings}.
 
+@item --palette=@var{palette}
+Specify what color palette to use when colored output is enabled.  It
+defaults to @samp{rs=0:hd=1:ad=32:de=31:ln=36} for red deleted lines,
+green added lines, cyan line numbers, bold header.
+
+Supported capabilities are as follows.
+
+@table @code
+@item ad=32
+@vindex ad @r{capability}
+
+SGR substring for added lines.
+The default is green foreground.
+
+@item de=31
+@vindex de @r{capability}
+
+SGR substring for deleted lines.
+The default is red foreground.
+
+@item hd=1
+@vindex hd @r{capability}
+
+SGR substring for chunk header.
+The default is bold foreground.
+
+@item ln=36
+@vindex ln @r{capability}
+
+SGR substring for line numbers.
+The default is cyan foreground.
+@end table
+
+
 @item -q
 @itemx --brief
 Report only whether the files differ, not the details of the
diff --git a/po/POTFILES.in b/po/POTFILES.in
index 74fb756..af39427 100644
--- a/po/POTFILES.in
+++ b/po/POTFILES.in
@@ -15,6 +15,7 @@
 # You should have received a copy of the GNU General Public License
 # along with this program.  If not, see <http://www.gnu.org/licenses/>.
 
+lib/argmatch.c
 lib/c-stack.c
 lib/error.c
 lib/file-type.c
diff --git a/src/diff.c b/src/diff.c
index 536f545..46ac99d 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -140,6 +140,7 @@ enum
   CHANGED_GROUP_FORMAT_OPTION,
 
   COLOR_OPTION,
+  COLOR_PALETTE_OPTION,
 };
 
 static char const group_format_option[][sizeof "--unchanged-group-format"] =
@@ -196,6 +197,7 @@ static struct option const longopts[] =
   {"old-group-format", 1, 0, OLD_GROUP_FORMAT_OPTION},
   {"old-line-format", 1, 0, OLD_LINE_FORMAT_OPTION},
   {"paginate", 0, 0, 'l'},
+  {"palette", 1, 0, COLOR_PALETTE_OPTION},
   {"rcs", 0, 0, 'n'},
   {"recursive", 0, 0, 'r'},
   {"report-identical-files", 0, 0, 's'},
@@ -635,6 +637,10 @@ main (int argc, char **argv)
 	  specify_colors_style (optarg);
 	  break;
 
+	case COLOR_PALETTE_OPTION:
+	  set_color_palette (optarg);
+	  break;
+
 	default:
 	  try_help (NULL, NULL);
 	}
@@ -950,6 +956,8 @@ static char const * const option_help_msgid[] = {
   N_("    --speed-large-files  assume large files and many scattered small changes"),
   N_("    --color[=WHEN]       colorize the output; WHEN can be 'never', 'always',"),
   N_("                           or 'auto' (the default)"),
+  N_("    --palette=PALETTE    specify the colors to use when --color is active"),
+  N_("                           PALETTE is a colon-separated list terminfo capabilities"),
   "",
   N_("    --help               display this help and exit"),
   N_("-v, --version            output version information and exit"),
diff --git a/src/diff.h b/src/diff.h
index 7bf7344..6f1bb34 100644
--- a/src/diff.h
+++ b/src/diff.h
@@ -418,3 +418,4 @@ enum color_context
 };
 
 extern void set_color_context (enum color_context color_context);
+extern void set_color_palette (char const *palette);
diff --git a/src/util.c b/src/util.c
index 78b1a2d..1fa61fa 100644
--- a/src/util.c
+++ b/src/util.c
@@ -19,6 +19,7 @@
    along with this program.  If not, see <http://www.gnu.org/licenses/>.  */
 
 #include "diff.h"
+#include "argmatch.h"
 #include <dirname.h>
 #include <error.h>
 #include <system-quote.h>
@@ -310,6 +311,397 @@ static char const *current_name1;
 static bool currently_recursive;
 static bool colors_enabled;
 
+static struct color_ext_type *color_ext_list = NULL;
+
+struct bin_str
+  {
+    size_t len;			/* Number of bytes */
+    const char *string;		/* Pointer to the same */
+  };
+
+struct color_ext_type
+  {
+    struct bin_str ext;		/* The extension we're looking for */
+    struct bin_str seq;		/* The sequence to output when we do */
+    struct color_ext_type *next;	/* Next in list */
+  };
+
+/* Parse a string as part of the --palette argument; this may involve
+   decoding all kinds of escape characters.  If equals_end is set an
+   unescaped equal sign ends the string, otherwise only a : or \0
+   does.  Set *OUTPUT_COUNT to the number of bytes output.  Return
+   true if successful.
+
+   The resulting string is *not* null-terminated, but may contain
+   embedded nulls.
+
+   Note that both dest and src are char **; on return they point to
+   the first free byte after the array and the character that ended
+   the input string, respectively.  */
+
+static bool
+get_funky_string (char **dest, const char **src, bool equals_end,
+                  size_t *output_count)
+{
+  char num;			/* For numerical codes */
+  size_t count;			/* Something to count with */
+  enum {
+    ST_GND, ST_BACKSLASH, ST_OCTAL, ST_HEX, ST_CARET, ST_END, ST_ERROR
+  } state;
+  const char *p;
+  char *q;
+
+  p = *src;			/* We don't want to double-indirect */
+  q = *dest;			/* the whole darn time.  */
+
+  count = 0;			/* No characters counted in yet.  */
+  num = 0;
+
+  state = ST_GND;		/* Start in ground state.  */
+  while (state < ST_END)
+    {
+      switch (state)
+        {
+        case ST_GND:		/* Ground state (no escapes) */
+          switch (*p)
+            {
+            case ':':
+            case '\0':
+              state = ST_END;	/* End of string */
+              break;
+            case '\\':
+              state = ST_BACKSLASH; /* Backslash scape sequence */
+              ++p;
+              break;
+            case '^':
+              state = ST_CARET; /* Caret escape */
+              ++p;
+              break;
+            case '=':
+              if (equals_end)
+                {
+                  state = ST_END; /* End */
+                  break;
+                }
+              /* else fall through */
+            default:
+              *(q++) = *(p++);
+              ++count;
+              break;
+            }
+          break;
+
+        case ST_BACKSLASH:	/* Backslash escaped character */
+          switch (*p)
+            {
+            case '0':
+            case '1':
+            case '2':
+            case '3':
+            case '4':
+            case '5':
+            case '6':
+            case '7':
+              state = ST_OCTAL;	/* Octal sequence */
+              num = *p - '0';
+              break;
+            case 'x':
+            case 'X':
+              state = ST_HEX;	/* Hex sequence */
+              num = 0;
+              break;
+            case 'a':		/* Bell */
+              num = '\a';
+              break;
+            case 'b':		/* Backspace */
+              num = '\b';
+              break;
+            case 'e':		/* Escape */
+              num = 27;
+              break;
+            case 'f':		/* Form feed */
+              num = '\f';
+              break;
+            case 'n':		/* Newline */
+              num = '\n';
+              break;
+            case 'r':		/* Carriage return */
+              num = '\r';
+              break;
+            case 't':		/* Tab */
+              num = '\t';
+              break;
+            case 'v':		/* Vtab */
+              num = '\v';
+              break;
+            case '?':		/* Delete */
+              num = 127;
+              break;
+            case '_':		/* Space */
+              num = ' ';
+              break;
+            case '\0':		/* End of string */
+              state = ST_ERROR;	/* Error! */
+              break;
+            default:		/* Escaped character like \ ^ : = */
+              num = *p;
+              break;
+            }
+          if (state == ST_BACKSLASH)
+            {
+              *(q++) = num;
+              ++count;
+              state = ST_GND;
+            }
+          ++p;
+          break;
+
+        case ST_OCTAL:		/* Octal sequence */
+          if (*p < '0' || *p > '7')
+            {
+              *(q++) = num;
+              ++count;
+              state = ST_GND;
+            }
+          else
+            num = (num << 3) + (*(p++) - '0');
+          break;
+
+        case ST_HEX:		/* Hex sequence */
+          switch (*p)
+            {
+            case '0':
+            case '1':
+            case '2':
+            case '3':
+            case '4':
+            case '5':
+            case '6':
+            case '7':
+            case '8':
+            case '9':
+              num = (num << 4) + (*(p++) - '0');
+              break;
+            case 'a':
+            case 'b':
+            case 'c':
+            case 'd':
+            case 'e':
+            case 'f':
+              num = (num << 4) + (*(p++) - 'a') + 10;
+              break;
+            case 'A':
+            case 'B':
+            case 'C':
+            case 'D':
+            case 'E':
+            case 'F':
+              num = (num << 4) + (*(p++) - 'A') + 10;
+              break;
+            default:
+              *(q++) = num;
+              ++count;
+              state = ST_GND;
+              break;
+            }
+          break;
+
+        case ST_CARET:		/* Caret escape */
+          state = ST_GND;	/* Should be the next state... */
+          if (*p >= '@' && *p <= '~')
+            {
+              *(q++) = *(p++) & 037;
+              ++count;
+            }
+          else if (*p == '?')
+            {
+              *(q++) = 127;
+              ++count;
+            }
+          else
+            state = ST_ERROR;
+          break;
+
+        default:
+          abort ();
+        }
+    }
+
+  *dest = q;
+  *src = p;
+  *output_count = count;
+
+  return state != ST_ERROR;
+}
+
+enum parse_state
+  {
+    PS_START = 1,
+    PS_2,
+    PS_3,
+    PS_4,
+    PS_DONE,
+    PS_FAIL
+  };
+
+#define LEN_STR_PAIR(s) sizeof (s) - 1, s
+
+static struct bin_str color_indicator[] =
+  {
+    { LEN_STR_PAIR ("\033[") },		/* lc: Left of color sequence */
+    { LEN_STR_PAIR ("m") },		/* rc: Right of color sequence */
+    { 0, NULL },			/* ec: End color (replaces lc+rs+rc) */
+    { LEN_STR_PAIR ("0") },		/* rs: Reset to ordinary colors */
+    { LEN_STR_PAIR ("1") },		/* hd: Header */
+    { LEN_STR_PAIR ("32") },		/* ad: Add line */
+    { LEN_STR_PAIR ("31") },		/* de: Delete line */
+    { LEN_STR_PAIR ("36") },		/* ln: Line number */
+  };
+
+static const char *const indicator_name[] =
+  {
+    "lc", "rc", "ec", "rs", "hd", "ad", "de", "ln", NULL
+  };
+ARGMATCH_VERIFY (indicator_name, color_indicator);
+
+static char const *color_palette;
+
+void
+set_color_palette (char const *palette)
+{
+  color_palette = palette;
+}
+
+static void
+parse_diff_color (void)
+{
+  char *color_buf;
+  const char *p;		/* Pointer to character being parsed */
+  char *buf;			/* color_buf buffer pointer */
+  int ind_no;			/* Indicator number */
+  char label[3];		/* Indicator label */
+  struct color_ext_type *ext;	/* Extension we are working on */
+
+  if ((p = color_palette) == NULL || *p == '\0')
+    return;
+
+  ext = NULL;
+  strcpy (label, "??");
+
+  /* This is an overly conservative estimate, but any possible
+     --palette string will *not* generate a color_buf longer than
+     itself, so it is a safe way of allocating a buffer in
+     advance.  */
+  buf = color_buf = xstrdup (p);
+
+  enum parse_state state = PS_START;
+  while (true)
+    {
+      switch (state)
+        {
+        case PS_START:		/* First label character */
+          switch (*p)
+            {
+            case ':':
+              ++p;
+              break;
+
+            case '*':
+              /* Allocate new extension block and add to head of
+                 linked list (this way a later definition will
+                 override an earlier one, which can be useful for
+                 having terminal-specific defs override global).  */
+
+              ext = xmalloc (sizeof *ext);
+              ext->next = color_ext_list;
+              color_ext_list = ext;
+
+              ++p;
+              ext->ext.string = buf;
+
+              state = (get_funky_string (&buf, &p, true, &ext->ext.len)
+                       ? PS_4 : PS_FAIL);
+              break;
+
+            case '\0':
+              state = PS_DONE;	/* Done! */
+              goto done;
+
+            default:	/* Assume it is file type label */
+              label[0] = *(p++);
+              state = PS_2;
+              break;
+            }
+          break;
+
+        case PS_2:		/* Second label character */
+          if (*p)
+            {
+              label[1] = *(p++);
+              state = PS_3;
+            }
+          else
+            state = PS_FAIL;	/* Error */
+          break;
+
+        case PS_3:		/* Equal sign after indicator label */
+          state = PS_FAIL;	/* Assume failure...  */
+          if (*(p++) == '=')/* It *should* be...  */
+            {
+              for (ind_no = 0; indicator_name[ind_no] != NULL; ++ind_no)
+                {
+                  if (STREQ (label, indicator_name[ind_no]))
+                    {
+                      color_indicator[ind_no].string = buf;
+                      state = (get_funky_string (&buf, &p, false,
+                                                 &color_indicator[ind_no].len)
+                               ? PS_START : PS_FAIL);
+                      break;
+                    }
+                }
+              if (state == PS_FAIL)
+                error (0, 0, _("unrecognized prefix: %s"), label);
+            }
+          break;
+
+        case PS_4:		/* Equal sign after *.ext */
+          if (*(p++) == '=')
+            {
+              ext->seq.string = buf;
+              state = (get_funky_string (&buf, &p, false, &ext->seq.len)
+                       ? PS_START : PS_FAIL);
+            }
+          else
+            state = PS_FAIL;
+          break;
+
+        case PS_FAIL:
+          goto done;
+
+        default:
+          abort ();
+        }
+    }
+ done:
+
+  if (state == PS_FAIL)
+    {
+      struct color_ext_type *e;
+      struct color_ext_type *e2;
+
+      error (0, 0,
+             _("unparsable value for --palette"));
+      free (color_buf);
+      for (e = color_ext_list; e != NULL; /* empty */)
+        {
+          e2 = e;
+          e = e->next;
+          free (e2);
+        }
+      colors_enabled = false;
+    }
+}
+
 static void
 check_color_output (bool is_pipe)
 {
@@ -323,6 +715,9 @@ check_color_output (bool is_pipe)
   colors_enabled = (colors_style == ALWAYS
                     || (colors_style == AUTO && output_is_tty));
 
+  if (colors_enabled)
+    parse_diff_color ();
+
   if (output_is_tty)
     install_signal_handlers ();
 }
@@ -938,42 +1333,57 @@ output_1_line (char const *base, char const *limit, char const *flag_format,
     }
 }
 
+enum indicator_no
+  {
+    C_LEFT, C_RIGHT, C_END, C_RESET, C_HEADER, C_ADD, C_DELETE, C_LINE
+  };
+
+static void
+put_indicator (const struct bin_str *ind)
+{
+  fwrite (ind->string, ind->len, 1, outfile);
+}
+
+static enum color_context last_context = RESET_CONTEXT;
 
 void
 set_color_context (enum color_context color_context)
 {
   process_signals ();
-  if (colors_enabled)
+  if (colors_enabled && last_context != color_context)
     {
+      put_indicator (&color_indicator[C_LEFT]);
       switch (color_context)
         {
         case HEADER_CONTEXT:
-          fputs ("\x1B[1m", outfile);
+          put_indicator (&color_indicator[C_HEADER]);
           break;
 
         case LINE_NUMBER_CONTEXT:
-          fputs ("\x1B[36m", outfile);
-
+          put_indicator (&color_indicator[C_LINE]);
           break;
 
         case ADD_CONTEXT:
-          fputs ("\x1B[32m", outfile);
+          put_indicator (&color_indicator[C_ADD]);
           break;
 
         case DELETE_CONTEXT:
-          fputs ("\x1B[31m", outfile);
+          put_indicator (&color_indicator[C_DELETE]);
           break;
 
         case RESET_CONTEXT:
-          fputs ("\x1b[0m", outfile);
+          put_indicator (&color_indicator[C_RESET]);
           break;
 
         default:
           abort ();
         }
+      put_indicator (&color_indicator[C_RIGHT]);
+      last_context = color_context;
     }
 }
 
+
 char const change_letter[] = { 0, 'd', 'a', 'c' };
 
 /* Translate an internal line number (an index into diff's table of lines)
-- 
2.10.1 (Apple Git-78)


From 0e72de47952beead69e44a4a8c9b4994992ef8ac Mon Sep 17 00:00:00 2001
From: Giuseppe Scrivano <gscrivano@gnu.org>
Date: Mon, 2 Nov 2015 19:03:32 +0000
Subject: [PATCH 066/119] doc: mention --color and --palette in NEWS

---
 NEWS | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/NEWS b/NEWS
index 7cdfedd..088f13b 100644
--- a/NEWS
+++ b/NEWS
@@ -2,6 +2,13 @@ GNU diffutils NEWS                                    -*- outline -*-
 
 * Noteworthy changes in release ?.? (????-??-??) [?]
 
+** New features
+
+   diff accepts two new options --color and --palette to generate
+   and configure colored output.  --color takes an optional argument
+   specifying when to colorize a line: --color=always, --color=auto,
+   --color=never.  --palette is used to configure which colors are used.
+
 ** Bug fixes
 
   When binary files differ, diff now exits with status 1 as POSIX requires.
-- 
2.10.1 (Apple Git-78)


From 875ca7183bd4b098f2d8fb71b10553df2d4d2d11 Mon Sep 17 00:00:00 2001
From: Giuseppe Scrivano <gscrivano@gnu.org>
Date: Mon, 2 Nov 2015 19:05:10 +0000
Subject: [PATCH 067/119] tests: Add tests for --color and --palette

* tests/colors: New file.
* tests/Makefile.am (TESTS): Add colors.
---
 tests/Makefile.am |   3 +-
 tests/colors      | 119 ++++++++++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 121 insertions(+), 1 deletion(-)
 create mode 100755 tests/colors

diff --git a/tests/Makefile.am b/tests/Makefile.am
index 438fbdf..805ccc2 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -15,7 +15,8 @@ TESTS = \
   no-newline-at-eof \
   stdin \
   strcoll-0-names \
-  filename-quoting
+  filename-quoting \
+  colors
 
 EXTRA_DIST = \
   $(TESTS) init.sh t-local.sh
diff --git a/tests/colors b/tests/colors
new file mode 100755
index 0000000..facfd8d
--- /dev/null
+++ b/tests/colors
@@ -0,0 +1,119 @@
+#!/bin/sh
+
+. "${srcdir=.}/init.sh"; path_prepend_ ../src
+
+TZ=UTC0
+export TZ
+
+fail=0
+
+echo a > a
+echo b > b
+
+epoch='1970-01-01 00:00:00'
+touch --date="$epoch" a b
+
+gen_exp_u()
+{
+    local tab=$(printf '\t')
+    local epoch_plus="$epoch.000000000 +0000"
+    local rs=$(printf "\e[${rs}m")
+    local hd=$(printf "\e[${hd}m")
+    local ad=$(printf "\e[${ad}m")
+    local de=$(printf "\e[${de}m")
+    local ln=$(printf "\e[${ln}m")
+    printf '%s' \
+"$hd--- a$tab$epoch_plus
++++ b$tab$epoch_plus
+$rs${ln}@@ -1 +1 @@$rs
+$de-a$rs
+$ad+b$rs
+"
+}
+
+gen_exp_c()
+{
+    local tab=$(printf '\t')
+    local epoch_posix_1003_1_2001="Thu Jan  1 00:00:00 1970"
+    local rs=$(printf "\e[${rs}m")
+    local hd=$(printf "\e[${hd}m")
+    local ad=$(printf "\e[${ad}m")
+    local de=$(printf "\e[${de}m")
+    local ln=$(printf "\e[${ln}m")
+    printf '%s' \
+"$hd*** a$tab$epoch_posix_1003_1_2001
+--- b$tab$epoch_posix_1003_1_2001
+$rs***************
+$ln*** 1 ****$rs
+$de! a$rs
+$ln--- 1 ----$rs
+$ad! b$rs
+"
+}
+
+gen_exp_default()
+{
+    printf '%s' \
+"1c1
+< a
+---
+> b
+"
+}
+
+gen_exp_default_colors()
+{
+    local rs=$(printf "\e[${rs}m")
+    local hd=$(printf "\e[${hd}m")
+    local ad=$(printf "\e[${ad}m")
+    local de=$(printf "\e[${de}m")
+    local ln=$(printf "\e[${ln}m")
+    printf '%s' \
+"${ln}1c1$rs
+$de< a$rs
+---
+$ad> b$rs
+"
+}
+
+# Compare with some known outputs
+
+rs=0 hd=1 ad=32 de=31 ln=36
+
+diff --color=auto a b > out
+test $? = 1 || fail=1
+gen_exp_default > exp || framework_failure_
+compare exp out || fail=1
+
+diff --color=never a b > out
+test $? = 1 || fail=1
+gen_exp_default > exp || framework_failure_
+compare exp out || fail=1
+
+diff a b > out
+test $? = 1 || fail=1
+gen_exp_default > exp || framework_failure_
+compare exp out || fail=1
+
+diff --color=always a b > out
+test $? = 1 || fail=1
+gen_exp_default_colors > exp || framework_failure_
+compare exp out || fail=1
+
+diff -u --color=always a b > out
+test $? = 1 || fail=1
+gen_exp_u > exp || framework_failure_
+compare exp out || fail=1
+
+diff -c --color=always a b > out
+test $? = 1 || fail=1
+gen_exp_c > exp || framework_failure_
+compare exp out || fail=1
+
+rs=0 hd=33 ad=34 de=35 ln=36
+diff -u --color=always --palette="rs=0:hd=33:ad=34:de=35:ln=36" a b > out
+test $? = 1 || fail=1
+gen_exp_u > exp || framework_failure_
+compare exp out || fail=1
+
+Exit $fail
-- 
2.10.1 (Apple Git-78)


From d77f95f8dcbfa6e160d74e07cbd5f7def737975e Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 28 Nov 2015 19:29:37 -0800
Subject: [PATCH 068/119] build: add gperf to the list of required programs
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

* bootstrap.conf (buildreq): Add gperf to the list.
Reported by Stephan Mller in http://debbugs.gnu.org/21945
---
 bootstrap.conf | 1 +
 1 file changed, 1 insertion(+)

diff --git a/bootstrap.conf b/bootstrap.conf
index 3ab2c8b..af4f35a 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -155,6 +155,7 @@ automake   1.12.2
 autopoint  -
 gettext    -
 git        1.4.4
+gperf      -
 gzip       -
 help2man   -
 makeinfo   -
-- 
2.10.1 (Apple Git-78)


From a1140dd45845d838401425f9a3c0af944abb5795 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 6 Dec 2015 10:38:17 -0800
Subject: [PATCH 069/119] tests: arrange to print any skipped-test explanation
 to tty, too

I noticed that when a test was skipped, the reason was not printed.
This fixes it.  In coreutils, this variable is set in init.cfg,
but there is no point in putting the definition so far from the
code that chooses the file descriptor number in tests/Makefile.am.
* tests/Makefile.am (TESTS_ENVIRONMENT) [stderr_fileno_]: Define
here (to 9), right next to the companion "9>&2".
---
 tests/Makefile.am | 1 +
 1 file changed, 1 insertion(+)

diff --git a/tests/Makefile.am b/tests/Makefile.am
index 805ccc2..083a00a 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -46,6 +46,7 @@ TESTS_ENVIRONMENT =							\
     export PREFERABLY_POSIX_SHELL;					\
   REPLACE_GETCWD=$(REPLACE_GETCWD); export REPLACE_GETCWD;		\
   PATH='$(abs_top_builddir)/src$(PATH_SEPARATOR)'"$$PATH"; export PATH	\
+  stderr_fileno_=9; export stderr_fileno				\
   ; 9>&2
 
 LOG_COMPILER= $(SHELL)
-- 
2.10.1 (Apple Git-78)


From a3ea9cd5cb911a0319c81b01e205b24c92a8535c Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 28 Nov 2015 18:02:05 -0800
Subject: [PATCH 070/119] diff --brief no longer mistakenly reports diff. with
 0-sized /proc/ files
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Normally, it is safe to assume two regular files are different when
their st_size values are different.  However, that assumption may
be invalid if either value is zero, as happens with files on Linux
/proc and /sys file systems. Since skipping this optimization will
usually cost very little (one read syscall, to read zero bytes),
it is fine to accommodate those unusual files.
* src/analyze.c (diff_2_files): Do not assume regular files differ
just because their st_size values differ when one or more is 0.
* src/diff.c (compare_files): Likewise.
* tests/brief-vs-proc-stat-zero: New test.
* tests/Makefile.am: Add it.
* NEWS (Bug fixes): Describe it.
Reported by Stephan Mller in http://debbugs.gnu.org/21942
---
 NEWS                                 |  7 +++++++
 src/analyze.c                        |  2 ++
 src/diff.c                           |  4 +++-
 tests/Makefile.am                    |  1 +
 tests/brief-vs-stat-zero-kernel-lies | 30 ++++++++++++++++++++++++++++++
 5 files changed, 43 insertions(+), 1 deletion(-)
 create mode 100755 tests/brief-vs-stat-zero-kernel-lies

diff --git a/NEWS b/NEWS
index 088f13b..5a2386f 100644
--- a/NEWS
+++ b/NEWS
@@ -23,6 +23,13 @@ GNU diffutils NEWS                                    -*- outline -*-
   diff -B no longer generates incorrect output if the two inputs
   each end with a one-byte incomplete line.
 
+  diff --brief no longer reports a difference for unusual identical files.
+  For example, when comparing a file like /proc/cmdline (for which the linux
+  kernel reports st_size of 0 even though it is not an empty file) to a
+  copy of that file's contents residing on a "normal" file system:
+    $ f=/proc/cmdline; cp $f k; diff --brief $f k
+    Files /proc/cmdline and k differ
+
 ** Performance changes
 
   diff's default algorithm has been adjusted to output higher-quality
diff --git a/src/analyze.c b/src/analyze.c
index 893d07c..2622810 100644
--- a/src/analyze.c
+++ b/src/analyze.c
@@ -477,6 +477,8 @@ diff_2_files (struct comparison *cmp)
     {
       /* Files with different lengths must be different.  */
       if (cmp->file[0].stat.st_size != cmp->file[1].stat.st_size
+	  && 0 < cmp->file[0].stat.st_size
+	  && 0 < cmp->file[1].stat.st_size
 	  && (cmp->file[0].desc < 0 || S_ISREG (cmp->file[0].stat.st_mode))
 	  && (cmp->file[1].desc < 0 || S_ISREG (cmp->file[1].stat.st_mode)))
 	changes = 1;
diff --git a/src/diff.c b/src/diff.c
index 46ac99d..cff23f0 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -1377,7 +1377,9 @@ compare_files (struct comparison const *parent,
   else if (files_can_be_treated_as_binary
 	   && S_ISREG (cmp.file[0].stat.st_mode)
 	   && S_ISREG (cmp.file[1].stat.st_mode)
-	   && cmp.file[0].stat.st_size != cmp.file[1].stat.st_size)
+	   && cmp.file[0].stat.st_size != cmp.file[1].stat.st_size
+	   && 0 < cmp.file[0].stat.st_size
+	   && 0 < cmp.file[1].stat.st_size)
     {
       message ("Files %s and %s differ\n",
 	       file_label[0] ? file_label[0] : cmp.file[0].name,
diff --git a/tests/Makefile.am b/tests/Makefile.am
index 083a00a..5457d3a 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -4,6 +4,7 @@ TESTS = \
   basic \
   bignum \
   binary \
+  brief-vs-stat-zero-kernel-lies \
   colliding-file-names \
   excess-slash \
   help-version	\
diff --git a/tests/brief-vs-stat-zero-kernel-lies b/tests/brief-vs-stat-zero-kernel-lies
new file mode 100755
index 0000000..9b272c6
--- /dev/null
+++ b/tests/brief-vs-stat-zero-kernel-lies
@@ -0,0 +1,30 @@
+#!/bin/sh
+# Before diff-3.4, diff --brief could mistakenly declare a difference.
+# For example, when comparing a file like /proc/cmdline (for which the linux
+# kernel reports a st_size of 0 even though it is not an empty file) to a
+# copy of that file's contents residing on a "normal" file system.
+
+. "${srcdir=.}/init.sh"; path_prepend_ ../src
+
+fail=0
+
+# Skip the test unless we have an appropriate file.
+boot=/proc/cmdline
+test -f $boot || skip_ no $boot file
+sz=$(stat --format %s $boot) || skip_ stat --format %s does not work
+test $sz = 0 || skip_ $boot has nonzero size
+
+# There are two code paths to test: one for non-binary and one for binary files.
+# $boot is non-binary.
+cat $boot > ref || framework_failure_
+diff --brief $boot ref > out 2>&1 || fail=1
+compare /dev/null out || fail=1
+
+# /proc/self/cmdline is a NUL-terminated list of argv values,
+# so construct the expected output here:
+printf 'diff\0--brief\0/proc/self/cmdline\0bin\0' > bin || framework_failure_
+# And run the command that is embedded in that output:
+diff --brief /proc/self/cmdline bin > out 2>&1 || fail=1
+compare /dev/null out || fail=1
+
+Exit $fail
-- 
2.10.1 (Apple Git-78)


From 7346a030108e032b0e8523f381f1a95b91806890 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Fri, 1 Jan 2016 15:06:05 -0800
Subject: [PATCH 071/119] maint: update copyright year, bootstrap, init.sh

Run "make update-copyright" and then...

* gnulib: Update to latest.
* tests/init.sh: Update from gnulib.
* bootstrap: Likewise.
---
 AUTHORS            |  2 +-
 ChangeLog-2008     |  4 ++--
 HACKING            |  2 +-
 Makefile.am        |  2 +-
 NEWS               |  2 +-
 README             |  2 +-
 README-hacking     |  2 +-
 bootstrap          | 47 +++++++++++++++++++++++++++++++++++++----------
 bootstrap.conf     |  2 +-
 cfg.mk             |  2 +-
 configure.ac       |  4 ++--
 doc/Makefile.am    |  2 +-
 doc/diffutils.texi |  2 +-
 exgettext          |  4 ++--
 gnulib             |  2 +-
 lib/Makefile.am    |  2 +-
 lib/cmpbuf.c       |  2 +-
 lib/cmpbuf.h       |  2 +-
 lib/prepargs.c     |  4 ++--
 man/Makefile.am    |  2 +-
 man/help2man       |  3 ++-
 po/POTFILES.in     |  2 +-
 po/en.po           |  3 ++-
 src/Makefile.am    |  3 ++-
 src/analyze.c      |  2 +-
 src/cmp.c          |  4 ++--
 src/context.c      |  2 +-
 src/diff.c         |  2 +-
 src/diff.h         |  4 ++--
 src/diff3.c        |  2 +-
 src/dir.c          |  2 +-
 src/ed.c           |  2 +-
 src/ifdef.c        |  4 ++--
 src/io.c           |  2 +-
 src/normal.c       |  4 ++--
 src/sdiff.c        |  4 ++--
 src/side.c         |  2 +-
 src/system.h       |  2 +-
 src/util.c         |  2 +-
 tests/help-version |  2 +-
 tests/init.sh      | 28 ++++++++++++++++++++++++++--
 41 files changed, 114 insertions(+), 60 deletions(-)

diff --git a/AUTHORS b/AUTHORS
index 0c6b0f4..58b097a 100644
--- a/AUTHORS
+++ b/AUTHORS
@@ -33,7 +33,7 @@ Patrick D'Cruze
 Eli Zaretskii
 
 
-Copyright (C) 2001, 2006, 2009-2013, 2015 Free Software Foundation, Inc.
+Copyright (C) 2001, 2006, 2009-2013, 2015-2016 Free Software Foundation, Inc.
 
 This file is part of GNU diffutils.
 
diff --git a/ChangeLog-2008 b/ChangeLog-2008
index 9945407..7cf442c 100644
--- a/ChangeLog-2008
+++ b/ChangeLog-2008
@@ -4265,8 +4265,8 @@ Thu Nov  3 16:30:24 1988  Randall Smith  (randy at gluteus.ai.mit.edu)
 
 	-----
 
-	Copyright (C) 1988-1994, 1997-2002, 2004, 2006, 2009-2013, 2015 Free
-	Software Foundation, Inc.
+	Copyright (C) 1988-1994, 1997-2002, 2004, 2006, 2009-2013, 2015-2016
+	Free Software Foundation, Inc.
 
 	Copying and distribution of this file, with or without
 	modification, are permitted provided the copyright notice and this
diff --git a/HACKING b/HACKING
index 80633a5..f998d2d 100644
--- a/HACKING
+++ b/HACKING
@@ -581,7 +581,7 @@ Then just open the index.html file (in the generated lcov-html directory)
 in your favorite web browser.
 
 ========================================================================
-Copyright (C) 2009-2013, 2015 Free Software Foundation, Inc.
+Copyright (C) 2009-2013, 2015-2016 Free Software Foundation, Inc.
 
 Permission is granted to copy, distribute and/or modify this document
 under the terms of the GNU Free Documentation License, Version 1.3 or
diff --git a/Makefile.am b/Makefile.am
index 7a1f431..06ce7c4 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -1,6 +1,6 @@
 # Main Automakefile for GNU diffutils.
 
-# Copyright (C) 2001-2002, 2004, 2006, 2009-2013, 2015 Free Software
+# Copyright (C) 2001-2002, 2004, 2006, 2009-2013, 2015-2016 Free Software
 # Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
diff --git a/NEWS b/NEWS
index 5a2386f..db5478c 100644
--- a/NEWS
+++ b/NEWS
@@ -367,7 +367,7 @@ User-visible changes in version 2.0:
 
 
 
-Copyright (C) 1993-1994, 1998, 2001-2002, 2004, 2006, 2009-2013, 2015 Free
+Copyright (C) 1993-1994, 1998, 2001-2002, 2004, 2006, 2009-2013, 2015-2016 Free
 Software Foundation, Inc.
 
 This file is part of GNU Diffutils.
diff --git a/README b/README
index 1317dfa..30bb380 100644
--- a/README
+++ b/README
@@ -51,7 +51,7 @@ Please report bugs to <bug-diffutils@gnu.org>.
 
 -----
 
-Copyright (C) 1992, 1998, 2001-2002, 2004, 2009-2013, 2015 Free Software
+Copyright (C) 1992, 1998, 2001-2002, 2004, 2009-2013, 2015-2016 Free Software
 Foundation, Inc.
 
 This file is part of GNU Diffutils.
diff --git a/README-hacking b/README-hacking
index 24f2a3f..7b2cd7e 100644
--- a/README-hacking
+++ b/README-hacking
@@ -94,7 +94,7 @@ each program.  One way to do this is to use vc-dwim
 
 -----
 
-Copyright (C) 2002-2007, 2009-2013, 2015 Free Software Foundation, Inc.
+Copyright (C) 2002-2007, 2009-2013, 2015-2016 Free Software Foundation, Inc.
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
diff --git a/bootstrap b/bootstrap
index 7d3aa5b..294c0bc 100755
--- a/bootstrap
+++ b/bootstrap
@@ -1,10 +1,10 @@
 #! /bin/sh
 # Print a version string.
-scriptversion=2013-12-05.23; # UTC
+scriptversion=2014-12-08.12; # UTC
 
 # Bootstrap this package from checked-out sources.
 
-# Copyright (C) 2003-2015 Free Software Foundation, Inc.
+# Copyright (C) 2003-2016 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -42,6 +42,9 @@ export LC_ALL
 
 local_gl_dir=gl
 
+# Honour $PERL, but work even if there is none
+PERL="${PERL-perl}"
+
 me=$0
 
 usage() {
@@ -210,7 +213,17 @@ bootstrap_sync=false
 use_git=true
 
 check_exists() {
-  ($1 --version </dev/null) >/dev/null 2>&1
+  if test "$1" = "--verbose"; then
+    ($2 --version </dev/null) >/dev/null 2>&1
+    if test $? -ge 126; then
+      # If not found, run with diagnostics as one may be
+      # presented with env variables to set to find the right version
+      ($2 --version </dev/null)
+    fi
+  else
+    ($1 --version </dev/null) >/dev/null 2>&1
+  fi
+
   test $? -lt 126
 }
 
@@ -408,7 +421,7 @@ sort_ver() { # sort -V is not generally available
 get_version() {
   app=$1
 
-  $app --version >/dev/null 2>&1 || return 1
+  $app --version >/dev/null 2>&1 || { $app --version; return 1; }
 
   $app --version 2>&1 |
   sed -n '# Move version to start of line.
@@ -446,6 +459,7 @@ check_versions() {
     test "$appvar" = TAR && appvar=AMTAR
     case $appvar in
         GZIP) ;; # Do not use $GZIP:  it contains gzip options.
+        PERL::*) ;; # Keep perl modules as-is
         *) eval "app=\${$appvar-$app}" ;;
     esac
 
@@ -463,11 +477,22 @@ check_versions() {
           ret=1
           continue
         } ;;
+      # Another check is for perl modules.  These can be written as
+      # e.g. perl::XML::XPath in case of XML::XPath module, etc.
+      perl::*)
+        # Extract module name
+        app="${app#perl::}"
+        if ! $PERL -m"$app" -e 'exit 0' >/dev/null 2>&1; then
+          warn_ "Error: perl module '$app' not found"
+          ret=1
+        fi
+        continue
+        ;;
     esac
     if [ "$req_ver" = "-" ]; then
       # Merely require app to exist; not all prereq apps are well-behaved
       # so we have to rely on $? rather than get_version.
-      if ! check_exists $app; then
+      if ! check_exists --verbose $app; then
         warn_ "Error: '$app' not found"
         ret=1
       fi
@@ -598,8 +623,8 @@ case ${GNULIB_SRCDIR--} in
   # Note that $use_git is necessarily true in this case.
   if git_modules_config submodule.gnulib.url >/dev/null; then
     echo "$0: getting gnulib files..."
-    git submodule init || exit $?
-    git submodule update || exit $?
+    git submodule init -- "$gnulib_path" || exit $?
+    git submodule update -- "$gnulib_path" || exit $?
 
   elif [ ! -d "$gnulib_path" ]; then
     echo "$0: getting gnulib files..."
@@ -628,13 +653,14 @@ case ${GNULIB_SRCDIR--} in
       # This fallback allows at least git 1.5.5.
       if test -f "$gnulib_path"/gnulib-tool; then
         # Since file already exists, assume submodule init already complete.
-        git submodule update || exit $?
+        git submodule update -- "$gnulib_path" || exit $?
       else
         # Older git can't clone into an empty directory.
         rmdir "$gnulib_path" 2>/dev/null
         git clone --reference "$GNULIB_SRCDIR" \
           "$(git_modules_config submodule.gnulib.url)" "$gnulib_path" \
-          && git submodule init && git submodule update \
+          && git submodule init -- "$gnulib_path" \
+          && git submodule update -- "$gnulib_path" \
           || exit $?
       fi
     fi
@@ -889,7 +915,8 @@ if test $use_libtool = 1; then
   esac
 fi
 echo "$0: $gnulib_tool $gnulib_tool_options --import ..."
-$gnulib_tool $gnulib_tool_options --import $gnulib_modules &&
+$gnulib_tool $gnulib_tool_options --import $gnulib_modules \
+  || die "gnulib-tool failed"
 
 for file in $gnulib_files; do
   symlink_to_dir "$GNULIB_SRCDIR" $file \
diff --git a/bootstrap.conf b/bootstrap.conf
index af4f35a..d5bb5c8 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -1,6 +1,6 @@
 # Bootstrap configuration.
 
-# Copyright (C) 2006-2013, 2015 Free Software Foundation, Inc.
+# Copyright (C) 2006-2013, 2015-2016 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/cfg.mk b/cfg.mk
index 510bf8a..f934cf3 100644
--- a/cfg.mk
+++ b/cfg.mk
@@ -1,5 +1,5 @@
 # Customize maint.mk                           -*- makefile -*-
-# Copyright (C) 2003-2013, 2015 Free Software Foundation, Inc.
+# Copyright (C) 2003-2013, 2015-2016 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/configure.ac b/configure.ac
index 667ad61..13a9d75 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1,7 +1,7 @@
 # Configure template for GNU Diffutils.
 
-# Copyright (C) 1994-1995, 1998, 2001-2002, 2004, 2006, 2009-2013, 2015 Free
-# Software Foundation, Inc.
+# Copyright (C) 1994-1995, 1998, 2001-2002, 2004, 2006, 2009-2013, 2015-2016
+# Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/doc/Makefile.am b/doc/Makefile.am
index 641fc96..4f738c6 100644
--- a/doc/Makefile.am
+++ b/doc/Makefile.am
@@ -1,6 +1,6 @@
 # Makefile for GNU diffutils documentation.
 
-# Copyright (C) 2001-2002, 2009-2013, 2015 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2009-2013, 2015-2016 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 4ec9a0b..b7c7fad 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -14,7 +14,7 @@ and documents the @acronym{GNU} @command{diff}, @command{diff3},
 differences between files and the @acronym{GNU} @command{patch} command for
 using their output to update files.
 
-Copyright @copyright{} 1992-1994, 1998, 2001-2002, 2004, 2006, 2009-2015 Free
+Copyright @copyright{} 1992-1994, 1998, 2001-2002, 2004, 2006, 2009-2016 Free
 Software Foundation, Inc.
 
 @quotation
diff --git a/exgettext b/exgettext
index 19fbdb8..39a9b86 100755
--- a/exgettext
+++ b/exgettext
@@ -1,8 +1,8 @@
 #! /bin/sh
 # Wrapper around gettext for programs using the msgid convention.
 
-# Copyright (C) 1998, 2001, 2004, 2009-2013, 2015 Free Software Foundation,
-# Inc.
+# Copyright (C) 1998, 2001, 2004, 2009-2013, 2015-2016 Free Software
+# Foundation, Inc.
 
 # Written by Paul Eggert <eggert@twinsun.com>.
 
diff --git a/gnulib b/gnulib
index aecd387..271dfe3 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit aecd38787af5ca0000e184912194e8c83123eb7f
+Subproject commit 271dfe37985ff3a6e9cf9d08ab67e8ea3e239162
diff --git a/lib/Makefile.am b/lib/Makefile.am
index b8c6eb6..8542af7 100644
--- a/lib/Makefile.am
+++ b/lib/Makefile.am
@@ -1,6 +1,6 @@
 # Automakefile for GNU Diffutils library.
 
-# Copyright (C) 2001-2002, 2004, 2006, 2009-2013, 2015 Free Software
+# Copyright (C) 2001-2002, 2004, 2006, 2009-2013, 2015-2016 Free Software
 # Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
diff --git a/lib/cmpbuf.c b/lib/cmpbuf.c
index 498b43a..fd34505 100644
--- a/lib/cmpbuf.c
+++ b/lib/cmpbuf.c
@@ -1,6 +1,6 @@
 /* Buffer primitives for comparison operations.
 
-   Copyright (C) 1993, 1995, 1998, 2001-2002, 2006, 2009-2013, 2015 Free
+   Copyright (C) 1993, 1995, 1998, 2001-2002, 2006, 2009-2013, 2015-2016 Free
    Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
diff --git a/lib/cmpbuf.h b/lib/cmpbuf.h
index ecd2e21..b9333d8 100644
--- a/lib/cmpbuf.h
+++ b/lib/cmpbuf.h
@@ -1,6 +1,6 @@
 /* Buffer primitives for comparison operations.
 
-   Copyright (C) 2002, 2009-2013, 2015 Free Software Foundation, Inc.
+   Copyright (C) 2002, 2009-2013, 2015-2016 Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/lib/prepargs.c b/lib/prepargs.c
index 285ad2b..f4a2f12 100644
--- a/lib/prepargs.c
+++ b/lib/prepargs.c
@@ -1,7 +1,7 @@
 /* Parse arguments from a string and prepend them to an argv.
 
-   Copyright (C) 1999-2002, 2006, 2009-2013, 2015 Free Software Foundation,
-   Inc.
+   Copyright (C) 1999-2002, 2006, 2009-2013, 2015-2016 Free Software
+   Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/man/Makefile.am b/man/Makefile.am
index de55e00..918d863 100644
--- a/man/Makefile.am
+++ b/man/Makefile.am
@@ -1,6 +1,6 @@
 # Automakefile for GNU diffutils man pages
 
-# Copyright (C) 2002, 2009-2013, 2015 Free Software Foundation, Inc.
+# Copyright (C) 2002, 2009-2013, 2015-2016 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/man/help2man b/man/help2man
index 7c92fb5..e6207e5 100755
--- a/man/help2man
+++ b/man/help2man
@@ -1,7 +1,8 @@
 #!/usr/bin/perl -w
 
 # Generate a short man page from --help and --version output.
-# Copyright (C) 1997-2005, 2009-2011, 2013, 2015 Free Software Foundation, Inc.
+# Copyright (C) 1997-2005, 2009-2011, 2013, 2015-2016 Free Software Foundation,
+# Inc.
 
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/po/POTFILES.in b/po/POTFILES.in
index af39427..c379074 100644
--- a/po/POTFILES.in
+++ b/po/POTFILES.in
@@ -1,6 +1,6 @@
 # List of files that contain translatable strings.
 
-# Copyright (C) 2001-2002, 2009-2013, 2015 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2009-2013, 2015-2016 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/po/en.po b/po/en.po
index 2f44c2f..5886a2f 100644
--- a/po/en.po
+++ b/po/en.po
@@ -1,5 +1,6 @@
 # English messages for GNU diffutils
-# Copyright 1998, 2001-2003, 2009-2013, 2015 Free Software Foundation, Inc.
+# Copyright 1998, 2001-2003, 2009-2013, 2015-2016 Free Software Foundation,
+# Inc.
 # Paul Eggert <eggert@twinsun.com>, 1998
 #
 msgid ""
diff --git a/src/Makefile.am b/src/Makefile.am
index ca2d25c..167f7fd 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -1,6 +1,7 @@
 # Automakefile for GNU diffutils programs.
 
-# Copyright (C) 2001-2002, 2006, 2009-2013, 2015 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2006, 2009-2013, 2015-2016 Free Software Foundation,
+# Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/src/analyze.c b/src/analyze.c
index 2622810..3981872 100644
--- a/src/analyze.c
+++ b/src/analyze.c
@@ -1,7 +1,7 @@
 /* Analyze file differences for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2013, 2015 Free Software Foundation, Inc.
+   2009-2013, 2015-2016 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/cmp.c b/src/cmp.c
index 87ee7be..ba5553b 100644
--- a/src/cmp.c
+++ b/src/cmp.c
@@ -1,7 +1,7 @@
 /* cmp - compare two files byte by byte
 
-   Copyright (C) 1990-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013, 2015
-   Free Software Foundation, Inc.
+   Copyright (C) 1990-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013,
+   2015-2016 Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/src/context.c b/src/context.c
index 46b5b1f..1a92a60 100644
--- a/src/context.c
+++ b/src/context.c
@@ -1,7 +1,7 @@
 /* Context-format output routines for GNU DIFF.
 
    Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
-   2015 Free Software Foundation, Inc.
+   2015-2016 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/diff.c b/src/diff.c
index cff23f0..3a566b8 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -1,7 +1,7 @@
 /* diff - compare files line by line
 
    Copyright (C) 1988-1989, 1992-1994, 1996, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2013, 2015 Free Software Foundation, Inc.
+   2009-2013, 2015-2016 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/diff.h b/src/diff.h
index 6f1bb34..e4c138c 100644
--- a/src/diff.h
+++ b/src/diff.h
@@ -1,7 +1,7 @@
 /* Shared definitions for GNU DIFF
 
-   Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2009-2013, 2015
-   Free Software Foundation, Inc.
+   Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2009-2013,
+   2015-2016 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/diff3.c b/src/diff3.c
index 26a95ea..ba8ba80 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -1,7 +1,7 @@
 /* diff3 - compare three files line by line
 
    Copyright (C) 1988-1989, 1992-1996, 1998, 2001-2002, 2004, 2006, 2009-2013,
-   2015 Free Software Foundation, Inc.
+   2015-2016 Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/src/dir.c b/src/dir.c
index f34e83d..c8aa6a5 100644
--- a/src/dir.c
+++ b/src/dir.c
@@ -1,7 +1,7 @@
 /* Read, sort and compare two directories.  Used for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2013, 2015 Free Software Foundation, Inc.
+   2009-2013, 2015-2016 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/ed.c b/src/ed.c
index cb74f24..1fae2b8 100644
--- a/src/ed.c
+++ b/src/ed.c
@@ -1,7 +1,7 @@
 /* Output routines for ed-script format.
 
    Copyright (C) 1988-1989, 1991-1993, 1995, 1998, 2001, 2004, 2006, 2009-2013,
-   2015 Free Software Foundation, Inc.
+   2015-2016 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/ifdef.c b/src/ifdef.c
index c41f0aa..b8b084f 100644
--- a/src/ifdef.c
+++ b/src/ifdef.c
@@ -1,7 +1,7 @@
 /* #ifdef-format output routines for GNU DIFF.
 
-   Copyright (C) 1989, 1991-1994, 2001-2002, 2004, 2006, 2009-2013, 2015 Free
-   Software Foundation, Inc.
+   Copyright (C) 1989, 1991-1994, 2001-2002, 2004, 2006, 2009-2013, 2015-2016
+   Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/io.c b/src/io.c
index 1aab782..410bfef 100644
--- a/src/io.c
+++ b/src/io.c
@@ -1,7 +1,7 @@
 /* File I/O for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
-   2015 Free Software Foundation, Inc.
+   2015-2016 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/normal.c b/src/normal.c
index e78e8ba..852a767 100644
--- a/src/normal.c
+++ b/src/normal.c
@@ -1,7 +1,7 @@
 /* Normal-format output routines for GNU DIFF.
 
-   Copyright (C) 1988-1989, 1993, 1995, 1998, 2001, 2006, 2009-2013, 2015 Free
-   Software Foundation, Inc.
+   Copyright (C) 1988-1989, 1993, 1995, 1998, 2001, 2006, 2009-2013, 2015-2016
+   Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/sdiff.c b/src/sdiff.c
index 1c66beb..22d6e5b 100644
--- a/src/sdiff.c
+++ b/src/sdiff.c
@@ -1,7 +1,7 @@
 /* sdiff - side-by-side merge of file differences
 
-   Copyright (C) 1992-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013, 2015
-   Free Software Foundation, Inc.
+   Copyright (C) 1992-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013,
+   2015-2016 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/side.c b/src/side.c
index a0213c4..2276385 100644
--- a/src/side.c
+++ b/src/side.c
@@ -1,6 +1,6 @@
 /* sdiff-format output routines for GNU DIFF.
 
-   Copyright (C) 1991-1993, 1998, 2001-2002, 2004, 2009-2013, 2015 Free
+   Copyright (C) 1991-1993, 1998, 2001-2002, 2004, 2009-2013, 2015-2016 Free
    Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/system.h b/src/system.h
index 19a1f3a..be1c0bd 100644
--- a/src/system.h
+++ b/src/system.h
@@ -1,7 +1,7 @@
 /* System dependent declarations.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
-   2015 Free Software Foundation, Inc.
+   2015-2016 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/util.c b/src/util.c
index 1fa61fa..bf9ed97 100644
--- a/src/util.c
+++ b/src/util.c
@@ -1,7 +1,7 @@
 /* Support routines for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
-   2015 Free Software Foundation, Inc.
+   2015-2016 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/tests/help-version b/tests/help-version
index 5f01f76..339ece7 100755
--- a/tests/help-version
+++ b/tests/help-version
@@ -2,7 +2,7 @@
 # Make sure all these programs work properly
 # when invoked with --help or --version.
 
-# Copyright (C) 2000-2013, 2015 Free Software Foundation, Inc.
+# Copyright (C) 2000-2013, 2015-2016 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/tests/init.sh b/tests/init.sh
index 671f802..ee08022 100644
--- a/tests/init.sh
+++ b/tests/init.sh
@@ -1,6 +1,6 @@
 # source this file; set up for tests
 
-# Copyright (C) 2009-2013, 2015 Free Software Foundation, Inc.
+# Copyright (C) 2009-2016 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -93,6 +93,27 @@ skip_ () { warn_ "$ME_: skipped test: $@"; Exit 77; }
 fatal_ () { warn_ "$ME_: hard error: $@"; Exit 99; }
 framework_failure_ () { warn_ "$ME_: set-up failure: $@"; Exit 99; }
 
+# This is used to simplify checking of the return value
+# which is useful when ensuring a command fails as desired.
+# I.e., just doing `command ... &&fail=1` will not catch
+# a segfault in command for example.  With this helper you
+# instead check an explicit exit code like
+#   returns_ 1 command ... || fail
+returns_ () {
+  # Disable tracing so it doesn't interfere with stderr of the wrapped command
+  { set +x; } 2>/dev/null
+
+  local exp_exit="$1"
+  shift
+  "$@"
+  test $? -eq $exp_exit && ret_=0 || ret_=1
+
+  if test "$VERBOSE" = yes && test "$gl_set_x_corrupts_stderr_" = false; then
+    set -x
+  fi
+  { return $ret_; } 2>/dev/null
+}
+
 # Sanitize this shell to POSIX mode, if possible.
 DUALCASE=1; export DUALCASE
 if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
@@ -129,6 +150,7 @@ fi
 #  ? - not ok
 gl_shell_test_script_='
 test $(echo y) = y || exit 1
+f_local_() { local v=1; }; f_local_ || exit 1
 score_=10
 if test "$VERBOSE" = yes; then
   test -n "$( (exec 3>&1; set -x; P=1 true 2>&3) 2> /dev/null)" && score_=9
@@ -201,6 +223,8 @@ else
       *x*) opts_=-x ;;
       *) opts_= ;;
     esac
+    re_shell=$re_shell_
+    export re_shell
     exec "$re_shell_" $opts_ "$0" --no-reexec "$@"
     echo "$ME_: exec failed" 1>&2
     exit 127
@@ -303,7 +327,7 @@ elif diff_out_=`exec 2>/dev/null; diff -c "$0" "$0" < /dev/null`; then
       fi
     }
   fi
-elif ( cmp --version < /dev/null 2>&1 | grep GNU ) > /dev/null 2>&1; then
+elif cmp -s /dev/null /dev/null 2>/dev/null; then
   compare_ () { cmp -s "$@"; }
 else
   compare_ () { cmp "$@"; }
-- 
2.10.1 (Apple Git-78)


From 3b74a905c5460e7979c53273ac90345860d001a7 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Fri, 1 Jan 2016 18:24:25 -0800
Subject: [PATCH 072/119] FIXME: src/diff3: plug a leak

---
 src/diff3.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/diff3.c b/src/diff3.c
index ba8ba80..47df6f9 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -1040,6 +1040,7 @@ process_diff (char const *filea,
 
   *block_list_end = NULL;
   *last_block = bptr;
+  free (diff_contents);
   return block_list;
 }
 
-- 
2.10.1 (Apple Git-78)


From a19bcfd9e7eec512abb774797da33c630b632082 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 31 Jan 2016 16:53:39 -0800
Subject: [PATCH 073/119] gnulib: update to latest

---
 bootstrap | 6 +++---
 gnulib    | 2 +-
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/bootstrap b/bootstrap
index 294c0bc..f060bab 100755
--- a/bootstrap
+++ b/bootstrap
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Print a version string.
-scriptversion=2014-12-08.12; # UTC
+scriptversion=2016-01-24.06; # UTC
 
 # Bootstrap this package from checked-out sources.
 
@@ -42,7 +42,7 @@ export LC_ALL
 
 local_gl_dir=gl
 
-# Honour $PERL, but work even if there is none
+# Honor $PERL, but work even if there is none.
 PERL="${PERL-perl}"
 
 me=$0
@@ -1021,6 +1021,6 @@ echo "$0: done.  Now you can run './configure'."
 # eval: (add-hook 'write-file-hooks 'time-stamp)
 # time-stamp-start: "scriptversion="
 # time-stamp-format: "%:y-%02m-%02d.%02H"
-# time-stamp-time-zone: "UTC"
+# time-stamp-time-zone: "UTC0"
 # time-stamp-end: "; # UTC"
 # End:
diff --git a/gnulib b/gnulib
index 271dfe3..9c780eb 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 271dfe37985ff3a6e9cf9d08ab67e8ea3e239162
+Subproject commit 9c780eb5856f02192301672ccbde8cb1f096c09e
-- 
2.10.1 (Apple Git-78)


From 3d8affcc9dd85da0de0121e95a6f932d68feb5fa Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 31 Jan 2016 18:01:27 -0800
Subject: [PATCH 074/119] maint: update prereq version of gettext

* configure.ac: Increase designated gettext version to 0.19.2
* bootstrap.conf (buildreq): Likewise.
Remove now-unnecessary code to remove gettext-provided files.
---
 bootstrap.conf | 57 +++------------------------------------------------------
 configure.ac   |  2 +-
 2 files changed, 4 insertions(+), 55 deletions(-)

diff --git a/bootstrap.conf b/bootstrap.conf
index d5bb5c8..ec9f895 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -96,51 +96,6 @@ XGETTEXT_OPTIONS=$XGETTEXT_OPTIONS'\\\
  --flag=try_help:1:c-format\\\
 '
 
-# If "AM_GNU_GETTEXT(external" or "AM_GNU_GETTEXT([external]"
-# appears in configure.ac, exclude some unnecessary files.
-# Without grep's -E option (not portable enough, pre-configure),
-# the following test is ugly.  Also, this depends on the existence
-# of configure.ac, not the obsolescent-named configure.in.  But if
-# you're using this infrastructure, you should care about such things.
-
-gettext_external=0
-grep '^[	 ]*AM_GNU_GETTEXT(external\>' configure.ac > /dev/null &&
-  gettext_external=1
-grep '^[	 ]*AM_GNU_GETTEXT(\[external\]' configure.ac > /dev/null &&
-  gettext_external=1
-
-needed_gnulib_files=
-unnecessary_gettext_files=
-
-if test $gettext_external = 1; then
-  # Gettext supplies these files, but we don't need them since
-  # we don't have an intl subdirectory.
-  unnecessary_gettext_files='
-    m4/glibc2.m4
-    m4/intdiv0.m4
-    m4/intl.m4
-    m4/intldir.m4
-    m4/intmax.m4
-    m4/lcmessage.m4
-    m4/lock.m4
-    m4/printf-posix.m4
-    m4/threadlib.m4
-    m4/uintmax_t.m4
-    m4/visibility.m4
-  '
-
-  # Gettext supplies these files, but the gnulib version of these files
-  # typically is more up-to-date.  We don't use gnulib's gettext module,
-  # as it's too heavyweight, so grab the files one at a time instead.
-  needed_gnulib_files='
-    m4/gettext.m4
-    m4/intlmacosx.m4
-    m4/nls.m4
-    m4/po.m4
-    m4/progtest.m4
-  '
-fi
-
 gnulib_tool_option_extras="--tests-base=gnulib-tests --with-tests
   --avoid=localename
   --avoid=lock
@@ -153,7 +108,7 @@ buildreq="\
 autoconf   2.61
 automake   1.12.2
 autopoint  -
-gettext    -
+gettext    0.19.2
 git        1.4.4
 gperf      -
 gzip       -
@@ -164,16 +119,10 @@ rsync      -
 tar        -
 "
 
-# Automake requires that ChangeLog exist.
-touch ChangeLog || exit 1
-
 bootstrap_post_import_hook()
 {
-  for file in $needed_gnulib_files; do
-    echo "$0: $gnulib_tool --copy-file $file $file ..."
-    $gnulib_tool --copy-file $file $file || exit
-  done
-  rm -f $unnecessary_gettext_files || exit
+  # Automake requires that ChangeLog exist.
+  touch ChangeLog || exit 1
 }
 
 bootstrap_epilogue()
diff --git a/configure.ac b/configure.ac
index 13a9d75..a473d66 100644
--- a/configure.ac
+++ b/configure.ac
@@ -164,7 +164,7 @@ test -f $srcdir/.tarball-version \
   || SRC_VERSION_C=../src/version.c
 
 AM_GNU_GETTEXT([external], [need-ngettext])
-AM_GNU_GETTEXT_VERSION([0.18.2])
+AM_GNU_GETTEXT_VERSION([0.19.2])
 XGETTEXT="AWK='$AWK' \$(SHELL) \$(top_srcdir)/exgettext $XGETTEXT"
 
 AC_CONFIG_FILES([
-- 
2.10.1 (Apple Git-78)


From 17e2698bcbee30a6cc282d61ad6242a64ba9c7cf Mon Sep 17 00:00:00 2001
From: Giuseppe Scrivano <gscrivano@gnu.org>
Date: Mon, 1 Feb 2016 09:58:52 +0100
Subject: [PATCH 075/119] diff: --color: fix an infinite recursion bug

* src/diff.h (presume_output_tty): New extern variable.
* src/diff.c (PRESUME_OUTPUT_TTY_OPTION): New enum.
(group_format_option): Add '-presume-output-tty'.
(main): Handle PRESUME_OUTPUT_TTY_OPTION.
* src/util.c: New variable `presume_output_tty'.
(check_color_output): Handle presume_output_tty.
(set_color_context): Call process_signals only when color_context is
not RESET_CONTEXT.
* tests/colors: Check that diff doesn't crash when interrupted
in the middle of a color sequence.

Reported by Gisle Vanem in http://debbugs.gnu.org/22067
---
 src/diff.c   | 9 +++++++++
 src/diff.h   | 2 ++
 src/util.c   | 7 +++++--
 tests/colors | 9 +++++++++
 4 files changed, 25 insertions(+), 2 deletions(-)

diff --git a/src/diff.c b/src/diff.c
index 3a566b8..9bc1d96 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -141,6 +141,8 @@ enum
 
   COLOR_OPTION,
   COLOR_PALETTE_OPTION,
+
+  PRESUME_OUTPUT_TTY_OPTION,
 };
 
 static char const group_format_option[][sizeof "--unchanged-group-format"] =
@@ -219,6 +221,9 @@ static struct option const longopts[] =
   {"unified", 2, 0, 'U'},
   {"version", 0, 0, 'v'},
   {"width", 1, 0, 'W'},
+
+  /* This is solely for testing.  Do not document.  */
+  {"-presume-output-tty", no_argument, NULL, PRESUME_OUTPUT_TTY_OPTION},
   {0, 0, 0, 0}
 };
 
@@ -641,6 +646,10 @@ main (int argc, char **argv)
 	  set_color_palette (optarg);
 	  break;
 
+        case PRESUME_OUTPUT_TTY_OPTION:
+          presume_output_tty = true;
+          break;
+
 	default:
 	  try_help (NULL, NULL);
 	}
diff --git a/src/diff.h b/src/diff.h
index e4c138c..0983e7c 100644
--- a/src/diff.h
+++ b/src/diff.h
@@ -417,5 +417,7 @@ enum color_context
   LINE_NUMBER_CONTEXT,
 };
 
+XTERN bool presume_output_tty;
+
 extern void set_color_context (enum color_context color_context);
 extern void set_color_palette (char const *palette);
diff --git a/src/util.c b/src/util.c
index bf9ed97..d7b8925 100644
--- a/src/util.c
+++ b/src/util.c
@@ -44,6 +44,8 @@
 
 char const pr_program[] = PR_PROGRAM;
 
+bool presume_output_tty;
+
 /* Queue up one-line messages to be printed at the end,
    when -l is specified.  Each message is recorded with a 'struct msg'.  */
 
@@ -710,7 +712,7 @@ check_color_output (bool is_pipe)
   if (! outfile || colors_style == NEVER)
     return;
 
-  output_is_tty = !is_pipe && isatty (fileno (outfile));
+  output_is_tty = presume_output_tty || (!is_pipe && isatty (fileno (outfile)));
 
   colors_enabled = (colors_style == ALWAYS
                     || (colors_style == AUTO && output_is_tty));
@@ -1349,7 +1351,8 @@ static enum color_context last_context = RESET_CONTEXT;
 void
 set_color_context (enum color_context color_context)
 {
-  process_signals ();
+  if (color_context != RESET_CONTEXT)
+    process_signals ();
   if (colors_enabled && last_context != color_context)
     {
       put_indicator (&color_indicator[C_LEFT]);
diff --git a/tests/colors b/tests/colors
index facfd8d..881c1b8 100755
--- a/tests/colors
+++ b/tests/colors
@@ -116,4 +116,13 @@ test $? = 1 || fail=1
 gen_exp_u > exp || framework_failure_
 compare exp out || fail=1
 
+# Before the fix in http://debbugs.gnu.org/22067,
+# this test would trigger an infinite loop bug.
+mkfifo fifo
+printf '%*s-a' 1000000 > a
+printf '%*s-b' 1000000 > b
+head -c 10 < fifo > /dev/null &
+diff --color=always ---presume-output-tty a b > fifo
+test $? = 141 || fail=1
+
 Exit $fail
-- 
2.10.1 (Apple Git-78)


From 5a485511d77a23d144a05266482ce89171249156 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Tue, 15 Mar 2016 10:38:23 -0700
Subject: [PATCH 076/119] maint: don't ignore gitlog-to-changelog failure

* Makefile.am (gen-ChangeLog): Don't ignore failure of
gitlog-to-changelog. This syncs to coreutils' copy of this rule.
---
 Makefile.am | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index 06ce7c4..244024e 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -34,9 +34,9 @@ gen_start_date = '2009-11-11 15:00'
 gen-ChangeLog:
 	$(AM_V_GEN)if test -d .git; then				\
 	  $(top_srcdir)/build-aux/gitlog-to-changelog			\
-	    --since=$(gen_start_date) > $(distdir)/cl-t;		\
-	  rm -f $(distdir)/ChangeLog;					\
-	  mv $(distdir)/cl-t $(distdir)/ChangeLog;			\
+	    --since=$(gen_start_date) > $(distdir)/cl-t &&		\
+	    { rm -f $(distdir)/ChangeLog &&				\
+	      mv $(distdir)/cl-t $(distdir)/ChangeLog; }		\
 	fi
 
 ALL_RECURSIVE_TARGETS += distcheck-hook
-- 
2.10.1 (Apple Git-78)


From 8c19e4a18ef037b97054f6ea4aefa94f62ac9dbc Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 30 Apr 2016 19:23:24 +0100
Subject: [PATCH 077/119] maint: arrange for better URLs in generated
 announcement message

* cfg.mk (url_dir_list): Define.  I had been correcting the generated
URLs by hand, just before the announcement.  This is better.
---
 cfg.mk | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/cfg.mk b/cfg.mk
index f934cf3..83e7860 100644
--- a/cfg.mk
+++ b/cfg.mk
@@ -14,6 +14,10 @@
 # You should have received a copy of the GNU General Public License
 # along with this program.  If not, see <http://www.gnu.org/licenses/>.
 
+# Use the direct link.  This is guaranteed to work immediately, while
+# it can take a while for the faster mirror links to become usable.
+url_dir_list = http://ftp.gnu.org/gnu/$(PACKAGE)
+
 # Used in maint.mk's web-manual rule
 manual_title = Comparing and Merging Files
 
-- 
2.10.1 (Apple Git-78)


From 752679190cf610ea32c54d625c368bb87da156fc Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 24 May 2016 19:51:36 -0700
Subject: [PATCH 078/119] doc: fix a reference to emacs' emerge node

* doc/diffutils.texi (Interactive Merging): Correct a reference to
emacs' emerge node: s/emerge/Emerge/.
This addresses http://debbugs.gnu.org/23613
---
 doc/diffutils.texi | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index b7c7fad..b478380 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -2438,7 +2438,7 @@ put the merged text.  @xref{Invoking sdiff}, for more details on the
 options to @command{sdiff}.
 
 Another way to merge files interactively is to use the Emacs Lisp
-package @command{emerge}.  @xref{emerge, , emerge, emacs, The
+package @command{emerge}.  @xref{Emerge, , Emerge, emacs, The
 @acronym{GNU} Emacs Manual}, for more information.
 
 @menu
-- 
2.10.1 (Apple Git-78)


From a10ff125c8ff7fbaf1100cd41ea4e8ac0d594c82 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 2 Apr 2016 18:42:19 -0700
Subject: [PATCH 079/119] maint: arrange for "make distcheck" to work with
 unreleased automake

* dist-check.mk (my-distcheck): Remove all .deps directories
before performing the recursive comparison.
---
 dist-check.mk | 1 +
 1 file changed, 1 insertion(+)

diff --git a/dist-check.mk b/dist-check.mk
index dd30db2..06d8d90 100644
--- a/dist-check.mk
+++ b/dist-check.mk
@@ -161,6 +161,7 @@ my-distcheck: $(DIST_ARCHIVES) $(local-check)
 	)
 	(cd $(t) && mv $(distdir) $(distdir).old	\
 	  && $(amtar_extract_) - ) < $(preferred_tarball_)
+	find $(t)/$(distdir).old $(t)/$(distdir) -name .deps | xargs rm -rf
 	diff -ur $(t)/$(distdir).old $(t)/$(distdir)
 	-rm -rf $(t)
 	rmdir $(tmpdir)/$(PACKAGE) $(tmpdir)
-- 
2.10.1 (Apple Git-78)


From 0353af91a02d1bd14b18d10293f1ef27dd6c0a58 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 23 Jul 2016 16:33:35 -0700
Subject: [PATCH 080/119] gnulib: update to latest; and tests/init.sh

* gnulib: Update to latest.
* init.sh: Update from gnulib.
---
 gnulib        |  2 +-
 tests/init.sh | 31 +++++++++++++++++--------------
 2 files changed, 18 insertions(+), 15 deletions(-)

diff --git a/gnulib b/gnulib
index 9c780eb..348402f 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 9c780eb5856f02192301672ccbde8cb1f096c09e
+Subproject commit 348402f2aac342bc925b7aaea9ee3cc353f427a9
diff --git a/tests/init.sh b/tests/init.sh
index ee08022..97e4e4b 100644
--- a/tests/init.sh
+++ b/tests/init.sh
@@ -308,13 +308,19 @@ if diff_out_=`exec 2>/dev/null; diff -u "$0" "$0" < /dev/null` \
       fi
     }
   fi
-elif diff_out_=`exec 2>/dev/null; diff -c "$0" "$0" < /dev/null`; then
+elif
+  for diff_opt_ in -U3 -c '' no; do
+    test "$diff_opt_" = no && break
+    diff_out_=`exec 2>/dev/null; diff $diff_opt_ "$0" "$0" </dev/null` && break
+  done
+  test "$diff_opt_" != no
+then
   if test -z "$diff_out_"; then
-    compare_ () { diff -c "$@"; }
+    compare_ () { diff $diff_opt_ "$@"; }
   else
     compare_ ()
     {
-      if diff -c "$@" > diff.out; then
+      if diff $diff_opt_ "$@" > diff.out; then
         # No differences were found, but AIX and HP-UX 'diff' produce output
         # "No differences encountered" or "There are no differences between the
         # files.". Hide this output.
@@ -466,7 +472,6 @@ setup_ ()
   fi
 
   initial_cwd_=$PWD
-  fail=0
 
   pfx_=`testdir_prefix_`
   test_dir_=`mktempd_ "$initial_cwd_" "$pfx_-$ME_.XXXX"` \
@@ -550,8 +555,9 @@ mktempd_ ()
   # Disallow any trailing slash on specified destdir:
   # it would subvert the post-mktemp "case"-based destdir test.
   case $destdir_ in
-  /) ;;
+  / | //) destdir_slash_=$destdir;;
   */) fail_ "invalid destination dir: remove trailing slash(es)";;
+  *) destdir_slash_=$destdir_/;;
   esac
 
   case $template_ in
@@ -561,20 +567,17 @@ mktempd_ ()
   esac
 
   # First, try to use mktemp.
-  d=`unset TMPDIR; { mktemp -d -t -p "$destdir_" "$template_"; } 2>/dev/null` \
-    || fail=1
+  d=`unset TMPDIR; { mktemp -d -t -p "$destdir_" "$template_"; } 2>/dev/null` &&
 
   # The resulting name must be in the specified directory.
-  case $d in "$destdir_"*);; *) fail=1;; esac
+  case $d in "$destdir_slash_"*) :;; *) false;; esac &&
 
   # It must have created the directory.
-  test -d "$d" || fail=1
+  test -d "$d" &&
 
   # It must have 0700 permissions.  Handle sticky "S" bits.
-  perms=`ls -dgo "$d" 2>/dev/null|tr S -` || fail=1
-  case $perms in drwx------*) ;; *) fail=1;; esac
-
-  test $fail = 0 && {
+  perms=`ls -dgo "$d" 2>/dev/null` &&
+  case $perms in drwx--[-S]---*) :;; *) false;; esac && {
     echo "$d"
     return
   }
@@ -593,7 +596,7 @@ mktempd_ ()
   i_=1
   while :; do
     X_=`rand_bytes_ $nx_`
-    candidate_dir_="$destdir_/$base_template_$X_"
+    candidate_dir_="$destdir_slash_$base_template_$X_"
     err_=`mkdir -m 0700 "$candidate_dir_" 2>&1` \
       && { echo "$candidate_dir_"; return; }
     test $MAX_TRIES_ -le $i_ && break;
-- 
2.10.1 (Apple Git-78)


From 55596fcd4846a802da9bce831547a9a01e4cbe15 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 31 Jul 2016 17:33:34 -0700
Subject: [PATCH 081/119] tests: colors: fix a portability problem and work
 around a shell bug

* tests/colors (e): Fix a portability bug: use printf '\033'
rather than '\e' to generate the required byte sequence, since
for some shells (at least dash 0.5.8), the latter doesn't work.
Work around a shell bug whereby "local tab=$(printf '\t')"
would result in an empty value for "$tab": hoist each "tab"
definition up/out of its function to global scope.
Reported by Assaf Gordon in http://debbugs.gnu.org/24116#8
---
 tests/colors | 34 +++++++++++++++++-----------------
 1 file changed, 17 insertions(+), 17 deletions(-)

diff --git a/tests/colors b/tests/colors
index 881c1b8..881ef5a 100755
--- a/tests/colors
+++ b/tests/colors
@@ -12,16 +12,17 @@ echo b > b
 
 epoch='1970-01-01 00:00:00'
 touch --date="$epoch" a b
+e=$(printf '\033')
+tab=$(printf '\t')
 
 gen_exp_u()
 {
-    local tab=$(printf '\t')
     local epoch_plus="$epoch.000000000 +0000"
-    local rs=$(printf "\e[${rs}m")
-    local hd=$(printf "\e[${hd}m")
-    local ad=$(printf "\e[${ad}m")
-    local de=$(printf "\e[${de}m")
-    local ln=$(printf "\e[${ln}m")
+    local rs=$(printf "$e[${rs}m")
+    local hd=$(printf "$e[${hd}m")
+    local ad=$(printf "$e[${ad}m")
+    local de=$(printf "$e[${de}m")
+    local ln=$(printf "$e[${ln}m")
     printf '%s' \
 "$hd--- a$tab$epoch_plus
 +++ b$tab$epoch_plus
@@ -33,13 +34,12 @@ $ad+b$rs
 
 gen_exp_c()
 {
-    local tab=$(printf '\t')
     local epoch_posix_1003_1_2001="Thu Jan  1 00:00:00 1970"
-    local rs=$(printf "\e[${rs}m")
-    local hd=$(printf "\e[${hd}m")
-    local ad=$(printf "\e[${ad}m")
-    local de=$(printf "\e[${de}m")
-    local ln=$(printf "\e[${ln}m")
+    local rs=$(printf "$e[${rs}m")
+    local hd=$(printf "$e[${hd}m")
+    local ad=$(printf "$e[${ad}m")
+    local de=$(printf "$e[${de}m")
+    local ln=$(printf "$e[${ln}m")
     printf '%s' \
 "$hd*** a$tab$epoch_posix_1003_1_2001
 --- b$tab$epoch_posix_1003_1_2001
@@ -63,11 +63,11 @@ gen_exp_default()
 
 gen_exp_default_colors()
 {
-    local rs=$(printf "\e[${rs}m")
-    local hd=$(printf "\e[${hd}m")
-    local ad=$(printf "\e[${ad}m")
-    local de=$(printf "\e[${de}m")
-    local ln=$(printf "\e[${ln}m")
+    local rs=$(printf "$e[${rs}m")
+    local hd=$(printf "$e[${hd}m")
+    local ad=$(printf "$e[${ad}m")
+    local de=$(printf "$e[${de}m")
+    local ln=$(printf "$e[${ln}m")
     printf '%s' \
 "${ln}1c1$rs
 $de< a$rs
-- 
2.10.1 (Apple Git-78)


From e974118719b9f79adf36454151b13eb2622faa93 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 31 Jul 2016 17:46:17 -0700
Subject: [PATCH 082/119] maint: remove gl/lib/reg*.c.diff; no longer needed

* gl/lib/regcomp.c.diff: Remove file, now that gnulib's
regcomp.c compiles regex.c with -Wno-unused-parameter.
* gl/lib/regex_internal.c.diff: This file induced a change to ensure
that the "Idx" type was unsigned and to remove a few "VAR < 0"
comparisons.  These days, it is probably fine to stay in sync with
gnulib/glibc's copies
of these files, so remove these patches, too.
* gl/lib/regexec.c.diff: Likewise.
Prompted by a report by Assaf Gordon and a suggestion from Paul Eggert.
---
 gl/lib/regcomp.c.diff        | 65 --------------------------------------------
 gl/lib/regex_internal.c.diff | 25 -----------------
 gl/lib/regexec.c.diff        | 45 ------------------------------
 3 files changed, 135 deletions(-)
 delete mode 100644 gl/lib/regcomp.c.diff
 delete mode 100644 gl/lib/regex_internal.c.diff
 delete mode 100644 gl/lib/regexec.c.diff

diff --git a/gl/lib/regcomp.c.diff b/gl/lib/regcomp.c.diff
deleted file mode 100644
index 30a6a02..0000000
--- a/gl/lib/regcomp.c.diff
+++ /dev/null
@@ -1,65 +0,0 @@
-diff -pu a/lib/regcomp.c b/lib/regcomp.c
---- a/lib/regcomp.c
-+++ b/lib/regcomp.c
-@@ -539,7 +539,7 @@ regerror (errcode, preg, errbuf, errbuf_
-     size_t errbuf_size;
- #else /* size_t might promote */
- size_t
--regerror (int errcode, const regex_t *_Restrict_ preg,
-+regerror (int errcode, const regex_t *_Restrict_ preg _UNUSED_PARAMETER_,
- 	  char *_Restrict_ errbuf, size_t errbuf_size)
- #endif
- {
-@@ -1415,7 +1415,7 @@ calc_first (void *extra, bin_tree_t *nod
-
- /* Pass 2: compute NEXT on the tree.  Preorder visit.  */
- static reg_errcode_t
--calc_next (void *extra, bin_tree_t *node)
-+calc_next (void *extra _UNUSED_PARAMETER_, bin_tree_t *node)
- {
-   switch (node->token.type)
-     {
-@@ -2798,8 +2798,10 @@ build_range_exp (const reg_syntax_t synt
- static reg_errcode_t
- internal_function
- # ifdef RE_ENABLE_I18N
--build_collating_symbol (bitset_t sbcset, re_charset_t *mbcset,
--			Idx *coll_sym_alloc, const unsigned char *name)
-+build_collating_symbol (bitset_t sbcset,
-+			re_charset_t *mbcset _UNUSED_PARAMETER_,
-+			Idx *coll_sym_alloc _UNUSED_PARAMETER_,
-+			const unsigned char *name)
- # else /* not RE_ENABLE_I18N */
- build_collating_symbol (bitset_t sbcset, const unsigned char *name)
- # endif /* not RE_ENABLE_I18N */
-@@ -3383,7 +3385,8 @@ parse_bracket_exp (re_string_t *regexp,
-
- static reg_errcode_t
- parse_bracket_element (bracket_elem_t *elem, re_string_t *regexp,
--		       re_token_t *token, int token_len, re_dfa_t *dfa,
-+		       re_token_t *token, int token_len,
-+		       re_dfa_t *dfa _UNUSED_PARAMETER_,
- 		       reg_syntax_t syntax, bool accept_hyphen)
- {
- #ifdef RE_ENABLE_I18N
-@@ -3470,8 +3473,9 @@ parse_bracket_symbol (bracket_elem_t *el
-
- static reg_errcode_t
- #ifdef RE_ENABLE_I18N
--build_equiv_class (bitset_t sbcset, re_charset_t *mbcset,
--		   Idx *equiv_class_alloc, const unsigned char *name)
-+build_equiv_class (bitset_t sbcset, re_charset_t *mbcset _UNUSED_PARAMETER_,
-+		   Idx *equiv_class_alloc _UNUSED_PARAMETER_,
-+		   const unsigned char *name)
- #else /* not RE_ENABLE_I18N */
- build_equiv_class (bitset_t sbcset, const unsigned char *name)
- #endif /* not RE_ENABLE_I18N */
-@@ -3877,7 +3881,7 @@ free_token (re_token_t *node)
-    and its children. */
-
- static reg_errcode_t
--free_tree (void *extra, bin_tree_t *node)
-+free_tree (void *extra _UNUSED_PARAMETER_, bin_tree_t *node)
- {
-   free_token (&node->token);
-   return REG_NOERROR;
diff --git a/gl/lib/regex_internal.c.diff b/gl/lib/regex_internal.c.diff
deleted file mode 100644
index 40b0f55..0000000
--- a/gl/lib/regex_internal.c.diff
+++ /dev/null
@@ -1,25 +0,0 @@
-diff --git a/lib/regex_internal.c b/lib/regex_internal.c
-index 904b88e..61c8d9d 100644
---- a/lib/regex_internal.c
-+++ b/lib/regex_internal.c
-@@ -17,6 +17,8 @@
-    with this program; if not, write to the Free Software Foundation,
-    Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA. */
-
-+#include "verify.h"
-+#include "intprops.h"
- static void re_string_construct_common (const char *str, Idx len,
- 					re_string_t *pstr,
- 					RE_TRANSLATE_TYPE trans, bool icase,
-@@ -1394,7 +1396,10 @@ static void
- internal_function
- re_node_set_remove_at (re_node_set *set, Idx idx)
- {
--  if (idx < 0 || idx >= set->nelem)
-+  verify (! TYPE_SIGNED (Idx));
-+  /* if (idx < 0)
-+     return; */
-+  if (idx >= set->nelem)
-     return;
-   --set->nelem;
-   for (; idx < set->nelem; idx++)
diff --git a/gl/lib/regexec.c.diff b/gl/lib/regexec.c.diff
deleted file mode 100644
index d9b6d1c..0000000
--- a/gl/lib/regexec.c.diff
+++ /dev/null
@@ -1,45 +0,0 @@
-diff --git a/lib/regexec.c b/lib/regexec.c
-index 21a8166..7762437 100644
---- a/lib/regexec.c
-+++ b/lib/regexec.c
-@@ -18,6 +18,8 @@
-    with this program; if not, write to the Free Software Foundation,
-    Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA. */
-
-+#include "verify.h"
-+#include "intprops.h"
- static reg_errcode_t match_ctx_init (re_match_context_t *cache, int eflags,
- 				     Idx n) internal_function;
- static void match_ctx_clean (re_match_context_t *mctx) internal_function;
-@@ -378,8 +380,11 @@ re_search_2_stub (struct re_pattern_buffer *bufp,
-   Idx len = length1 + length2;
-   char *s = NULL;
-
--  if (BE (length1 < 0 || length2 < 0 || stop < 0 || len < length1, 0))
--    return -2;
-+  verify (! TYPE_SIGNED (Idx));
-+  if (BE (len < length1, 0))
-+     return -2;
-+  /* if (BE (length1 < 0 || length2 < 0 || stop < 0, 0))
-+     return -2; */
-
-   /* Concatenate the strings.  */
-   if (length2 > 0)
-@@ -431,11 +436,14 @@ re_search_stub (struct re_pattern_buffer *bufp,
-   Idx last_start = start + range;
-
-   /* Check for out-of-range.  */
--  if (BE (start < 0 || start > length, 0))
--    return -1;
-+  verify (! TYPE_SIGNED (Idx));
-+  /* if (BE (start < 0, 0))
-+     return -1; */
-+  if (BE (start > length, 0))
-+     return -1;
-   if (BE (length < last_start || (0 <= range && last_start < start), 0))
-     last_start = length;
--  else if (BE (last_start < 0 || (range < 0 && start <= last_start), 0))
-+  else if (BE (/* last_start < 0 || */ (range < 0 && start <= last_start), 0))
-     last_start = 0;
-
-   __libc_lock_lock (dfa->lock);
-- 
2.10.1 (Apple Git-78)


From b43e6fed25d5fbd0243224753e14be2f4eb00b7e Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 31 Jul 2016 21:29:21 -0700
Subject: [PATCH 083/119] test: improve test infrastructure

* tests/envvar-check: New file, copied from grep, with the addition
of the EDITOR and GREP_OPTIONS envvar names.
* tests/Makefile.am (EXTRA_DIST): Add it.
(TESTS_ENVIRONMENT): Revamp, to be more like that of grep.
---
 tests/Makefile.am  | 71 ++++++++++++++++++++++++++++++++++++------------------
 tests/envvar-check | 65 +++++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 113 insertions(+), 23 deletions(-)
 create mode 100644 tests/envvar-check

diff --git a/tests/Makefile.am b/tests/Makefile.am
index 5457d3a..e8a36ac 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -20,34 +20,59 @@ TESTS = \
   colors
 
 EXTRA_DIST = \
-  $(TESTS) init.sh t-local.sh
+  $(TESTS) init.sh t-local.sh envvar-check
 
 # Note that the first lines are statements.  They ensure that environment
 # variables that can perturb tests are unset or set to expected values.
 # The rest are envvar settings that propagate build-related Makefile
 # variables to test scripts.
-TESTS_ENVIRONMENT =							\
-  tmp__=$$TMPDIR; test -d "$$tmp__" || tmp__=.;				\
-  TMPDIR=$$tmp__; export TMPDIR;					\
-  VERSION='$(VERSION)'; export VERSION;					\
-  abs_top_builddir='$(abs_top_builddir)'; export abs_top_builddir;	\
-  abs_top_srcdir='$(abs_top_srcdir)'; export abs_top_srcdir;		\
-  abs_srcdir='$(abs_srcdir)'; export abs_srcdir;			\
-  built_programs="`$(built_programs)`"					\
-  srcdir='$(srcdir)'; export built_programs;				\
-  top_srcdir='$(top_srcdir)'; export top_srcdir;			\
-  CC='$(CC)'; export CC;						\
-  MAKE=$(MAKE); export MAKE;						\
-  PACKAGE_BUGREPORT='$(PACKAGE_BUGREPORT)'; export PACKAGE_BUGREPORT;	\
-  PACKAGE_VERSION=$(PACKAGE_VERSION); export PACKAGE_VERSION;		\
-  CONFIG_HEADER='$(abs_top_builddir)/lib/config.h'; export CONFIG_HEADER; \
-  ENABLE_DEVICE_MAPPER=$(ENABLE_DEVICE_MAPPER); export ENABLE_DEVICE_MAPPER; \
-  PERL='$(PERL)'; export PERL;						\
-  PREFERABLY_POSIX_SHELL='$(PREFERABLY_POSIX_SHELL)';			\
-    export PREFERABLY_POSIX_SHELL;					\
-  REPLACE_GETCWD=$(REPLACE_GETCWD); export REPLACE_GETCWD;		\
-  PATH='$(abs_top_builddir)/src$(PATH_SEPARATOR)'"$$PATH"; export PATH	\
-  stderr_fileno_=9; export stderr_fileno				\
+TESTS_ENVIRONMENT =					\
+  tmp__=$${TMPDIR-/tmp};				\
+  test -d "$$tmp__" && test -w "$$tmp__" || tmp__=.;	\
+  . $(srcdir)/envvar-check;				\
+  TMPDIR=$$tmp__; export TMPDIR;			\
+							\
+  if test -n "$$BASH_VERSION" || (eval "export v=x") 2>/dev/null; then \
+    export_with_values () { export "$$@"; };		\
+  else							\
+    export_with_values ()				\
+    {							\
+      sed_extract_var='s/=.*//';			\
+      sed_quote_value="s/'/'\\\\''/g;s/=\\(.*\\)/='\\1'/";\
+      for arg in "$$@"; do				\
+        var=`echo "$$arg" | sed "$$sed_extract_var"`;	\
+        arg=`echo "$$arg" | sed "$$sed_quote_value"`;	\
+        eval "$$arg";					\
+        export "$$var";					\
+      done;						\
+    };							\
+  fi;							\
+							\
+  export_with_values					\
+  VERSION='$(VERSION)'					\
+  LOCALE_FR='$(LOCALE_FR)'				\
+  LOCALE_FR_UTF8='$(LOCALE_FR_UTF8)'			\
+  AWK=$(AWK)						\
+  GREP_OPTIONS=''					\
+  LC_ALL=C						\
+  abs_top_builddir='$(abs_top_builddir)'		\
+  abs_top_srcdir='$(abs_top_srcdir)'			\
+  abs_srcdir='$(abs_srcdir)'				\
+  built_programs="`$(built_programs)`"			\
+  srcdir='$(srcdir)'					\
+  top_srcdir='$(top_srcdir)'				\
+  CC='$(CC)'						\
+  DIFFUTILS_TEST_NAME=`echo $$tst|sed 's,^\./,,;s,/,-,g'` \
+  MAKE=$(MAKE)						\
+  MALLOC_PERTURB_=$(MALLOC_PERTURB_)			\
+  PACKAGE_BUGREPORT='$(PACKAGE_BUGREPORT)'		\
+  PACKAGE_VERSION=$(PACKAGE_VERSION)			\
+  PERL='$(PERL)'					\
+  SHELL='$(SHELL)'					\
+  PREFERABLY_POSIX_SHELL='$(PREFERABLY_POSIX_SHELL)'	\
+  REPLACE_GETCWD=$(REPLACE_GETCWD)			\
+  PATH='$(abs_top_builddir)/src$(PATH_SEPARATOR)'"$$PATH"	\
+  stderr_fileno_=9					\
   ; 9>&2
 
 LOG_COMPILER= $(SHELL)
diff --git a/tests/envvar-check b/tests/envvar-check
new file mode 100644
index 0000000..3debef7
--- /dev/null
+++ b/tests/envvar-check
@@ -0,0 +1,65 @@
+# -*- sh -*-
+# Check environment variables for sane values while testing.
+
+# Copyright (C) 2000-2016 Free Software Foundation, Inc.
+
+# This program is free software: you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or
+# (at your option) any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+
+if (FOO=FOO; unset FOO) >/dev/null 2>&1; then
+  as_unset=unset
+else
+  as_unset=false
+fi
+
+envvar_check_fail=0
+vars='
+  _POSIX2_VERSION
+  _STDBUF_E
+  _STDBUF_I
+  _STDBUF_O
+  BASH_ENV
+  BLOCKSIZE
+  BLOCK_SIZE
+  CDPATH
+  COLUMNS
+  DF_BLOCK_SIZE
+  DU_BLOCK_SIZE
+  EDITOR
+  ENV
+  GREP_OPTIONS
+  LANGUAGE
+  LS_BLOCK_SIZE
+  LS_COLORS
+  OMP_NUM_THREADS
+  POSIXLY_CORRECT
+  QUOTING_STYLE
+  SIMPLE_BACKUP_SUFFIX
+  TABSIZE
+  TERM
+  COLORTERM
+  TIME_STYLE
+  TMPDIR
+  VERSION_CONTROL
+'
+for var in $vars
+do
+  $as_unset $var
+  if eval test \"\${$var+set}\" = set; then
+    echo "$0: the $var environment variable is set --" \
+      ' unset it and rerun this test' >&2
+    envvar_check_fail=1
+  fi
+done
+
+test "$envvar_check_fail" = 1 && exit 1
-- 
2.10.1 (Apple Git-78)


From 47f84d5a75bd46822c000ceab4abea5c11079d17 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Mon, 1 Aug 2016 08:03:22 -0700
Subject: [PATCH 084/119] build: Solaris 9: avoid link failure due to isblank
 use

* bootstrap.conf (gnulib_modules): Add isblank, to avoid a link
error on Solaris 9 Sparc.  Reported by Dagobert Michelsen.
---
 bootstrap.conf | 1 +
 1 file changed, 1 insertion(+)

diff --git a/bootstrap.conf b/bootstrap.conf
index ec9f895..828ffef 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -48,6 +48,7 @@ gnupload
 hard-locale
 inttostr
 inttypes
+isblank
 largefile
 lstat
 maintainer-makefile
-- 
2.10.1 (Apple Git-78)


From df14e616b3d497c611edb04d6071b09565f65434 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Mon, 1 Aug 2016 09:23:03 -0700
Subject: [PATCH 085/119] tests/colors: fix portability problem with touch
 --date

* tests/colors (epoch): Don't use GNU touch's --date=$epoch option.
Use the portable -t 197001010000.00.
Reported by Assaf Gordon in https://debbugs.gnu.org/24121#8
---
 tests/colors | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/tests/colors b/tests/colors
index 881ef5a..3ad2206 100755
--- a/tests/colors
+++ b/tests/colors
@@ -11,7 +11,8 @@ echo a > a
 echo b > b
 
 epoch='1970-01-01 00:00:00'
-touch --date="$epoch" a b
+touch -t 197001010000.00 a b
+
 e=$(printf '\033')
 tab=$(printf '\t')
 
-- 
2.10.1 (Apple Git-78)


From 38e3a1dd49d6a2793eb990da60efae25a2ba1fcf Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Tue, 2 Aug 2016 09:30:06 -0700
Subject: [PATCH 086/119] tests: skip a /proc/self-dependent test on the Hurd

* tests/brief-vs-stat-zero-kernel-lies: The Hurd's /proc/self
is not useful, so detect that and skip the test that requires it.
Reported by Assaf Gordon in https://debbugs.gnu.org/24121#29
---
 tests/brief-vs-stat-zero-kernel-lies | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/tests/brief-vs-stat-zero-kernel-lies b/tests/brief-vs-stat-zero-kernel-lies
index 9b272c6..7b043db 100755
--- a/tests/brief-vs-stat-zero-kernel-lies
+++ b/tests/brief-vs-stat-zero-kernel-lies
@@ -14,6 +14,14 @@ test -f $boot || skip_ no $boot file
 sz=$(stat --format %s $boot) || skip_ stat --format %s does not work
 test $sz = 0 || skip_ $boot has nonzero size
 
+# /proc/self is not useful on the Hurd, where it always points to "1",
+# so skip this test when /proc/self does not point to a file whose name is
+# the current process ID.
+readlink /proc/self > pid & pid=$!
+wait $pid
+echo $pid > exp
+compare exp pid || skip_ /proc/self is not useful on this system
+
 # There are two code paths to test: one for non-binary and one for binary files.
 # $boot is non-binary.
 cat $boot > ref || framework_failure_
-- 
2.10.1 (Apple Git-78)


From a37c5846867defe109e1eefe550793cd8947fbb2 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Tue, 2 Aug 2016 19:09:20 -0700
Subject: [PATCH 087/119] gnulib: update to latest

---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index 348402f..0fe8b3c 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 348402f2aac342bc925b7aaea9ee3cc353f427a9
+Subproject commit 0fe8b3c8116168e3b8b058df63ddedd45c3fcab0
-- 
2.10.1 (Apple Git-78)


From 91d23408864f70ce2da19d0b272b298e72fad018 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 6 Aug 2016 11:19:07 -0700
Subject: [PATCH 088/119] tests: tweak built_programs definition

* tests/Makefile.am (built_programs): Adjust to work around what
may be a problem due to interaction between Solaris 10's /bin/sh
and an old version of GNU make. Reported by Dagobert Michelsen
in https https://bugs.gnu.org/24137.
---
 tests/Makefile.am | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/tests/Makefile.am b/tests/Makefile.am
index e8a36ac..77d9fc3 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -79,7 +79,11 @@ LOG_COMPILER= $(SHELL)
 
 built_programs =							\
   echo 'spy:;@echo $$(PROGRAMS)'					\
-    | (cd ../src && MAKEFLAGS= $(MAKE) -s -f Makefile -f - spy)		\
-    | tr ' ' '\n' | sed '/^$$/d; s,$(EXEEXT)$$,,' | sort -u
+    | { (cd ../src && MAKEFLAGS= $(MAKE) -s -f Makefile -f - spy)	\
+          | tr ' ' '\n'							\
+          | sed '/^$$/d; s,$(EXEEXT)$$,,'				\
+          | sort -u							\
+          | tr '\n' ' '; echo; }					\
+    | sed 's/ $$//'
 
 VERBOSE = yes
-- 
2.10.1 (Apple Git-78)


From 05476e882f0aa6b032d7cf3859214210a5ccc1fb Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 6 Aug 2016 13:50:06 -0700
Subject: [PATCH 089/119] gnulib: update to latest

---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index 0fe8b3c..e4f1a4a 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 0fe8b3c8116168e3b8b058df63ddedd45c3fcab0
+Subproject commit e4f1a4a5bcd4fa6da6b7663c548ab411423b8c2a
-- 
2.10.1 (Apple Git-78)


From 5ac64141edd699566edfa9a6659c0d7586f019e4 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Mon, 8 Aug 2016 10:10:51 -0700
Subject: [PATCH 090/119] version 3.4

* NEWS: Record release date.
---
 NEWS | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/NEWS b/NEWS
index db5478c..536dba5 100644
--- a/NEWS
+++ b/NEWS
@@ -1,6 +1,6 @@
 GNU diffutils NEWS                                    -*- outline -*-
 
-* Noteworthy changes in release ?.? (????-??-??) [?]
+* Noteworthy changes in release 3.4 (2016-08-08) [stable]
 
 ** New features
 
-- 
2.10.1 (Apple Git-78)


From 09369932527342a4fb0ccc6677184c3d3ce7fc49 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Mon, 8 Aug 2016 10:14:00 -0700
Subject: [PATCH 091/119] maint: post-release administrivia

* NEWS: Add header line for next release.
* .prev-version: Record previous version.
* cfg.mk (old_NEWS_hash): Auto-update.
---
 .prev-version | 2 +-
 NEWS          | 3 +++
 cfg.mk        | 2 +-
 3 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/.prev-version b/.prev-version
index eb39e53..2f4b607 100644
--- a/.prev-version
+++ b/.prev-version
@@ -1 +1 @@
-3.3
+3.4
diff --git a/NEWS b/NEWS
index 536dba5..add082b 100644
--- a/NEWS
+++ b/NEWS
@@ -1,5 +1,8 @@
 GNU diffutils NEWS                                    -*- outline -*-
 
+* Noteworthy changes in release ?.? (????-??-??) [?]
+
+
 * Noteworthy changes in release 3.4 (2016-08-08) [stable]
 
 ** New features
diff --git a/cfg.mk b/cfg.mk
index 83e7860..5e0f045 100644
--- a/cfg.mk
+++ b/cfg.mk
@@ -33,7 +33,7 @@ bootstrap-tools = autoconf,automake,gnulib
 # Now that we have better tests, make this the default.
 export VERBOSE = yes
 
-old_NEWS_hash = 8632093db0c946f65f639f06ac7de39a
+old_NEWS_hash = 69329628b612be7ab46517bbf067c85f
 
 # Tell maint.mk's syntax-check rules that diff gets config.h directly or
 # via diff.h or system.h.
-- 
2.10.1 (Apple Git-78)


From 697c1f4fa93ac971c487725e9e53fc211cd3c670 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Mon, 8 Aug 2016 18:50:15 -0700
Subject: [PATCH 092/119] diff: disable colorization for TERM=dumb

* src/diff.c (main): With --color or --color=auto, when TERM is
"dumb", disable colorization.  Suggested by Daniel Colascione.
* NEWS (Bug fixes): Mention it.
* tests/colors: Add a test that would fail without this change,
yet passes with it.
---
 NEWS         | 4 ++++
 src/diff.c   | 7 +++++++
 tests/colors | 5 +++++
 3 files changed, 16 insertions(+)

diff --git a/NEWS b/NEWS
index add082b..9a8d2e1 100644
--- a/NEWS
+++ b/NEWS
@@ -2,6 +2,10 @@ GNU diffutils NEWS                                    -*- outline -*-
 
 * Noteworthy changes in release ?.? (????-??-??) [?]
 
+** Bug fixes
+
+  diff --color no longer colorizes when TERM=dumb
+
 
 * Noteworthy changes in release 3.4 (2016-08-08) [stable]
 
diff --git a/src/diff.c b/src/diff.c
index 9bc1d96..686945e 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -656,6 +656,13 @@ main (int argc, char **argv)
       prev = c;
     }
 
+  if (colors_style == AUTO)
+    {
+      char const *t = getenv ("TERM");
+      if (t && STREQ (t, "dumb"))
+        colors_style = NEVER;
+    }
+
   if (output_style == OUTPUT_UNSPECIFIED)
     {
       if (show_c_function)
diff --git a/tests/colors b/tests/colors
index 3ad2206..8651a5b 100755
--- a/tests/colors
+++ b/tests/colors
@@ -86,6 +86,11 @@ test $? = 1 || fail=1
 gen_exp_default > exp || framework_failure_
 compare exp out || fail=1
 
+TERM=dumb diff ---presume-output-tty --color=auto a b > out
+test $? = 1 || fail=1
+gen_exp_default > exp || framework_failure_
+compare exp out || fail=1
+
 diff --color=never a b > out
 test $? = 1 || fail=1
 gen_exp_default > exp || framework_failure_
-- 
2.10.1 (Apple Git-78)


From 1b3907f976df79e45063901d5f7de76e3f1c7f43 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 13 Aug 2016 19:42:57 -0700
Subject: [PATCH 093/119] maint: diff3: remove an unreachable statement

* src/diff3.c (main): Remove unreachable "return" after exit from main.
---
 src/diff3.c | 1 -
 1 file changed, 1 deletion(-)

diff --git a/src/diff3.c b/src/diff3.c
index 47df6f9..6ef90f4 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -402,7 +402,6 @@ main (int argc, char **argv)
 
   check_stdout ();
   exit (conflicts_found);
-  return conflicts_found;
 }
 
 static void
-- 
2.10.1 (Apple Git-78)


From 88d911dbc717494febee4b0ebc790808054fefff Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 13 Aug 2016 19:40:20 -0700
Subject: [PATCH 094/119] build: ignore texinfo build artifacts

* .gitignore: Ignore texinfo artifacts in doc/.
---
 .gitignore | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/.gitignore b/.gitignore
index bf11312..3fecace 100644
--- a/.gitignore
+++ b/.gitignore
@@ -15,10 +15,14 @@
 /config.log
 /config.status
 /configure
-/diffutils-*.tar.gz
 /diffutils-*.tar.xz
 /doc/.gitignore
+/doc/diffutils.aux
+/doc/diffutils.cp
+/doc/diffutils.cps
 /doc/diffutils.info
+/doc/diffutils.log
+/doc/diffutils.toc
 /doc/stamp-vti
 /doc/version.texi
 /gnulib-tests
-- 
2.10.1 (Apple Git-78)


From 1a0df4396ebe3b9a58b882bb976cfce3f50d3cac Mon Sep 17 00:00:00 2001
From: Bastian Beischer <bastian.beischer@rwth-aachen.de>
Date: Sat, 13 Aug 2016 18:53:36 -0700
Subject: [PATCH 095/119] diff3: fix heap use-after-free; add minimal diff3
 test coverage

Commit v3.3-42-g3b74a90, "FIXME: src/diff3: plug a leak" added an
invalid use of free, leading to use-after-free in nearly any invocation
of diff3.  Revert that commit.
* NEWS (Bug fixes): Mention it.
* tests/diff3: New file, to add minimal test coverage.
* tests/Makefile.am (TESTS): Add it.
Reported by Bastian Beischer in http://bugs.gnu.org/24210
---
 NEWS              |  3 +++
 src/diff3.c       |  1 -
 tests/Makefile.am |  1 +
 tests/diff3       | 30 ++++++++++++++++++++++++++++++
 4 files changed, 34 insertions(+), 1 deletion(-)
 create mode 100644 tests/diff3

diff --git a/NEWS b/NEWS
index 9a8d2e1..73ff83b 100644
--- a/NEWS
+++ b/NEWS
@@ -4,6 +4,9 @@ GNU diffutils NEWS                                    -*- outline -*-
 
 ** Bug fixes
 
+  diff3 no longer malfunctions due to use-after-free
+  [bug introduced in 3.4]
+
   diff --color no longer colorizes when TERM=dumb
 
 
diff --git a/src/diff3.c b/src/diff3.c
index 6ef90f4..0eb643e 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -1039,7 +1039,6 @@ process_diff (char const *filea,
 
   *block_list_end = NULL;
   *last_block = bptr;
-  free (diff_contents);
   return block_list;
 }
 
diff --git a/tests/Makefile.am b/tests/Makefile.am
index 77d9fc3..66e25a5 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -6,6 +6,7 @@ TESTS = \
   binary \
   brief-vs-stat-zero-kernel-lies \
   colliding-file-names \
+  diff3 \
   excess-slash \
   help-version	\
   function-line-vs-leading-space \
diff --git a/tests/diff3 b/tests/diff3
new file mode 100644
index 0000000..a1fc287
--- /dev/null
+++ b/tests/diff3
@@ -0,0 +1,30 @@
+#!/bin/sh
+# This would malfunction in diff-3.4
+
+. "${srcdir=.}/init.sh"; path_prepend_ ../src
+
+echo a > a || framework_failure_
+echo b > b || framework_failure_
+echo c > c || framework_failure_
+cat <<'EOF' > exp || framework_failure_
+====
+1:1c
+  a
+2:1c
+  b
+3:1c
+  c
+EOF
+
+fail=0
+
+diff3 a b c > out 2> err || fail=1
+compare exp out || fail=1
+compare /dev/null err || fail=1
+
+# Repeat, but with all three files the same:
+diff3 a a a > out 2> err || fail=1
+compare /dev/null out || fail=1
+compare /dev/null err || fail=1
+
+Exit $fail
-- 
2.10.1 (Apple Git-78)


From b3def738f3b435cbe6f2a8406bae5a71175a0b80 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Fri, 12 Aug 2016 11:17:26 -0700
Subject: [PATCH 096/119] maint: require that commit messages be of a certain
 form

* bootstrap.conf (bootstrap_epilogue): Merge from coreutils, so that
a local commit hook will now help enforce consistent commit messages.
* Makefile.am (check-git-hook-script-sync): New rule, largely copied
from coreutils.
* scripts/git-hooks/commit-msg: New file, from coreutils, but
with adapted list of program names.
* scripts/git-hooks/applypatch-msg: New file, from git.
* scripts/git-hooks/pre-applypatch: Likewise.
* scripts/git-hooks/pre-commit: Likewise.
---
 Makefile.am                      |  14 ++++
 bootstrap.conf                   |  25 +++++++
 scripts/git-hooks/applypatch-msg |  15 ++++
 scripts/git-hooks/commit-msg     | 153 +++++++++++++++++++++++++++++++++++++++
 scripts/git-hooks/pre-applypatch |  14 ++++
 scripts/git-hooks/pre-commit     |  49 +++++++++++++
 6 files changed, 270 insertions(+)
 create mode 100755 scripts/git-hooks/applypatch-msg
 create mode 100755 scripts/git-hooks/commit-msg
 create mode 100755 scripts/git-hooks/pre-applypatch
 create mode 100755 scripts/git-hooks/pre-commit

diff --git a/Makefile.am b/Makefile.am
index 244024e..edee5fa 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -42,3 +42,17 @@ gen-ChangeLog:
 ALL_RECURSIVE_TARGETS += distcheck-hook
 distcheck-hook:
 	$(MAKE) my-distcheck
+
+# Some of our git hook scripts are supposed to be identical to git's samples.
+# See if they are still in sync.
+.PHONY: check-git-hook-script-sync
+check-git-hook-script-sync:
+	@fail=0;							\
+	t=$$(mktemp -d)							\
+	  && cd $$t && git init -q && cd .git/hooks			\
+	  && for i in pre-commit pre-applypatch applypatch-msg; do	\
+	       diff -u $(abs_top_srcdir)/scripts/git-hooks/$$i $$i.sample	\
+		 || fail=1;						\
+	     done;							\
+	rm -rf $$t;							\
+	test $$fail = 0
diff --git a/bootstrap.conf b/bootstrap.conf
index 828ffef..ac3c278 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -129,4 +129,29 @@ bootstrap_post_import_hook()
 bootstrap_epilogue()
 {
   perl -pi -e "s/\@PACKAGE\@/$package/g" README-release
+
+  # Since this is a "GNU" package, replace this line
+  #   if LC_ALL=C grep 'GNU @PACKAGE@' $(top_srcdir)/* 2>/dev/null \
+  #      | grep -v 'libtool:' >/dev/null; then
+  # with this:
+  #   if true; then
+  # Why?  That pipeline searches all files in $(top_srcdir), and if you
+  # happen to have large files (or apparently large sparse files), the
+  # first grep may well run out of memory.
+  perl -pi -e 's/if LC_ALL=C grep .GNU .PACKAGE.*; then/if true; then/' \
+    po/Makefile.in.in
+
+  # Install our git hooks, as long as "cp" accepts the --backup option,
+  # so that we can back up any existing files.
+  case $(cp --help) in *--backup*) backup=1;; *) backup=0;; esac
+  if test $backup = 1; then
+    hooks=$(cd scripts/git-hooks && git ls-files)
+    for f in $hooks; do
+      # If it is identical, skip it.
+      cmp scripts/git-hooks/$f .git/hooks/$f > /dev/null \
+        && continue
+      cp --backup=numbered scripts/git-hooks/$f .git/hooks
+      chmod a-w .git/hooks/$f
+    done
+  fi
 }
diff --git a/scripts/git-hooks/applypatch-msg b/scripts/git-hooks/applypatch-msg
new file mode 100755
index 0000000..a5d7b84
--- /dev/null
+++ b/scripts/git-hooks/applypatch-msg
@@ -0,0 +1,15 @@
+#!/bin/sh
+#
+# An example hook script to check the commit log message taken by
+# applypatch from an e-mail message.
+#
+# The hook should exit with non-zero status after issuing an
+# appropriate message if it wants to stop the commit.  The hook is
+# allowed to edit the commit message file.
+#
+# To enable this hook, rename this file to "applypatch-msg".
+
+. git-sh-setup
+commitmsg="$(git rev-parse --git-path hooks/commit-msg)"
+test -x "$commitmsg" && exec "$commitmsg" ${1+"$@"}
+:
diff --git a/scripts/git-hooks/commit-msg b/scripts/git-hooks/commit-msg
new file mode 100755
index 0000000..888b83b
--- /dev/null
+++ b/scripts/git-hooks/commit-msg
@@ -0,0 +1,153 @@
+eval '(exit $?0)' && eval 'exec perl -w "$0" ${1+"$@"}'
+  & eval 'exec perl -w "$0" $argv:q'
+    if 0;
+
+use strict;
+use warnings;
+(my $ME = $0) =~ s|.*/||;
+
+# Emulate Git's choice of the editor for the commit message.
+chomp (my $editor = `git var GIT_EDITOR`);
+# And have a sane, minimal fallback in case of weird failures.
+$editor = "vi" if $? != 0 or $editor =~ /^\s*\z/;
+
+# Keywords allowed before the colon on the first line of a commit message:
+# program names and a few general category names.
+my @valid = qw(
+    diff diff3 cmp sdiff
+
+    gnulib tests maint doc build scripts
+    );
+my $v_or = join '|', @valid;
+my $valid_regex = qr/^(?:$v_or)$/;
+
+# Rewrite the $LOG_FILE (old contents in @$LINE_REF) with an additional
+# a commented diagnostic "# $ERR" line at the top.
+sub rewrite($$$)
+{
+  my ($log_file, $err, $line_ref) = @_;
+  local *LOG;
+  open LOG, '>', $log_file
+    or die "$ME: $log_file: failed to open for writing: $!";
+  print LOG "# $err";
+  print LOG @$line_ref;
+  close LOG
+    or die "$ME: $log_file: failed to rewrite: $!\n";
+}
+
+sub re_edit($)
+{
+  my ($log_file) = @_;
+
+  warn "Interrupt (Ctrl-C) to abort...\n";
+
+  system 'sh', '-c', "$editor $log_file";
+  ($? & 127) || ($? >> 8)
+    and die "$ME: $log_file: the editor ($editor) failed, aborting\n";
+}
+
+sub bad_first_line($)
+{
+  my ($line) = @_;
+
+  $line =~ /^[Vv]ersion \d/
+    and return '';
+
+  $line =~ /:/
+    or return 'missing colon on first line of log message';
+
+  $line =~ /\.$/
+    and return 'do not use a period "." at the end of the first line';
+
+  # The token(s) before the colon on the first line must be on our list
+  # Tokens may be space- or comma-separated.
+  (my $pre_colon = $line) =~ s/:.*//;
+  my @word = split (/[ ,]/, $pre_colon);
+  my @bad = grep !/$valid_regex/, @word;
+  @bad
+    and return 'invalid first word(s) of summary line: ' . join (', ', @bad);
+
+  return '';
+}
+
+# Given a $LOG_FILE name and a \@LINE buffer,
+# read the contents of the file into the buffer and analyze it.
+# If the log message passes muster, return the empty string.
+# If not, return a diagnostic.
+sub check_msg($$)
+{
+  my ($log_file, $line_ref) = @_;
+
+  local *LOG;
+  open LOG, '<', $log_file
+    or return "failed to open for reading: $!";
+  @$line_ref = <LOG>;
+  close LOG;
+
+  my @line = @$line_ref;
+  chomp @line;
+
+  # Don't filter out blank or comment lines; git does that already,
+  # and if we were to ignore them here, it could lead to committing
+  # with lines that start with "#" in the log.
+
+  # Filter out leading blank and comment lines.
+  # while (@line && $line[0] =~ /^(?:#.*|[ \t]*)$/) { shift @line; }
+
+  # Filter out blank and comment lines at EOF.
+  # while (@line && $line[$#line] =~ /^(?:#.*|[ \t]*)$/) { pop @line; }
+
+  @line == 0
+    and return 'no log message';
+
+  my $bad = bad_first_line $line[0];
+  $bad
+    and return $bad;
+
+  # Second line should be blank or not present.
+  2 <= @line && length $line[1]
+    and return 'second line must be empty';
+
+  # Limit line length to allow for the ChangeLog's leading TAB.
+  foreach my $line (@line)
+    {
+      72 < length $line && $line =~ /^[^#]/
+        and return 'line longer than 72';
+    }
+
+  my $buf = join ("\n", @line) . "\n";
+  $buf =~ m!https?://bugzilla\.redhat\.com/show_bug\.cgi\?id=(\d+)!s
+    and return "use shorter http://bugzilla.redhat.com/$1";
+
+  $buf =~ m!https?://debbugs\.gnu\.org/(?:cgi/bugreport\.cgi\?bug=)?(\d+)!s
+    and return "use shorter http://bugs.gnu.org/$1";
+
+  $buf =~ /^ *Signed-off-by:/mi
+    and return q(do not use "Signed-off-by:");
+
+  return '';
+}
+
+{
+  @ARGV == 1
+    or die;
+
+  my $log_file = $ARGV[0];
+
+  while (1)
+    {
+      my @line;
+      my $err = check_msg $log_file, \@line;
+      $err eq ''
+        and last;
+      $err = "$ME: $err\n";
+      warn $err;
+      # Insert the diagnostic as a comment on the first line of $log_file.
+      rewrite $log_file, $err, \@line;
+      re_edit $log_file;
+
+      # Stop if our parent is killed.
+      getppid() == 1
+        and last;
+    }
+}
diff --git a/scripts/git-hooks/pre-applypatch b/scripts/git-hooks/pre-applypatch
new file mode 100755
index 0000000..4142082
--- /dev/null
+++ b/scripts/git-hooks/pre-applypatch
@@ -0,0 +1,14 @@
+#!/bin/sh
+#
+# An example hook script to verify what is about to be committed
+# by applypatch from an e-mail message.
+#
+# The hook should exit with non-zero status after issuing an
+# appropriate message if it wants to stop the commit.
+#
+# To enable this hook, rename this file to "pre-applypatch".
+
+. git-sh-setup
+precommit="$(git rev-parse --git-path hooks/pre-commit)"
+test -x "$precommit" && exec "$precommit" ${1+"$@"}
+:
diff --git a/scripts/git-hooks/pre-commit b/scripts/git-hooks/pre-commit
new file mode 100755
index 0000000..68d62d5
--- /dev/null
+++ b/scripts/git-hooks/pre-commit
@@ -0,0 +1,49 @@
+#!/bin/sh
+#
+# An example hook script to verify what is about to be committed.
+# Called by "git commit" with no arguments.  The hook should
+# exit with non-zero status after issuing an appropriate message if
+# it wants to stop the commit.
+#
+# To enable this hook, rename this file to "pre-commit".
+
+if git rev-parse --verify HEAD >/dev/null 2>&1
+then
+	against=HEAD
+else
+	# Initial commit: diff against an empty tree object
+	against=4b825dc642cb6eb9a060e54bf8d69288fbee4904
+fi
+
+# If you want to allow non-ASCII filenames set this variable to true.
+allownonascii=$(git config --bool hooks.allownonascii)
+
+# Redirect output to stderr.
+exec 1>&2
+
+# Cross platform projects tend to avoid non-ASCII filenames; prevent
+# them from being added to the repository. We exploit the fact that the
+# printable range starts at the space character and ends with tilde.
+if [ "$allownonascii" != "true" ] &&
+	# Note that the use of brackets around a tr range is ok here, (it's
+	# even required, for portability to Solaris 10's /usr/bin/tr), since
+	# the square bracket bytes happen to fall in the designated range.
+	test $(git diff --cached --name-only --diff-filter=A -z $against |
+	  LC_ALL=C tr -d '[ -~]\0' | wc -c) != 0
+then
+	cat <<\EOF
+Error: Attempt to add a non-ASCII file name.
+
+This can cause problems if you want to work with people on other platforms.
+
+To be portable it is advisable to rename the file.
+
+If you know what you are doing you can disable this check using:
+
+  git config hooks.allownonascii true
+EOF
+	exit 1
+fi
+
+# If there are whitespace errors, print the offending file names and fail.
+exec git diff-index --check --cached $against --
-- 
2.10.1 (Apple Git-78)


From edd942ca27d570a33d612b12eecaa33a76640e46 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Fri, 12 Aug 2016 21:40:29 -0700
Subject: [PATCH 097/119] diff3: fix leaks, for real

* src/diff3.c (struct diff_block)[lint]: Add member, n2.
(free_diff_block, next_to_n2): New functions.
* tests/diff3: Add more test coverage.
---
 src/diff3.c | 56 +++++++++++++++++++++++++++++++++++++++++++++++----
 tests/diff3 | 66 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 118 insertions(+), 4 deletions(-)

diff --git a/src/diff3.c b/src/diff3.c
index 0eb643e..b80aeb3 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -78,6 +78,9 @@ struct diff_block {
   char **lines[2];		/* The actual lines (may contain nulls) */
   size_t *lengths[2];		/* Line lengths (including newlines, if any) */
   struct diff_block *next;
+#ifdef lint
+  struct diff_block *n2;	/* Used only when freeing.  */
+#endif
 };
 
 /* Three way diff */
@@ -176,7 +179,7 @@ static struct diff3_block *create_diff3_block (lin, lin, lin, lin, lin, lin);
 static struct diff3_block *make_3way_diff (struct diff_block *, struct diff_block *);
 static struct diff3_block *reverse_diff3_blocklist (struct diff3_block *);
 static struct diff3_block *using_to_diff3_block (struct diff_block *[2], struct diff_block *[2], int, int, struct diff3_block const *);
-static struct diff_block *process_diff (char const *, char const *, struct diff_block **);
+static struct diff_block *process_diff (char const *, char const *, struct diff_block **, char **);
 static void check_stdout (void);
 static void fatal (char const *) __attribute__((noreturn));
 static void output_diff3 (FILE *, struct diff3_block *, int const[3], int const[3]);
@@ -212,6 +215,38 @@ static struct option const longopts[] =
   {0, 0, 0, 0}
 };
 
+static void
+free_diff_block (struct diff_block *p)
+{
+#ifndef lint
+  (void)p;
+#else
+  while (p)
+    {
+      free (p->lines[0]);
+      free (p->lines[1]);
+      free (p->lengths[0]);
+      free (p->lengths[1]);
+      struct diff_block *next = p->n2;
+      free (p);
+      p = next;
+    }
+#endif
+}
+
+/* Copy each next pointer to n2, since make_3way_diff would clobber the former,
+   yet we will still need something to free these buffers.  */
+static void
+next_to_n2 (struct diff_block *p)
+{
+#ifndef lint
+  (void)p;
+#else
+  while (p)
+    p = p->n2 = p->next;
+#endif
+}
+
 int
 main (int argc, char **argv)
 {
@@ -377,10 +412,19 @@ main (int argc, char **argv)
   /* Invoke diff twice on two pairs of input files, combine the two
      diffs, and output them.  */
 
+  char *b0, *b1;
   commonname = file[rev_mapping[FILEC]];
-  thread1 = process_diff (file[rev_mapping[FILE1]], commonname, &last_block);
-  thread0 = process_diff (file[rev_mapping[FILE0]], commonname, &last_block);
+  thread1 = process_diff (file[rev_mapping[FILE1]], commonname, &last_block, &b1);
+  thread0 = process_diff (file[rev_mapping[FILE0]], commonname, &last_block, &b0);
+
+  next_to_n2 (thread0);
+  next_to_n2 (thread1);
+
   diff3 = make_3way_diff (thread0, thread1);
+
+  free_diff_block (thread0);
+  free_diff_block (thread1);
+
   if (edscript)
     conflicts_found
       = output_diff3_edscript (stdout, diff3, mapping, rev_mapping,
@@ -400,6 +444,8 @@ main (int argc, char **argv)
       conflicts_found = false;
     }
 
+  free (b0);
+  free (b1);
   check_stdout ();
   exit (conflicts_found);
 }
@@ -938,7 +984,8 @@ compare_line_list (char * const list1[], size_t const lengths1[],
 static struct diff_block *
 process_diff (char const *filea,
 	      char const *fileb,
-	      struct diff_block **last_block)
+	      struct diff_block **last_block,
+	      char **buf_to_free)
 {
   char *diff_contents;
   char *diff_limit;
@@ -953,6 +1000,7 @@ process_diff (char const *filea,
 				  sizeof *bptr->lengths[1]));
 
   diff_limit = read_diff (filea, fileb, &diff_contents);
+  *buf_to_free = diff_contents;
   scan_diff = diff_contents;
 
   while (scan_diff < diff_limit)
diff --git a/tests/diff3 b/tests/diff3
index a1fc287..a40631b 100644
--- a/tests/diff3
+++ b/tests/diff3
@@ -27,4 +27,70 @@ diff3 a a a > out 2> err || fail=1
 compare /dev/null out || fail=1
 compare /dev/null err || fail=1
 
+# This would have provoked a nontrivial leak prior to diffutils-3.5,
+# due to the nontrivial list of diff_block structs.
+seq 10 40|sed 's/1$/x/' > d || framework_failure_
+seq 10 40|sed 's/5$/y/' > e || framework_failure_
+seq 10 40|sed 's/8$/z/' > f || framework_failure_
+cat <<'EOF' > exp40 || framework_failure_
+====1
+1:2c
+  1x
+2:2c
+3:2c
+  11
+====2
+1:6c
+3:6c
+  15
+2:6c
+  1y
+====3
+1:9c
+2:9c
+  18
+3:9c
+  1z
+====1
+1:12c
+  2x
+2:12c
+3:12c
+  21
+====2
+1:16c
+3:16c
+  25
+2:16c
+  2y
+====3
+1:19c
+2:19c
+  28
+3:19c
+  2z
+====1
+1:22c
+  3x
+2:22c
+3:22c
+  31
+====2
+1:26c
+3:26c
+  35
+2:26c
+  3y
+====3
+1:29c
+2:29c
+  38
+3:29c
+  3z
+EOF
+
+diff3 d e f > out 2> err
+compare exp40 out || fail=1
+compare /dev/null err || fail=1
+
 Exit $fail
-- 
2.10.1 (Apple Git-78)


From c61efccd23c827a03bdd1d41211c70479a632b86 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 14 Aug 2016 22:25:49 -0700
Subject: [PATCH 098/119] tests: diff3: work around missing seq on some systems

* tests/diff3 (seq): Provide a seq replacement function,
since at least AIX, SunOS 5.10, OpenBSD-5.8 lack it.
Reported by Assaf Gordon in https://bugs.gnu.org/24227#8
---
 tests/diff3 | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/tests/diff3 b/tests/diff3
index a40631b..b591751 100644
--- a/tests/diff3
+++ b/tests/diff3
@@ -3,6 +3,18 @@
 
 . "${srcdir=.}/init.sh"; path_prepend_ ../src
 
+# Some systems lack seq.
+# A limited replacement for seq: handle 1 or 2 args; increment must be 1
+seq()
+{
+  case $# in
+    1) start=1  final=$1;;
+    2) start=$1 final=$2;;
+    *) echo you lose 1>&2; exit 1;;
+  esac
+  awk 'BEGIN{for(i='$start';i<='$final';i++) print i}' < /dev/null
+}
+
 echo a > a || framework_failure_
 echo b > b || framework_failure_
 echo c > c || framework_failure_
-- 
2.10.1 (Apple Git-78)


From d6474c4c512d9196d7d9a6086a96eac6813a5c19 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 14 Aug 2016 17:16:59 -0700
Subject: [PATCH 099/119] gnulib: update to latest

---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index e4f1a4a..1eb82ad 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit e4f1a4a5bcd4fa6da6b7663c548ab411423b8c2a
+Subproject commit 1eb82ad96b535801392e5d404dc7c79e69321858
-- 
2.10.1 (Apple Git-78)


From c2dc91f1968c6ccd8ba623f9fa391f529ab800ab Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Hanno=20B=C3=B6ck?= <hanno@hboeck.de>
Date: Tue, 16 Aug 2016 22:02:13 -0700
Subject: [PATCH 100/119] diff: avoid duplicate definition of
 presume_output_tty

* src/util.c (presume_output_tty): Remove this definition.
The other is in diff.h.  Reported in https://bugs.gnu.org/24248
---
 src/util.c | 2 --
 1 file changed, 2 deletions(-)

diff --git a/src/util.c b/src/util.c
index d7b8925..76872cb 100644
--- a/src/util.c
+++ b/src/util.c
@@ -44,8 +44,6 @@
 
 char const pr_program[] = PR_PROGRAM;
 
-bool presume_output_tty;
-
 /* Queue up one-line messages to be printed at the end,
    when -l is specified.  Each message is recorded with a 'struct msg'.  */
 
-- 
2.10.1 (Apple Git-78)


From 24792668f02cb915a170a8098d945da325287288 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Tue, 16 Aug 2016 22:20:28 -0700
Subject: [PATCH 101/119] build: arrange to build with -fno-common, when
 possible

* configure.ac (WERROR_CFLAGS): Add -fno-common, when possible.
This would have prevented the duplicate definition of
presume_output_tty that was fixed in v3.4-10-gc2dc91f.
---
 configure.ac | 1 +
 1 file changed, 1 insertion(+)

diff --git a/configure.ac b/configure.ac
index a473d66..936338f 100644
--- a/configure.ac
+++ b/configure.ac
@@ -109,6 +109,7 @@ if test "$gl_gcc_warnings" = yes; then
 
   gl_WARN_ADD([-fdiagnostics-show-option])
   gl_WARN_ADD([-funit-at-a-time])
+  gl_WARN_ADD([-fno-common])
 
   AC_SUBST([WARN_CFLAGS])
 
-- 
2.10.1 (Apple Git-78)


From d1145efd81ffbcc0b00f138ede826d3d6f640200 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 20 Aug 2016 22:21:26 -0700
Subject: [PATCH 102/119] version 3.5

* NEWS: Record release date.
---
 NEWS | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/NEWS b/NEWS
index 73ff83b..674e35f 100644
--- a/NEWS
+++ b/NEWS
@@ -1,6 +1,6 @@
 GNU diffutils NEWS                                    -*- outline -*-
 
-* Noteworthy changes in release ?.? (????-??-??) [?]
+* Noteworthy changes in release 3.5 (2016-08-20) [stable]
 
 ** Bug fixes
 
-- 
2.10.1 (Apple Git-78)


From 34823e7e6770042ec5d7349218efdb34307349e9 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 20 Aug 2016 22:23:28 -0700
Subject: [PATCH 103/119] maint: post-release administrivia

* NEWS: Add header line for next release.
* .prev-version: Record previous version.
* cfg.mk (old_NEWS_hash): Auto-update.
---
 .prev-version | 2 +-
 NEWS          | 3 +++
 cfg.mk        | 2 +-
 3 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/.prev-version b/.prev-version
index 2f4b607..5a95802 100644
--- a/.prev-version
+++ b/.prev-version
@@ -1 +1 @@
-3.4
+3.5
diff --git a/NEWS b/NEWS
index 674e35f..accdf88 100644
--- a/NEWS
+++ b/NEWS
@@ -1,5 +1,8 @@
 GNU diffutils NEWS                                    -*- outline -*-
 
+* Noteworthy changes in release ?.? (????-??-??) [?]
+
+
 * Noteworthy changes in release 3.5 (2016-08-20) [stable]
 
 ** Bug fixes
diff --git a/cfg.mk b/cfg.mk
index 5e0f045..61efa04 100644
--- a/cfg.mk
+++ b/cfg.mk
@@ -33,7 +33,7 @@ bootstrap-tools = autoconf,automake,gnulib
 # Now that we have better tests, make this the default.
 export VERBOSE = yes
 
-old_NEWS_hash = 69329628b612be7ab46517bbf067c85f
+old_NEWS_hash = 7813d6f6ccefe3a1706548b5f1cab93f
 
 # Tell maint.mk's syntax-check rules that diff gets config.h directly or
 # via diff.h or system.h.
-- 
2.10.1 (Apple Git-78)


From f2712fcddff9c7ff571b19ace30d0d3a195ebde8 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sat, 27 Aug 2016 14:59:13 -0700
Subject: [PATCH 104/119] diff: port line numbers to mingw64

Problem reported by Peter Rosin (Bug#24311).
* src/system.h (printint, pI): New typedef and macro.
All uses of 'long int' and "%l" in printf format replaced by
'printint' and "%"pI respectively.
* src/ifdef.c (do_printf_spec): Don't assume pI is length 1.
---
 NEWS          |  4 ++++
 src/context.c | 12 ++++++------
 src/diff.h    |  2 +-
 src/diff3.c   | 35 +++++++++++++++++------------------
 src/ed.c      |  8 +++++---
 src/ifdef.c   | 15 ++++++++-------
 src/sdiff.c   | 16 ++++++++--------
 src/side.c    | 12 ++++++------
 src/system.h  | 24 ++++++++++++++++++++----
 src/util.c    | 22 +++++++++++-----------
 10 files changed, 86 insertions(+), 64 deletions(-)

diff --git a/NEWS b/NEWS
index accdf88..473332e 100644
--- a/NEWS
+++ b/NEWS
@@ -2,6 +2,10 @@ GNU diffutils NEWS                                    -*- outline -*-
 
 * Noteworthy changes in release ?.? (????-??-??) [?]
 
+** Bug fixes
+
+  diff no longer mishandles line numbers exceeding 2**31 on Mingw-w64.
+
 
 * Noteworthy changes in release 3.5 (2016-08-20) [stable]
 
diff --git a/src/context.c b/src/context.c
index 1a92a60..1a663ba 100644
--- a/src/context.c
+++ b/src/context.c
@@ -126,7 +126,7 @@ print_context_script (struct change *script, bool unidiff)
 static void
 print_context_number_range (struct file_data const *file, lin a, lin b)
 {
-  long int trans_a, trans_b;
+  printint trans_a, trans_b;
   translate_range (file, a, b, &trans_a, &trans_b);
 
   /* We can have B <= A in the case of a range of no lines.
@@ -139,9 +139,9 @@ print_context_number_range (struct file_data const *file, lin a, lin b)
      specification.  */
 
   if (trans_b <= trans_a)
-    fprintf (outfile, "%ld", trans_b);
+    fprintf (outfile, "%"pI"d", trans_b);
   else
-    fprintf (outfile, "%ld,%ld", trans_a, trans_b);
+    fprintf (outfile, "%"pI"d,%"pI"d", trans_a, trans_b);
 }
 
 /* Print FUNCTION in a context header.  */
@@ -299,7 +299,7 @@ pr_context_hunk (struct change *hunk)
 static void
 print_unidiff_number_range (struct file_data const *file, lin a, lin b)
 {
-  long int trans_a, trans_b;
+  printint trans_a, trans_b;
   translate_range (file, a, b, &trans_a, &trans_b);
 
   /* We can have B < A in the case of a range of no lines.
@@ -307,9 +307,9 @@ print_unidiff_number_range (struct file_data const *file, lin a, lin b)
      which is B.  It would be more logical to print A, but
      'patch' expects B in order to detect diffs against empty files.  */
   if (trans_b <= trans_a)
-    fprintf (outfile, trans_b < trans_a ? "%ld,0" : "%ld", trans_b);
+    fprintf (outfile, trans_b < trans_a ? "%"pI"d,0" : "%"pI"d", trans_b);
   else
-    fprintf (outfile, "%ld,%ld", trans_a, trans_b - trans_a + 1);
+    fprintf (outfile, "%"pI"d,%"pI"d", trans_a, trans_b - trans_a + 1);
 }
 
 /* Print a portion of an edit script in unidiff format.
diff --git a/src/diff.h b/src/diff.h
index 0983e7c..6eda1e6 100644
--- a/src/diff.h
+++ b/src/diff.h
@@ -406,7 +406,7 @@ extern void print_script (struct change *, struct change * (*) (struct change *)
                           void (*) (struct change *));
 extern void setup_output (char const *, char const *, bool);
 extern void translate_range (struct file_data const *, lin, lin,
-                             long int *, long int *);
+                             printint *, printint *);
 
 enum color_context
 {
diff --git a/src/diff3.c b/src/diff3.c
index b80aeb3..b2de4b6 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -1428,20 +1428,20 @@ output_diff3 (FILE *outputfile, struct diff3_block *diff,
 	  int realfile = mapping[i];
 	  lin lowt = D_LOWLINE (ptr, realfile);
 	  lin hight = D_HIGHLINE (ptr, realfile);
-	  long int llowt = lowt;
-	  long int lhight = hight;
+	  printint llowt = lowt;
+	  printint lhight = hight;
 
 	  fprintf (outputfile, "%d:", i + 1);
 	  switch (lowt - hight)
 	    {
 	    case 1:
-	      fprintf (outputfile, "%lda\n", llowt - 1);
+	      fprintf (outputfile, "%"pI"da\n", llowt - 1);
 	      break;
 	    case 0:
-	      fprintf (outputfile, "%ldc\n", llowt);
+	      fprintf (outputfile, "%"pI"dc\n", llowt);
 	      break;
 	    default:
-	      fprintf (outputfile, "%ld,%ldc\n", llowt, lhight);
+	      fprintf (outputfile, "%"pI"d,%"pI"dc\n", llowt, lhight);
 	      break;
 	    }
 
@@ -1495,19 +1495,18 @@ dotlines (FILE *outputfile, struct diff3_block *b, int filenum)
 
 /* Output to OUTPUTFILE a '.' line.  If LEADING_DOT is true, also
    output a command that removes initial '.'s starting with line START
-   and continuing for NUM lines.  (START is long int, not lin, for
-   convenience with printf %ld formats.)  */
+   and continuing for NUM lines.  */
 
 static void
-undotlines (FILE *outputfile, bool leading_dot, long int start, lin num)
+undotlines (FILE *outputfile, bool leading_dot, printint start, printint num)
 {
   fputs (".\n", outputfile);
   if (leading_dot)
     {
       if (num == 1)
-	fprintf (outputfile, "%lds/^\\.//\n", start);
+	fprintf (outputfile, "%"pI"ds/^\\.//\n", start);
       else
-	fprintf (outputfile, "%ld,%lds/^\\.//\n", start, start + num - 1);
+	fprintf (outputfile, "%"pI"d,%"pI"ds/^\\.//\n", start, start + num - 1);
     }
 }
 
@@ -1548,7 +1547,7 @@ output_diff3_edscript (FILE *outputfile, struct diff3_block *diff,
 	   ? DIFF_ALL
 	   : DIFF_1ST + rev_mapping[b->correspond - DIFF_1ST]);
 
-      long int low0, high0;
+      printint low0, high0;
 
       /* If we aren't supposed to do this output block, skip it.  */
       switch (type)
@@ -1569,7 +1568,7 @@ output_diff3_edscript (FILE *outputfile, struct diff3_block *diff,
 
 	  /* Mark end of conflict.  */
 
-	  fprintf (outputfile, "%lda\n", high0);
+	  fprintf (outputfile, "%"pI"da\n", high0);
 	  leading_dot = false;
 	  if (type == DIFF_ALL)
 	    {
@@ -1591,7 +1590,7 @@ output_diff3_edscript (FILE *outputfile, struct diff3_block *diff,
 
 	  /* Mark start of conflict.  */
 
-	  fprintf (outputfile, "%lda\n<<<<<<< %s\n", low0 - 1,
+	  fprintf (outputfile, "%"pI"da\n<<<<<<< %s\n", low0 - 1,
 		   type == DIFF_ALL ? file0 : file1);
 	  leading_dot = false;
 	  if (type == DIFF_2ND)
@@ -1607,9 +1606,9 @@ output_diff3_edscript (FILE *outputfile, struct diff3_block *diff,
 	/* Write out a delete */
 	{
 	  if (low0 == high0)
-	    fprintf (outputfile, "%ldd\n", low0);
+	    fprintf (outputfile, "%"pI"dd\n", low0);
 	  else
-	    fprintf (outputfile, "%ld,%ldd\n", low0, high0);
+	    fprintf (outputfile, "%"pI"d,%"pI"dd\n", low0, high0);
 	}
       else
 	/* Write out an add or change */
@@ -1617,13 +1616,13 @@ output_diff3_edscript (FILE *outputfile, struct diff3_block *diff,
 	  switch (high0 - low0)
 	    {
 	    case -1:
-	      fprintf (outputfile, "%lda\n", high0);
+	      fprintf (outputfile, "%"pI"da\n", high0);
 	      break;
 	    case 0:
-	      fprintf (outputfile, "%ldc\n", high0);
+	      fprintf (outputfile, "%"pI"dc\n", high0);
 	      break;
 	    default:
-	      fprintf (outputfile, "%ld,%ldc\n", low0, high0);
+	      fprintf (outputfile, "%"pI"d,%"pI"dc\n", low0, high0);
 	      break;
 	    }
 
diff --git a/src/ed.c b/src/ed.c
index 1fae2b8..6c9192c 100644
--- a/src/ed.c
+++ b/src/ed.c
@@ -144,7 +144,7 @@ static void
 print_rcs_hunk (struct change *hunk)
 {
   lin i, f0, l0, f1, l1;
-  long int tf0, tl0, tf1, tl1;
+  printint tf0, tl0, tf1, tl1;
 
   /* Determine range of line numbers involved in each file.  */
   enum changes changes = analyze_hunk (hunk, &f0, &l0, &f1, &l1);
@@ -159,14 +159,16 @@ print_rcs_hunk (struct change *hunk)
     {
       /* For deletion, print just the starting line number from file 0
 	 and the number of lines deleted.  */
-      fprintf (outfile, "d%ld %ld\n", tf0, tf0 <= tl0 ? tl0 - tf0 + 1 : 1);
+      fprintf (outfile, "d%"pI"d %"pI"d\n", tf0,
+	       tf0 <= tl0 ? tl0 - tf0 + 1 : 1);
     }
 
   if (changes & NEW)
     {
       /* Take last-line-number from file 0 and # lines from file 1.  */
       translate_range (&files[1], f1, l1, &tf1, &tl1);
-      fprintf (outfile, "a%ld %ld\n", tl0, tf1 <= tl1 ? tl1 - tf1 + 1 : 1);
+      fprintf (outfile, "a%"pI"d %"pI"d\n", tl0,
+	       tf1 <= tl1 ? tl1 - tf1 + 1 : 1);
 
       /* Print the inserted lines.  */
       for (i = f1; i <= l1; i++)
diff --git a/src/ifdef.c b/src/ifdef.c
index b8b084f..d67eb5b 100644
--- a/src/ifdef.c
+++ b/src/ifdef.c
@@ -357,21 +357,22 @@ do_printf_spec (FILE *out, char const *spec,
 
 	if (out)
 	  {
-	    /* For example, if the spec is "%3xn", use the printf
+	    /* For example, if the spec is "%3xn" and pI is "l", use the printf
 	       format spec "%3lx".  Here the spec prefix is "%3".  */
-	    long int long_value = value;
+	    printint print_value = value;
 	    size_t spec_prefix_len = f - spec - 2;
+	    size_t pI_len = sizeof pI - 1;
 #if HAVE_C_VARARRAYS
-	    char format[spec_prefix_len + 3];
+	    char format[spec_prefix_len + pI_len + 2];
 #else
-	    char *format = xmalloc (spec_prefix_len + 3);
+	    char *format = xmalloc (spec_prefix_len + pI_len + 2);
 #endif
-	    char *p = format + spec_prefix_len;
+	    char *p = format + spec_prefix_len + pI_len;
 	    memcpy (format, spec, spec_prefix_len);
-	    *p++ = 'l';
+	    memcpy (format + spec_prefix_len, pI, pI_len);
 	    *p++ = c;
 	    *p = '\0';
-	    fprintf (out, format, long_value);
+	    fprintf (out, format, print_value);
 #if ! HAVE_C_VARARRAYS
 	    free (format);
 #endif
diff --git a/src/sdiff.c b/src/sdiff.c
index 22d6e5b..d900779 100644
--- a/src/sdiff.c
+++ b/src/sdiff.c
@@ -967,12 +967,12 @@ edit (struct line_filter *left, char const *lname, lin lline, lin llen,
 	      case 'd':
 		if (llen)
 		  {
+		    printint l1 = lline;
+		    printint l2 = lline + llen - 1;
 		    if (llen == 1)
-		      fprintf (tmp, "--- %s %ld\n", lname, (long int) lline);
+		      fprintf (tmp, "--- %s %"pI"d\n", lname, l1);
 		    else
-		      fprintf (tmp, "--- %s %ld,%ld\n", lname,
-			       (long int) lline,
-			       (long int) (lline + llen - 1));
+		      fprintf (tmp, "--- %s %"pI"d,%"pI"d\n", lname, l1, l2);
 		  }
 		/* Fall through.  */
 	      case '1': case 'b': case 'l':
@@ -989,12 +989,12 @@ edit (struct line_filter *left, char const *lname, lin lline, lin llen,
 	      case 'd':
 		if (rlen)
 		  {
+		    printint l1 = rline;
+		    printint l2 = rline + rlen - 1;
 		    if (rlen == 1)
-		      fprintf (tmp, "+++ %s %ld\n", rname, (long int) rline);
+		      fprintf (tmp, "+++ %s %"pI"d\n", rname, l1);
 		    else
-		      fprintf (tmp, "+++ %s %ld,%ld\n", rname,
-			       (long int) rline,
-			       (long int) (rline + rlen - 1));
+		      fprintf (tmp, "+++ %s %"pI"d,%"pI"d\n", rname, l1, l2);
 		  }
 		/* Fall through.  */
 	      case '2': case 'b': case 'r':
diff --git a/src/side.c b/src/side.c
index 2276385..40356c9 100644
--- a/src/side.c
+++ b/src/side.c
@@ -260,9 +260,9 @@ print_sdiff_common_lines (lin limit0, lin limit1)
     {
       if (sdiff_merge_assist)
 	{
-	  long int len0 = limit0 - i0;
-	  long int len1 = limit1 - i1;
-	  fprintf (outfile, "i%ld,%ld\n", len0, len1);
+	  printint len0 = limit0 - i0;
+	  printint len1 = limit1 - i1;
+	  fprintf (outfile, "i%"pI"d,%"pI"d\n", len0, len1);
 	}
 
       if (!left_column)
@@ -302,9 +302,9 @@ print_sdiff_hunk (struct change *hunk)
 
   if (sdiff_merge_assist)
     {
-      long int len0 = last0 - first0 + 1;
-      long int len1 = last1 - first1 + 1;
-      fprintf (outfile, "c%ld,%ld\n", len0, len1);
+      printint len0 = last0 - first0 + 1;
+      printint len1 = last1 - first1 + 1;
+      fprintf (outfile, "c%"pI"d,%"pI"d\n", len0, len1);
     }
 
   /* Print "xxx  |  xxx " lines.  */
diff --git a/src/system.h b/src/system.h
index be1c0bd..481d3a0 100644
--- a/src/system.h
+++ b/src/system.h
@@ -127,14 +127,30 @@ int strcasecmp (char const *, char const *);
 # define word size_t
 #endif
 
-/* The integer type of a line number.  Since files are read into main
-   memory, ptrdiff_t should be wide enough.  */
+/* The signed integer type of a line number.  Since files are read
+   into main memory, ptrdiff_t should be wide enough.  */
 
 typedef ptrdiff_t lin;
 #define LIN_MAX PTRDIFF_MAX
+
+/* The signed integer type for printing line numbers, and its printf
+   length modifier.  Prefer 'long int' if it suffices, to cater to C
+   implementations that lack support for "ll".  The natural
+   C99-or-later implementation with ptrdiff_t and "t" is less portable
+   in practice.  */
+
+#if LIN_MAX <= LONG_MAX
+typedef long int printint;
+# define pI "l"
+#else
+typedef long long int printint;
+# define pI "ll"
+#endif
+
 verify (TYPE_SIGNED (lin));
-verify (sizeof (ptrdiff_t) <= sizeof (lin));
-verify (sizeof (lin) <= sizeof (long int));
+verify (TYPE_SIGNED (printint));
+verify (LIN_MAX == TYPE_MAXIMUM (lin));
+verify (LIN_MAX <= TYPE_MAXIMUM (printint));
 
 /* Limit so that 2 * CONTEXT + 1 does not overflow.  */
 
diff --git a/src/util.c b/src/util.c
index 76872cb..bef2bff 100644
--- a/src/util.c
+++ b/src/util.c
@@ -1401,13 +1401,13 @@ translate_line_number (struct file_data const *file, lin i)
 }
 
 /* Translate a line number range.  This is always done for printing,
-   so for convenience translate to long int rather than lin, so that the
-   caller can use printf with "%ld" without casting.  */
+   so for convenience translate to printint rather than lin, so that the
+   caller can use printf with "%"pI"d" without casting.  */
 
 void
 translate_range (struct file_data const *file,
 		 lin a, lin b,
-		 long int *aptr, long int *bptr)
+		 printint *aptr, printint *bptr)
 {
   *aptr = translate_line_number (file, a - 1) + 1;
   *bptr = translate_line_number (file, b + 1) - 1;
@@ -1422,16 +1422,16 @@ translate_range (struct file_data const *file,
 void
 print_number_range (char sepchar, struct file_data *file, lin a, lin b)
 {
-  long int trans_a, trans_b;
+  printint trans_a, trans_b;
   translate_range (file, a, b, &trans_a, &trans_b);
 
   /* Note: we can have B < A in the case of a range of no lines.
      In this case, we should print the line number before the range,
      which is B.  */
   if (trans_b > trans_a)
-    fprintf (outfile, "%ld%c%ld", trans_a, sepchar, trans_b);
+    fprintf (outfile, "%"pI"d%c%"pI"d", trans_a, sepchar, trans_b);
   else
-    fprintf (outfile, "%ld", trans_b);
+    fprintf (outfile, "%"pI"d", trans_b);
 }
 
 /* Look at a hunk of edit script and report the range of lines in each file
@@ -1565,11 +1565,11 @@ debug_script (struct change *sp)
 
   for (; sp; sp = sp->link)
     {
-      long int line0 = sp->line0;
-      long int line1 = sp->line1;
-      long int deleted = sp->deleted;
-      long int inserted = sp->inserted;
-      fprintf (stderr, "%3ld %3ld delete %ld insert %ld\n",
+      printint line0 = sp->line0;
+      printint line1 = sp->line1;
+      printint deleted = sp->deleted;
+      printint inserted = sp->inserted;
+      fprintf (stderr, "%3"pI"d %3"pI"d delete %"pI"d insert %"pI"d\n",
 	       line0, line1, deleted, inserted);
     }
 
-- 
2.10.1 (Apple Git-78)


From 688f4fb211b603050ef7efd6cbe1db63b31f2fd7 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 28 Aug 2016 16:46:34 -0700
Subject: [PATCH 105/119] diff: don't assume ptrdiff_t <= long long int

* src/system.h (printint, pI): Port to (theoretical) platforms
where ptrdiff_t is wider than long long int (Bug#24311).
---
 src/system.h | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/src/system.h b/src/system.h
index 481d3a0..028113e 100644
--- a/src/system.h
+++ b/src/system.h
@@ -134,17 +134,19 @@ typedef ptrdiff_t lin;
 #define LIN_MAX PTRDIFF_MAX
 
 /* The signed integer type for printing line numbers, and its printf
-   length modifier.  Prefer 'long int' if it suffices, to cater to C
-   implementations that lack support for "ll".  The natural
-   C99-or-later implementation with ptrdiff_t and "t" is less portable
-   in practice.  */
+   length modifier.  This is not simply ptrdiff_t, to cater to older
+   and/or nonstandard C libraries where "l" works but "ll" and "t" do
+   not, or where 'long' is too narrow and "ll" works but "t" does not.  */
 
 #if LIN_MAX <= LONG_MAX
 typedef long int printint;
 # define pI "l"
-#else
+#elif LIN_MAX <= LLONG_MAX
 typedef long long int printint;
 # define pI "ll"
+#else
+typedef ptrdiff_t printint;
+# define pI "t"
 #endif
 
 verify (TYPE_SIGNED (lin));
-- 
2.10.1 (Apple Git-78)


From 65185e4c62028b468ad8a0602a33561561d9d0be Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Mon, 29 Aug 2016 20:07:16 -0700
Subject: [PATCH 106/119] gnulib: update to latest, to port to upcoming GCC 7

This fixes compilation errors when using gcc-7-to-be that were
due to missing backslashes in gnulib's intprops.h and an API
change in functions like __builtin_add_overflow.  This ports
to GCC 7's newer built-in overflow-checking functions.
---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index 1eb82ad..a569083 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 1eb82ad96b535801392e5d404dc7c79e69321858
+Subproject commit a56908381dd1ed630007a04ad03db17b1795e539
-- 
2.10.1 (Apple Git-78)


From ff2b22a8b3fafe6407ecebd95ddc41a13551879b Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Tue, 30 Aug 2016 12:41:38 -0700
Subject: [PATCH 107/119] gnulib: update to latest

---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index a569083..39fca95 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit a56908381dd1ed630007a04ad03db17b1795e539
+Subproject commit 39fca95053926d63f2ffed3dd64dc41a7d35b767
-- 
2.10.1 (Apple Git-78)


From 8db62fe5ec9b81899c39461c4380fcf2bb7a9d82 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 2 Oct 2016 10:56:55 -0700
Subject: [PATCH 108/119] build: avoid GCC 7's new warnings

* src/util.c (get_funky_string): Adjust comment so that GCC 7's
-Wimplicit-fallthrough recognizes it.
* src/diff3.c (main): Cast boolean MERGE to "int" to avoid this:
diff3.c:341:25: error: '~' on a boolean expression \
[-Werror=bool-operation]
---
 src/diff3.c | 4 +++-
 src/util.c  | 2 +-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/diff3.c b/src/diff3.c
index b2de4b6..055d275 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -338,7 +338,9 @@ main (int argc, char **argv)
 	}
     }
 
-  edscript = incompat & ~merge;  /* -AeExX3 without -m implies ed script.  */
+  /* -AeExX3 without -m implies ed script.  */
+  edscript = incompat & ~(int) merge;
+
   show_2nd |= ~incompat & merge;  /* -m without -AeExX3 implies -A.  */
   flagging |= ~incompat & merge;
 
diff --git a/src/util.c b/src/util.c
index bef2bff..c95dc77 100644
--- a/src/util.c
+++ b/src/util.c
@@ -383,7 +383,7 @@ get_funky_string (char **dest, const char **src, bool equals_end,
                   state = ST_END; /* End */
                   break;
                 }
-              /* else fall through */
+              /* fall through */
             default:
               *(q++) = *(p++);
               ++count;
-- 
2.10.1 (Apple Git-78)


From 84387b8f5fa66ecb4c2ac46a2a8cde909222f090 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sat, 1 Oct 2016 13:00:35 -0700
Subject: [PATCH 109/119] gnulib: update to latest

---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index 39fca95..e63f5eb 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit 39fca95053926d63f2ffed3dd64dc41a7d35b767
+Subproject commit e63f5eb55570a1ea3e51ce47df33689785e085c1
-- 
2.10.1 (Apple Git-78)


From 1c1de418606f163a0027b3e7305ca91708616219 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 16 Oct 2016 08:43:14 -0700
Subject: [PATCH 110/119] maint: use die rather than error

Use "die (N, ..." rather than "error (N, ..." whenever N is a nonzero
constant.  That lets the compiler know that control never goes beyond
that point, and thus makes unnecessary the occasional following
"abort ();" or "break;" statement we have historically added to inform
static analysis tools of this aspect of "error" semantics.
* src/die.h: New file.
* src/Makefile.am (noinst_HEADERS): Add it.
* src/cmp.c: Use die in place of error whenever the first
argument is a nonzero constant.  Also remove any immediately-
following call to abort, and include "die.h".
* src/diff.c: Likewise.
* src/diff3.c: Likewise.
* src/sdiff.c: Likewise.
* src/util.c: Likewise.
---
 src/Makefile.am |  5 ++++-
 src/cmp.c       | 18 +++++++++---------
 src/die.h       | 31 +++++++++++++++++++++++++++++++
 src/diff.c      |  6 +++---
 src/diff3.c     | 16 +++++++---------
 src/sdiff.c     |  4 ++--
 src/util.c      |  9 ++++-----
 7 files changed, 60 insertions(+), 29 deletions(-)
 create mode 100644 src/die.h

diff --git a/src/Makefile.am b/src/Makefile.am
index 167f7fd..65a1633 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -43,7 +43,10 @@ sdiff_SOURCES = sdiff.c
 diff_SOURCES = \
   analyze.c context.c diff.c dir.c ed.c ifdef.c io.c \
   normal.c side.c util.c
-noinst_HEADERS = diff.h system.h
+noinst_HEADERS =	\
+  die.h			\
+  diff.h		\
+  system.h
 
 MOSTLYCLEANFILES = paths.h paths.ht
 
diff --git a/src/cmp.c b/src/cmp.c
index ba5553b..5c1493d 100644
--- a/src/cmp.c
+++ b/src/cmp.c
@@ -23,6 +23,7 @@
 
 #include <c-stack.h>
 #include <cmpbuf.h>
+#include "die.h"
 #include <error.h>
 #include <exitfail.h>
 #include <file-type.h>
@@ -114,9 +115,8 @@ try_help (char const *reason_msgid, char const *operand)
 {
   if (reason_msgid)
     error (0, 0, _(reason_msgid), operand);
-  error (EXIT_TROUBLE, 0,
+  die (EXIT_TROUBLE, 0,
 	 _("Try '%s --help' for more information."), program_name);
-  abort ();
 }
 
 static char const valid_suffixes[] = "kKMGTPEZY0";
@@ -152,9 +152,9 @@ static void
 check_stdout (void)
 {
   if (ferror (stdout))
-    error (EXIT_TROUBLE, 0, "%s", _("write failed"));
+    die (EXIT_TROUBLE, 0, "%s", _("write failed"));
   else if (fclose (stdout) != 0)
-    error (EXIT_TROUBLE, errno, "%s", _("standard output"));
+    die (EXIT_TROUBLE, errno, "%s", _("standard output"));
 }
 
 static char const * const option_help_msgid[] = {
@@ -303,7 +303,7 @@ main (int argc, char **argv)
 	  if (file_desc[f1] < 0 && comparison_type == type_status)
 	    exit (EXIT_TROUBLE);
 	  else
-	    error (EXIT_TROUBLE, errno, "%s", file[f1]);
+	    die (EXIT_TROUBLE, errno, "%s", file[f1]);
 	}
     }
 
@@ -363,7 +363,7 @@ main (int argc, char **argv)
 
   for (f = 0; f < 2; f++)
     if (close (file_desc[f]) != 0)
-      error (EXIT_TROUBLE, errno, "%s", file[f]);
+      die (EXIT_TROUBLE, errno, "%s", file[f]);
   if (exit_status != EXIT_SUCCESS && comparison_type < type_no_stdout)
     check_stdout ();
   exit (exit_status);
@@ -421,7 +421,7 @@ cmp (void)
 	      if (r != bytes_to_read)
 		{
 		  if (r == SIZE_MAX)
-		    error (EXIT_TROUBLE, errno, "%s", file[f]);
+		    die (EXIT_TROUBLE, errno, "%s", file[f]);
 		  break;
 		}
 	      ig -= r;
@@ -443,10 +443,10 @@ cmp (void)
 
       read0 = block_read (file_desc[0], buf0, bytes_to_read);
       if (read0 == SIZE_MAX)
-	error (EXIT_TROUBLE, errno, "%s", file[0]);
+	die (EXIT_TROUBLE, errno, "%s", file[0]);
       read1 = block_read (file_desc[1], buf1, bytes_to_read);
       if (read1 == SIZE_MAX)
-	error (EXIT_TROUBLE, errno, "%s", file[1]);
+	die (EXIT_TROUBLE, errno, "%s", file[1]);
 
       smaller = MIN (read0, read1);
 
diff --git a/src/die.h b/src/die.h
new file mode 100644
index 0000000..f64ab34
--- /dev/null
+++ b/src/die.h
@@ -0,0 +1,31 @@
+/* Report an error and exit.
+   Copyright 2016 Free Software Foundation, Inc.
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 3, or (at your option)
+   any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA
+   02110-1301, USA.  */
+
+#ifndef DIE_H
+# define DIE_H
+
+# include <error.h>
+# include <stdbool.h>
+# include <verify.h>
+
+/* Like 'error (STATUS, ...)', except STATUS must be a nonzero constant.
+   This may pacify the compiler or help it generate better code.  */
+# define die(status, ...) \
+  verify_expr (status, (error (status, __VA_ARGS__), assume (false)))
+
+#endif /* DIE_H */
diff --git a/src/diff.c b/src/diff.c
index 686945e..bc7fd9e 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -20,6 +20,7 @@
 
 #define GDIFF_MAIN
 #include "diff.h"
+#include "die.h"
 #include <assert.h>
 #include "paths.h"
 #include <c-stack.h>
@@ -862,7 +863,7 @@ summarize_regexp_list (struct regexp_list *reglist)
 	  char const *m = re_compile_pattern (reglist->regexps, reglist->len,
 					      reglist->buf);
 	  if (m)
-	    error (EXIT_TROUBLE, 0, "%s: %s", reglist->regexps, m);
+	    die (EXIT_TROUBLE, 0, "%s: %s", reglist->regexps, m);
 	}
     }
 }
@@ -872,9 +873,8 @@ try_help (char const *reason_msgid, char const *operand)
 {
   if (reason_msgid)
     error (0, 0, _(reason_msgid), operand);
-  error (EXIT_TROUBLE, 0, _("Try '%s --help' for more information."),
+  die (EXIT_TROUBLE, 0, _("Try '%s --help' for more information."),
 	 program_name);
-  abort ();
 }
 
 static void
diff --git a/src/diff3.c b/src/diff3.c
index 055d275..7f93d22 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -24,6 +24,7 @@
 
 #include <c-stack.h>
 #include <cmpbuf.h>
+#include "die.h"
 #include <error.h>
 #include <exitfail.h>
 #include <file-type.h>
@@ -403,7 +404,7 @@ main (int argc, char **argv)
 	if (stat (file[i], &statb) < 0)
 	  perror_with_exit (file[i]);
 	else if (S_ISDIR (statb.st_mode))
-	  error (EXIT_TROUBLE, EISDIR, "%s", file[i]);
+	  die (EXIT_TROUBLE, EISDIR, "%s", file[i]);
       }
 
 #ifdef SIGCHLD
@@ -457,9 +458,8 @@ try_help (char const *reason_msgid, char const *operand)
 {
   if (reason_msgid)
     error (0, 0, _(reason_msgid), operand);
-  error (EXIT_TROUBLE, 0,
+  die (EXIT_TROUBLE, 0,
 	 _("Try '%s --help' for more information."), program_name);
-  abort ();
 }
 
 static void
@@ -1319,7 +1319,7 @@ read_diff (char const *filea,
   status = ! werrno && WIFEXITED (wstatus) ? WEXITSTATUS (wstatus) : INT_MAX;
 
   if (EXIT_TROUBLE <= status)
-    error (EXIT_TROUBLE, werrno,
+    die (EXIT_TROUBLE, werrno,
 	   _(status == 126
 	     ? "subsidiary program '%s' could not be invoked"
 	     : status == 127
@@ -1776,17 +1776,15 @@ reverse_diff3_blocklist (struct diff3_block *diff)
 
   return prev;
 }
-
+
 static void
 fatal (char const *msgid)
 {
-  error (EXIT_TROUBLE, 0, "%s", _(msgid));
-  abort ();
+  die (EXIT_TROUBLE, 0, "%s", _(msgid));
 }
 
 static void
 perror_with_exit (char const *string)
 {
-  error (EXIT_TROUBLE, errno, "%s", string);
-  abort ();
+  die (EXIT_TROUBLE, errno, "%s", string);
 }
diff --git a/src/sdiff.c b/src/sdiff.c
index d900779..aa69f18 100644
--- a/src/sdiff.c
+++ b/src/sdiff.c
@@ -26,6 +26,7 @@
 
 #include <c-stack.h>
 #include <dirname.h>
+#include "die.h"
 #include <error.h>
 #include <exitfail.h>
 #include <file-type.h>
@@ -155,9 +156,8 @@ try_help (char const *reason_msgid, char const *operand)
 {
   if (reason_msgid)
     error (0, 0, _(reason_msgid), operand);
-  error (EXIT_TROUBLE, 0, _("Try '%s --help' for more information."),
+  die (EXIT_TROUBLE, 0, _("Try '%s --help' for more information."),
 	 program_name);
-  abort ();
 }
 
 static void
diff --git a/src/util.c b/src/util.c
index c95dc77..ca6fbfa 100644
--- a/src/util.c
+++ b/src/util.c
@@ -20,6 +20,7 @@
 
 #include "diff.h"
 #include "argmatch.h"
+#include "die.h"
 #include <dirname.h>
 #include <error.h>
 #include <system-quote.h>
@@ -77,8 +78,7 @@ pfatal_with_name (char const *name)
 {
   int e = errno;
   print_message_queue ();
-  error (EXIT_TROUBLE, e, "%s", name);
-  abort ();
+  die (EXIT_TROUBLE, e, "%s", name);
 }
 
 /* Print an error message containing MSGID, then exit.  */
@@ -87,8 +87,7 @@ void
 fatal (char const *msgid)
 {
   print_message_queue ();
-  error (EXIT_TROUBLE, 0, "%s", _(msgid));
-  abort ();
+  die (EXIT_TROUBLE, 0, "%s", _(msgid));
 }
 
 /* Like printf, except if -l in effect then save the message and print later.
@@ -965,7 +964,7 @@ finish_output (void)
 		? WEXITSTATUS (wstatus)
 		: INT_MAX);
       if (status)
-	error (EXIT_TROUBLE, werrno,
+	die (EXIT_TROUBLE, werrno,
 	       _(status == 126
 		 ? "subsidiary program '%s' could not be invoked"
 		 : status == 127
-- 
2.10.1 (Apple Git-78)


From 571f01c069dfc7f860e5500a5d08ebfdaf9c3068 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Tue, 25 Oct 2016 21:52:31 -0700
Subject: [PATCH 111/119] build: update gnulib submodule to latest

---
 gnulib | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gnulib b/gnulib
index e63f5eb..d55ed06 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit e63f5eb55570a1ea3e51ce47df33689785e085c1
+Subproject commit d55ed0636eefeb43ad1aa8123416c33839652646
-- 
2.10.1 (Apple Git-78)


From 68b82f6f8419a815cfcf962b3061352d414dc606 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Tue, 25 Oct 2016 21:57:56 -0700
Subject: [PATCH 112/119] diff: fix big performance degradation in 3.4

* NEWS, doc/diffutils.texi (Overview): Document this.
* src/analyze.c (diff_2_files): Restore too_expensive heuristic,
but this time with a floor that is 16 times the old floor.  This
should fix Bug#16848, by generating good-quality output for its
test case, while not introducing Bug#24715, by running nearly as
fast as diff-3.3 for that test case.
---
 NEWS               |  5 +++++
 doc/diffutils.texi |  5 ++++-
 src/analyze.c      | 11 ++++++++++-
 3 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/NEWS b/NEWS
index 473332e..88f5d2b 100644
--- a/NEWS
+++ b/NEWS
@@ -6,6 +6,11 @@ GNU diffutils NEWS                                    -*- outline -*-
 
   diff no longer mishandles line numbers exceeding 2**31 on Mingw-w64.
 
+** Performance changes
+
+  diff's default algorithm has been tweaked to deal better with larger
+  files, reversing some of the changes made in diffutils-3.4.
+
 
 * Noteworthy changes in release 3.5 (2016-08-20) [stable]
 
diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index b478380..ceaf557 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -161,7 +161,10 @@ The algorithm was independently discovered as described by Esko Ukkonen in
 @c Date: Wed, 29 Sep 1993 08:27:55 MST
 @c Ukkonen should be given credit for also discovering the algorithm used
 @c in GNU diff.
-Related algorithms are surveyed by Alfred V. Aho in
+Unless the @option{--minimal} option is used, @command{diff} uses a
+heuristic by Paul Eggert that limits the cost to @math{O(N^1.5 log N)}
+at the price of producing suboptimal output for large inputs with many
+differences.  Related algorithms are surveyed by Alfred V. Aho in
 section 6.3 of ``Algorithms for Finding Patterns in Strings'',
 @cite{Handbook of Theoretical Computer Science} (Jan Van Leeuwen,
 ed.), Vol.@: A, @cite{Algorithms and Complexity}, Elsevier/MIT Press,
diff --git a/src/analyze.c b/src/analyze.c
index 3981872..847b8b0 100644
--- a/src/analyze.c
+++ b/src/analyze.c
@@ -534,6 +534,7 @@ diff_2_files (struct comparison *cmp)
     {
       struct context ctxt;
       lin diags;
+      lin too_expensive;
 
       /* Allocate vectors for the results of comparison:
 	 a flag for each line of each file, saying whether that line
@@ -565,11 +566,19 @@ diff_2_files (struct comparison *cmp)
 
       ctxt.heuristic = speed_large_files;
 
+      /* Set TOO_EXPENSIVE to be the approximate square root of the
+	 input size, bounded below by 4096.  4096 seems to be good for
+	 circa-2016 CPUs; see Bug#16848 and Bug#24715.  */
+      too_expensive = 1;
+      for (;  diags != 0;  diags >>= 2)
+	too_expensive <<= 1;
+      ctxt.too_expensive = MAX (4096, too_expensive);
+
       files[0] = cmp->file[0];
       files[1] = cmp->file[1];
 
       compareseq (0, cmp->file[0].nondiscarded_lines,
-		  0, cmp->file[1].nondiscarded_lines, &ctxt);
+		  0, cmp->file[1].nondiscarded_lines, minimal, &ctxt);
 
       free (ctxt.fdiag - (cmp->file[1].nondiscarded_lines + 1));
 
-- 
2.10.1 (Apple Git-78)


From a9cc55101cc9c10cf7a8857034fef88559f4c656 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 30 Oct 2016 12:13:13 -0700
Subject: [PATCH 113/119] tests: use "returns_" rather than explicit comparison
 with "$?"

* tests/colors: Use "returns_ 1" rather than testing $? = 1
* tests/basic: Likewise.
* tests/binary: Likewise.
* tests/filename-quoting: Likewise.
* tests/function-line-vs-leading-space: Likewise.
* tests/ignore-matching-lines: Likewise.
* tests/label-vs-func: Likewise.
* tests/new-file: Likewise.
* tests/no-dereference: Likewise.
* tests/no-newline-at-eof: Likewise.
* tests/stdin: Likewise.
---
 tests/basic                          |  2 +-
 tests/binary                         |  4 +---
 tests/colors                         | 26 +++++++++-------------
 tests/filename-quoting               |  4 ++--
 tests/function-line-vs-leading-space |  4 ++--
 tests/ignore-matching-lines          |  3 +--
 tests/label-vs-func                  |  2 +-
 tests/new-file                       | 16 +++++++-------
 tests/no-dereference                 | 42 ++++++++++++------------------------
 tests/no-newline-at-eof              |  9 +++-----
 tests/stdin                          |  2 +-
 11 files changed, 44 insertions(+), 70 deletions(-)

diff --git a/tests/basic b/tests/basic
index 45b9c9c..161262d 100755
--- a/tests/basic
+++ b/tests/basic
@@ -33,7 +33,7 @@ EOF
 echo a > a
 echo b > b
 for opt in '' -u -c; do
-  diff $opt a b > out 2> err; test $? = 1 || fail=1
+  returns_ 1 diff $opt a b > out 2> err || fail=1
   # Remove date and time.
   sed -e 's/^\([-+*][-+*][-+*] [^	]*\)	.*/\1/' out > k; mv k out
   compare exp-$(echo $opt|tr ' ' _) out || fail=1
diff --git a/tests/binary b/tests/binary
index 0110f6e..36fbe2d 100755
--- a/tests/binary
+++ b/tests/binary
@@ -7,10 +7,8 @@ printf 'Binary files - and /dev/null differ\n' > out-exp || fail_ setup
 
 fail=0
 
-printf '\0'|diff - /dev/null > out 2> err
-
 # diff must exit with status 1, stdout as above, and no stderr.
-test $? = 1 || fail=1
+printf '\0'| returns_ 1 diff - /dev/null > out 2> err || fail=1
 compare out-exp out || fail=1
 compare /dev/null err || fail=1
 
diff --git a/tests/colors b/tests/colors
index 8651a5b..4ca634d 100755
--- a/tests/colors
+++ b/tests/colors
@@ -81,44 +81,38 @@ $ad> b$rs
 
 rs=0 hd=1 ad=32 de=31 ln=36
 
-diff --color=auto a b > out
-test $? = 1 || fail=1
+returns_ 1 diff --color=auto a b > out || fail=1
 gen_exp_default > exp || framework_failure_
 compare exp out || fail=1
 
-TERM=dumb diff ---presume-output-tty --color=auto a b > out
-test $? = 1 || fail=1
+TERM=dumb returns_ 1 diff ---presume-output-tty --color=auto a b > out \
+  || fail=1
 gen_exp_default > exp || framework_failure_
 compare exp out || fail=1
 
-diff --color=never a b > out
-test $? = 1 || fail=1
+returns_ 1 diff --color=never a b > out || fail=1
 gen_exp_default > exp || framework_failure_
 compare exp out || fail=1
 
-diff a b > out
-test $? = 1 || fail=1
+returns_ 1 diff a b > out || fail=1
 gen_exp_default > exp || framework_failure_
 compare exp out || fail=1
 
-diff --color=always a b > out
-test $? = 1 || fail=1
+returns_ 1 diff --color=always a b > out || fail=1
 gen_exp_default_colors > exp || framework_failure_
 compare exp out || fail=1
 
-diff -u --color=always a b > out
-test $? = 1 || fail=1
+returns_ 1 diff -u --color=always a b > out || fail=1
 gen_exp_u > exp || framework_failure_
 compare exp out || fail=1
 
-diff -c --color=always a b > out
-test $? = 1 || fail=1
+returns_ 1 diff -c --color=always a b > out || fail=1
 gen_exp_c > exp || framework_failure_
 compare exp out || fail=1
 
 rs=0 hd=33 ad=34 de=35 ln=36
-diff -u --color=always --palette="rs=0:hd=33:ad=34:de=35:ln=36" a b > out
-test $? = 1 || fail=1
+returns_ 1 diff -u --color=always \
+  --palette="rs=0:hd=33:ad=34:de=35:ln=36" a b > out || fail=1
 gen_exp_u > exp || framework_failure_
 compare exp out || fail=1
 
diff --git a/tests/filename-quoting b/tests/filename-quoting
index e3e9193..2e75a03 100755
--- a/tests/filename-quoting
+++ b/tests/filename-quoting
@@ -32,7 +32,7 @@ EOF
 mkdir a b
 echo space > "b/ " || fail=1
 for opt in '' -u -c; do
-  diff -N -r $opt a b > out 2> err; test $? = 1 || fail=1
+  returns_ 1 diff -N -r $opt a b > out 2> err || fail=1
   # Remove date and time.
   sed -e 's/^\([-+*][-+*][-+*] [^	]*\)	.*/\1/' out > k; mv k out
   compare exp-$(echo $opt|tr ' ' _) out || fail=1
@@ -53,7 +53,7 @@ x01=$(printf '\001')
 
 echo tab > "a/$tab"   || fail=1
 echo one > "b/$x01" || fail=1
-diff -u "a/$tab" "b/$x01" > out 2> err; test $? = 1 || fail=1
+returns_ 1 diff -u "a/$tab" "b/$x01" > out 2> err || fail=1
 # Remove date and time.
 sed -e 's/^\([-+*][-+*][-+*] [^	]*\)	.*/\1/' out > k; mv k out
 compare exp out || fail=1
diff --git a/tests/function-line-vs-leading-space b/tests/function-line-vs-leading-space
index 572427c..d67eaf4 100755
--- a/tests/function-line-vs-leading-space
+++ b/tests/function-line-vs-leading-space
@@ -52,8 +52,8 @@ EOF
 
 fail=0
 
-diff -u -F '^[[:space:]]*\(function\|procedure\)' in in2 > out 2> err
-test $? = 1 || fail=1
+returns_ 1 diff -u -F '^[[:space:]]*\(function\|procedure\)' in in2 \
+  > out 2> err || fail=1
 
 sed -n '3,$p' out > k && mv k out || fail=1
 
diff --git a/tests/ignore-matching-lines b/tests/ignore-matching-lines
index 5db9ba3..1b3259f 100755
--- a/tests/ignore-matching-lines
+++ b/tests/ignore-matching-lines
@@ -39,8 +39,7 @@ cat <<'EOF' >exp
 +7
 EOF
 
-diff -u --ignore-matching-lines 3 a b >out 2>err
-test $? = 1 || fail=1
+returns_ 1 diff -u --ignore-matching-lines 3 a b >out 2>err || fail=1
 sed 1,2d out >outtail || framework_failure+
 compare exp outtail || fail=1
 
diff --git a/tests/label-vs-func b/tests/label-vs-func
index 2de61f7..4b4c9b7 100755
--- a/tests/label-vs-func
+++ b/tests/label-vs-func
@@ -19,7 +19,7 @@ label:
 EOF
 
 sed s/1/2/ a > b || fail=1
-diff -p -u0 a b > out 2> err; test $? = 1 || fail=1
+returns_ 1 diff -p -u0 a b > out 2> err || fail=1
 
 tail -3 out > k && mv k out || fail=1
 
diff --git a/tests/new-file b/tests/new-file
index af7cc4c..ab99708 100755
--- a/tests/new-file
+++ b/tests/new-file
@@ -10,29 +10,29 @@ echo a > a || fail=1
 echo '0a1
 > a' > exp || fail=1
 
-diff -N - a <&- > out; test $? = 1 || fail=1
+returns_ 1 diff -N - a <&- > out || fail=1
 compare exp out || fail=1
 
-diff --unidirectional-new-file - a <&- > out; test $? = 1 || fail=1
+returns_ 1 diff --unidirectional-new-file - a <&- > out || fail=1
 compare exp out || fail=1
 
-diff -N b - < a > out; test $? = 1 || fail=1
+returns_ 1 diff -N b - < a > out || fail=1
 compare exp out || fail=1
 
-diff --unidirectional-new-file b - < a > out; test $? = 1 || fail=1
+returns_ 1 diff --unidirectional-new-file b - < a > out || fail=1
 compare exp out || fail=1
 
 echo '1d0
 < a' > exp || fail=1
 
-diff -N a - <&- > out; test $? = 1 || fail=1
+returns_ 1 diff -N a - <&- > out || fail=1
 compare exp out || fail=1
 
-diff --unidirectional-new-file a - <&- > out; test $? = 2 || fail=1
+returns_ 2 diff --unidirectional-new-file a - <&- > out || fail=1
 
-diff -N - b < a > out; test $? = 1 || fail=1
+returns_ 1 diff -N - b < a > out || fail=1
 compare exp out || fail=1
 
-diff --unidirectional-new-file - b < a > out; test $? = 2 || fail=1
+returns_ 2 diff --unidirectional-new-file - b < a > out || fail=1
 
 Exit $fail
diff --git a/tests/no-dereference b/tests/no-dereference
index 1426beb..3f67bd2 100644
--- a/tests/no-dereference
+++ b/tests/no-dereference
@@ -14,8 +14,7 @@ ln -s regular3 symlink3
 # Non-recursive comparisons.
 
 # Test case 3: Compare regular file with regular file.
-diff --no-dereference regular1 regular2 > out
-test $? = 1 || fail=1
+returns_ 1 diff --no-dereference regular1 regular2 > out || fail=1
 cat <<EOF > expected || framework_failure_
 1c1
 < Simple contents
@@ -25,30 +24,26 @@ EOF
 compare expected out || fail=1
 
 # Test case 4: Compare regular file with symbolic link.
-diff --no-dereference regular1 symlink1 > out
-test $? = 1 || fail=1
+returns_ 1 diff --no-dereference regular1 symlink1 > out || fail=1
 cat <<EOF > expected || framework_failure_
 File regular1 is a regular file while file symlink1 is a symbolic link
 EOF
 compare expected out || fail=1
 
 # Test case 5: Compare symbolic link with regular file.
-diff --no-dereference symlink1 regular1 > out
-test $? = 1 || fail=1
+returns_ 1 diff --no-dereference symlink1 regular1 > out || fail=1
 cat <<EOF > expected || framework_failure_
 File symlink1 is a symbolic link while file regular1 is a regular file
 EOF
 compare expected out || fail=1
 
 # Test case 6: Compare symbolic links with same value.
-diff --no-dereference symlink1 symlink1bis > out
-test $? = 0 || fail=1
+diff --no-dereference symlink1 symlink1bis > out || fail=1
 compare /dev/null out || fail=1
 
 # Test case 7: Compare symbolic links with different value and different target
 # contents.
-diff --no-dereference symlink1 symlink2 > out
-test $? = 1 || fail=1
+returns_ 1 diff --no-dereference symlink1 symlink2 > out || fail=1
 cat <<EOF > expected || framework_failure_
 Symbolic links symlink1 and symlink2 differ
 EOF
@@ -56,8 +51,7 @@ compare expected out || fail=1
 
 # Test case 8: Compare symbolic links with different value and same target
 # contents.
-diff --no-dereference symlink2 symlink3 > out
-test $? = 1 || fail=1
+returns_ 1 diff --no-dereference symlink2 symlink3 > out || fail=1
 cat <<EOF > expected || framework_failure_
 Symbolic links symlink2 and symlink3 differ
 EOF
@@ -70,8 +64,7 @@ mkdir subdir1a
 mkdir subdir1b
 ln -s nonexistent subdir1a/foo
 ln -s ../regular1 subdir1a/bar
-diff -r --no-dereference subdir1a subdir1b > out
-test $? = 1 || fail=1
+returns_ 1 diff -r --no-dereference subdir1a subdir1b > out || fail=1
 cat <<EOF > expected || framework_failure_
 Only in subdir1a: bar
 Only in subdir1a: foo
@@ -83,8 +76,7 @@ mkdir subdir2a
 mkdir subdir2b
 ln -s nonexistent subdir2b/foo
 ln -s ../regular1 subdir2b/bar
-diff -r --no-dereference subdir2a subdir2b > out
-test $? = 1 || fail=1
+returns_ 1 diff -r --no-dereference subdir2a subdir2b > out || fail=1
 cat <<EOF > expected || framework_failure_
 Only in subdir2b: bar
 Only in subdir2b: foo
@@ -96,8 +88,7 @@ mkdir subdir3a
 mkdir subdir3b
 cp regular1 subdir3a/foo
 cp regular2 subdir3b/foo
-diff -r --no-dereference subdir3a subdir3b > out
-test $? = 1 || fail=1
+returns_ 1 diff -r --no-dereference subdir3a subdir3b > out || fail=1
 cat <<EOF > expected || framework_failure_
 diff -r --no-dereference subdir3a/foo subdir3b/foo
 1c1
@@ -112,8 +103,7 @@ mkdir subdir4a
 mkdir subdir4b
 cp regular1 subdir4a/foo
 ln -s ../regular1 subdir4b/foo
-diff -r --no-dereference subdir4a subdir4b > out
-test $? = 1 || fail=1
+returns_ 1 diff -r --no-dereference subdir4a subdir4b > out || fail=1
 cat <<EOF > expected || framework_failure_
 File subdir4a/foo is a regular file while file subdir4b/foo is a symbolic link
 EOF
@@ -124,8 +114,7 @@ mkdir subdir5a
 mkdir subdir5b
 ln -s ../regular1 subdir5a/foo
 cp regular1 subdir5b/foo
-diff -r --no-dereference subdir5a subdir5b > out
-test $? = 1 || fail=1
+returns_ 1 diff -r --no-dereference subdir5a subdir5b > out || fail=1
 cat <<EOF > expected || framework_failure_
 File subdir5a/foo is a symbolic link while file subdir5b/foo is a regular file
 EOF
@@ -136,8 +125,7 @@ mkdir subdir6a
 mkdir subdir6b
 ln -s ../regular1 subdir6a/foo
 ln -s ../regular1 subdir6b/foo
-diff -r --no-dereference subdir6a subdir6b > out
-test $? = 0 || fail=1
+diff -r --no-dereference subdir6a subdir6b > out || fail=1
 compare /dev/null out || fail=1
 
 # Test case 7: Compare symbolic links with different value and different target
@@ -146,8 +134,7 @@ mkdir subdir7a
 mkdir subdir7b
 ln -s ../regular1 subdir7a/foo
 ln -s ../regular2 subdir7b/foo
-diff -r --no-dereference subdir7a subdir7b > out
-test $? = 1 || fail=1
+returns_ 1 diff -r --no-dereference subdir7a subdir7b > out || fail=1
 cat <<EOF > expected || framework_failure_
 Symbolic links subdir7a/foo and subdir7b/foo differ
 EOF
@@ -159,8 +146,7 @@ mkdir subdir8a
 mkdir subdir8b
 ln -s ../regular2 subdir8a/foo
 ln -s ../regular3 subdir8b/foo
-diff -r --no-dereference subdir8a subdir8b > out
-test $? = 1 || fail=1
+returns_ 1 diff -r --no-dereference subdir8a subdir8b > out || fail=1
 cat <<EOF > expected || framework_failure_
 Symbolic links subdir8a/foo and subdir8b/foo differ
 EOF
diff --git a/tests/no-newline-at-eof b/tests/no-newline-at-eof
index f503718..5f00003 100755
--- a/tests/no-newline-at-eof
+++ b/tests/no-newline-at-eof
@@ -31,8 +31,7 @@ fail=0
 # So we don't have to record trailing blanks in expected output above.
 opt=--suppress-blank-empty
 
-diff $opt -U1 a b > out 2> err
-test $? = 1 || fail=1
+returns_ 1 diff $opt -U1 a b > out 2> err || fail=1
 
 sed -n '/^@@/,$p' out > k && mv k out || fail=1
 compare exp out || fail=1
@@ -42,8 +41,7 @@ compare /dev/null err || fail=1
 # Repeat, but with a newline at the end of "a".
 echo >> a
 
-diff $opt -U1 a b > out 2> err
-test $? = 1 || fail=1
+returns_ 1 diff $opt -U1 a b > out 2> err || fail=1
 
 sed -n '/^@@/,$p' out > k && mv k out || fail=1
 compare exp2 out || fail=1
@@ -53,7 +51,6 @@ compare /dev/null err || fail=1
 # Test for Bug#18402.
 printf a > a
 printf b > b
-diff -B a b > out 2>err
-test $? = 1 || fail=1
+returns_ 1 diff -B a b > out 2>err || fail=1
 
 Exit $fail
diff --git a/tests/stdin b/tests/stdin
index 295e98d..94b7542 100755
--- a/tests/stdin
+++ b/tests/stdin
@@ -16,7 +16,7 @@ EOF
 echo a > a
 echo b > b
 
-diff -u - b < a > out 2> err; test $? = 1 || fail=1
+returns_ 1 diff -u - b < a > out 2> err || fail=1
 # Remove date and time.
 sed -e 's/^\([-+*][-+*][-+*] [^	]*\)	.*/\1/' out > k; mv k out
 compare exp out || fail=1
-- 
2.10.1 (Apple Git-78)


From 90106d33ab3004872f8cfe46779683be48b7bd12 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Sun, 1 Jan 2017 03:22:44 -0800
Subject: [PATCH 114/119] maint: update gnulib and copyright dates for 2017

* gnulib: Update to latest.
* all files: Run "make update-copyright".
---
 AUTHORS            | 2 +-
 ChangeLog-2008     | 2 +-
 HACKING            | 2 +-
 Makefile.am        | 2 +-
 NEWS               | 2 +-
 README             | 2 +-
 README-hacking     | 2 +-
 bootstrap          | 2 +-
 bootstrap.conf     | 2 +-
 cfg.mk             | 2 +-
 configure.ac       | 2 +-
 doc/Makefile.am    | 2 +-
 doc/diffutils.texi | 2 +-
 exgettext          | 2 +-
 gnulib             | 2 +-
 lib/Makefile.am    | 2 +-
 lib/cmpbuf.c       | 2 +-
 lib/cmpbuf.h       | 2 +-
 lib/prepargs.c     | 2 +-
 man/Makefile.am    | 2 +-
 man/help2man       | 2 +-
 po/POTFILES.in     | 2 +-
 po/en.po           | 2 +-
 src/Makefile.am    | 2 +-
 src/analyze.c      | 2 +-
 src/cmp.c          | 2 +-
 src/context.c      | 2 +-
 src/die.h          | 2 +-
 src/diff.c         | 2 +-
 src/diff.h         | 2 +-
 src/diff3.c        | 2 +-
 src/dir.c          | 2 +-
 src/ed.c           | 2 +-
 src/ifdef.c        | 2 +-
 src/io.c           | 2 +-
 src/normal.c       | 2 +-
 src/sdiff.c        | 2 +-
 src/side.c         | 2 +-
 src/system.h       | 2 +-
 src/util.c         | 2 +-
 tests/envvar-check | 2 +-
 tests/help-version | 2 +-
 tests/init.sh      | 2 +-
 43 files changed, 43 insertions(+), 43 deletions(-)

diff --git a/AUTHORS b/AUTHORS
index 58b097a..c19d1c8 100644
--- a/AUTHORS
+++ b/AUTHORS
@@ -33,7 +33,7 @@ Patrick D'Cruze
 Eli Zaretskii
 
 
-Copyright (C) 2001, 2006, 2009-2013, 2015-2016 Free Software Foundation, Inc.
+Copyright (C) 2001, 2006, 2009-2013, 2015-2017 Free Software Foundation, Inc.
 
 This file is part of GNU diffutils.
 
diff --git a/ChangeLog-2008 b/ChangeLog-2008
index 7cf442c..bde317d 100644
--- a/ChangeLog-2008
+++ b/ChangeLog-2008
@@ -4265,7 +4265,7 @@ Thu Nov  3 16:30:24 1988  Randall Smith  (randy at gluteus.ai.mit.edu)
 
 	-----
 
-	Copyright (C) 1988-1994, 1997-2002, 2004, 2006, 2009-2013, 2015-2016
+	Copyright (C) 1988-1994, 1997-2002, 2004, 2006, 2009-2013, 2015-2017
 	Free Software Foundation, Inc.
 
 	Copying and distribution of this file, with or without
diff --git a/HACKING b/HACKING
index f998d2d..941e3a8 100644
--- a/HACKING
+++ b/HACKING
@@ -581,7 +581,7 @@ Then just open the index.html file (in the generated lcov-html directory)
 in your favorite web browser.
 
 ========================================================================
-Copyright (C) 2009-2013, 2015-2016 Free Software Foundation, Inc.
+Copyright (C) 2009-2013, 2015-2017 Free Software Foundation, Inc.
 
 Permission is granted to copy, distribute and/or modify this document
 under the terms of the GNU Free Documentation License, Version 1.3 or
diff --git a/Makefile.am b/Makefile.am
index edee5fa..eacce96 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -1,6 +1,6 @@
 # Main Automakefile for GNU diffutils.
 
-# Copyright (C) 2001-2002, 2004, 2006, 2009-2013, 2015-2016 Free Software
+# Copyright (C) 2001-2002, 2004, 2006, 2009-2013, 2015-2017 Free Software
 # Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
diff --git a/NEWS b/NEWS
index 88f5d2b..3f7bcac 100644
--- a/NEWS
+++ b/NEWS
@@ -389,7 +389,7 @@ User-visible changes in version 2.0:
 
 
 
-Copyright (C) 1993-1994, 1998, 2001-2002, 2004, 2006, 2009-2013, 2015-2016 Free
+Copyright (C) 1993-1994, 1998, 2001-2002, 2004, 2006, 2009-2013, 2015-2017 Free
 Software Foundation, Inc.
 
 This file is part of GNU Diffutils.
diff --git a/README b/README
index 30bb380..665a6b1 100644
--- a/README
+++ b/README
@@ -51,7 +51,7 @@ Please report bugs to <bug-diffutils@gnu.org>.
 
 -----
 
-Copyright (C) 1992, 1998, 2001-2002, 2004, 2009-2013, 2015-2016 Free Software
+Copyright (C) 1992, 1998, 2001-2002, 2004, 2009-2013, 2015-2017 Free Software
 Foundation, Inc.
 
 This file is part of GNU Diffutils.
diff --git a/README-hacking b/README-hacking
index 7b2cd7e..4628c8e 100644
--- a/README-hacking
+++ b/README-hacking
@@ -94,7 +94,7 @@ each program.  One way to do this is to use vc-dwim
 
 -----
 
-Copyright (C) 2002-2007, 2009-2013, 2015-2016 Free Software Foundation, Inc.
+Copyright (C) 2002-2007, 2009-2013, 2015-2017 Free Software Foundation, Inc.
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
diff --git a/bootstrap b/bootstrap
index f060bab..e482a16 100755
--- a/bootstrap
+++ b/bootstrap
@@ -4,7 +4,7 @@ scriptversion=2016-01-24.06; # UTC
 
 # Bootstrap this package from checked-out sources.
 
-# Copyright (C) 2003-2016 Free Software Foundation, Inc.
+# Copyright (C) 2003-2017 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/bootstrap.conf b/bootstrap.conf
index ac3c278..b83f39a 100644
--- a/bootstrap.conf
+++ b/bootstrap.conf
@@ -1,6 +1,6 @@
 # Bootstrap configuration.
 
-# Copyright (C) 2006-2013, 2015-2016 Free Software Foundation, Inc.
+# Copyright (C) 2006-2013, 2015-2017 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/cfg.mk b/cfg.mk
index 61efa04..6d7cff2 100644
--- a/cfg.mk
+++ b/cfg.mk
@@ -1,5 +1,5 @@
 # Customize maint.mk                           -*- makefile -*-
-# Copyright (C) 2003-2013, 2015-2016 Free Software Foundation, Inc.
+# Copyright (C) 2003-2013, 2015-2017 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/configure.ac b/configure.ac
index 936338f..28e0107 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1,6 +1,6 @@
 # Configure template for GNU Diffutils.
 
-# Copyright (C) 1994-1995, 1998, 2001-2002, 2004, 2006, 2009-2013, 2015-2016
+# Copyright (C) 1994-1995, 1998, 2001-2002, 2004, 2006, 2009-2013, 2015-2017
 # Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
diff --git a/doc/Makefile.am b/doc/Makefile.am
index 4f738c6..2fbfc69 100644
--- a/doc/Makefile.am
+++ b/doc/Makefile.am
@@ -1,6 +1,6 @@
 # Makefile for GNU diffutils documentation.
 
-# Copyright (C) 2001-2002, 2009-2013, 2015-2016 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2009-2013, 2015-2017 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index ceaf557..54a1457 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -14,7 +14,7 @@ and documents the @acronym{GNU} @command{diff}, @command{diff3},
 differences between files and the @acronym{GNU} @command{patch} command for
 using their output to update files.
 
-Copyright @copyright{} 1992-1994, 1998, 2001-2002, 2004, 2006, 2009-2016 Free
+Copyright @copyright{} 1992-1994, 1998, 2001-2002, 2004, 2006, 2009-2017 Free
 Software Foundation, Inc.
 
 @quotation
diff --git a/exgettext b/exgettext
index 39a9b86..b825b1d 100755
--- a/exgettext
+++ b/exgettext
@@ -1,7 +1,7 @@
 #! /bin/sh
 # Wrapper around gettext for programs using the msgid convention.
 
-# Copyright (C) 1998, 2001, 2004, 2009-2013, 2015-2016 Free Software
+# Copyright (C) 1998, 2001, 2004, 2009-2013, 2015-2017 Free Software
 # Foundation, Inc.
 
 # Written by Paul Eggert <eggert@twinsun.com>.
diff --git a/gnulib b/gnulib
index d55ed06..a3fd683 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit d55ed0636eefeb43ad1aa8123416c33839652646
+Subproject commit a3fd683de3decbb58ab5fb5d32ad2e62f74fbf12
diff --git a/lib/Makefile.am b/lib/Makefile.am
index 8542af7..ce32659 100644
--- a/lib/Makefile.am
+++ b/lib/Makefile.am
@@ -1,6 +1,6 @@
 # Automakefile for GNU Diffutils library.
 
-# Copyright (C) 2001-2002, 2004, 2006, 2009-2013, 2015-2016 Free Software
+# Copyright (C) 2001-2002, 2004, 2006, 2009-2013, 2015-2017 Free Software
 # Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
diff --git a/lib/cmpbuf.c b/lib/cmpbuf.c
index fd34505..8e185bd 100644
--- a/lib/cmpbuf.c
+++ b/lib/cmpbuf.c
@@ -1,6 +1,6 @@
 /* Buffer primitives for comparison operations.
 
-   Copyright (C) 1993, 1995, 1998, 2001-2002, 2006, 2009-2013, 2015-2016 Free
+   Copyright (C) 1993, 1995, 1998, 2001-2002, 2006, 2009-2013, 2015-2017 Free
    Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
diff --git a/lib/cmpbuf.h b/lib/cmpbuf.h
index b9333d8..cf63a3b 100644
--- a/lib/cmpbuf.h
+++ b/lib/cmpbuf.h
@@ -1,6 +1,6 @@
 /* Buffer primitives for comparison operations.
 
-   Copyright (C) 2002, 2009-2013, 2015-2016 Free Software Foundation, Inc.
+   Copyright (C) 2002, 2009-2013, 2015-2017 Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/lib/prepargs.c b/lib/prepargs.c
index f4a2f12..c4928cd 100644
--- a/lib/prepargs.c
+++ b/lib/prepargs.c
@@ -1,6 +1,6 @@
 /* Parse arguments from a string and prepend them to an argv.
 
-   Copyright (C) 1999-2002, 2006, 2009-2013, 2015-2016 Free Software
+   Copyright (C) 1999-2002, 2006, 2009-2013, 2015-2017 Free Software
    Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
diff --git a/man/Makefile.am b/man/Makefile.am
index 918d863..98bfb4b 100644
--- a/man/Makefile.am
+++ b/man/Makefile.am
@@ -1,6 +1,6 @@
 # Automakefile for GNU diffutils man pages
 
-# Copyright (C) 2002, 2009-2013, 2015-2016 Free Software Foundation, Inc.
+# Copyright (C) 2002, 2009-2013, 2015-2017 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/man/help2man b/man/help2man
index e6207e5..54e5a31 100755
--- a/man/help2man
+++ b/man/help2man
@@ -1,7 +1,7 @@
 #!/usr/bin/perl -w
 
 # Generate a short man page from --help and --version output.
-# Copyright (C) 1997-2005, 2009-2011, 2013, 2015-2016 Free Software Foundation,
+# Copyright (C) 1997-2005, 2009-2011, 2013, 2015-2017 Free Software Foundation,
 # Inc.
 
 # This program is free software; you can redistribute it and/or modify
diff --git a/po/POTFILES.in b/po/POTFILES.in
index c379074..08690f8 100644
--- a/po/POTFILES.in
+++ b/po/POTFILES.in
@@ -1,6 +1,6 @@
 # List of files that contain translatable strings.
 
-# Copyright (C) 2001-2002, 2009-2013, 2015-2016 Free Software Foundation, Inc.
+# Copyright (C) 2001-2002, 2009-2013, 2015-2017 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/po/en.po b/po/en.po
index 5886a2f..6b3f956 100644
--- a/po/en.po
+++ b/po/en.po
@@ -1,5 +1,5 @@
 # English messages for GNU diffutils
-# Copyright 1998, 2001-2003, 2009-2013, 2015-2016 Free Software Foundation,
+# Copyright 1998, 2001-2003, 2009-2013, 2015-2017 Free Software Foundation,
 # Inc.
 # Paul Eggert <eggert@twinsun.com>, 1998
 #
diff --git a/src/Makefile.am b/src/Makefile.am
index 65a1633..50acad9 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -1,6 +1,6 @@
 # Automakefile for GNU diffutils programs.
 
-# Copyright (C) 2001-2002, 2006, 2009-2013, 2015-2016 Free Software Foundation,
+# Copyright (C) 2001-2002, 2006, 2009-2013, 2015-2017 Free Software Foundation,
 # Inc.
 
 # This program is free software: you can redistribute it and/or modify
diff --git a/src/analyze.c b/src/analyze.c
index 847b8b0..403ae73 100644
--- a/src/analyze.c
+++ b/src/analyze.c
@@ -1,7 +1,7 @@
 /* Analyze file differences for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2013, 2015-2016 Free Software Foundation, Inc.
+   2009-2013, 2015-2017 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/cmp.c b/src/cmp.c
index 5c1493d..748c212 100644
--- a/src/cmp.c
+++ b/src/cmp.c
@@ -1,7 +1,7 @@
 /* cmp - compare two files byte by byte
 
    Copyright (C) 1990-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013,
-   2015-2016 Free Software Foundation, Inc.
+   2015-2017 Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/src/context.c b/src/context.c
index 1a663ba..e96007d 100644
--- a/src/context.c
+++ b/src/context.c
@@ -1,7 +1,7 @@
 /* Context-format output routines for GNU DIFF.
 
    Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
-   2015-2016 Free Software Foundation, Inc.
+   2015-2017 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/die.h b/src/die.h
index f64ab34..8835d80 100644
--- a/src/die.h
+++ b/src/die.h
@@ -1,5 +1,5 @@
 /* Report an error and exit.
-   Copyright 2016 Free Software Foundation, Inc.
+   Copyright 2016-2017 Free Software Foundation, Inc.
 
    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/src/diff.c b/src/diff.c
index bc7fd9e..efcedf9 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -1,7 +1,7 @@
 /* diff - compare files line by line
 
    Copyright (C) 1988-1989, 1992-1994, 1996, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2013, 2015-2016 Free Software Foundation, Inc.
+   2009-2013, 2015-2017 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/diff.h b/src/diff.h
index 6eda1e6..c8cf436 100644
--- a/src/diff.h
+++ b/src/diff.h
@@ -1,7 +1,7 @@
 /* Shared definitions for GNU DIFF
 
    Copyright (C) 1988-1989, 1991-1995, 1998, 2001-2002, 2004, 2009-2013,
-   2015-2016 Free Software Foundation, Inc.
+   2015-2017 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/diff3.c b/src/diff3.c
index 7f93d22..b82c1fc 100644
--- a/src/diff3.c
+++ b/src/diff3.c
@@ -1,7 +1,7 @@
 /* diff3 - compare three files line by line
 
    Copyright (C) 1988-1989, 1992-1996, 1998, 2001-2002, 2004, 2006, 2009-2013,
-   2015-2016 Free Software Foundation, Inc.
+   2015-2017 Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
diff --git a/src/dir.c b/src/dir.c
index c8aa6a5..52c320a 100644
--- a/src/dir.c
+++ b/src/dir.c
@@ -1,7 +1,7 @@
 /* Read, sort and compare two directories.  Used for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006-2007,
-   2009-2013, 2015-2016 Free Software Foundation, Inc.
+   2009-2013, 2015-2017 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/ed.c b/src/ed.c
index 6c9192c..68789a4 100644
--- a/src/ed.c
+++ b/src/ed.c
@@ -1,7 +1,7 @@
 /* Output routines for ed-script format.
 
    Copyright (C) 1988-1989, 1991-1993, 1995, 1998, 2001, 2004, 2006, 2009-2013,
-   2015-2016 Free Software Foundation, Inc.
+   2015-2017 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/ifdef.c b/src/ifdef.c
index d67eb5b..ad9f734 100644
--- a/src/ifdef.c
+++ b/src/ifdef.c
@@ -1,6 +1,6 @@
 /* #ifdef-format output routines for GNU DIFF.
 
-   Copyright (C) 1989, 1991-1994, 2001-2002, 2004, 2006, 2009-2013, 2015-2016
+   Copyright (C) 1989, 1991-1994, 2001-2002, 2004, 2006, 2009-2013, 2015-2017
    Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/io.c b/src/io.c
index 410bfef..b4ef5dc 100644
--- a/src/io.c
+++ b/src/io.c
@@ -1,7 +1,7 @@
 /* File I/O for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
-   2015-2016 Free Software Foundation, Inc.
+   2015-2017 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/normal.c b/src/normal.c
index 852a767..0f809da 100644
--- a/src/normal.c
+++ b/src/normal.c
@@ -1,6 +1,6 @@
 /* Normal-format output routines for GNU DIFF.
 
-   Copyright (C) 1988-1989, 1993, 1995, 1998, 2001, 2006, 2009-2013, 2015-2016
+   Copyright (C) 1988-1989, 1993, 1995, 1998, 2001, 2006, 2009-2013, 2015-2017
    Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/sdiff.c b/src/sdiff.c
index aa69f18..96ec0f5 100644
--- a/src/sdiff.c
+++ b/src/sdiff.c
@@ -1,7 +1,7 @@
 /* sdiff - side-by-side merge of file differences
 
    Copyright (C) 1992-1996, 1998, 2001-2002, 2004, 2006-2007, 2009-2013,
-   2015-2016 Free Software Foundation, Inc.
+   2015-2017 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/side.c b/src/side.c
index 40356c9..647f5b7 100644
--- a/src/side.c
+++ b/src/side.c
@@ -1,6 +1,6 @@
 /* sdiff-format output routines for GNU DIFF.
 
-   Copyright (C) 1991-1993, 1998, 2001-2002, 2004, 2009-2013, 2015-2016 Free
+   Copyright (C) 1991-1993, 1998, 2001-2002, 2004, 2009-2013, 2015-2017 Free
    Software Foundation, Inc.
 
    This file is part of GNU DIFF.
diff --git a/src/system.h b/src/system.h
index 028113e..759b63c 100644
--- a/src/system.h
+++ b/src/system.h
@@ -1,7 +1,7 @@
 /* System dependent declarations.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
-   2015-2016 Free Software Foundation, Inc.
+   2015-2017 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/src/util.c b/src/util.c
index ca6fbfa..09c5316 100644
--- a/src/util.c
+++ b/src/util.c
@@ -1,7 +1,7 @@
 /* Support routines for GNU DIFF.
 
    Copyright (C) 1988-1989, 1992-1995, 1998, 2001-2002, 2004, 2006, 2009-2013,
-   2015-2016 Free Software Foundation, Inc.
+   2015-2017 Free Software Foundation, Inc.
 
    This file is part of GNU DIFF.
 
diff --git a/tests/envvar-check b/tests/envvar-check
index 3debef7..e602485 100644
--- a/tests/envvar-check
+++ b/tests/envvar-check
@@ -1,7 +1,7 @@
 # -*- sh -*-
 # Check environment variables for sane values while testing.
 
-# Copyright (C) 2000-2016 Free Software Foundation, Inc.
+# Copyright (C) 2000-2017 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/tests/help-version b/tests/help-version
index 339ece7..c3a91b3 100755
--- a/tests/help-version
+++ b/tests/help-version
@@ -2,7 +2,7 @@
 # Make sure all these programs work properly
 # when invoked with --help or --version.
 
-# Copyright (C) 2000-2013, 2015-2016 Free Software Foundation, Inc.
+# Copyright (C) 2000-2013, 2015-2017 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff --git a/tests/init.sh b/tests/init.sh
index 97e4e4b..7637f3d 100644
--- a/tests/init.sh
+++ b/tests/init.sh
@@ -1,6 +1,6 @@
 # source this file; set up for tests
 
-# Copyright (C) 2009-2016 Free Software Foundation, Inc.
+# Copyright (C) 2009-2017 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
-- 
2.10.1 (Apple Git-78)


From 75173432ed47ae77d3024da8e5daa70f1f8d2650 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Tue, 31 Jan 2017 10:45:11 -0800
Subject: [PATCH 115/119] maint: change "time stamp" to "timestamp" globally

This avoids a new syntax-check failure.
* ChangeLog-2008: Perform that change.
* doc/diffutils.texi: Likewise.
* NEWS: Likewise.
* cfg.mk: Update the old news hash accordingly.
---
 ChangeLog-2008     |  8 +++---
 NEWS               |  4 +--
 cfg.mk             |  2 +-
 doc/diffutils.texi | 76 +++++++++++++++++++++++++++---------------------------
 4 files changed, 45 insertions(+), 45 deletions(-)

diff --git a/ChangeLog-2008 b/ChangeLog-2008
index bde317d..714c354 100644
--- a/ChangeLog-2008
+++ b/ChangeLog-2008
@@ -1068,7 +1068,7 @@
 	(Standards conformance): New chapter.
 	(Binary): Differing binary files are trouble unless the user asked for
 	brief output.
-	(Detailed Context): Prefer ISO time stamp format in discussion.
+	(Detailed Context): Prefer ISO timestamp format in discussion.
 	(Detailed Unified, Pagination): Likewise.
 	(Less Context): Likewise.  Also use short option.
 	(Alternate Names): Separate option from arg.
@@ -1189,7 +1189,7 @@
 	likewise for -u and -U 3.
 	Use specify_style and specify_value.
 	(SIGCHLD): Do not define; now done in a header.
-	Use new style time stamp format for -u / -U.
+	Use new style timestamp format for -u / -U.
 	Reject numeric-string options if operating in POSIX 1003.1-2001 mode.
 	Avoid overflow problems with tab width.
 	Simplify from-file and to-file code.
@@ -1956,7 +1956,7 @@
 	(TIMESPEC_NS): New macro.
 	(nstrftime): New decl.
 	(print_context_label): Use nstrftime and time_format to format times.
-	Print numeric time stamp value if localtime fails.
+	Print numeric timestamp value if localtime fails.
 	(print_context_function): New function.
 	(pr_context_hunk, pr_unidiff_hunk): Use it.
 	(find_function): Use size_t for sizes, not int.
@@ -2538,7 +2538,7 @@ Thu Sep 22 16:47:00 1994  Paul Eggert  <eggert@twinsun.com>
 	(binprefix): Removed.
 	(distfiles): Add stamp-h.in.
 	(clean): Clean stamp-h.
-	(config.hin, config.h): Use time stamp files.
+	(config.hin, config.h): Use timestamp files.
 	(cmp_o): Add $(LIBOBJS).
 	(install): Install info files from srcdir if they're not in `.'.
 
diff --git a/NEWS b/NEWS
index 3f7bcac..030432f 100644
--- a/NEWS
+++ b/NEWS
@@ -178,7 +178,7 @@ User-visible changes in version 2.8.6:
   cmp now uses the maximal value instead of the last one.
 
 * diff now omits the ".000000000" on hosts that do not support
-  fractional time stamps.
+  fractional timestamps.
 
 Version 2.8.5 was not publicly released.
 
@@ -223,7 +223,7 @@ User-visible changes in version 2.8:
 * cmp now outputs "byte" rather than "char" outside the POSIX locale.
 * cmp -l's index column width now adjusts to fit larger (or smaller) files.
 * cmp -l -s and cmp -s -l are not allowed.  Use cmp -s or cmp -l instead.
-* diff uses ISO 8601 style time stamps for output times (e.g. "2001-11-23
+* diff uses ISO 8601 style timestamps for output times (e.g. "2001-11-23
   16:44:36.875702460 -0800") unless in the C or POSIX locale and the
   -c style is specified.
 * diff's -I and -F options use the regexp syntax of grep, not of Emacs.
diff --git a/cfg.mk b/cfg.mk
index 6d7cff2..b838488 100644
--- a/cfg.mk
+++ b/cfg.mk
@@ -33,7 +33,7 @@ bootstrap-tools = autoconf,automake,gnulib
 # Now that we have better tests, make this the default.
 export VERBOSE = yes
 
-old_NEWS_hash = 7813d6f6ccefe3a1706548b5f1cab93f
+old_NEWS_hash = 0216ec3bf3e3322f33afd4e949a9a29b
 
 # Tell maint.mk's syntax-check rules that diff gets config.h directly or
 # via diff.h or system.h.
diff --git a/doc/diffutils.texi b/doc/diffutils.texi
index 54a1457..16da09e 100644
--- a/doc/diffutils.texi
+++ b/doc/diffutils.texi
@@ -700,13 +700,13 @@ like this:
 
 @noindent
 @vindex LC_TIME
-@cindex time stamp format, context diffs
-The time stamp normally looks like @samp{2002-02-21 23:30:39.942229878
+@cindex timestamp format, context diffs
+The timestamp normally looks like @samp{2002-02-21 23:30:39.942229878
 -0800} to indicate the date, time with fractional seconds, and time
 zone in @uref{ftp://ftp.isi.edu/in-notes/rfc2822.txt, Internet RFC
 2822 format}.  (The fractional seconds are omitted on hosts that do
-not support fractional time stamps.)  However, a traditional time
-stamp like @samp{Thu Feb 21 23:30:39 2002} is used if the
+not support fractional timestamps.)  However, a traditional timestamp
+like @samp{Thu Feb 21 23:30:39 2002} is used if the
 @env{LC_TIME} locale category is either @samp{C} or @samp{POSIX}.
 
 You can change the header's content with the
@@ -816,11 +816,11 @@ like this:
 @end example
 
 @noindent
-@cindex time stamp format, unified diffs
-The time stamp looks like @samp{2002-02-21 23:30:39.942229878 -0800}
+@cindex timestamp format, unified diffs
+The timestamp looks like @samp{2002-02-21 23:30:39.942229878 -0800}
 to indicate the date, time with fractional seconds, and time zone.
 The fractional seconds are omitted on hosts that do not support
-fractional time stamps.
+fractional timestamps.
 
 You can change the header's content with the
 @option{--label=@var{label}} option. @xref{Alternate Names}.
@@ -2570,7 +2570,7 @@ hunks (if any) into @samp{@var{f}.rej}.
 * Revision Control::       Getting files from @acronym{RCS}, @acronym{SCCS}, etc.
 * Imperfect::              Dealing with imperfect patches.
 * Creating and Removing::  Creating and removing files with a patch.
-* Patching Time Stamps::   Updating time stamps on patched files.
+* Patching Timestamps::   Updating timestamps on patched files.
 * Multiple Patches::       Handling multiple patches in a file.
 * patch Directories::      Changing directory and stripping directories.
 * Backups::                Whether backup files are made.
@@ -2816,12 +2816,12 @@ file.
 If the patch appears to create a file that already exists,
 @command{patch} asks for confirmation before applying the patch.
 
-@node Patching Time Stamps
-@section Updating Time Stamps on Patched Files
-@cindex time stamps on patched files
+@node Patching Timestamps
+@section Updating Timestamps on Patched Files
+@cindex timestamps on patched files
 
 When @command{patch} updates a file, it normally sets the file's
-last-modified time stamp to the current time of day.  If you are using
+last-modified timestamp to the current time of day.  If you are using
 @command{patch} to track a software distribution, this can cause
 @command{make} to incorrectly conclude that a patched file is out of
 date.  For example, if @file{syntax.c} depends on @file{syntax.y}, and
@@ -2830,29 +2830,29 @@ date.  For example, if @file{syntax.c} depends on @file{syntax.y}, and
 @file{syntax.y} even though its contents are actually up to date.
 
 The @option{--set-utc} (@option{-Z}) option causes @command{patch} to
-set a patched file's modification and access times to the time stamps
+set a patched file's modification and access times to the timestamps
 given in context diff headers.  If the context diff headers do not
 specify a time zone, they are assumed to use Coordinated Universal
 Time (@acronym{UTC}, often known as @acronym{GMT}).
 
 The @option{--set-time} (@option{-T}) option acts like @option{-Z} or
 @option{--set-utc}, except that it assumes that the context diff
-headers' time stamps use local time instead of @acronym{UTC}.  This option
+headers' timestamps use local time instead of @acronym{UTC}.  This option
 is not recommended, because patches using local time cannot easily be
-used by people in other time zones, and because local time stamps are
+used by people in other time zones, and because local timestamps are
 ambiguous when local clocks move backwards during daylight-saving time
 adjustments.  If the context diff headers specify a time zone, this
 option is equivalent to @option{--set-utc} (@option{-Z}).
 
-@command{patch} normally refrains from setting a file's time stamps if
-the file's original last-modified time stamp does not match the time
+@command{patch} normally refrains from setting a file's timestamps if
+the file's original last-modified timestamp does not match the time
 given in the diff header, of if the file's contents do not exactly
 match the patch.  However, if the @option{--force} (@option{-f})
-option is given, the file's time stamps are set regardless.
+option is given, the file's timestamps are set regardless.
 
 Due to the limitations of the current @command{diff} format,
 @command{patch} cannot update the times of files whose contents have
-not changed.  Also, if you set file time stamps to values other than
+not changed.  Also, if you set file timestamps to values other than
 the current time of day, you should also remove (e.g., with @samp{make
 clean}) all files that depend on the patched files, so that later
 invocations of @command{make} do not get confused by the patched
@@ -3356,7 +3356,7 @@ To generate the patch, use the command @samp{diff -Naur @var{old}
 directories.  The names @var{old} and @var{new} should not contain any
 slashes.  The @option{-N} option lets the patch create and remove
 files; @option{-a} lets the patch update non-text files; @option{-u}
-generates useful time stamps and enough context; and @option{-r} lets
+generates useful timestamps and enough context; and @option{-r} lets
 the patch update subdirectories.  Here is an example command, using
 Bourne shell syntax:
 
@@ -3465,8 +3465,8 @@ exclude them from the patch by giving @command{diff} the @option{-x
 @var{pattern}} option (@pxref{Comparing Directories}).  If you want
 your patch to modify a derived file because your recipients lack tools
 to build it, make sure that the patch for the derived file follows any
-patches for files that it depends on, so that the recipients' time
-stamps will not confuse @command{make}.
+patches for files that it depends on, so that the recipients'
+timestamps will not confuse @command{make}.
 
 Now you can create the patch using @samp{diff -Naur}.  Make sure to
 specify the scratch directory first and the newer directory second.
@@ -4343,9 +4343,9 @@ Do not ask any questions.  @xref{patch Messages}.
 
 @item -T
 @itemx --set-time
-Set the modification and access times of patched files from time
-stamps given in context diff headers, assuming that the context diff
-headers use local time.  @xref{Patching Time Stamps}.
+Set the modification and access times of patched files from timestamps
+given in context diff headers, assuming that the context diff
+headers use local time.  @xref{Patching Timestamps}.
 
 @item -u
 @itemx --unified
@@ -4378,9 +4378,9 @@ Use @var{suffix} as the backup extension instead of @samp{.orig} or
 
 @item -Z
 @itemx --set-utc
-Set the modification and access times of patched files from time
-stamps given in context diff headers, assuming that the context diff
-headers use @acronym{UTC}.  @xref{Patching Time Stamps}.
+Set the modification and access times of patched files from timestamps
+given in context diff headers, assuming that the context diff
+headers use @acronym{UTC}.  @xref{Patching Timestamps}.
 
 @end table
 
@@ -4597,7 +4597,7 @@ following suggested projects.
 * Changing Structure::   Handling changes to the directory structure.
 * Special Files::        Handling symbolic links, device special files, etc.
 * Unusual File Names::   Handling file names that contain unusual characters.
-* Time Stamp Order::     Outputting diffs in time stamp order.
+* Timestamp Order::     Outputting diffs in timestamp order.
 * Ignoring Changes::     Ignoring certain changes while showing others.
 * Speedups::             Improving performance.
 @end menu
@@ -4642,7 +4642,7 @@ There should be a way to specify that a file has been removed without
 having to include its entire contents in the patch file.  There should
 also be a way to tell @command{patch} that a file was renamed, even if
 there is no way for @command{diff} to generate such information.
-There should be a way to tell @command{patch} that a file's time stamp
+There should be a way to tell @command{patch} that a file's timestamp
 has changed, even if its contents have not changed.
 
 These problems can be fixed by extending the @command{diff} output format
@@ -4683,16 +4683,16 @@ parse.  The problem is with format of @command{diff} output, not just with
 patches the wrong files.  The format of @command{diff} output should be
 extended to handle all possible file names.
 
-@node Time Stamp Order
-@subsection Outputting Diffs in Time Stamp Order
+@node Timestamp Order
+@subsection Outputting Diffs in Timestamp Order
 
 Applying @command{patch} to a multiple-file diff can result in files
-whose time stamps are out of order.  @acronym{GNU} @command{patch} has
-options to restore the time stamps of the updated files
-(@pxref{Patching Time Stamps}), but sometimes it is useful to generate
+whose timestamps are out of order.  @acronym{GNU} @command{patch} has
+options to restore the timestamps of the updated files
+(@pxref{Patching Timestamps}), but sometimes it is useful to generate
 a patch that works even if the recipient does not have @acronym{GNU} patch,
 or does not use these options.  One way to do this would be to
-implement a @command{diff} option to output diffs in time stamp order.
+implement a @command{diff} option to output diffs in timestamp order.
 
 @node Ignoring Changes
 @subsection Ignoring Certain Changes
@@ -4719,10 +4719,10 @@ However, this outputs the filtered text, not the original.
 @subsection Improving Performance
 
 When comparing two large directory structures, one of which was
-originally copied from the other with time stamps preserved (e.g.,
+originally copied from the other with timestamps preserved (e.g.,
 with @samp{cp -pR}), it would greatly improve performance if an option
 told @command{diff} to assume that two files with the same size and
-time stamps have the same content.  @xref{diff Performance}.
+timestamps have the same content.  @xref{diff Performance}.
 
 @node Bugs
 @section Reporting Bugs
-- 
2.10.1 (Apple Git-78)


From 8420aff7e0eac5b6d02dcb60b88b9f9c2150f85a Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Tue, 31 Jan 2017 10:36:25 -0800
Subject: [PATCH 116/119] gnulib: update to latest; and update bootstrap and
 init.sh

---
 bootstrap     | 38 +++++++++++++++--------------
 gnulib        |  2 +-
 tests/init.sh | 77 +++++++++++++++++++++++++----------------------------------
 3 files changed, 54 insertions(+), 63 deletions(-)

diff --git a/bootstrap b/bootstrap
index e482a16..932ff85 100755
--- a/bootstrap
+++ b/bootstrap
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Print a version string.
-scriptversion=2016-01-24.06; # UTC
+scriptversion=2017-01-09.19; # UTC
 
 # Bootstrap this package from checked-out sources.
 
@@ -418,28 +418,30 @@ sort_ver() { # sort -V is not generally available
   done
 }
 
-get_version() {
-  app=$1
+get_version_sed='
+# Move version to start of line.
+s/.*[v ]\([0-9]\)/\1/
 
-  $app --version >/dev/null 2>&1 || { $app --version; return 1; }
+# Skip lines that do not start with version.
+/^[0-9]/!d
 
-  $app --version 2>&1 |
-  sed -n '# Move version to start of line.
-          s/.*[v ]\([0-9]\)/\1/
+# Remove characters after the version.
+s/[^.a-z0-9-].*//
 
-          # Skip lines that do not start with version.
-          /^[0-9]/!d
+# The first component must be digits only.
+s/^\([0-9]*\)[a-z-].*/\1/
 
-          # Remove characters after the version.
-          s/[^.a-z0-9-].*//
+#the following essentially does s/5.005/5.5/
+s/\.0*\([1-9]\)/.\1/g
+p
+q'
 
-          # The first component must be digits only.
-          s/^\([0-9]*\)[a-z-].*/\1/
+get_version() {
+  app=$1
+
+  $app --version >/dev/null 2>&1 || { $app --version; return 1; }
 
-          #the following essentially does s/5.005/5.5/
-          s/\.0*\([1-9]\)/.\1/g
-          p
-          q'
+  $app --version 2>&1 | sed -n "$get_version_sed"
 }
 
 check_versions() {
@@ -788,7 +790,7 @@ symlink_to_dir()
       # Leave any existing symlink alone, if it already points to the source,
       # so that broken build tools that care about symlink times
       # aren't confused into doing unnecessary builds.  Conversely, if the
-      # existing symlink's time stamp is older than the source, make it afresh,
+      # existing symlink's timestamp is older than the source, make it afresh,
       # so that broken tools aren't confused into skipping needed builds.  See
       # <http://lists.gnu.org/archive/html/bug-gnulib/2011-05/msg00326.html>.
       test -h "$dst" &&
diff --git a/gnulib b/gnulib
index a3fd683..16f6a8d 160000
--- a/gnulib
+++ b/gnulib
@@ -1 +1 @@
-Subproject commit a3fd683de3decbb58ab5fb5d32ad2e62f74fbf12
+Subproject commit 16f6a8d8d81cc93745a24c0fb89caab2c383ae3c
diff --git a/tests/init.sh b/tests/init.sh
index 7637f3d..584194f 100644
--- a/tests/init.sh
+++ b/tests/init.sh
@@ -45,6 +45,9 @@
 # Running a single test, with verbose output:
 #   $ make check TESTS=test-foo.sh VERBOSE=yes
 #
+# Running a single test, keeping the temporary directory:
+#   $ make check TESTS=test-foo.sh KEEP=yes
+#
 # Running a single test, with single-stepping:
 #   1. Go into a sub-shell:
 #   $ bash
@@ -128,6 +131,13 @@ else
 fi
 
 # We require $(...) support unconditionally.
+# We require non-surprising "local" semantics (this eliminates dash).
+# This takes the admittedly draconian step of eliminating dash, because the
+# assignment tab=$(printf '\t') works fine, yet preceding it with "local "
+# transforms it into an assignment that sets the variable to the empty string.
+# That is too counter-intuitive, and can lead to subtle run-time malfunction.
+# The example below is less subtle in that with dash, it evokes the run-time
+# exception "dash: 1: local: 1: bad variable name".
 # We require a few additional shell features only when $EXEEXT is nonempty,
 # in order to support automatic $EXEEXT emulation:
 # - hyphen-containing alias names
@@ -151,6 +161,7 @@ fi
 gl_shell_test_script_='
 test $(echo y) = y || exit 1
 f_local_() { local v=1; }; f_local_ || exit 1
+f_dash_local_fail_() { local t=$(printf " 1"); }; f_dash_local_fail_
 score_=10
 if test "$VERBOSE" = yes; then
   test -n "$( (exec 3>&1; set -x; P=1 true 2>&3) 2> /dev/null)" && score_=9
@@ -287,50 +298,24 @@ compare_dev_null_ ()
   return 2
 }
 
-if diff_out_=`exec 2>/dev/null; diff -u "$0" "$0" < /dev/null` \
-   && diff -u Makefile "$0" 2>/dev/null | grep '^[+]#!' >/dev/null; then
-  # diff accepts the -u option and does not (like AIX 7 'diff') produce an
-  # extra space on column 1 of every content line.
-  if test -z "$diff_out_"; then
-    compare_ () { diff -u "$@"; }
-  else
-    compare_ ()
-    {
-      if diff -u "$@" > diff.out; then
-        # No differences were found, but Solaris 'diff' produces output
-        # "No differences encountered". Hide this output.
-        rm -f diff.out
-        true
-      else
-        cat diff.out
-        rm -f diff.out
-        false
-      fi
-    }
-  fi
-elif
-  for diff_opt_ in -U3 -c '' no; do
-    test "$diff_opt_" = no && break
-    diff_out_=`exec 2>/dev/null; diff $diff_opt_ "$0" "$0" </dev/null` && break
-  done
-  test "$diff_opt_" != no
-then
+for diff_opt_ in -u -U3 -c '' no; do
+  test "$diff_opt_" != no &&
+    diff_out_=`exec 2>/dev/null; diff $diff_opt_ "$0" "$0" < /dev/null` &&
+    break
+done
+if test "$diff_opt_" != no; then
   if test -z "$diff_out_"; then
     compare_ () { diff $diff_opt_ "$@"; }
   else
     compare_ ()
     {
-      if diff $diff_opt_ "$@" > diff.out; then
-        # No differences were found, but AIX and HP-UX 'diff' produce output
-        # "No differences encountered" or "There are no differences between the
-        # files.". Hide this output.
-        rm -f diff.out
-        true
-      else
-        cat diff.out
-        rm -f diff.out
-        false
-      fi
+      # If no differences were found, AIX and HP-UX 'diff' produce output
+      # like "No differences encountered".  Hide this output.
+      diff $diff_opt_ "$@" > diff.out
+      diff_status_=$?
+      test $diff_status_ -eq 0 || cat diff.out || diff_status_=2
+      rm -f diff.out || diff_status_=2
+      return $diff_status_
     }
   fi
 elif cmp -s /dev/null /dev/null 2>/dev/null; then
@@ -367,11 +352,15 @@ remove_tmp_ ()
 {
   __st=$?
   cleanup_
-  # cd out of the directory we're about to remove
-  cd "$initial_cwd_" || cd / || cd /tmp
-  chmod -R u+rwx "$test_dir_"
-  # If removal fails and exit status was to be 0, then change it to 1.
-  rm -rf "$test_dir_" || { test $__st = 0 && __st=1; }
+  if test "$KEEP" = yes; then
+    echo "Not removing temporary directory $test_dir_"
+  else
+    # cd out of the directory we're about to remove
+    cd "$initial_cwd_" || cd / || cd /tmp
+    chmod -R u+rwx "$test_dir_"
+    # If removal fails and exit status was to be 0, then change it to 1.
+    rm -rf "$test_dir_" || { test $__st = 0 && __st=1; }
+  fi
   exit $__st
 }
 
-- 
2.10.1 (Apple Git-78)


From eaa2a24345fba918eb7ad7a6a263e7e639d82d5f Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Tue, 31 Jan 2017 16:44:03 -0800
Subject: [PATCH 117/119] diff: avoid UMR with ---presume-output-tty

* src/diff.c (main): Always define presume_output_tty.
Otherwise, it would be read uninitialized.
Introduced in v3.3-45-g17e2698
* NEWS (Bug fixes): Mention it.
---
 NEWS       | 3 +++
 src/diff.c | 1 +
 2 files changed, 4 insertions(+)

diff --git a/NEWS b/NEWS
index 030432f..0afee1b 100644
--- a/NEWS
+++ b/NEWS
@@ -6,6 +6,9 @@ GNU diffutils NEWS                                    -*- outline -*-
 
   diff no longer mishandles line numbers exceeding 2**31 on Mingw-w64.
 
+  the ---presume-output-tty (ostensibly test-only) option would cause
+  diff --color to read an uninitialized variable
+
 ** Performance changes
 
   diff's default algorithm has been tweaked to deal better with larger
diff --git a/src/diff.c b/src/diff.c
index efcedf9..76851ac 100644
--- a/src/diff.c
+++ b/src/diff.c
@@ -296,6 +296,7 @@ main (int argc, char **argv)
   ignore_regexp_list.buf = &ignore_regexp;
   re_set_syntax (RE_SYNTAX_GREP | RE_NO_POSIX_BACKTRACKING);
   excluded = new_exclude ();
+  presume_output_tty = false;
 
   /* Decode the options.  */
 
-- 
2.10.1 (Apple Git-78)


From affa30def0d530022a03845372ec19c644f8f1ac Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Tue, 31 Jan 2017 17:06:10 -0800
Subject: [PATCH 118/119] maint: add "introduced in 3.4" in latest NEWS entry

* NEWS: Update.  Also, thanks to Nelson Beebe for reporting this.
---
 NEWS | 1 +
 1 file changed, 1 insertion(+)

diff --git a/NEWS b/NEWS
index 0afee1b..eae32b2 100644
--- a/NEWS
+++ b/NEWS
@@ -8,6 +8,7 @@ GNU diffutils NEWS                                    -*- outline -*-
 
   the ---presume-output-tty (ostensibly test-only) option would cause
   diff --color to read an uninitialized variable
+  [bug introduced in 3.4]
 
 ** Performance changes
 
-- 
2.10.1 (Apple Git-78)


From 198c55a64557c89f201ddea7cbcb14c09c400071 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@fb.com>
Date: Wed, 1 Feb 2017 23:06:29 -0800
Subject: [PATCH 119/119] tests: avoid false failure with some shells on
 debian, freebsd

* tests/colors: Move the TERM=dumb setting into the code run by
"returns_", since some shells do not propagate envvar setting through
to a use of a function like this.  That would cause this test to fail
because results were colorized when they should not have been.
Reported by Nelson Beebe.
---
 tests/colors | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/tests/colors b/tests/colors
index 4ca634d..9c7021c 100755
--- a/tests/colors
+++ b/tests/colors
@@ -85,7 +85,7 @@ returns_ 1 diff --color=auto a b > out || fail=1
 gen_exp_default > exp || framework_failure_
 compare exp out || fail=1
 
-TERM=dumb returns_ 1 diff ---presume-output-tty --color=auto a b > out \
+returns_ 1 env TERM=dumb diff ---presume-output-tty --color=auto a b > out \
   || fail=1
 gen_exp_default > exp || framework_failure_
 compare exp out || fail=1
-- 
2.10.1 (Apple Git-78)

